\documentclass[a4paper,10pt]{report}

\usepackage{stackrel, amsmath,amsthm,amsfonts,amssymb, stmaryrd}
%\usepackage{amsthm}
%\usepackage{mathrsfs}
%\usepackage{amsfont}
\usepackage{dsfont}\let\mathbb\mathds
\usepackage{yhmath}
\usepackage{listings}
\lstset{breaklines=true}
\usepackage{xr}


%PGF/TikZ
\usepackage{pgf,pgfplots, tikz}
\usetikzlibrary{arrows}

\usepackage{hyperref}
\hypersetup{
    colorlinks,
    citecolor=black,
    filecolor=black,
    linkcolor=black,
    urlcolor=black
}

\usepackage{float}
\usepackage[utf8]{inputenc} 
%\usepackage[T1]{fontenc} 
\usepackage[english]{babel}
\usepackage[all]{xy}
\usepackage{graphicx} 
\usepackage{geometry}
\geometry{hmargin=2.5cm,vmargin=2cm}

\usepackage{fancyvrb}

\usepackage{setspace}
\onehalfspacing 

\usepackage{mathtools}

\usepackage[ruled,linesnumbered]{algorithm2e}

\usepackage[
n, % or lambda advantage , operators , sets,
adversary , landau , probability , notions ,
logic ,
ff, mm,
primitives , events , complexity , asymptotics , keys
]{cryptocode}

\theoremstyle{definition}
\newtheorem{definition}{Definition}[chapter]

\theoremstyle{plain}
\newtheorem{proposition}[definition]{Proposition}
\newtheorem{lemma}[definition]{Lemma}
\newtheorem{corollary}[definition]{Corollary}
\newtheorem{theorem}[definition]{Theorem}

\theoremstyle{definition}
\newtheorem{remark}[definition]{Remark}
\newtheorem{example}[definition]{Example}
\newtheorem{assumption}[definition]{Assumption}
\newtheorem{problem}[definition]{Problem}


%cells divided in two diagonally
\usepackage{diagbox}

 %macros
\newcommand{\N}{\mathbb{N}}
\newcommand{\Z}{\mathbb{Z}}
\newcommand{\Q}{\mathbb{Q}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\C}{\mathbb{C}}
\newcommand{\K}{\mathbb{K}}
\newcommand{\F}{\mathbb{F}}
\newcommand{\Hc}{\mathbb{H}}
\newcommand{\Lc}{\mathbb{L}}
\newcommand{\M}{\mathbb{M}}
\newcommand{\Pc}{\mathbb{P}}
\newcommand{\A}{\mathbb{A}}
\newcommand{\B}{\mathbb{B}}
\newcommand{\E}{\mathbb{E}}
\newcommand{\V}{\mathbb{V}}
\newcommand{\m}[1]{\mathcal{#1}}
\newcommand{\mA}{\mathcal{A}}
\newcommand{\mB}{\mathcal{B}}
\newcommand{\mC}{\mathcal{C}}
\newcommand{\mP}{\mathcal{P}}
\newcommand{\mK}{\mathcal{K}}
\newcommand{\mL}{\mathcal{L}}
\newcommand{\mE}{\mathcal{E}}
\newcommand{\mD}{\mathcal{D}}
\newcommand{\mF}{\mathcal{F}}
\newcommand{\mO}{\mathcal{O}}
\newcommand{\im}{\mbox{im}}
\renewcommand{\ker}{\mbox{ker}}
\renewcommand{\dim}{\mbox{dim}}
\renewcommand{\deg}{\mbox{deg}}
\renewcommand{\i}[2]{\left\llbracket #1~;~#2\right\rrbracket}
\renewcommand{\(}{\left(}
\renewcommand{\)}{\right)}
\renewcommand{\P}{\mathbb{P}}
%commandes de Quentin
%\newcommand{\F}[1]{\mathbb{F}_{#1}}
\newcommand{\Fp}[1]{\mathbb{F}_{p^{#1}}}
\newcommand{\db}[1]{\mathbb{#1}}
\newcommand{\id}{\mbox{id}}
\newcommand{\mf}[1]{\mathfrak{#1}}
\newcommand{\mfm}{\mathfrak{m}}
\newcommand{\mfn}{\mathfrak{n}}
\newcommand{\mfp}{\mathfrak{p}}
\newcommand{\mfq}{\mathfrak{q}}
\newcommand{\Spec}{\mbox{Spec}}
\newcommand{\Proj}{\mbox{Proj}}
\newcommand{\Hom}{\mbox{Hom}}
\newcommand{\End}{\mbox{End}}
\newcommand{\leftmapsto}{\leftarrow\!\shortmid}
\newcommand{\longleftmapsto}{\longleftarrow\!\shortmid}
\renewcommand{\vec}[1]{\mathbf{#1}}

\begin{document}

\begin{center}

{\LARGE {\bfseries IBM Research Zurich}}

\vspace{0.2cm}

{\LARGE {\bfseries Université de Rennes 1}}

\vspace{1.5cm}

{\LARGE {\bfseries Master's thesis}}

\vspace{1.5cm}

{\huge {\bfseries On Oriented Supersingular Isogeny Diffie-Hellman}}

\vspace{1.5cm}

{\Large Pierrick Dartois}

\vspace{0.5cm}

{\Large Under the supervision of Luca De Feo}

\end{center}

\vspace{2cm}

{\bfseries Abstract:} The goal of this thesis is to present and give an implementation of the new isogeny based cryptosystem Oriented Supersingular Isogeny Diffie-Hellman (OSIDH) due to Kohel and Col\`{o} \cite{OSIDH}.  We will also present the complementary proofs and improvements of Onuki \cite{Onuki}.


Shore discovered in 1996 that quantum computers powerful enough could break all cryptographic primitives based on discrete logarithm and integer factorization such as the widespread RSA and commonly used elliptic curve cryptography.  Ever since, efforts have been made to find quantum-safe cryptographic primitives. Since the foundational works of Couveignes at the end of the 1990's and De Feo, Jao and Pl\^{u}t in 2011, isogeny-based cryptography has become a promising area of research in post-quantum cryptography.   The Oriented Supersingular Isogeny Diffie-Hellman (OSIDH) is a key exchange protocol generalizing the ideas of Commutative Supersingular Isogeny Diffie-Hellman (CSIDH) due to Castryck et. al.  (2018) itself based on the ideas of Couveignes.  We conduct a cryptanalysis of OSIDH and reach the conclusion that this cryptosystem is not secure, not only against quantum attacks but also against classical attacks.

\chapter{Mathematical framework of OSIDH}
\section{Oriented supersingular elliptic curves}

\subsection{Orientations}

Let $E/k$ be an elliptic curve.  We denote by $\End^0(E)$ the tensor product $\End(E)\otimes \Q$.  Let $K$ be a quadratic imaginary number field.

\begin{definition}
A $K$-\emph{orientation} of $E$ is an embedding $\iota : K\hookrightarrow \End^0(E)$.  If $\mO$ is an order of $K$,  we say that $(E, \iota)$ is an $\mO$-\emph{orientation} if $\iota(\mO)\subseteq \End(E)$.  An $\mO$-orientation is \emph{primitive} if $\iota(\mO)=\End(E)\cap\iota(K)$.
\end{definition}

\begin{lemma}
Let $(E,\iota)$ be a $K$-oriented elliptic curve.  Then :
\begin{description}
\item[(i)] For all $\alpha\in\iota^{-1}(\End(E))$,  $\iota(\overline{\alpha})=\widehat{\iota(\alpha)}$,  $\mbox{Tr}(\iota(\alpha))=\mbox{Tr}_{K/\Q}(\alpha)$ and $\deg(\iota(\alpha))=N_{K/\Q}(\alpha)$.
\item[(ii)] $\iota^{-1}(\End(E))$ is an order of $K$.  In particular,  every $K$-oriented elliptic curve admits a primitive orientation by an order of $K$.
\end{description}
\end{lemma}

\begin{proof}
\textbf{(i)} Let $\alpha\in\iota^{-1}(\End(E))$.  If $\alpha\in\Z$ then $\overline{\alpha}=\alpha$ and $\iota(\alpha)=\widehat{\iota(\alpha)}$,  so that $\iota(\overline{\alpha})=\widehat{\iota(\alpha)}$,  
\[\mbox{Tr}(\iota(\alpha))=\iota^{-1}(\iota(\alpha)+\widehat{\iota(\alpha)})=2\alpha=\mbox{Tr}_{K/\Q}(\alpha) \quad \mbox{and} \quad \deg(\iota(\alpha))=\iota^{-1}(\iota(\alpha)\widehat{\iota(\alpha)})=\alpha\overline{\alpha}=N_{K/\Q}(\alpha)\]
Otherwise,  $[\Q(\alpha):\Z]=2$ so that $X^2-\mbox{Tr}(\iota(\alpha))X+\deg(\iota(\alpha))$ is the minimal polynomial of $\alpha$ (it vanishes $\iota(\alpha)$,  then it vanishes $\alpha$) so we can identify the trace and the norm.

\textbf{(ii)}  By $(i)$,  $\iota^{-1}(\End(E))\subseteq \mO_K$ because every $\alpha\in\iota^{-1}(\End(E))$ is vanished by the polynomial $X^2-\mbox{Tr}(\iota(\alpha))X+\deg(\iota(\alpha))\in\Z[X]$.  Then either $\iota^{-1}(\End(E))=\Z$ or $\iota^{-1}(\End(E))$ is an order of $K$.  The first case is impossible,  otherwise we would have an embedding $K\hookrightarrow \Q$ with $[K:\Q]=2$.
\end{proof}

\begin{definition}\label{definition 1}
Let $(E, \iota)$ be a $K$-oriented elliptic curve and $\varphi : E\longrightarrow F$ an isogeny.  Then,  we define a $K$-orientation $\varphi_*(\iota)$ on $F$ by:
\[\forall \alpha\in K,  \quad \varphi_*(\iota)(\alpha)=\frac{1}{\deg(\varphi)}\varphi\iota(\alpha)\widehat{\varphi}\]

Let $(E, \iota_E)$ and $(F,\iota_F)$ be two isogenies.  An isogeny $\varphi : E\longrightarrow F$ is $K$-\emph{oriented} if $\varphi_*(\iota_E)=\iota_F$.  We denote this by $\varphi : (E, \iota_E)\longrightarrow(F,\iota_F)$.
\end{definition}

Let $\varphi : (E, \iota_E)\longrightarrow(F,\iota_F)$ be a $K$-oriented isogeny,  $\mO:=\iota_E^{-1}(\End(E))$ and $\mO':=\iota_F^{-1}(\End(F))$,  so that $\iota_E$ is a primitive $\mO$-orientation and $\iota_F$ is a primitive $\mO'$-orientation.  

\begin{lemma}
There exist non-negative coprime integers $m,m'\in\N^*$ such that $\Z+m\mO=\Z+m'\mO'$ and $mm'|\deg(\varphi)$.
\end{lemma}

\begin{proof}
Let $f$ and $f'$ be respectively the conductors of $\mO$ and $\mO'$.  Let $e:=\gcd(f,f')$.  Then $f:=m'e$ and $f':=me$ with $m,m'\in\N^*$,  coprime.  Then :
\[\mO=\Z+f\mO_K=\Z+em'\mO_K \quad \mbox{and} \quad \mO'=\Z+f'\mO_K=\Z+em\mO_K\]
and we trivially have $\Z+m\mO=\Z+mm'e\mO_K=\Z+m'\mO'$.

Since $\varphi$ is $K$-oriented,  we have $\deg(\varphi)\iota_F=\varphi\iota_E\widehat{\varphi}$,  so that $\deg(\varphi)\iota_F(\mO)\subseteq \End(E)\cap\iota_F(K)=\iota_F(\mO')$ and $\deg(\varphi)\mO\subseteq \mO'$.  Multiplying the equation $\deg(\varphi)\iota_F=\varphi\iota_E\widehat{\varphi}$ by $\widehat{\varphi}$ on the left and $\varphi$ on the right, we get that $\deg(\varphi)\iota_E=\widehat{\varphi}\iota_F\varphi$ and we conclude that $\deg(\varphi)\mO'\subseteq \mO$. 

It follows that :
\[\Z+m\deg(\varphi)\mO'\subseteq \Z+m\mO= \Z+m'\mO'\]
Taking a generator $\omega$ of $\mO$ ($\mO=\Z[\omega]$),  we get that $m\deg(\varphi)\omega=a+bm'\omega$ for certain integers $a,b\in\Z$.  It follows that $m\deg(\varphi)=bm'$ so that $m'|\deg(\varphi)$ because $m$ and $m'$ are coprime.  By symmetry,  $m|\deg(\varphi)$,  so $mm'|\deg(\varphi)$.
\end{proof}

\begin{proposition}\label{proposition 4}
We assume that $\ell:=\deg(\varphi)$ is a prime number $\neq p$.  Then one of the following statements holds:
\begin{description}
\item[(i)] $\mO=\mO'$,  in which case,  we say that $\varphi$ is \emph{horizontal}.
\item[(ii)] $\mO\supsetneq \mO'$ and $[\mO:\mO']=\ell$,  in which case,  we say that $\varphi$ is \emph{descending}. 
\item[(iii)] $\mO\subsetneq \mO'$ and $[\mO':\mO]=\ell$,  in which case,  we say that $\varphi$ is \emph{ascending}. 
\end{description}
\end{proposition}

\begin{proof}
It follows immediately by the preceding lemma.  We have $\Z+m\mO=\Z+m'\mO'$ with $m$ and $m'$ coprime non-negative integers and $mm'|\ell$.  Then,  either $m=m'=1$,  in which case $\mO=\mO'$ or $m=\ell$ and $m'=1$  in which case $\mO\supsetneq \mO'=\Z+\ell\mO$ and $[\mO:\mO']=\ell$ or $m=1$ and $m'=\ell$  in which case $\mO=\Z+\ell\mO'\subsetneq \mO'$ and $[\mO':\mO]=\ell$.
\end{proof}

\begin{remark}
$K$-oriented supersingular elliptic curves fairly behave like the ordinary ones,  especially when we look at the $\ell$-isogeny graphs.  The graphs (over $\overline{\F_q}$) are still $(\ell+1)$-regular.  Moreover,  as Kohel proved in \cite[proposition 23]{Kohel_thesis},  there are no horizontal $K$-oriented $\ell$-isogenies if $\ell|[\mO_K:\mO]$ and there are exactly $1+\(\frac{\mbox{disc}(\mO_K)}{\ell}\)$ such isogenies otherwise.

However,  the definition of $K$-oriented supersingular $\ell$-isogeny graphs differ from the ordinary $\ell$-isogeny graphs  (as the notion of isomorphism does) and more importantly,  the ideal class group action on $K$-oriented supersingular elliptic curves is no longer faithfull and transitive.
\end{remark}

\begin{example}
We introduce an example of horizontal $K$-isogeny that will be reused later.  Let $E/\F_{p^2}$ be a supersingular elliptic curve, $\phi_p$ the $p$-th power Frobenius defined on $E$ and $E^{(p)}$ its image. Suppose that $E$ admits a primitive $\mO$-orientation $\iota$.  We denote by $\iota^{(p)}$ the $K$-orientation of $E^{(p)}$ given by $\iota^{(p)}:=(\phi_p)_*(\iota)$.  Then $(E^{(p)},\iota^{(p)})$ is a primitive $\mO$-orientation.  In other words, $\phi_p$ is horizontal.

Indeed, if $\alpha\in\mO$, then there exists $\psi\in\End(E^{(p)})$ such that $\phi_p\circ\iota(\alpha)=\psi\circ\phi_p$. $\psi$ is obtained by raising the coefficients of the rational fractions defining $\iota(\alpha)$ to the power $p$. It follows that:
\[\iota^{(p)}(\alpha)=\frac{1}{p}\phi_p\iota(\alpha)\widehat{\phi_p}=\frac{1}{p}\psi\phi_p\widehat{\phi_p}=\frac{1}{p}\psi\circ[p]=\psi\]
So that $\iota^{(p)}(\alpha)\in\End(E^{(p)})$. It follows that $\mO\subseteq\(\iota^{(p)}\)^{-1}\(\End\(E^{(p)}\)\)$. Since:
\[\iota(\alpha)=\frac{1}{p}\widehat{\phi_p}\iota^{(p)}(\alpha)\phi_p\]
We obtain the converse inclusion by similar arguments.  Whence $\phi_p$ is horizontal.
\end{example}

\begin{definition}
A $K$-oriented isogeny $\varphi : (E, \iota_E)\longrightarrow(F,\iota_F)$ is an isomorphism if $\varphi$ is an isomorphism $E\longrightarrow F$ and its inverse defines a $K$-oriented isogeny $(F, \iota_F)\longrightarrow(E,\iota_E)$.
\end{definition}

\subsection{Group action and reduction}

Let $\mbox{SS}(p)$ be the set of supersingular elliptic curves defined over $\F_{p^2}$ up to isomorphism (i.e. the set of supersingular $j$-invariants). Let $\mbox{SS}_{\mO}(p)$ and $\mbox{SS}_{\mO}^{pr}(p)$ be respectively the sets $\mO$-oriented supersingular elliptic curves (respectively primitive) up to $K$-oriented isomorphism.  As in the ordinary case,  we have a group action :
\[\mbox{Cl}(\mO)\times \mbox{SS}_{\mO}^{pr}(p) \longrightarrow \mbox{SS}_{\mO}^{pr}(p)\]
We will prove later that this action is well-defined (see theorem \ref{theorem 3} in particular).  Although,  contrary to the ordinary case,  this action is not faithfully transitive as outlines the following example.

\begin{example}\label{example 1}
Let $E$ be the elliptic curve defined over $\F_p$ by the Weierstrass equation $y^2=x^3+x$ with $p\equiv 3 \ [4]$ (so that $E$ is supersingular).  Let $a\in\F_{p^2}$ such that $a^2=-1$ and the isomorphism:
\[\phi : (x,y)\in E \longmapsto (-x,ay)\in E\]
Since $\phi^2=[-1]$,  we have two primitive $\Z[i]$-orientations:
\[\begin{array}{rcl}
\iota : \Q(i) & \longrightarrow & \End^0(E)\\
i & \longmapsto & \phi
\end{array} 
\qquad \mbox{and} \qquad
 \begin{array}{rcl}
\iota' : \Q(i) & \longrightarrow & \End^0(E)\\
i & \longmapsto & -\phi
\end{array}\]
These orientations are not isomorphic.  Indeed,  otherwise we would have an automorphism $\varphi\in\mbox{Aut}(E)$ such that $\varphi_*(\iota)=\iota'$.  However:
\[\mbox{Aut}(E)=\{[1],[-1],\phi,-\phi\}\]
and we trivially have $[\pm 1]_*(\iota)=\iota$ and:
\[\forall \alpha\in \Q(i), \quad \phi_*(\iota)(\alpha)=\phi\iota(\alpha)\widehat{\phi}=\phi\iota(\alpha)(-\phi)=-\iota(i)\iota(\alpha)\iota(i)=\iota(-i^2\alpha)=\iota(\alpha)\]
so that $[\phi]_*(\iota)=\iota$.  By the same computations,  $[-\phi]_*(\iota)=\iota$.  Then $(E,\iota)\not\simeq (E,\iota')$ so there are at least two isomorphism classes of primitive $\Z[i]$-orientations.  

Although,  the ideal class group $\mbox{Cl}(\Z[i])$ is trivial so the orbits contain only one element.  Hence,  the group action of $\mbox{Cl}(\Z[i])$ on $\mbox{SS}_{\Z[i]}^{pr}(p)$ cannot be transitive.
\end{example}

We will see,  nonetheless,  that this result holds when we restrict to the good reductions of elliptic curves with complex multiplication by $\mO$ over the complex numbers. 

\subsubsection{Reductions of elliptic curves with complex multiplication by $\mO$}

Now we fix $L$ a number field containing $K$ and an elliptic curve $E/L$ such that $\End(E)\simeq \mO$. This is always possible if we take for $E$ the elliptic curve defined over the complex numbers associated to the complex torus $\C/\mO$.  Since $E$ has complex multiplication by $\mO$,  we know that $j(E)$ is integral over $\Z$ by \cite[theorem II.6.1]{Silverman2} so $E$ is defined over the number field $L$ generated by $K$ and $j(E)$.  We fix a \emph{normalized} ring isomorphism $[.]_E:\mO\longrightarrow \End(E)$,  meaning that $[\alpha]_E^*\omega=\alpha\omega$ for all $\alpha\in\mO$,  where $\omega$ is the invariant differential of $E$ (see \cite[proposition II.1.1]{Silverman2}). 

Let $p$ be a prime number ($\geq 5$) and $\mfp$ be a place above $p$.  We suppose that $E$ has good reduction modulo $\mfp$. Then, we can define a $K$-orientation $[.]_{\overline{E}}: K\longrightarrow \End^0(\overline{E})$ as follows :
\[\forall \alpha\in \mO, \quad [\alpha]_{\overline{E}}:=[\alpha]_E \ \mbox{mod} \ \mfp\]

\begin{lemma}
Let $E$ and $F$ be two elliptic curves defined over $L$ with complex multiplication by $\mO$ and good reduction modulo $\mfp$.  If $E$ and $F$ are isomorphic,  then the orientations $(\overline{E},[.]_{\overline{E}})$ and $(\overline{F},[.]_{\overline{F}})$ are $K$-isomorphic.
\end{lemma}

\begin{proof}
Let $\lambda : E\longrightarrow F$ be an isomorphism.  Since $[.]_E$ and $[.]_F$ are normalized, we have  $[\alpha]_F=\lambda\circ[\alpha]_E\circ\lambda^{-1}$ for all $\alpha\in\mO$ by \cite[corollary II.1.1.1]{Silverman2}).  Reducing this equality modulo $\mfp$, we get by functoriality of the reduction that $[.]_{\overline{F}}=\overline{\lambda}_*([.]_{\overline{E}})$ where $\overline{\lambda}$ is an isomorphism $\overline{E}\longrightarrow\overline{F}$.  This completes the proof.
\end{proof}

To understand better the reduction, we cite two classical results due to Deuring:

\begin{theorem}[Deuring, 1941]\label{theorem 1}
Let $L$ be a number field and $E$ an elliptic curve over $L$ such that $\End(E)\simeq \mO$.  Let $\mfp$ be a place above $p$. Suppose that $E$ has good reduction modulo $\mfp$.  Then $\overline{E}$ is supersingular if and only if $p$ does not split in $K$.  

Moreover,  if $c:=p^r c_0$ is the conductor of $\mO$, with $r,c_0\in\N$ such that $p\not|c_0$, then we have:
\[[.]_{\overline{E}}^{-1}(\End(\overline{E}))=\Z+c_0\mO_K\]
\end{theorem}

\begin{proof}
See \cite[chapter 13, theorem 12]{Lang_EF}.  The result given here is slightly more general than the one proved in \cite{Lang_EF} because the computation of $[.]_{\overline{E}}^{-1}(\End(\overline{E}))$ is only done in the ordinary case. However, the same ideas stand (we just consider $[K]_{\overline{E}}$ instead of $\End^0(\overline{E})$).
\end{proof}

\begin{theorem}[Deuring lifting theorem, 1941]\label{theorem 2}
Let $F$ be an elliptic curve defined over a finite field $k$ of characteristic $p$ and $\psi\in\mbox{End}(F)$. Then there exists a number field $L$, a place $\mfp$ of $\mO_L$ lying above $p$, an elliptic curve $E/L$ and an endomorphism $\varphi\in\mbox{End}(E)$ such that the reduction of $E$ modulo $\mfp$ is isomorphic to $F$ and $\varphi$ modulo $\mfp$ is $\psi$.
\end{theorem}

\begin{proof}
See \cite[chapter 13, theorem 14]{Lang_EF}.
\end{proof}

\begin{proposition}\label{proposition 2}
$\mbox{SS}_{\mO}^{pr}(p)$ is not empty if and only if $p$ does not split in $K$ and does not divide the conductor of $\mO$. 
\end{proposition}

\begin{proof}
$\Longleftarrow$ We suppose that $p$ does not split in $K$ and that $p$ does not divide the conductor of $\mO$.  Let $L$ be a number field containing $K$ and an elliptic curve $E/L$ such that $\End(E)\simeq \mO$. Then $j(E)$ is an algebraic integer by \cite[theorem II.6.1]{Silverman2} so $E$ has potential good reduction by proposition \ref{proposition 1}. Replacing $L$ by a finite field extension if necessary, we may then assume that $E$ has good reduction modulo $\mfp$.  Since $p$ does not split in $K$ and that $p$ does not divide the conductor of $\mO$, we get that the reduction of $E$ mod $\mfp$, $\overline{E}$ is supersingular and that $[.]_{\overline{E}}^{-1}(\End(\overline{E}))=\mO$, by the theorem \ref{theorem 1}. It follows that $(\overline{E}, [.]_{\overline{E}})\in\mbox{SS}_{\mO}^{pr}(p)$.

$\Longrightarrow$ Suppose that $\mbox{SS}_{\mO}^{pr}(p)\neq\emptyset$ and let $(F,\iota)\in\mbox{SS}_{\mO}^{pr}(p)$. Let $\alpha\in \mO$ be a generator of $\mO$: $\mO=\Z[\alpha]$. Then by the theorem \ref{theorem 2}, there exist a number field $L$ containing $K$ (we may take an extension of $L$ if necessary), a place $\mfp$ of $\mO_L$ lying above $p$, an elliptic curve $E/L$ and an endomorphism $\varphi\in\mbox{End}(E)$ such that $E$ has good reduction modulo $\mfp$, the reduction modulo $\mfp$,  $\overline{E}$ is isomorphic to $F$ and $\varphi \ \mbox{mod}\ \mfp= \iota(\alpha)$.  Since $\alpha$ generates $\mO$, it is not an integer and neither is $\varphi$ (because $\varphi$ is a root of the minimal polynomial of $\alpha$ since the reduction mod $\mfp$ is a ring homomorphism and $\iota$ is injective), so we have $\End^0(E)=\Q(\varphi)$ and the reduction map $\End(E)\longrightarrow\End(F)$ has its image in $\Q(\varphi \ \mbox{mod}\ \mfp)=\Q(\iota(\alpha))=\iota(\Q(\alpha))=\iota(K)$.  Since $(F,\iota)$ is a primitive $\mO$-orientation and the reduction map is injective, we have an injective ring homomorphism:
\[\End(E)\overset{\mbox{mod} \ \mfp}{\longrightarrow}\End(F)\cap\iota(K)\overset{\iota^{-1}}{\longrightarrow}\mO\]
and an injective ring homomorphism $\mO\longrightarrow\End(E)$ mapping $\alpha$ to $\varphi$. Whence $\End(E)\simeq \mO$ so by theorem \ref{theorem 1}, $p$ does not divide the conductor of $\mO$.  Moreover, $p$ does not split in $K$ because $F=\overline{E}$ is supersingular.
\end{proof}

In the following, we assume that $p$ does not split in $K$ and does not contain the conductor of $\mO$, so that $\mbox{SS}_\mO^{pr}(p)$ is not empty.  Let $\mbox{Ell}(\mO)$ the set of isomorphism classes of elliptic curves defined over $\C$ with complex multiplication by $\mO$. (i.e.  with endomorphism ring isomorphic to $ \mO$). As we saw, every class $[E]\in\mbox{Ell}(\mO)$ admits a representative $E$ defined over a number field $L_E$ containing $K$ and any place $\mfp$ lying above $p$ has potential good reduction modulo $\mfp$, so there is a finite field extension $L'/L_E$ and a place $\mf{P}$ lying above $\mfp$ such that $E$ has good reduction modulo $\mf{P}$. Let $L'_E$ be the field generated by the reunion of these extensions when $\mfp$ varies.  It is still a number field because there are finitely many places in $\mO_L$ lying above $p$ ($\mO_L$ is Dedekind).  Moreover,  $\mbox{Ell}(\mO)$ is finished (by \cite[proposition II.2.1.(b)]{Silverman2}). Then, the field $L$ generated by all the fields $L'_E$ is a number field (containing $K$) and every elliptic curve $E$ with complex multiplication by $\mO$ is defined over $L$ (up to isomorphism) and has good reduction modulo any place $\mfp$ of $L$ lying above $p$.  We will fix $L$ and $\mfp$ in the following.  Then, we have a map given by the reduction modulo $\mfp$:
\[\begin{array}{rcl} \rho : \mbox{Ell}(\mO)& \longmapsto& \mbox{SS}_\mO^{pr}(p)\\ 
E&\longmapsto&(\overline{E},[.]_{\overline{E}})
\end{array}\]
This map is actually not surjective (that is why the action described in example \ref{example 1} fails to be transitive), however we have a comforting result.

\begin{proposition}\label{proposition 6}
For all $(F,\iota)\in\mbox{SS}_\mO^{pr}(p)$, we either have $(F,\iota)\in\rho(\mbox{Ell}(\mO))$ or $(F^{(p)},\iota^{(p)})\in\rho(\mbox{Ell}(\mO))$.
\end{proposition}

\begin{proof}
Let $(F,\iota)\in\mbox{SS}_\mO^{pr}(p)$.  Then, as in the proof of the direct implication of \ref{proposition 2}, there exist a number field $L'$ containing $K$, a place $\mfp'$ of $\mO_{L'}$ lying above $p$, an elliptic curve $E/L'$ such that $E$ has good reduction modulo $\mfp'$, the reduction modulo $\mfp'$,  $\overline{E}$ is isomorphic to $F$ and $\mbox{End}(F)\simeq \mO$.  We also have obtained in the proof of \ref{proposition 2}, that $(\overline{E},[.]_{\overline{E}})$ is a primitive $\mO$-orientation satisfying $[K]_{\overline{E}}=\iota(K)$. Then the composition:
\[K\overset{[.]_{\overline{E}}}{\longrightarrow}[K]_{\overline{E}}=\iota(K)\overset{\iota^{-1}}{\longrightarrow}K\]
is a field automorphism so it is either the identity or the complex conjugation, so we either have $[\alpha]_{\overline{E}}=\iota(\alpha)$ or $[\alpha]_{\overline{E}}=\iota(\overline{\alpha})$ for all $\alpha\in K$. In the first case, $(\overline{E},[.]_{\overline{E}})$ is $K$-isomorphic to $(F,\iota)$. 

Now we assume that $[\alpha]_{\overline{E}}=\iota(\overline{\alpha})$ for all $\alpha\in K$.  Replacing $L'$ by the field extension generated by the conjugates of a generator of $L'$ if necessary, we may assume that $L'/\Q$ is Galois.  Let $G_{\mfp'}$ be the decomposition group of $\mfp'$:
\[G_{\mfp'}:=\{\sigma\in\mbox{Gal}(L',\Q)\mid \sigma(\mfp')=\mfp'\}\]
There exists $\sigma\in G_{\mfp'}$ whose restriction to $K$ is not trivial.  Indeed, otherwise by \cite[corollary I.3]{Lang_ANT}, $K$ would be contained in the subfield $L''$ fixed by $\mfp'$, which is the maximal field subextension of $L'$ in which $p$ splits completely.  But $p$ does not split in $K$ so there is only one prime ideal $\mfq$ lying above $p$ and all prime ideals of $L''$ lying above $p$ would be lying above $\mfq$ so there would be at most $[L'':K]<[L'':\Q]$ such prime ideals by \cite[chapter I, proposition 11]{Lang_ANT} and $p$ would not split completely in $L''$.  Contradiction.

Then, we may take $\sigma\in G_{\mfp'}$ such that $\sigma_{|K}$ is the complex conjugation. As in \cite[§ II.2]{Silverman2}, we define a map:
\[\begin{array}{rcl}\End(E)&\longrightarrow&\End(E^{\sigma})\\
\phi &\longmapsto &\phi^\sigma
\end{array}\]
Where $E^{\sigma}$ is obtained from $E$ by letting $\sigma$ act on the coefficients of its Weierstrass equation and $\phi^\sigma$ is given by the action of $\sigma$ on the coefficients of the rational fractions defining $\phi$. We have by \cite[theorem II.2.2.(a)]{Silverman2}, $([\overline{\alpha}]_E)^\sigma=[\sigma(\overline{\alpha})]_{E^\sigma}=[\alpha]_{E^\sigma}$ for all $\alpha\in K$.  Hence:
\[\forall\alpha\in K, \quad [\alpha]_{E^\sigma} \ \mbox{mod} \ \mfp'\equiv ([\overline{\alpha}]_E)^\sigma \ \mbox{mod} \ \mfp'\equiv \([\overline{\alpha}]_E \ \mbox{mod} \ \mfp'\)^{\overline{\sigma}}= ([\overline{\alpha}]_{\overline{E}})^{\overline{\sigma}}= (\iota(\alpha))^{\overline{\sigma}}\]
where $\overline{\sigma}\in\mbox{Gal}(\mO_{L'}/\mfp',\F_p)$ is obtained by reduction of $\sigma$ modulo $\mfp'$. Furthermore, $\overline{E^{\sigma}}=F^{\overline{\sigma}}$. By the following lemma, we can assume that $\overline{\sigma}$ is either the identity or the $p$-th power Frobenius. It follows that $[.]_{\overline{E^{\sigma}}}=\iota$ or $\iota^{(p)}$ i.e. that the reduction $(\overline{E^{\sigma}},[.]_{\overline{E^{\sigma}}})$ is either $K$-isomorphic to $(F,\iota)$ or $(F^{(p)},\iota^{(p)})$.

\begin{lemma}
Let $H$ be the subgroup of $G_{\mfp'}$ formed by elements fixing $K$. Then, the coset $\sigma H$ is formed of elements of $G_{\mfp'}$ whose restriction on $K$ is the complex conjugation. The reduction $\overline{\sigma}\overline{H}$ of $\sigma H$ mod $\mfp'$ contains either the identity or the $p$-th power Frobenius.
\end{lemma}

\begin{proof}
By \cite[propostion I.14]{Lang_ANT}, the reduction map $G_{\mfp'}\longrightarrow G:=\mbox{Gal}(\mO_{L'}/\mfp',\F_p)$ is a surjective group homorphism.  Since $G_{\mfp'}:=H\sqcup\sigma H$, we also have $G=\overline{H}\cup\overline{\sigma}\overline{H}$. If $\overline{\sigma}\in \overline{H}$, then $G=\overline{H}=\overline{\sigma}\overline{H}$ and both the identity or the $p$-th power Frobenius are in $\overline{\sigma}\overline{H}$.

Let us assume that $\overline{\sigma}\not\in \overline{H}$. Then $G=\overline{H}\sqcup\overline{\sigma}\overline{H}$ and $\overline{H}$ is a subgroup of index $2$ in $G$. Since $G$ is cyclic and generated by the $p$-th power Frobenius $\sigma_p$, $\overline{H}$ is generated by $\sigma_p^2$, so that:
\[\overline{H}=\{\sigma_p^k\mid k \ \mbox{even}\} \quad \mbox{and} \quad \overline{\sigma}\overline{H}=\{\sigma_p^k\mid k \ \mbox{odd}\}\]
Then $\overline{\sigma}\overline{H}$ contains $\sigma_p$, which completes the proof of the lemma. 
\end{proof}

In both cases ($[\alpha]_{\overline{E}}=\iota(\alpha)$ or $[\alpha]_{\overline{E}}=\iota(\overline{\alpha})$ for all $\alpha\in K$), we have obtained an elliptic curve $E$ over $L'$ with good reduction mod $\mfp'$ such that $\End(E)\simeq \mO$ and $(\overline{E},[.]_{\overline{E}})$ is $K$-isomorphic to $(F,\iota)$ or $(F^{(p)},\iota^{(p)})$. 

If $L'\subseteq L$ and $\mfp'\subseteq\mfp$, the proof is complete. We now prove that we can reduce to this case. Let $M$ be the field generated by $L'$ and the $K$-conjugates of a generator of $L$. Then $M/K$ is a Galois extension of $L/K$ and $L'/K$.  Let $\mf{P}$ and $\mf{P}'$ be prime ideals of $\mO_M$ lying above $\mfp$ and $\mfp'$ respectively. Since $p$ does not split in $K$, there is a unique prime ideal $\mfq$ of $\mO_K$ lying above $p$, so that $\mfp, \mfp', \mf{P}$ and $\mf{P}'$ lie above $\mfq$. By transitivity of the Galois group action on prime ideals \cite[proposition I.11]{Lang_ANT}, there exists $\sigma\in\mbox{Gal}(M,K)$ such that $\sigma(\mf{P}')=\mf{P}$.  Then, by \cite[theorem II.2.2.(a)]{Silverman2}, we have $([\alpha]_E)^\sigma=[\sigma(\alpha)]_{E^\sigma}=[\alpha]_{E^\sigma}$. It follows that:
\[\forall\alpha\in K, \quad [\alpha]_{E^\sigma} \ \mbox{mod} \ \mf{P}\equiv ([\alpha]_E)^\sigma \ \mbox{mod} \ \sigma(\mf{P}')\equiv \([\alpha]_E \ \mbox{mod} \ \mf{P}'\)^{\overline{\sigma}}= ([\alpha]_{\overline{E}})^{\overline{\sigma}}\]
where $\overline{\sigma} :\mO_M/\mf{P}'\longrightarrow\mO_M/\mf{P}$ is the finite field isomorphism induced by $\sigma$. Since the fields are finite, this isomorphism could be seen as a finite field automorphism fixing $\mO_K/\mfq$, i.e. as a power of the Frobenius $p^{N(\mfq)}$-th power. Moreover, we have for all $\tau\in G_{\mf{P}}$, $\tau\sigma(\mf{P}')=\tau(\mf{P})=\mf{P}$ and the reduction map $G_{\mf{P}}\longrightarrow\mbox{Gal}(\mO_M/\mf{P},\mO_K/\mfq)$ is surjective so we may assume that $\overline{\sigma}$ is the identity.  Hence, 
we get that the reduction of $(E^{\sigma},[.]_{E^\sigma})$ modulo $\mf{P}$ is $(\overline{E},[.]_{\overline{E}})$. Since $\End(E^{\sigma})\simeq\End(E)\simeq \mO$ by \cite[proposition II.2.1]{Silverman2}, we have $[E^\sigma]\in\mbox{Ell}(\mO)$ so there exists an elliptic curve $E'$ defined over $L$ with good reduction modulo $\mfp$ isomorphic to $E^\sigma$.  As $\mf{P}$ lies above $\mfp$, this completes the proof.
\end{proof}

\subsubsection{A good ideal class group action}

We shall now define a group action of $\mbox{Cl}(\mO)$ on $\rho(\mbox{Ell}(\mO))$, as announced previously and prove that it is faithful and transitive. Let $\mf{a}$ be a non-zero ideal of $\mO$. According to \cite[corollary 7.17]{Cox}, we can assume that $N(\mf{a})$ is prime to $p$ without changing the class $[\mf{a}]\in\mbox{Cl}(\mO)$. We will always work under this assumption in the following. We define the $\mf{a}$-torison of $E$ by:
\[E[\mf{a}]=\bigcap_{\alpha\in\mf{a}}\ker(\iota(\alpha))\]
$E[\mf{a}]$ is finite, so \cite[proposition III.4.12]{Silverman1} ensures that there exists an elliptic curve $E'$ and a separable isogeny $\varphi:E\longrightarrow E'$ such that $\ker(\varphi)=E[\mf{a}]$. $(E',\varphi)$ is unique up to isomorphism. Indeed, if $\varphi':E\longrightarrow E''$ has the kernel, then there exists an isomorphism $\lambda : E'\longrightarrow E''$ such that $\varphi'=\lambda\circ\varphi$. Then, we have $\varphi'_*(\iota)=\lambda_*(\varphi_*(\iota))$ and $\lambda$ being an endomorphism, $(E',\varphi_*(\iota))$ is $K$-isomorphic to $(E'',\varphi'_*(\iota))$. Then, $(E',\varphi_*(\iota))$ is uniquely determined by $\mf{a}$ up to $K$-isomorphism. In the following, for a given ideal $\mf{a}$ of $\mO$ we shall refer to  $E'$, $\varphi$ and $(E',\varphi_*(\iota))$ as $E/E[\mf{a}]$, $\varphi_{\mf{a}}$ and $\mf{a}\cdot(E,\iota)$ respectively.

\begin{proposition}\label{proposition 3}
Let $(E,\iota)$ be a primitively $\mO$-oriented elliptic curve and $\mf{a}$ an ideal of $\mO$ of norm prime to $p$. 
\begin{description}
\item[(i)] Let $(E',\iota'):=\mf{a}\cdot (E,\iota)$,  $\mO':=\iota'^{-1}(\End(E'))$ and $\mf{b}$ an ideal of $\mO'$ of norm prime to $p$.  We suppose that $\mO'\subseteq\mO$. Then $\ker(\varphi_{\mf{b}}\circ\varphi_{\mf{a}})=E[\mf{b}\mf{a}]$.
\item[(ii)] $\deg(\varphi_{\mf{a}})=N(\mf{a})$.
\item[(iii)] $\varphi_{\mf{a}}$ is either horizontal or ascending ($\mO\subseteq\mO'$).
\item[(iv)] If $\mf{a}$ is invertible, then $\varphi_{\mf{a}}$ is horizontal. In addition, we have $\ker(\widehat{\varphi_{\mf{a}}})=E'[\overline{\mf{a}}]$.
\end{description}
\end{proposition}

\begin{proof}
\textbf{(i)} This is a difficult result beyond the scope of this thesis that becomes natural with the framework of abelian varieties. The classical reference for this fact is Waterhouse's thesis \cite[proposition 3.12]{Waterhouse1969} but I found the proof of Milne given in his lecture notes on complex multiplication \cite[proposition 7.28]{Milne_CM} easier to follow.

\textbf{(ii)} See \cite[theorem 3.15]{Waterhouse1969} or \cite[proposition 7.29]{Milne_CM}.

\textbf{(iii)} We may assume that $E[\mf{a}]$ is cyclic. Indeed, we suppose that this is not the case. Then, the theorem of finite abelian group structure and the Chinese remainder theorem ensure that:
\[E[\mf{a}]\simeq\prod_{i=1}^r (\Z/p_i^{a_i}\Z)^{b_i}\]
with $r\in\N^*$, $p_1, \cdots, p_r$ distinct prime numbers and $a_1, \cdots, a_r, b_1, \cdots, b_r\in\N$ with an index $i_0\in\i{1}{r}$ such that $b_{i_0}\geq 2$ (otherwise, $E[\mf{a}]$ would be cyclic by the Chinese remainder theorem). It follows that $E[p_i^{a_i}]\simeq(\Z/p_i^{a_i}\Z)^2\subseteq E[\mf{a}]\subseteq\ker(\iota(\alpha))$ for all $\alpha\in\mf{a}$. Since $E[p_i^{a_i}]\simeq(\Z/p_i^{a_i}\Z)^2$ here, $[p^{a_i}]=\iota(p_i^{a_i})$ is separable and for all $\alpha\in\mf{a}$, we have a factorization $\iota(\alpha)=\lambda_\alpha\circ \iota(p_i^{a_i})$ with $\lambda_\alpha=\iota(\alpha/p_i^{a_i})\in\End(E)$ by \cite[corollary III.4.11]{Silverman1}. Hence, $\mf{a}$ is divisible by $p_i^{a_i}$and furthermore $E[p_i^{a_i}]\subseteq \ker(\varphi_{\mf{a}})$ so $\varphi_{\mf{a}}$ factors through $[p_i^{a_i}]=\iota(p_i^{a_i})$ which is horizontal, so we may replace it by $\mf{a}/p_i^{a_i}$. Applying this process iteratively, we get that $E[\mf{a}]$ is cyclic. 

Let $n:=\deg(\varphi_{\mf{a}})=N(\mf{a})$. Then $E[\mf{a}]\subseteq E[n]$. Since $\varphi_{\mf{a}}$ is separable by construction, $|E[\mf{a}]|=n$ so that $E[\mf{a}]\simeq\Z/n\Z$ and $p$ does not divide $n$ so that $E[n]\simeq (\Z/n\Z)^2$.  Hence there exists a $\Z/n\Z$-basis $(P,Q)$ of $E[n]$ such that $P$ generates $E[\mf{a}]$, according to the following lemma.

\begin{lemma}
Let $(G,+)$ be an abelian group isomorphic to $(\Z/n\Z)^2$ and $g\in G$ of order $n$. Then, there exists $h\in G$ such that $(g,h)$ generate $G$.
\end{lemma}

\begin{proof}
Let $(g',h')$ be a $\Z/n\Z$-basis of $G$ (it does exist because $G$ is a free $\Z/n\Z$-module of rank $2$). Then there exists $k,l\in\N$ such that $kg'+lh'=g$. Since $g$ is of order $n$, $\gcd(n,k,l)=1$ so there exists $u,v,w\in\Z$ such that $un+vk+wl=1$. Let $h:=-wg'+vh'$. We prove that $(g,h)$ generates $G$ i.e. that $(\lambda,\mu)\in(\Z/n\Z)^2\longmapsto \lambda g+\mu h\in G$ is surjective. By cardinality, it suffices to show that this group homomorphism is injective. Let $(\lambda,\mu)\in(\Z/n\Z)^2$ such that $\lambda g+\mu h=0$. Then $(\lambda k-w\mu)g'+(\lambda l+\mu w)h'=0$ so that $\lambda k-w\mu\equiv 0 \ [n]$ and $\lambda l+\mu w\equiv 0 \ [n]$ because $(g',h')$ be a $\Z/n\Z$-basis.  Then $0\equiv v(\lambda k-w\mu)+w(\lambda l+\mu w)\equiv \lambda \ [n]$ and $0\equiv l(\lambda k-w\mu)-k(\lambda l+\mu w)\equiv \mu \ [n]$, which completes the proof.
\end{proof}

Let $P'\in E$ such that $P=nP'$ (it does exist because $[n]$ is surjective as any non-zero isogeny). Then, $[n]\circ\varphi_{\mf{a}}(P')=\varphi_{\mf{a}}([n]P')=\varphi_{\mf{a}}(P)=O$ and $[n]\circ\varphi_{\mf{a}}(Q)=\varphi_{\mf{a}}([n]Q)=O$ so that $\varphi_{\mf{a}}(P'),\varphi_{\mf{a}}(Q)\in E'[n]$. Furthermore, by \cite[proposition III.8.2]{Silverman1}:
\[e_n(\varphi_{\mf{a}}(P'),\varphi_{\mf{a}}(Q))=e_n(\widehat{\varphi_{\mf{a}}}\varphi_{\mf{a}}(P'),Q)=e_n([n]P',Q)=e_n(P,Q)\]
so $(\varphi_{\mf{a}}(P'),\varphi_{\mf{a}}(Q))$ generates $E'[n]$ by the following lemma.

\begin{lemma}
Let $(R,S)\in E[n]^2$. Then, $(R,S)$ generates $E[n]$ if and only if $e_n(R,S)$ is a primitive $n$-th root of unity.
\end{lemma}

\begin{proof}
$\Longrightarrow$ Suppose that $(R,S)$ generates $E[n]$. Let $d\in\Z$ such that $e_n(R,S)^d=1$. Then for all $a, b\in \Z$, we have:
\[e_n([a]R+[b]S,[d]S)=e_n(R,S)^{ad}=1\]
so that $e_n(T,[d]S)=1$ for all $T\in E[n]$. Since $e_n$ is non-degenerate, $[d]S=O$ and $n|d$. 

$\Longleftarrow$ Suppose that $e_n(R,S)$ is a primitive $n$-th root of unity. Let $a, b\in \Z$ such that $[a]R+[b]S=O$. Then:
\[1=e_n([a]R+[b]S,S)=e_n(R,S)^a \quad \mbox{and} \quad 1=e_n(R,[a]R+[b]S)=e_n(R,S)^b\]
so that $n|a$ and $n|b$. Hence $(R,S)$ generates $E[n]$.
\end{proof}

We have for all $\alpha\in \mf{a}$ and $\beta\in\mO$:
\[\iota(\alpha)\circ\iota(\beta)\circ\widehat{\varphi_{\mf{a}}}\circ\varphi_{\mf{a}}(P')=\iota(\alpha\beta)([n]P')=\iota(\beta)\circ\iota(\alpha)(P)=O\]
so that $\iota(\beta)\circ\widehat{\varphi_{\mf{a}}}\circ\varphi_{\mf{a}}(P')\in\bigcap_{\alpha\in\mf{a}}\ker(\iota(\alpha))=E[\mf{a}]$ and we have for all $\beta\in\mO$:
\[\varphi_{\mf{a}}\circ\iota(\beta)\circ\widehat{\varphi_{\mf{a}}}\circ\varphi_{\mf{a}}(P')=O\]
We also trivially have for all $\beta\in\mO$:
\[\varphi_{\mf{a}}\circ\iota(\beta)\circ\widehat{\varphi_{\mf{a}}}\circ\varphi_{\mf{a}}(Q)=\varphi_{\mf{a}}\circ\iota(\beta)([n]Q)=\varphi_{\mf{a}}\circ\iota(\beta)(O)=O\]
Then $E'[n]\subseteq \ker(\varphi_{\mf{a}}\circ\iota(\beta)\circ\widehat{\varphi_{\mf{a}}})$ since $(\varphi_{\mf{a}}(P'),\varphi_{\mf{a}}(Q))$ generates $E'[n]$.  By \cite[corollary III.4.11]{Silverman1}, it follows that $n$ divides $\varphi_{\mf{a}}\circ\iota(\beta)\circ\widehat{\varphi_{\mf{a}}}$, so that $\iota'(\beta)={\varphi_{\mf{a}}}_*(\iota)(\beta)\in\End(E')$ for all $\beta\in\mO$. Hence $\mO\subseteq\iota'^{-1}(\End(E'))=\mO'$ and $\varphi_{\mf{a}}$ is horizontal or ascending.

\textbf{(iv)} First, we prove that $\ker(\widehat{\varphi_{\mf{a}}})=E'[\overline{\mf{a}}\mO']$. Since $\mf{a}$ is invertible \cite[lemma 7.14.(iii)]{Cox} ensures that $\mf{a}\overline{\mf{a}}=N(\mf{a})\mO=n\mO$ i.e. that $\overline{\mf{a}}=n\mf{a}^{-1}$. 

We keep the notations of $(iii)$ and the point $Q$ in particular. Since $Q\in E[n]$, we have $\varphi_{\mf{a}}(Q)\in\ker(\widehat{\varphi_{\mf{a}}})$. But $(\varphi_{\mf{a}}(P'),\varphi_{\mf{a}}(Q))$ generate $E[n]$ so $\varphi_{\mf{a}}(Q)$ is of order $n=\deg(\widehat{\varphi_{\mf{a}}})$ so $\varphi_{\mf{a}}(Q)$ generates $\ker(\widehat{\varphi_{\mf{a}}})$.  For all $\alpha\in\mf{a}$ and $\beta\in\mf{a}^{-1}$, we have:
\[\iota(\alpha)\circ\iota(n\beta)(Q)=\iota(\alpha \beta)([n]Q)=O\]
Hence $\iota(n\beta)(Q)\in\bigcap_{\alpha\in\mf{a}}\ker(\iota(\alpha))=E[\mf{a}]$ so that for all $\beta\in\mf{a}^{-1}$:
\[O=\varphi_{\mf{a}}(\iota(n\beta)(Q))=\iota'(n\beta)\varphi_{\mf{a}}(Q)\]
And $\varphi_{\mf{a}}(Q)\in E'[n\mf{a}^{-1}\mO']=E'[\overline{\mf{a}}\mO']$. It follows that $\ker(\widehat{\varphi_{\mf{a}}})\subseteq E'[\overline{\mf{a}}\mO']$. 


Conversely, let $R\in E'[\overline{\mf{a}}\mO']$. Since $\varphi_{\mf{a}}$ is not constant, it is surjective and there exists $S\in E$ such that $R=\varphi_{\mf{a}}(S)$. For all $\beta\in\mf{a}^{-1}$, we have:
\[\varphi_{\mf{a}}(\iota(n\beta)(S))=\iota'(n\beta)(\varphi_{\mf{a}}(S))=\iota'(n\beta)(R)=O\]
so that $\iota(\alpha)\circ \iota(n\beta)(S)=O$ for all $\alpha\in \mf{a}$. Since $\mf{a}\mf{a}^{-1}=\mO$, there exists $\alpha_1, \cdots, \alpha_r\in\mf{a}$ and $\beta_1, \cdots, \beta_r\in\mf{a}^{-1}$ such that $\sum_{i=1}^r \alpha_i\beta_i=1$ and we have:
\[[n]S=\iota\(\sum_{i=1}^r \alpha_i n\beta_i\)(S)=\sum_{i=1}^r\iota(\alpha_i)\iota(n\beta_i)(S)=O\]
Hence $O=[n]S=\widehat{\varphi_{\mf{a}}}(\varphi_{\mf{a}}(S))=\widehat{\varphi_{\mf{a}}}(R)$ and $R\in\ker(\widehat{\varphi_{\mf{a}}})$. 

We conclude that $\ker(\widehat{\varphi_{\mf{a}}})=E'[\overline{\mf{a}}\mO']$, so that $\widehat{\varphi_{\mf{a}}}$ is the isogeny $\varphi_{\overline{\mf{a}}\mO'}$ associated to the ideal $\overline{\mf{a}}\mO'$. Applying (iii) in the other direction, we get that $\mO'\subseteq\mO$ i.e. that $\varphi_{\mf{a}}$ is horizontal.
\end{proof}

The preceding proposition was our first step towards the proof of the desired theorem:

\begin{theorem}\label{theorem 3}
$\mbox{Cl}(\mO)$ acts faithfully and transitively on $\rho(\mbox{Ell}(\mO))$ via: $(\mf{a},(E,\iota))\longmapsto \mf{a}\cdot (E,\iota)$.
\end{theorem}

\begin{proof}
First of all, we prove that the map $(\mf{a},(E,\iota))\longmapsto \mf{a}\cdot (E,\iota)$ defines a group action of $\mbox{Cl}(\mO)$ on $\rho(\mbox{Ell}(\mO))$. 

Let $(F,\iota)\in \rho(\mbox{Ell}(\mO))$ and let $E\in\mbox{Ell}(\mO)$ such that $\rho(E)=(F,\iota)$ i.e. such that $(\overline{E},[.]_{\overline{E}})\simeq (F,\iota)$.  Let $\mf{a}$ be an invertible ideal of $\mO$ of norm prime to $p$. It is a general fact that the kernel of the reduction modulo $\mfp$ of an isogeny is the reduction modulo $\mfp$ of its kernel. It follows that the reduction modulo $\mfp$ of $E[\mf{a}]:=\bigcap_{\alpha\in\mf{a}}\ker([\alpha]_E)$ is:
\[\overline{E[\mf{a}]}=\bigcap_{\alpha\in\mf{a}}\overline{\ker([\alpha]_E)}=\bigcap_{\alpha\in\mf{a}}\ker(\overline{[\alpha]_E})=\bigcap_{\alpha\in\mf{a}}\ker([\alpha]_{\overline{E}})=\overline{E}[\mf{a}]=F[\mf{a}]\]
By \cite[proposition III.4.12]{Silverman1}, there exists an isogeny $\phi : E\longrightarrow E'$ such that $\ker(\phi)=E[\mf{a}]$. By the theory of complex multiplication over the complex numbers,  we have $E'\in\mbox{Ell}(\mO)$ (see \cite[proposition II.2.1.(a).(ii)]{Silverman2} which is still valid for any order $\mO$ and not only for $\mO_K$). Then, we can assume that $E'$ is defined over $L$ and has good reduction modulo $\mfp$. The reduction of $\phi$ modulo $\mfp$, $\overline{\phi}:\overline{E}\longrightarrow\overline{E'}$ has kernel $\overline{E[\mf{a}]}=F[\mf{a}]$ so $\overline{E'}$ is isomorphic to $F/F[\mf{a}]$ and $\overline{\phi}=\varphi_{\mf{a}}$. Furthermore, we have for all $\alpha\in K$, $\phi[\alpha]_E=[\alpha]_{E'}\phi$ by \cite[corollary II.1.1.1]{Silverman2}. The reduction modulo $\mfp$ of this formula ensures that ${\varphi_{\mf{a}}}_*(\iota)=\overline{\phi}_*([.]_{\overline{E}})=[.]_{\overline{E'}}$. Whence: 
\[\mf{a}\cdot(F,\iota)=(F/F[\mf{a}],{\varphi_{\mf{a}}}_*(\iota))=(\overline{E'},[.]_{\overline{E'}})=\rho(E')\]
We have proved that we have a well defined map $(\mf{a},(E,\iota))\in\mathcal{I}_p(\mO)\times\rho(\mbox{Ell}(\mO))\longmapsto \mf{a}\cdot (E,\iota)\in\rho(\mbox{Ell}(\mO))$, where $\mathcal{I}_p(\mO)$ is the set of invertible ideals of $\mO$ of norm prime to $p$. Since any class of $\mbox{Cl}(\mO)$ admits a representative in $\mathcal{I}_p(\mO)$, it remains to prove that principal ideals fix $\rho(\mbox{Ell}(\mO))$. 

Let $\alpha\in\mO$ and $(E,\iota)\in\rho(\mbox{Ell}(\mO))$. Then $E[\alpha\mO]=\ker(\iota(\alpha))$, so $E/E[\alpha\mO]\simeq E$ because $\iota(\alpha)\in\End(E)$. Furthermore:
\[\forall\beta\in K, \quad \iota(\alpha)_*(\iota)(\beta)=\frac{1}{\deg(\iota(\alpha))}\iota(\alpha)\iota(\beta)\widehat{\iota(\alpha)}=\frac{1}{N_{K/\Q}(\alpha)}\iota(\alpha)\iota(\beta)\iota(\overline{\alpha})=\frac{1}{N_{K/\Q}(\alpha)}\iota(\alpha\overline{\alpha}\beta)=\iota(\beta)\]
so that $\alpha\mO\cdot (E,\iota)\simeq (E,\iota)$. Hence the map reduces to $\mbox{Cl}(\mO)$.

Let $\mf{a}, \mf{b}$ be invertible ideals of $\mO$ of norm prime to $p$ and $(E,\iota)\in \rho(\mbox{Ell}(\mO))$.  Then we have $\ker(\varphi_{\mf{b}}\circ\varphi_{\mf{a}})=E[\mf{b}\mf{a}]$ by point (i) of proposition \ref{proposition 3}, so that $\varphi_{\mf{b}}\circ\varphi_{\mf{a}}=\varphi_{\mf{b}\mf{a}}$ and ${\varphi_{\mf{b}}}_*({\varphi_ {\mf{a}}}_*(\iota))=(\varphi_{\mf{b}}\circ\varphi_{\mf{a}})_*(\iota)$. It follows that:
\[\mf{b}\cdot(\mf{a}\cdot (E, \iota))=(\mf{b}\mf{a})\cdot (E,\iota)\]
Hence, $(\mf{a},(E,\iota))\in\mbox{Cl}(\mO)\times\rho(\mbox{Ell}(\mO))\longmapsto \mf{a}\cdot (E,\iota)\in\rho(\mbox{Ell}(\mO))$ is a group action.

We now prove that it is faithful. Let $\mf{a}$ be an invertible ideal of $\mO$ of norm prime to $p$ and $(E,\iota)\in\rho(\mbox{Ell}(\mO))$ such that $\mf{a}\cdot(E,\iota)=(E,\iota)$. Then $\varphi_{\mf{a}}\in\End(E)$ and ${\varphi_{\mf{a}}}_*(\iota)=\iota$. It follows that: 
\[\forall \alpha\in K, \quad \varphi_{\mf{a}}\circ\iota(\alpha)=\iota(\alpha)\circ\varphi_{\mf{a}} \quad (\star)\]
We claim that $\varphi_{\mf{a}}\in\iota(K)\cap\End(E)=\iota(\mO)$. Let us suppose the contrary by contradiction. Let $K'$ be the field generated by $\iota(K)$ and $\varphi_{\mf{a}}$. Then $K\subsetneq K'$ and $[K':\Q]=[K':K][K:\Q]\geq 4$ so $K'=\End^0(E)$ since $\End^0(E)$ has dimension at most $4$ by \cite[corollary III.7.5]{Silverman1}. Then, $K'$ is a quaternion algebra by \cite[theorem V.3.1]{Silverman1} so is non-commutative, contradicting $(\star)$. Hence, there exists $\alpha\in\mO$ such that $\varphi_{\mf{a}}=\iota(\alpha)$. It follows that $\ker(\iota(\alpha))=E[\mf{a}]=\bigcap_{\beta\in\mf{a}}\ker(\iota(\beta))$ and consequently, that all $\iota(\beta)$ for $\beta\in\mf{a}$ factor through $\iota(\alpha)$ i.e. that $\beta/\alpha\in\mO$. Hence $\mf{a}\subseteq \alpha\mO$. Furthermore, point (ii) of proposition \ref{proposition 3} and \cite[lemma 7.14.(i)]{Cox} ensure that:
\[N(\mf{a})=\deg(\varphi_{\mf{a}})=\deg(\iota(\alpha))=N(\alpha)=N(\alpha\mO)\]
so that $\mf{a}= \alpha\mO$, which achieves the proof of the faithfulness.

Finally, we obtain the transitiveness by a cardinality argument: by faithfulness, every orbit has cardinality $|\mbox{Cl}(\mO)|$ but we know by \cite[proposition II.1.2.(b)]{Silverman2} that $|\mbox{Cl}(\mO)|=|\mbox{Ell}(\mO)|\geq |\rho(\mbox{Ell}(\mO))|$. 
\end{proof}

\begin{remark}\label{remark 1}
By the last cardinality argument, we also obtain that the reduction map $\rho$ is injective.
\end{remark}

\section{Oriented supersingular isogeny graphs}

\subsection{Volcano structure of oriented supersingular isogeny graphs} 

We fix a quadratic imaginary number field $K$, and a prime number such that $p$ does not split in $K$.  We want to study isogeny graphs of $K$-oriented supersingular elliptic curves. To be able to use the ideal class group action, we restrict to the good reductions of elliptic curves with complex multiplication by an order of $K$ modulo a prime ideal lying over $p$ in a field of definition of these curves.  We already defined these reduction maps when the order $\mO$ is fixed. The definition of these reductions can be made coherent when the order of $K$ varies. More precisely, we can construct a sequence $(L_f,\mf{p}_f)_{f\in\N^*}$, where for all $f\in\N^*$, $L_f$ is a number field containing $K$ and $\mf{p}_f$ a prime ideal of $\mO_{L_f}$ lying above $p$ such that all elliptic curves isomorphism classes defined over $\C$ with complex multiplication by $\mO_f:=\Z+f\mO_K$ have a representative defined over $L_f$ with good reduction modulo $\mf{p}_f$ and such that $L_f\subseteq L_{f'}$ and $\mf{p}_f\subseteq \mf{p}_{f'}$ every time $f|f'$.  We can associate to this sequence a sequence of reduction maps $(\rho_f : \mbox{Ell}(\mO_f)\longrightarrow\mbox{SS}_{\mO_f}^{pr}(p))_{p\nmid f}$, with the restriction of the set of indices that $p$ should not divide the conductor $f=[\mO_K:\mO_f]$ (see proposition \ref{proposition 2}).  Without ambiguity, we will denote $\rho$ instead of $\rho_f$. 

In the following, we fix a prime number $\ell\neq p$.

\begin{definition}
We define the $K$-oriented $\ell$-isogeny graph $G_\ell(K,p)$ as follows: the vertices are in the $K$-isomorphism classes in the image of $\rho$ and the edges are $K$-oriented isogenies of degree $\ell$.  
\end{definition}

Considering dual isogenies, we see that this graph is undirected. Note that two vertices of this graph may have the same $j$-invatiant but not the same $K$-orientation up to $K$-isomorphism, that is why they are distinct in $G_\ell(K,p)$ (see example \ref{example 1}). Since $\ell\neq p$, all $\ell$-isogenies coming from a vertex $(E,\iota)$ of $G_\ell(K,p)$  are separable and determined by their kernel (by \cite[corollary III.4.11]{Silverman1}) which is a cyclic subgroup of order $\ell$ in $E[\ell]$. Considering the action of $(\Z/\ell\Z)^*$ on the set of non-zero elements of $E[\ell]\simeq(\Z/\ell\Z)^2$ by scalar multiplication, whose orbits are exactly the cyclic subgroups of order $\ell$ in $E[\ell]$ (deprived from the neutral element), we obtain that there are:
\[\frac{\ell^2-1}{\ell-1}=\ell+1\]
such subgroups. If $\varphi:(E,\iota)\longrightarrow (E',\iota')$ is such an isogeny, one can lift $E$, $E'$ and $\varphi$ by lifting the kernel as we did in the proof of theorem \ref{theorem 3}.  It follows that $(E',\iota')$ is in the image of $\rho$, so that $(E',\iota')\in G_\ell(K,p)$. Hence, $G_\ell(K,p)$ is stable by $\ell$-isogenies and $(\ell+1)$-regular.  Furthermore, $\rho$ being injective by remark \ref{remark 1}, we obtain that $G_\ell(K,p)$ is isomorphic to the ordinary $\ell$-isogeny graph $G_\ell(K)$ whose vertices are the isomorphism classes of elliptic curves with complex multiplication by an order of $K$ and edges are $\ell$-isogenies. It follows that every connected component of $G_\ell(K,p)$ is an isogeny volcano, as Kohel proved \cite[proposition 23]{Kohel_thesis}. We recall the result and its proof here.

\begin{proposition}\label{proposition 5}
Let $(E,\iota)$ be a supersingular primitively $\mO$-oriented elliptic curve and $\Delta_K:=\mbox{disc}(K)$. Then :
\begin{description}
\item[(i)] If $\ell\nmid [\mO_K:\mO]$, then there are $1+\(\frac{\Delta_K}{\ell}\)$ horizontal, $\ell-\(\frac{\Delta_K}{\ell}\)$ descending and no ascending $\ell$-isogenies, where $\(\frac{.}{\ell}\)$ is the Kronecker symbol, given by:
\[\(\frac{a}{\ell}\)=\left\{\begin{array}{cl}
0 & \mbox{if } a\equiv 0 \ \mbox{mod} \ \ell \\
1 & \mbox{if } a \ \mbox{mod} \ \ell \mbox{ is a square in } \F_\ell^*\\
-1 & \mbox{otherwise}\\
\end{array}\right. \quad \mbox{if } \ell\neq 2 \quad \left\{\begin{array}{cl}
0 & \mbox{if } a\equiv 0 \ \mbox{mod} \ 4 \\
1 & \mbox{if } a\equiv 1 \ \mbox{mod} \ 8\\
-1 & \mbox{otherwise}\\
\end{array}\right.\quad \mbox{if } \ell=2\]
for all $a\in\Z$.
\item[(ii)] If $\ell|[\mO_K:\mO]$, then there are no horizontal, $\ell$ descending and one ascending $\ell$-isogenies.
\item[(iii)] Every codomain of a descending $\ell$-isogeny with domain $(E,\iota)$ has $[\mO^\times:(\Z+\ell\mO)^\times]$ $\ell$-isogenies coming from $(E,\iota)$. 
\end{description}
\end{proposition}

\begin{proof}
\textbf{(i)} and \textbf{(ii)} By the discussion above, we can work over $\C$ to prove this classical result. The proof follows from \cite[theorem 23.5]{MIT}, as it is more elementary than the proof from Kohel. 

We first assume that $E$ is the complex torus $\C/\Lambda$ with $\Lambda$ homothetic to $\mO$. To simplify, we set $\Lambda:=\ell\mO$. Let $\varphi: E\longrightarrow E'$ be an $\ell$-isogeny.  Let $\Lambda'$ be the lattice associated to $E'$. Then, up to homotety we can assume that $\Lambda\subseteq \Lambda'$ and that $\varphi$ is induced by this inclusion. Then, $\Lambda=\ell\mO$ has index $\ell$ in $\Lambda'$, so that $\ell\Lambda'\subseteq\Lambda=\ell\mO$ i.e. $\Lambda'\subseteq\mO$ and we have : 
\[[\mO:\Lambda']=\frac{[\mO:\Lambda']}{[\Lambda':\Lambda]}=\frac{\ell^2}{\ell}=\ell\]
Let $\tau\in\overline{\Q}$ be a generator of $\mO$. Then $\mO$ is the lattice $[1,\tau]$ and $\Lambda'$ is one of the sublattices of index $\ell$, $\Lambda_i:=[\ell,\tau+i]$ for $i\in\i{0}{\ell-1}$ or $\Lambda_\ell:=[1,\ell\tau]$ according to the following lemma.

\begin{lemma}
A sublattice of index $\ell$ of $[1,\tau]$ is of the form $[\ell,\tau+i]$ for $i\in\i{0}{\ell-1}$ or $[1,\ell\tau]$.
\end{lemma}

\begin{proof}
Let us denote $L:=[1,\tau]$ and let $L'\subseteq L$ be a sublattice of index $\ell$. Then $L'$ has rank $2$ and we have $L':=[a+b\tau,c+d\tau]$ with $a,b,c,d\in\Z$.  Let $\delta:=\gcd(a,c)$ and $\delta':=\gcd(b,d)$. Since $L'$ has index $\ell$, we have $\ell,\ell\tau\in L'$, so $\delta|\ell$ and $\delta'|\ell$. However, both cannot equal $\ell$, otherwise we would have $L'\subseteq\ell L$ whose index is $\ell^2$, so either $\delta$ or $\delta'$ equals $1$.  

Suppose $\delta'=\ell$.  Then, $\delta=1$ so there exists $u, v\in\Z$ such that $ua+vc=1$, so that $1+(ub+vd)\tau=u(a+b\tau)+v(c+d\tau)\in L'$ and $\ell|ub+vd$ so $1\in L'$ because $\ell\tau\in L'$. Hence, $[1,\ell\tau]\subseteq L'$ and this inclusion is an equality because $[1,\ell\tau]$ has index $\ell$ in $L$. 

Suppose $\delta'=1$.  Then, there exists $u, v\in\Z$ such that $ub+vd=1$, and $(ua+vc)+\tau=u(a+b\tau)+v(c+d\tau)\in L'$. Adding or subtracting $\ell$ as many times as necessary, we obtain that $\tau+i\in L'$ with $i\in\i{0}{\ell-1}$, so $[\ell,\tau+i]\subseteq L'$ and this inclusion is an equality because $[\ell,\tau+i]$ has index $\ell$ in $L$. 
\end{proof}

Let $\mO':=\End(E)$. By the theory of complex multiplication, we have:
\[\mO'=\{\alpha\in\C\mid \alpha \Lambda'\subseteq\Lambda'\}\]
Hence $\mO'=\mO$ if and only if $\Lambda'$ is a proper ideal of $\mO$ of norm $\ell$.  If $\ell\nmid [\mO_K:\mO]$, there are $1+\(\frac{\Delta_K}{\ell}\)$ such ideals, corresponding to horizontal isogenies and otherwise there is no such ideal (hence no horizontal isogeny), by the following lemma. 

\begin{lemma}\label{lemma 1}
If $\ell\nmid [\mO_K:\mO]$, there are $1+\(\frac{\Delta_K}{\ell}\)$ proper ideals of norm $\ell$ in $\mO$. Otherwise,  all ideals of norm $\ell$ are not proper.
\end{lemma}

\begin{proof}
Let $\mf{l}$ be an ideal of norm $\ell$.  Then $\mf{l}$ is proper by, \cite[lemma 7.18.(ii)]{Cox} if and only if $\ell\nmid [\mO_K:\mO]$.  Furthermore, $\mf{l}\overline{\mf{l}}=\ell\mO$ by \cite[lemma 7.14.(iii)]{Cox}, so that $\ell\in\mf{l}$ and $\mf{l}\mO_K\overline{\mf{l}}\mO_K=\ell\mO_K$ and $N(\mf{l}\mO_K)N(\overline{\mf{l}}\mO_K)=N(\ell\mO_K)=\ell^2$ by \cite[lemma 7.14.(ii)]{Cox}. Hence $N(\mf{l}\mO_K)=\ell$ because the norm of an ideal is invariant under complex conjugation.  Moreover, $\mf{l}\mO_K\cap\mO\supseteq \mf{l}$ and we have an equality because the injection $\mO/\mf{l}\mO_K\cap\mO\hookrightarrow \mO_K/\mf{l}\mO_K$ ensures that $N(\mf{l}\mO_K\cap \mO)|N(\mf{l}\mO_K)=\ell$. Hence, the maps $\mf{l}\longmapsto\mf{l}\mO_K$ and $\mf{\ell'}\longmapsto\mf{\ell'}\cap\mO$ are reciprocal bijections between the sets of ideals of norm $\ell$ in $\mO$ and $\mO_K$.

Hence, we can assume that $\mO=\mO_K$. Let $\alpha\in\C$ such that $\mO_K=\Z[\alpha]$ and let $\Pi:=X^2-tX+n\in\Z[X]$ the minimal polynomial of $\alpha$. Then, by \cite[proposition I.25]{Lang_ANT} the ideals containing $\ell$ are of the form $\mf{l}_Q:=\ell\mO_K+Q(\alpha)\mO_K$ where $Q\in\Z[X]$ is such that the reduction of $Q$ modulo $\ell$ is a factor of $\Pi$ in $\F_\ell[X]$.  $\mf{l}_Q$ has norm $\ell$ if and only if $Q$ is a factor of degree $1$. 

If $\ell\neq 2$, such a factor exists if and only if $\Delta_K=t^2-4n$ is a square in $\F_\ell$. Hence, there are no ideal of norm $\ell$ if $\(\frac{\Delta_K}{\ell}\)=-1$, $1$ such ideal if $\(\frac{\Delta_K}{\ell}\)=0$ i.e. $\Delta_K\equiv 0 \ [\ell]$ and $2$ such ideals if $\(\frac{\Delta_K}{\ell}\)=1$. 

Suppose now that $\ell=2$. Then $\Delta_K\equiv 0, 1 \ [4]$. If $\Delta_K\equiv 0 \ [4]$, then $t$ is even so $\Pi\equiv X^2 \ [2]$ or $\Pi\equiv X^2+1=(X+1)^2 \ [2]$ and $\Pi$ has one factor of degree $1$, so there is $1=1+\(\frac{\Delta_K}{2}\)$ ideal of norm $2$.If $\Delta_K\equiv 1 \ [4]$, then $t$ is odd so $t\equiv \pm 1 \ [4]$ and $t^2\equiv 1 \ [8]$. Hence, $4n\equiv 1-\Delta_K \ [8]$, so $n$ is even when $\Delta_K\equiv 1 \ [8]$ and $\Pi\equiv X^2+X\equiv X(X+1) \ [2]$ has two factors of degree $1$, so there are $2=1+\(\frac{\Delta_K}{2}\)$ ideal of norm $2$.  On the contrary, $n$ is odd when $\Delta_K\equiv 5 \ [8]$ and $\Pi\equiv X^2+X+1\ [2]$ has no factor of degree $1$, so there is $0=1+\(\frac{\Delta_K}{2}\)$ ideal of norm $2$.
\end{proof}

If $\ell\nmid [\mO_K:\mO]$, then we cannot have $\mO\subseteq\mO'$ and $\ell|[\mO':\mO]$ so there is no ascending isogeny by proposition \ref{proposition 4}. Hence, we have $\ell-\(\frac{\Delta_K}{\ell}\)$ descending isogenies.

Now, we assume that $\ell|[\mO_K:\mO]$. Then, there exists an order $\mO''\subseteq \mO_K$ containing $\mO$ with index $\ell$. Hence, we have $\mO''=\Z[\alpha]$ with $\ell\alpha=\tau$.  Since $\alpha$ is an algebraic integer, we have $\alpha^2-t\alpha+n=0$, with $t:=\mbox{Tr}_{K/\Q}(\alpha)\in \Z$ and $n:=N_{K/\Q}(\alpha)\in \Z$. Since $\varphi$ cannot be horizontal the proposition \ref{proposition 4} ensures that $\varphi:E\longrightarrow E'$ is ascending if and only if $\mO'=\mO''$ and that otherwise, $\varphi$ is descending and $\mO'\subsetneq \mO\subsetneq \mO''$.  We have $\alpha\ell=\tau\in\Lambda_0=[\ell,\tau]$ and $\alpha\tau=\ell\alpha^2=\ell(t\alpha-n)=t\tau-\ell n\in \Lambda_0$ so $\mO''$ fixes $\Lambda_0$, so that $\mO'\supset\mO''$ so $\Lambda_0$ corresponds to an ascending isogeny.  For all $i\in\i{1}{\ell-1}$, we have $\alpha(\tau+i)=\ell\alpha^2+\alpha i=\ell(t\alpha-n)+\alpha i=t\tau-\ell n+\alpha i\not\in\mO$ because $\alpha i\not\in\mO$ and but $\Lambda_i=[\ell,\tau+i]\subseteq\mO$ so $\Lambda_i$ is not stable by multiplication by $\mO''$.  Eventually,  $\alpha\not\in \mO\supseteq \Lambda_\ell=[1,\ell\tau]$ so $\Lambda_\ell$ is not stable by multiplication by $\mO''$. Whence there are $\ell$ descending isogenies and only one ascending isogeny.

Now we treat the general case: $\Lambda$ is no longer homothetic to $\mO$ but we can reduce to this case. Since the action of $\mbox{Cl}(\mO)$ on $\mbox{Ell}(\mO)$ and maps $E=\C/\Lambda$ and an ideal $\mf{a}$ of $\mO$ to $\C/\mf{a}^{-1}\Lambda$ and since $\C/\mO\in\mbox{Ell}(\mO)$, we can assume that $\Lambda$ is an ideal $\mf{a}$ of $\mO$.  Multiplying $\mf{a}$ by a principal ideal does not change the isomorphism class of $E$ and, furthermore, every ideal class in $\mbox{Cl}(\mO)$ contains infinitely many ideals of prime norm by \cite[theorems 7.7. (iii) and 9.12]{Cox} so we may assume that $q:=N(\mf{a})$ is a prime number $\neq\ell$.  We consider the isogeny $\varphi_{\mf{a}}:E=\C/\mf{a}\longrightarrow E_0:=\C/\mf{a}^{-1}\mf{a}=\C/\mO$ whose kernel is $E[\mf{a}]$. We saw that $\mf{b}\longmapsto\mf{b}\mO'$ and $\mf{b}\longmapsto\mf{b}\cap\mO'$ are bijections between ideals of norm $q$ of $\mO$ and $\mO'$, respectively when $\mO\subseteq\mO'$ and $\mO\supseteq\mO'$.  Then, we can associate an ideal $\mf{a}'$ of norm $q$ in $\mO'$ to $\mf{a}$. Consider the isogeny $\varphi_{\mf{a}'}:E'\longrightarrow E'_0$ such that $\ker(\varphi_{\mf{a}'})=E'[\mf{a}']$. We claim that the isogeny $\varphi_0 : E_0\longrightarrow E'_0$ such that $\ker(\varphi_0)=\varphi_{\mf{a}}(\ker(\varphi_{\mf{a}'}\circ\varphi))$ makes the diagram commute :
\[\xymatrix{
E \ar[d]^{\varphi} \ar[r]^{\varphi_{\mf{a}}} & E_0 \ar[d]^{\varphi_0} \\
E' \ar[r]^{\varphi_{\mf{a}'}} & E'_0
}\]
By \cite[corollary III.4.11]{Silverman1}, it suffices to prove that $\ker(\varphi_{\mf{a}'}\circ\varphi)=\ker(\varphi_0\circ \varphi_{\mf{a}})$. We clearly have $\ker(\varphi_{\mf{a}'}\circ\varphi)\subseteq \ker(\varphi_0\circ \varphi_{\mf{a}})$ and we conclude because both $\varphi_{\mf{a}'}\circ\varphi$ and $\varphi_0\circ \varphi_{\mf{a}}$ have degree $\ell q$.  $\varphi_{\mf{a}}$ and $\varphi_{\mf{a}'}$ are horizontal so $\varphi$ is ascending, horizontal or descending if and only if $\varphi_0$ is too. Since $E_0\simeq\C/\mO$, we conclude by the case we treated above.

\textbf{(iii)} Let $\varphi, \psi : E\longrightarrow E'$ be two descending $\ell$-isogenies. Then $\varphi$ and $\psi$ are represented by the complex multiplication by $\alpha$ and $\beta\in K$ respectively.  By \cite[exercise 6.10.(b)]{Silverman1},  the endomorphisms $\psi\circ\widehat{\varphi}$ and $\varphi\circ\widehat{\psi}\in\End(E')$ are represented by $\ell\beta\alpha^{-1}$ and $\ell\alpha\beta^{-1}\in\mO'=[1,\ell\tau]$ respectively.  Let us write $\ell\beta\alpha^{-1}=a+b\ell\tau$, $\ell\alpha\beta^{-1}=c+d\ell\tau$, with $a,b,c,d\in\Z$, $\tau^2-t\tau+n=0$, with $t:=\mbox{Tr}_{K/\Q}(\tau)\in \Z$ and $n:=N_{K/\Q}(\tau)\in \Z$.  Then, we have:
\[\ell^2=\ell\beta\alpha^{-1}\ell\alpha\beta^{-1}=(a+b\ell\tau)(c+d\ell\tau)=ac+\ell(bc+ad)\tau+\ell^2bd\tau^2=ac+tbd\ell^2+\ell(bc+ad-\ell n bd)\tau\]
it follows that $\ell^2|ac$.  If $\ell\nmid c$, then $\ell^2|a$ and $bc+ad-\ell n bd=0$ so $\ell^2|b$ so $\ell^2|\ell\beta\alpha^{-1}$ i.e.  $\psi\circ\widehat{\varphi}$ factors through $[\ell^2]$, which is impossible because $\deg(\psi\circ\widehat{\varphi})=\ell^2$ and $\deg([\ell^2])=\ell^4$. Hence $\ell|c$. For the same reason, $\ell|a$. Hence, $\beta\alpha^{-1}\in\mO$ and $\alpha\beta^{-1}\in\mO$ so that $\alpha\beta^{-1}\in\mO^\times$.  $\varphi$ and $\psi$ are are considered invariant when multiplied on the left by an element of $\mbox{Aut}(E')$. But $\mbox{Aut}(E')$ corresponds to $\mO'^\times$ by complex multiplication. Hence, there are $[\mO^\times:\mO'^\times]$ descending $\ell$-isogenies $E\longrightarrow E'$.
\end{proof}

\begin{remark}\label{remark 2}
In the course of this proof, we obtained that every horizontal $\ell$-isogeny comes from a proper prime ideal of norm $\ell$.
\end{remark}

\subsection{Graph refolding and the forgetting map}

Forgetting the $K$-orientation, one can always consider supersingular $\ell$-isogeny graphs whose set of vertices is $\mbox{SS}(p)$, the set of isogeny classes of supersingular elliptic curves. We have a natural map $G_\ell(K,p)\longrightarrow\mbox{SS}(p)$, called the \emph{forgetting map}. This map cannot be injective since $G_\ell(K,p)$ is infinite (as ordinary $\ell$-isogeny graphs with complex multiplication by orders of $K$) and $\mbox{SS}(p)$ is finite of cardinality close to $\frac{p}{12}$ (by \cite[theorem V.4.1.(c)]{Silverman1}).

However, the cryptographic constructions of OSIDH use $j$-invariants alone so the $\mO$-orientations we consider on a given elliptic curves might be ambiguous.  That is why we look for partial injectivity results of the forgetting map.  Indeed, we can always restrict the set of vertices to the finite subset:
\[\mbox{SS}_{\mO}(p)\cap\im(\rho)=\bigcup_{\mO\subseteq\mO'}\rho(\mbox{Ell}(\mO'))\]
formed of (not necessarily primitively) $\mO$-oriented supersingular elliptic curves obtained by the reduction map $\rho$.

%Let $\mO_0$ be an order of $K$ and $\ell$ be a prime $\neq p$ such that neither $\ell$ nor $p$ divide the conductor of $\mO_0$.  Then, by propositions \ref{proposition 2} and \ref{proposition 6}, $\rho(\mbox{Ell}(\mO_0))$ is not empty so we can consider the subgraph given by the reunion of the connected components of ellements in $\rho(\mbox{Ell}(\mO_0))$, that we will denote by $G_\ell(\mO_0,p)$. We have:
%\[G_\ell(\mO_0,p)=\bigcup_{n\in\N}\rho(\mbox{Ell}(\mO_n))\]
%with $\mO_n:=\Z+\ell^n\mO_0$ for all $n\in\N$.Since the reduction map $\rho$ is injective, this graph is infinite but we can restrict to depth $n\in\N$ and consider:
%\[G_{\ell,\leq n}(\mO_0,p):=\bigcup_{i=0}^n\rho(\mbox{Ell}(\mO_i))\]
%Actually, we have a partial injectivity result:



\begin{theorem}\label{theorem 4}
Let $\Delta:=\mbox{disc}(\mO)$. If $|\Delta|<p$, then the map $\mbox{SS}_{\mO}(p)\cap\im(\rho)\longrightarrow\mbox{SS}(p)$ is injective.
\end{theorem}

Actually, this theorem is a direct consequence of the following proposition:

\begin{proposition}\label{proposition 7}
Let $E/\F_{p^2}$ be a supersingular elliptic curve admitting two distinct $K$-orientations $(E,\iota_1),(E,\iota_2)\in\im(\rho)$.  Let $\mO_1:=\iota_1^{-1}(\End(E))$ and $\mO_2:=\iota_2^{-1}(\End(E))$ and $\Delta_i:=\mbox{disc}(\mO_i)$ for all $i\in\{1,2\}$.  Then $\Delta_1\Delta_2\geq p^2$.
\end{proposition}

\begin{proof}
\textbf{Case 1:} Suppose that $\iota_1(\mO_1)=\iota_2(\mO_2)$. Then, $\iota_2^{-1}\circ\iota_1$ is a field automorphism of $K$ inducing an isomorphism $\mO_1\overset{\sim}{\longrightarrow}\mO_2$. Hence $\mO_1=\mO_2$ and we either have $\iota_2(\alpha)=\iota_1(\alpha)$ or $\iota_2(\alpha)=\iota_1(\overline{\alpha})$ for all $\alpha\in K$.  Since $\iota_1$ and $\iota_2$ are distinct, the latter equation holds. Considering Galois action like in the proof of proposition \ref{proposition 6}, we get that $(E,\iota_2)=(E^{(p)},\iota_1^{(p)})$. In particular, $E=E^{(p)}$. Then, we have $(E,\iota_1),(E,\iota_1^{(p)})\in\rho(\mbox{Ell}(\mO))$, where $\mO:=\mO_1=\mO_2$. Since the action of $\mbox{Cl}(\mO)$ on $\rho(\mbox{Ell}(\mO))$ is transitive by theorem \ref{theorem 3}, there exists an invertible ideal $\mf{a}\subseteq\mO$ of norm prime to $p$ such that $\mf{a}\cdot(E,\iota_1)=(E,\iota_1^{(p)})$.  Let $\varphi:=\varphi_{\mf{a}}$ and $\phi_p$ the $p$-th power Frobenius endomorphism. Then $\iota_2={\phi_p}_*(\iota_1)=\varphi_*(\iota_1)$. It follows that:
\[\forall\alpha\in K, \quad \frac{1}{p}\phi_p\iota(\alpha)\widehat{\phi_p}=\frac{1}{d}\varphi\iota(\alpha)\widehat{\varphi}\]
with $d:=\deg(\varphi)$. Multiplying by $\widehat{\varphi}$ on the left and by $\phi_p$ on the left, we get that $\widehat{\varphi}\circ\phi_p$ commutes with $\iota(K)$, so the exists $\alpha\in\mO$ such that $\widehat{\varphi}\circ\phi_p=\iota(\alpha)$ (otherwise, $\iota(K)$ and $\widehat{\varphi}\circ\phi_p$ would generate the quaternion algebra $\End^0(E)$, which would be commutative). Hence, $N(\alpha)=\deg(\widehat{\varphi}\circ\phi_p)=dp$, so $p|N(\alpha)=\alpha\overline{\alpha}$. Hence, if $p$ is inert, then $p\mO$ is prime so $\alpha\in p\mO$ or $\overline{\alpha}\in\mO$. Either way $\alpha\in p\mO$, so $p^2|N(\alpha)$ and $p|d$. But $d=N(\mf{a})$ by point (ii) of proposition \ref{proposition 3} and $N(\mf{a})$ is prime to $p$. Contradiction. Since $p$ does not split in $K$, $p$ ramifies so we have $\(\frac{\Delta_K}{p}\)=0$ i.e. $p|\Delta_K|\Delta$ by lemma \ref{lemma 1}.  Hence, $|\Delta|\geq p$, so $\Delta_1\Delta_2=\Delta^2\geq p^2$.

\textbf{Case 2:} Suppose that $\iota_1(\mO_1)\neq\iota_2(\mO_2)$. Then, $\iota_1(\mO_1)$ and $\iota_2(\mO_2)$ do not commute (the commutativity implies the equality, by arguments we already gave).  Let $\alpha_i$ be the image by $\iota_i$ of a generator of $\mO_i$ for all $i\in\{1,2\}$. Then, the commutator $\beta:=[\alpha_1,\alpha_2]=\alpha_1\alpha_2-\alpha_2\alpha_1$ is not zero.  By computation, we get the following expression for the norm of $\beta$:
\[N(\beta)=\frac{\Delta_1\Delta_2-T^2}{4}\quad (\star)\]
with $T:=2\mbox{Tr}(\alpha_1\alpha_2)-\mbox{Tr}(\alpha_1)\mbox{Tr}(\alpha_2)$. By \cite[theorem 42.1.19]{Voight}, $\End^0(E)=\End(E)\otimes_\Z \Q$ is a quaternion algebra that ramifies at $p$ and $\infty$ and $\End(E)$ is a maximal order in $\End^0(E)$. Since $\End^0(E)$ ramifies at $p$, $B_p:=\End^0(E)\otimes_\Q\Q_p$ is the unique division quaternion algebra over $\Q_p$, so we have an embedding $\End^0(E)\hookrightarrow B_p$ mapping $\End(E)$ to the valuation ring $O_p$ of $B_p$ formed of elements with non-negative $p$-adic valuation.  Furthermore, there is a unique maximal two sided ideal $P_p\subseteq O_p$ (see \cite[theorem 13.3.11]{Voight}). $P_p$ is formed of elements of positive $p$-adic valuation:
\[P_p=\{\alpha\in O_p\mid v_p(N(\alpha))>0\}=\{\alpha\in O_p\mid N(\alpha)\equiv 0 \ [p]\}\]
By \cite[theorem 13.3.11.(b)]{Voight} again, the quotient $O_p/P_p$ is the finite field $\F_{p^2}$ so it is commutative. It follows that $\beta=[\alpha_1,\alpha_2]\in P_p$, so that $N(\beta)\equiv 0 \ [p]$. 

By $(\star)$, it follows that $\sqrt{\Delta_1\Delta_2}+|T|\equiv 0 \ [2p]$ or $\sqrt{\Delta_1\Delta_2}-|T|\equiv 0 \ [2p]$ ($\sqrt{\Delta_1\Delta_2}\in\Z$ since $\mO_1,\mO_2\subseteq K$). Moreover, $\End^0(E)$ ramifies at $\infty$ so the norm is a positive definite function by \cite[Exercise 2.4]{Voight} and we have $N(\beta)>0$ since $\beta\neq 0$. It follows that $\sqrt{\Delta_1\Delta_2}>|T|$, so that $2p\leq\sqrt{\Delta_1\Delta_2}+|T|\leq 2\sqrt{\Delta_1\Delta_2}$ i.e.  $\Delta_1\Delta_2\geq p^2$.
\end{proof}

\section{Isogeny chains and ladders}

\subsection{Definition}

We now introduce the basic cryptographic constructions of the OSIDH protocol.

\begin{definition}
An \emph{$\ell$-isogeny chain} of length $n$ is a sequence of $\ell$-isogenies:
\[\xymatrix{
E_0 \ar[r]^{\varphi_0} & E_1 \ar[r]^{\varphi_{1}}& \cdots \ar[r]^{\varphi_{n-2}} & E_{n-1} \ar[r]^{\varphi_{n-1}} & E_n
}\]
We say that it is $K$-oriented if all elliptic curves $E_i$ ($0\leq i\leq n$) and isogenies $\varphi_i : E_i\longrightarrow E_{i+1}$ ($0\leq i\leq n-1$) are \emph{$K$-oriented}.

A $K$-oriented $\ell$-isogeny chain $(\varphi_i : E_i\longrightarrow E_{i+1})_{0\leq i\leq n-1}$ is \emph{descending}, \emph{horizontal} or \emph{ascending} if all the $\varphi_i$ are respectively descending, horizontal or ascending.
\end{definition}

In the following, we shall only consider $K$-oriented isogeny chains, so we will omit to mention that they are $K$-oriented.

\begin{definition}
An \emph{$\ell$-ladder} of length $n$ and degree $q$ is a commutative diagram of $\ell$-isogeny chains $(\varphi_i:E_i\longrightarrow E_{i+1})_{0\leq i\leq n-1}$ and $(\varphi'_i:F_i\longrightarrow F_{i+1})_{0\leq i\leq n-1}$:
\[\xymatrix{
E_0 \ar[d]^{\psi_0} \ar[r]^{\varphi_0} & E_1\ar[d]^{\psi_1} \ar[r]^{\varphi_{1}}& \cdots \ar[r]^{\varphi_{n-2}} & E_{n-1} \ar[d]^{\psi_{n-1}} \ar[r]^{\varphi_{n-1}} & E_n \ar[d]^{\psi_n}\\
F_0 \ar[r]^{\varphi'_0} & F_1 \ar[r]^{\varphi'_{1}}& \cdots \ar[r]^{\varphi'_{n-2}} & F_{n-1} \ar[r]^{\varphi'_{n-1}} & F_n
}\]
such that $\psi_i : E_i\longrightarrow F_i$ is a $q$-isogeny for all $i\in\i{0}{n}$. Such an $\ell$-ladder is often denoted $\psi : (E_i,\varphi_i)_{0\leq i\leq n-1}\longrightarrow (F_i,\varphi'_i)_{0\leq i\leq n-1}$ and referred to as a $q$-isogeny between $\ell$-isogeny chains. 

An $\ell$-ladder $\psi : (E_i,\varphi_i)_{0\leq i\leq n-1}\longrightarrow (F_i,\varphi'_i)_{0\leq i\leq n-1}$ is \emph{descending}, \emph{horizontal} or \emph{ascending} if all the $\varphi_i$ are respectively descending, horizontal or ascending.  It is \emph{level} if $\psi_0 : E_0\longrightarrow F_0$ is horizontal.
\end{definition}

\begin{lemma}\label{lemma 2}
Suppose $\ell$ and $q$ are distinct prime numbers. Let $\psi : ((E_i,\iota_i),\varphi_i)\longrightarrow ((F_i,\iota'_i),\varphi'_i)$ be an $\ell$-lader of length $n$ between  $K$-oriented $\ell$-isogeny chains. Then $\psi$ is level if and only if $\iota_i^{-1}(\End(E_i))={\iota'}_i^{-1}(\End(F_i))$ for all $i\in\i{0}{n}$. In particular,  if $\psi$ is level and descending, horizontal or ascending, then the $\ell$-isogeny chain $(\varphi'_i: F_i\longrightarrow F_{i+1})_{0\leq i\leq n-1}$ is respectively descending, horizontal or ascending.
\end{lemma}

\begin{proof}
Suppose that $\psi$ is level. Then we prove that $\mO_i:=\iota_i^{-1}(\End(E_i))$ equals $\mO'_i:={\iota'}_i^{-1}(\End(F_i))$ by induction on $i\in\i{0}{n}$. Since $\psi_0$ is horizontal, the result follows immediately at $i=0$. 

Now, let $i\in\i{0}{n-1}$ and suppose that $\mO_i=\mO'_i$. Suppose that $\varphi_i : E_i\longrightarrow E_{i+1}$ is descending. Then $\mO_{i+1}\subseteq\mO_i$ and $[\mO_i:\mO_{i+1}]=\ell$ by proposition \ref{proposition 4}, and $\varphi'_i: F_i\longrightarrow F_{i+1}$ must be descending to, otherwise, we would have $\mO_{i+1}\subseteq\mO_i=\mO'_i\subseteq \mO'_{i+1}$ and $\ell=[\mO_i:\mO_{i+1}]|[\mO'_{i+1}:\mO_{i+1}]$ so $\psi_{i+1}$ is ascending and $[\mO'_{i+1}:\mO_{i+1}]=q$ by proposition \ref{proposition 4}. Contradiction because $\ell\nmid q$.  Hence $\varphi'_i$ is descending and $\mO_{i+1}=\mO'_{i+1}$ since they have the same conductor. We treat the cases where $\varphi_i$ is horizontal and ascending likewise. Whence the result, $\psi$ beign trivially level when $\mO_i=\mO'_i$ for all $i\in\i{0}{n}$.
\end{proof}

We now introduce a way to obtain a level and descending $\ell$-ladder. Let $q$ and $\ell$ be distinct prime numbers distinct from $p$. Let $\mO_0$ be an order of $K$ whose conductor is prime to $\ell$,  $p$ and $q$ (for instance $\mO_0=\mO_K$).  Let $\mO_i:=\Z+\ell^i\mO_0$ for all $i\in\i{0}{n}$.

Suppose that $q$ splits in $K$. Let $\mfq$ be a prime ideal of $\mO_0$ lying above $q$. Then $\mfq$ is proper and has norm $q$ and so does $\mfq^{(i)}:=\mfq\cap\mO_i$ for all $i\in\i{0}{n}$ (as we proved in lemma \ref{lemma 1}).

Let $(\varphi_i: (E_i,\iota_i)\longrightarrow (E_{i+1},\iota_{i+1}))$ be a descending $\ell$-isogeny chain of length $n$ such that $E_i$ is primitively $\mO_i$-oriented for all $i\in\i{1}{n}$. For all $i\in\i{0}{n}$, let:
\[(F_i,\iota'_i):=\mfq^{(i)}\cdot(E_i,\iota_i)=(E_i/E_i[\mfq^{(i)}],{\psi_i}_*(\iota_i))\]
where $\psi_i:=\varphi_{\mfq^{(i)}}$. Then, there is an $\ell$-isogeny chain $(\varphi'_i:F_i\longrightarrow F_{i+1})$ such that the following diagram commutes:
\[\xymatrix{
E_0 \ar[d]^{\psi_0} \ar[r]^{\varphi_0} & E_1\ar[d]^{\psi_1} \ar[r]^{\varphi_{1}}& \cdots \ar[r]^{\varphi_{n-2}} & E_{n-1} \ar[d]^{\psi_{n-1}} \ar[r]^{\varphi_{n-1}} & E_n \ar[d]^{\psi_n}\\
F_0 \ar[r]^{\varphi'_0} & F_1 \ar[r]^{\varphi'_{1}}& \cdots \ar[r]^{\varphi'_{n-2}} & F_{n-1} \ar[r]^{\varphi'_{n-1}} & F_n
}\]
i.e. forms a descending $\ell$-ladder.  The $\varphi'_i$ are given by $\ker(\varphi'_i)=\psi_i(\ker(\psi_{i+1}\circ\varphi_i))$ for all $i\in\i{0}{n-1}$.  The $\ell$-isogeny chain at the bottom will be denoted by $\mf{q}\cdot((E_i,\iota_i),\varphi_i)$ or simply $\mf{q}\cdot(E_i,\varphi_i)$. 

If $\mfq=\mfq^{(0)}$ is principal, then $\psi_0$ is an endomorphism and the $\ell$-ladder is level. It is always the case when $\mbox{Cl}(\mO_0)$ is trivial (assumption that will always be made in the following). This assumption is very restrictive. First because it requires $\mO_0$ to be a principal ideal domain, hence a unique factorization domain, hence integrally closed so that $\mO_0=\mO_K$. Second, because the discriminant must be in the set:
\[\{-3,-4,-7,-8,-11,-19,-43,-67,-163\}\]
by \cite[theorem 7.30.(i)]{Cox}.


\subsection{A practical way to construct descending $\ell$-ladders}\label{paragraph 1}

Here we assume that $\mbox{Cl}(\mO_0)$ is trivial ($\mO_0=\mO_K$), so that the descending $\ell$-ladder we will construct will be level.

First, we construct the $\ell$-isogeny chain $(\varphi_i: (E_i,\iota_i)\longrightarrow (E_{i+1},\iota_{i+1}))_{0\leq i\leq n-1}$ by descent of the $\ell$-isogeny volcano whose crater is formed by $K$-oriented supersingular primitively $\mO_0$-oriented elliptic curves.  We want to construct $\mf{q}\cdot(E_i,\varphi_i)$.  The action of $\mfq^{(0)}$ on $(E_0,\iota_0)$ is trivial so we have $(F_0,\iota'_0)=(E_0,\iota_0)$. 

The $K$-oriented elliptic curves $(F_{i+1},\iota'_{i+1})$, $\psi_{i+1}$ and $\varphi'_i$ are still to be constructed for all $i\in\i{0}{n-1}$. However, instead of working with explicit formulas for isogenies and models for elliptic curves, the OSIDH protocol only requires $j$-invariants. Then, we will only need to work with modular equations: if $E$ qnd $E'$ are elliptic curves defined over the finite field $k$ and $n\in\N^*$ is such that $p:=\mbox{char}(k)\nmid n$, it is well known that there is a cyclic $n$-isogeny $E\longrightarrow E'$ if and only if $\Phi_n(j(E),j(E'))=0$, where $\Phi_n\in\Z[X,Y]$ is the $n$-th modular polynomial (\cite[theorem V.5]{Lang_EF}). Let us assume that $(F_i,\iota_i)$ is constructed and that $\psi_i$ and $\varphi'_i$ are given (but unknown since only $j(F_i)$ is known).  We want to construct $F_{i+1}$. We know that there exist an $\ell$-isogeny $\varphi'_i: (F_i,\iota'_i)\longrightarrow (F_{i+1},\iota'_{i+1})$ and a $q$-isogeny $\psi_{i+1}: (E_{i+1},\iota_{i+1})\longrightarrow (F_{i+1},\iota'_{i+1})$ making the following diagram commute:
\[\xymatrix{
E_i \ar[d]^{\psi_i} \ar[r]^{\varphi_i} & E_{i+1}\ar[d]^{\psi_{i+1}} \\
F_i \ar[r]^{\varphi'_i} & F_{i+1}
}\]
Then, $j(F_{i+1})$ is a solution of the equations:
\[\left\{\begin{array}{c}
\Phi_\ell(j(F_i),x)=0\\
\Phi_q(j(E_{i+1}),x)=0
\end{array}\right. \Longleftrightarrow \quad \gcd(\Phi_\ell(j(F_i),x),\Phi_q(j(E_{i+1}),x))=0\quad (E_i)\]
However, \emph{a priori} this equation can admit multiple solutions so we want to make sure that the solution is unique and corresponds to $(F_{i+1},\iota'_{i+1})=\mf{q}^{(i+1)}\cdot(E_{i+1},\iota_i)$. This will be the case under some assumptions.

\begin{proposition}\label{proposition 9}
Let $\Delta_0:=\mbox{disc}(\mO_0)$. We assume that:
\begin{description}
\item[(i)] $p>q\ell^{2n}|\Delta_0|$.
\item[(ii)] $(F_0,\iota'_0)=\mf{q}^{(0)}\cdot(E_{0},\iota_0)$ and $(F_1,\iota'_1)=\mf{q}^{(1)}\cdot(E_{1},\iota_1)$.
\item[(iii)] $(\mfq^{(1)})^2$ is not principal in $\mO_1$.
\item[(iv)] $j(F_{i})$ is a solution of $(E_{i-1})$ for all $i\in\i{1}{n}$. 
\end{description}
Then $(F_{i},\iota'_{i})=\mf{q}^{(i)}\cdot(E_{i},\iota_i)$ for all $i\in\i{0}{n}$.  
\end{proposition}

\begin{proof}
We prove by induction on $i\in\i{0}{n}$ that $(F_i,\iota'_i)=\mf{q}^{(i)}\cdot(E_{i},\iota_i)$. We already know that the result holds for $i=0$ and $i=1$. 

Let $i\in\i{1}{n-1}$.  Let us assume that $(F_i,\iota'_i)=\mf{q}^{(i)}\cdot(E_{i},\iota_i)$. Since $j(F_{i+1})$ is solution of $(E_i)$,  there exist an $\ell$-isogeny $\varphi'_i: F_i\longrightarrow F_{i+1}$ and a $q$-isogeny $\psi_{i+1}: E_{i+1}\longrightarrow F_{i+1}$. Since $(F_i,\iota'_i)=\mf{q}^{(i)}\cdot(E_{i},\iota_i)$ and $\mfq^{(i)}$ is invertible (its norm is $q$, which is prime to $[\mO_K:\mO_i]=\ell^i[\mO_K:\mO_0]$), $\psi_i$ is an horizontal isogeny by point (iv) of proposition \ref{proposition 3}. Hence, we have ${\iota'_i}^{-1}(\End(F_i))=\mO_i$ (with $\iota'_i={\psi_{i}}_*(\iota_i)$). Since $\varphi'_i$ has degree $\ell$,  ${\varphi'_i}_*(\iota'_i)^{-1}(\End(F_{i+1}))$ is a suborder of $\mO_0$ of index $\ell^{i-1}$, $\ell^i$ or $\ell^{i+1}$ by proposition \ref{proposition 4}. Since $\psi_{i+1}$ has degree $q$, ${\psi_{i+1}}_*(\iota_{i+1})^{-1}(\End(F_{i+1}))$ is a suborder of $\mO_0$ of index $\ell^{i+1}$ or $q\ell^{i+1}$. Hence, if ${\varphi'_i}_*(\iota'_i)$ and ${\psi_{i+1}}_*(\iota_{i+1})$ were distinct $K$-orientation, we would have $q^2\ell^{4i+4}\Delta_0^2\geq p^2$ by proposition \ref{proposition 7},contradicting point (i). Whence, ${\varphi'_i}_*(\iota'_i)={\psi_{i+1}}_*(\iota_{i+1})$ i.e. :
\[(\varphi'_i\circ\psi_i)_*(\iota_i)=(\psi_{i+1}\circ\varphi_i)_*(\iota_i)\]
Let $\phi:=\varphi'_i\circ\psi_i$ and $\psi:=\psi_{i+1}\circ\varphi_i$. Then, $\widehat{\psi}\circ\phi$ commutes with $\iota_i(K)$ (since $\psi$ and $\phi$ have the same degree) and there exists $\alpha\in\mO_i$ such that $\widehat{\psi}\circ\phi=\iota_i(\alpha)$. 

We will prove that $\alpha=q\ell$, so that $\varphi'_i\circ\psi_i=\psi_{i+1}\circ\varphi_i$, whence $\ker(\psi_{i+1})=\varphi_i(\ker(\varphi'_i\circ\psi_i))=E_{i+1}[\mfq^{(i+1)}]$ and the proof will be complete.

Let $\iota'_{i+1}:=\phi_*(\iota_i)=\psi_*(\iota_i)$.  Since $\varphi'_i$ has degree $\ell$ and $\psi_{i+1}$ has degree $q\neq \ell$, the argument given in the proof of lemma \ref{lemma 2} ensures that $\psi_{i+1}$ is horizontal, i.e. that ${\iota'_{i+1}}^{-1}(\End(F_{i+1}))=\mO_{i+1}$.  $\psi_{i+1}$ being horizontal of degree $q$, remark \ref{remark 2} ensures that $\psi_{i+1}$ is given by an invertible ideal of norm $q$, that is to say $\mfq^{(i)}$ or $\overline{\mfq}^{(i)}$, so we either have $\ker(\psi_{i+1})=E_{i+1}[\mfq^{(i+1)}]$ or $\ker(\psi_{i+1})=E_{i+1}[\overline{\mfq}^{(i+1)}]$.  We assume that the latter holds.

We have:
\[\iota'_{i+1}(\alpha)=\frac{1}{q\ell}\psi\circ\iota_i(\alpha)\circ\widehat{\psi}=\frac{1}{q\ell}\psi\circ \widehat{\psi}\circ\phi\circ\widehat{\psi}=\phi\circ\widehat{\psi}\in \End(F_{i+1})\]
so that $\alpha\in \mO_{i+1}$. Let $\tau\in K$ be a generator of $\mO_i$. Then, $\ell\tau$ is a generator of $\mO_{i+1}$ so there exist $a,b\in\Z$ such that $\alpha=a+b\ell\tau$, so that:
\[N(\alpha)=\alpha\overline{\alpha}=(a+b\ell\tau)(a+b\ell\overline{\tau})=a^2+ab\ell\mbox{Tr}(\tau)+\ell^2b^2N(\tau)\]
Since $\ell^2q^2=\deg(\iota_i(\alpha))=N(\alpha)$, it follows that $\ell|a$. Hence, $\alpha\in\ell\mO_i$.  Let $\beta:=\frac{\alpha}{\ell}\in\mO_i$.  Then:
\[\widehat{\varphi_i}\circ\widehat{\psi_{i+1}}\circ\varphi'_i\circ\psi_i=[\ell]\circ\iota_i(\beta)\quad\mbox{so that} \quad [\ell q]\circ\varphi'_i\circ\psi_i=[\ell]\circ\psi_{i+1}\circ\varphi_i\circ\iota_i(\beta)\]
i.e.
\[[q]\circ\varphi'_i\circ\psi_i=\psi_{i+1}\circ\varphi_i\circ\iota_i(\beta)\quad (\star)\]

Let $P\in E_i[\mfq^{(i)}]=\ker(\psi_i)$.  Then $[q]\circ\varphi'_i\circ\psi_i(P)=O$, so that $\psi_{i+1}\circ\varphi_i\circ\iota_i(\beta)(P)=O$ i.e. $\varphi_i\circ\iota_i(\beta)(P)\in\ker(\psi_{i+1})=E_{i+1}[\overline{\mfq}^{(i+1)}]$. Hence, for all $\gamma\in\overline{\mfq}^{(i+1)}$, we have:
\[O=\iota_{i+1}(\gamma)\circ\varphi_i\circ\iota_i(\beta)(P)=\varphi_i\circ\iota_i(\gamma\beta)(P) \]
so that $\iota_i(\gamma\beta)(P)\in\ker(\varphi_i)$. But for all $\gamma\in\mfq^{(i+1)}$, we have $\iota_i(\gamma\beta)(P)=O$ because $P\in E_i[\mfq^{(i)}]$.  Since $q$ splits in $K$,$\mfq^{(i+1)}$ and $\overline{\mfq}^{(i+1)}$ are distinct and we have $\mfq^{(i+1)}+\overline{\mfq}^{(i+1)}=\mO_{i+1}$. It follows that $\iota_i(\beta)(P)\in\ker(\varphi_i)$. But $\ker(\varphi_i)$ is a cyclic group of order $\ell$ and the order of $\iota_i(\beta)(P)\in E_i[\mfq^{(i)}]$, which is a cyclic group of order $q$. Hence, the order of $\iota_i(\beta)(P)$ divides $\gcd(\ell,q)=1$ i.e. $\iota_i(\beta)(P)=O$.  We just have proved that $\ker(\psi_i)=E_i[\mfq^{(i)}]\subseteq\ker(\iota_i(\beta))$. Then, by \cite[corollary III.4.11]{Silverman1}, there exists an isogeny $\lambda : F_i\longrightarrow E_i$ such that: 
\[\iota_i(\beta)=\lambda\circ\psi_i\]
By $(\star)$,  it follows that $[q]\circ\varphi'_i=\psi_{i+1}\circ\varphi_i\circ\lambda$. 

Let $P\in F_i[\mfq^{(i)}]$. Since $F_i[\mfq^{(i)}]\subseteq F_i[q]$, we have $[q]\circ\varphi'_i(P)=\varphi'_i([q]P)=O$ so that $\psi_{i+1}\circ\varphi_i\circ\lambda(P)=O$ i.e.  $\varphi_i\circ\lambda(P)\in\ker(\psi_{i+1})=E_{i+1}[\overline{\mfq}^{(i+1)}]$. Hence, for all $\gamma\in\overline{\mfq}^{(i+1)}$, we have:
\[O=\iota_{i+1}(\gamma)\circ\varphi_i\circ\lambda(P)=\varphi_i\circ\iota_i(\gamma)\circ\lambda(P)\]
so that $\iota_i(\gamma)\circ\lambda(P)\in \ker(\varphi_i)$. But $\ker(\varphi_i)$ has order $\ell$ and $\iota_i(\gamma)\circ\lambda(P)\in E_i[q]$ so $\iota_i(\gamma)\circ\lambda(P)=O$. We also have for all $\gamma\in\mfq^{(i+1)}$:
\[\iota_i(\gamma)\circ\lambda(P)=\lambda\circ\iota'_i(\gamma)(P)=O\]
since $\lambda_*(\iota'_i)=(\lambda\circ\psi_i)_*(\iota_i)=(\iota_i(\beta))_*(\iota_i)=\iota_i$. Since $\mfq^{(i+1)}+\overline{\mfq}^{(i+1)}=\mO_{i+1}$, it follows that $\lambda(P)=O$. Hence $F_i[\mfq^{(i)}]\subseteq\ker(\lambda)$ and $\lambda$ has degree $q$, so $F_i[\mfq^{(i)}]=\ker(\lambda)$. Since $E_i$ is the codomain of $\lambda$, we have $(E_i,\iota_i)=\mfq^{(i)}\cdot (F_i,\iota'_i)=(\mfq^{(i)})^2\cdot (E_i,\iota_i)$ and $(\mfq^{(i)})^2$ is principal by faithfulness of the group action (theorem \ref{theorem 3}). Hence, there exists $\gamma\in\mO_i$ such that $(\mfq^{(i)})^2=\gamma\mO_i$, so that $\gamma\in (\mfq^{(i)})^2\subseteq (\mfq^{(1)})^2$ i.e. $\gamma\mO_1\subseteq (\mfq^{(1)})^2$ but $N((\mfq^{(1)})^2)=N((\mfq^{(i)})^2)=N(\gamma)$ (by \cite[proposition 7.20.(i)]{Cox}) so $\gamma\mO_1= (\mfq^{(1)})^2$, which contradicts (iii).  We conclude that $\ker(\psi_{i+1})=E_{i+1}[\mfq^{(i+1)}]$, so that $(F_{i+1},\iota'_{i+1})=\mf{q}^{(i+1)}\cdot(E_{i+1},\iota_{i+1})$. This completes the proof.
\end{proof}

Under the assumptions of proposition \ref{proposition 9},  $(E_i)$ admits only one solution for all $i\geq 1$, and there is no ambiguity to determine $j(F_{i+1})$. Since $\mbox{Cl}(\mO_0)$ is trivial, we also know that $j(F_0)=j(E_0)$. However, the solution of $(E_0)$ can be $j(F_1)=j(E_1/E_1[\mfq^{(1)}])$ or $j(E_1/E_1[\overline{\mfq}^{(1)}])$. Fortunately, $(\mfq^{(1)})^2$ is not principal, so that $\mfq^{(1)}$ and $\overline{\mfq}^{(1)}$ have distinct images in $\mbox{Cl}(\mO_1)$ and $j(E_1/E_1[\mfq^{(1)}])\neq j(E_1/E_1[\overline{\mfq}^{(1)}])$ by faithfulness of the ideal class group action and by theorem \ref{theorem 4}.  Hence, we need to compute both $j$-invariants. This can be made by computing $E_1[\mfq^{(1)}]$ and $E_1[\overline{\mfq}^{(1)}]$ and using V\'{e}lu's formulas \cite{Velu}. 

\begin{remark}
The choice of direction $\mfq$ and $\overline{\mfq}$ at step $i=1$ is not compulsory, and the non-principality of $(\mfq^{(1)})^2$ in $\mO_1$ can be a restrictive hypothesis in general, especially if we consider multiple prime ideals like in the real OSIDH cryptosystem. Actually, when $(\mfq^{(i)})^2$ is principal in $\mO_i$, $j(E_i/E_i[\mfq^{(i)}])=j(E_i/E_i[\overline{\mfq^{(i)}}])$ and equation $(E_{i-1})$ admits only one solution, so there is no ambiguity till $(\mfq^{(i)})^2$ is no longer principal in $\mO_i$. Instead of determining the direction at rank $1$, we may then determine the direction at rank $i_0$ such that $(\mfq^{(i_0)})^2$ is not principal in $\mO_{i_0}$. 

Such an index $i_0$ always exists.  indeed, if $(\mfq^{(i)})^2=\alpha\mO_i$ for a certain $\alpha\in\mO_i$, then $N(\alpha)=q^2$ by \cite[lemma 7.14.(i)]{Cox}. Let $\tau$ be a generator of $\mO_0$, $t$ its trace and $d$ its norm. Then,  $\mO_i=\Z+\ell^i\tau\Z$ and $\alpha=a+b\ell^i\tau$ with $a, b\in\Z$, so that:
\[q^2=N(\alpha)=(a+b\ell^i\tau)(a+b\ell^i\overline{\tau})=a^2+ab\ell^it+b^2\ell^{2i}d\]
If $b\neq 0$, we get that $a$ is a root of the polynomial $X^2+b\ell^itX+b^2\ell^{2i}d-q^2$ whose discriminant is:
\[b^2\ell^{2i}(t^2-4d^2)+4q^2=b^2\ell^{2i}\Delta_K+4q^2\leq 4q^2+\ell^{2i}\Delta_K\]
There is no integral root when this quantity is $<0$, i.e. once $i\geq i_0:=\lfloor \log_\ell(2q/\sqrt{|\Delta_K|})\rfloor +1$. Hence, if $i\geq i_0$, we must have $b=0$, so $a=q$ and $(\mfq^{(i_0)})^2=q\mO_i$, so that $\mfq^2=q\mO_K$ and $q$ ramifies in $K$, which is impossible. It follows that $(\mfq^{(i)})^2$ is not principal for $i\geq i_0$.
\end{remark}

\chapter{The OSIDH cryptosystem}

\section{A first naive Diffie Hellman protocol}

Let $K$ be a quadratic imaginary number field such that $\mO_0:=\mO_K$ has a trivial ideal class group $\mbox{Cl}(\mO_K)$. Let $p$ be a prime that does not split in $K$. Let $\ell$ be a prime distinct from $p$ and $\mO_i:=\Z+\ell^i\mO_K$ for all $i\in\N$. 

The parties Alice and Bob agree on a supersingular elliptic curve $E_0\in\rho(\mbox{Ell}(\mO_K))$ and a descending $\ell$-isogeny chain $(E_i,\iota_i)_{0\leq i\leq n}$ which is public data. Alice and Bob then act separately on this chain with secret powersmooth ideals:
\[\mf{a}=\prod_{j=1}^t \mf{q}_j^{e_j} \qquad \mbox{and} \qquad \mf{b}=\prod_{j=1}^t \mf{q}_j^{f_j}\]
where the $\mf{q}_j$ are prime ideals of $\mO_K$ of small norms and the exponents $e_j, f_j$ are small. Alice successively computes the chains $ \mf{q}_1\cdot (E_i,\iota_i), \mf{q}_1^2\cdot (E_i,\iota_i), \cdots, \mf{q}_1^{e_i}\cdot (E_i,\iota_i),  \mf{q}_2\mf{q}_1^{e_i}\cdot (E_i,\iota_i),\cdots$ until $(E_{A,i},\iota_{A,i}):=\mf{a}\cdot (E_i,\iota_i)$ with the method presented in paragraph \ref{paragraph 1}.  Bob uses the same method to compute $(E_{B,i},\iota_{B,i}):=\mf{b}\cdot (E_i,\iota_i)$. 

Then, Alice sends the chain $(E_{A,i},\iota_{A,i})$ to Bob and Bob sends the chain $(E_{B,i},\iota_{B,i})$ to Alice. Finally, Alice and Bob separately compute their shared secret with the action of their secret ideals on the exchanged chains:
\[(E_{AB,i},\iota_{AB,i})=\mf{a}\cdot (E_{B,i},\iota_{B,i})=\mf{b}\cdot (E_{A,i},\iota_{A,i})\]
However, this key-exchange scheme is not secured because the chain exchange gives away too much information to potential attackers. 

\section{A first attack using quaternions}\label{paragraph 7}

There is a subexponential classical attack using arithmetic of quaternion algebras.  We recall here the problem we have to solve: given a chain $(E_i,\iota_i)_{0\leq i\leq n}$ and a chain $(F_i,\iota'_i)_{0\leq i\leq n}=\mf{a}\cdot(E_i,\iota_i)_{0\leq i\leq n}$ with a secret ideal class $[\mf{a}]\in\mbox{Cl}(\mO_n)$, we want to recover $[\mf{a}]$. The attack follows the following steps:
\begin{enumerate}
\item Recover $\End(E_n)$ and $\End(F_n)$ from the chains $(E_i,\iota_i)_{0\leq i\leq n}$ and $(F_i,\iota'_i)_{0\leq i\leq n}$.
\item Compute a connecting ideal $I$ between $\End(E_n)$ and $\End(F_n)$, defining an isogeny $E_n\longrightarrow F_n$ by the Deuring correspondence.
\item Find an equivalent ideal $J$ to $I$ that is generated by a prime ideal $\mf{N}$ of $\mO_n$ norm $N\neq\ell$.
\item Find an ideal $\mf{a}\subseteq \mO_n$ of powersmooth norm, equivalent to $\mf{N}$, so that the action of $\mf{a}$ on elliptic curves is easy to compute.
\end{enumerate}

\subsection{Step 1: computing $\End(E_n)$ and $\End(F_n)$}\label{paragraph 6}

If $E/\F_{p^2}$ is a supersingular elliptic curve, we know that $\End(E)$ is a maximal order in the quaternion algebra $B_{p,\infty}$ ramifying at $p$ and $\infty$ (by \cite[theorem 42.1.9]{Voight}).  We have an explicit description of $B_{p,\infty}$ as $B_{p,\infty}=H(a,b)$ ($a,b\in\Q$), with $H(a,b)=\Q+\Q i+\Q j+\Q k$ and:
\[i^2=a, \quad j^2=b, \quad k=ij,\quad ij=-ji\]
This description follows from \cite[proposition 5.1]{Pizer80}:
\[B_{p,\infty}=\left\{\begin{array}{cl}
H(-1,-1) & \mbox{if } p=2\\
H(-1,-p) & \mbox{if } p\equiv 3 \ [4]\\
H(-2,-p)  & \mbox{if } p\equiv 5 \ [8]\\
H(-q,-p)  & \mbox{if } p\equiv 1 \ [8]\\
\end{array}\right.\]
with $q\equiv 3 \ [4]$ and $\(\frac{q}{p}\)=-1$. Using an isomorphism $\End^0(E)\simeq B_{p,\infty}$, one can express a $\Z$-basis of $\End(E)$ in terms of $i$,$j$,$k$. However, given an endomorphism of $E$ expressed in the $\Z$-basis of $\End(E)$ or equivalently, in terms of $1$, $i$,$j$, $k$ it is not trivial in general to know how to evaluate it on points of $E$, but this evaluation will be necessary to find the endomorphism rings of the elleptic curves in the chains  $(E_i,\iota_i)_{0\leq i\leq n}$ and $(F_i,\iota'_i)_{0\leq i\leq n}$. 

More precisely, following \cite{LP_merged}, we will need to evaluate in polynomial time in $\log(p)$ any element of the $\Z$-basis of $\End(E)$ at points of $E$ defined over a field extension of $\F_p$ of polynomial degree in $\log(p)$. If it is the case,  any linear combination of elements of such a basis with coefficients in polynomial size in $\log(p)$ can be evaluated in polynomial time in $\log(p)$.  Such a basis will be said \emph{useful}.  We may restrict the possibility to evaluate to points with \textbf{known order} prime to a certain integer $f\in\Z$,  in which case the basis will be said $f$-\emph{useful}. We also want this basis to be \emph{concise}, that is to say storable in space polynomial in $\log(p)$, e.g. with an expression in terms of $1$, $i$,$j$, $k$ (via the isomorphism $\End^0(E)\simeq B_{p,\infty}$) of polynomial size in $\log(p)$. 

\begin{definition}
The data given by an isomorphism $\Phi : B_{p,\infty} \overset{\sim}{\longrightarrow}\End^0(E)$ together with a basis of $\End(E)$ that is ($f$-)useful and concise (relatively to $\Phi$) is called an ($f$-)\emph{compact representation} of $\End(E)$.

Generally, an order $\m{R}\subseteq B_{p,\infty}$ or a lattice $I\subseteq B_{p,\infty}$ will be said \emph{concise} when given with a concise $\Z$-bais.
\end{definition}

\begin{example}\label{example 2}
For $p\equiv 3 \ [4]$, let $E_0$ be the elliptic curve defined by the Weierstrass equation $y^2=x^3+x$. Then $\End(E_0)$ admits a compact representation given by the isomorphism: 
\[\Phi_0 : B_{p,\infty}=H(-1,-p) \longrightarrow\End^0(E_0)\] 
mapping $i$ to $\phi : (x,y)\longmapsto (-x,ay)$ (with $a^2=-1$) and $j$ to the Frobenius $\pi : (x,y)\longmapsto (x^p,y^p)$ and $\(1, \phi,\frac{\phi+\pi}{2},\frac{1+\pi\phi}{2}\)$ is a useful and concise basis of $\End(E_0)$.
\end{example}

In general, the first curve of the chain $E_0$ will be chosen to have a compact representation as in example \ref{example 2}, for simplicity of the construction. We shall prove that the knowledge of the chain $(E_i,\iota_i)_{0\leq i\leq n}$ will help us construct a compact representation of $\End(E_i)$ for all $i\in\i{0}{n}$, ensuring that we can deduce a basis of $\End(E_{i+1})$ from a basis of $\End(E_i)$ for all $i\in\i{0}{n-1}$.

\begin{lemma}\label{lemma 3}
The map:
\[\psi\in\End^0(E_i)\longmapsto \frac{1}{\ell}\varphi_i\psi\widehat{\varphi_i}\in \End^0(E_{i+1})\]
is an isomorphism of quaternion algebras inducing a ring isomorphism between quaternion orders:
\[\Z+\ell\End(E_i)\simeq \Z+\varphi_i\End(E_i)\widehat{\varphi_i}\]
As a consequence, $\Z+\varphi_i\End(E_i)\widehat{\varphi_i}$ has index $\ell^3$ in $\End(E_{i+1})$.
\end{lemma}

\begin{proof}
Everything is clear, except maybe the last assertion.  Since, $\Z+\ell\End(E_i)\simeq \Z+\varphi_i\End(E_i)\widehat{\varphi_i}$, we have:
\[\mbox{disc}(\Z+\ell\End(E_i))=\mbox{disc}(\Z+\varphi_i\End(E_i))\]
by \cite[corollary 15.2.9]{Voight}. By \cite[theorem 15.5.5]{Voight}, we also have:
\[\mbox{disc}(\End(E_i))=\mbox{disc}(\End(E_{i+1}))=16p^2\]
since $\End(E_i)$ and $\End(E_{i+1})$ are maximal. Finally, by \cite[lemma 15.2.15]{Voight}, we have:
\[\mbox{disc}(\End(E_i))=[\End(E_i):\Z+\ell\End(E_i)]^2\mbox{disc}(\Z+\ell\End(E_i))\]
And:
\[\mbox{disc}(\End(E_{i+1}))=[\End(E_{i+1}):\Z+\varphi_i\End(E_i)\widehat{\varphi_i}]^2\mbox{disc}(\Z+\varphi_i\End(E_i)\widehat{\varphi_i})\]\
so that:
\[[\End(E_{i+1}):\Z+\varphi_i\End(E_i)\widehat{\varphi_i}]=[\End(E_i):\Z+\ell\End(E_i)]=\ell^3\]
\end{proof}

\begin{proposition}
Assume that $E_0$ admits a compact representation.  Then, $E_i$ admits an $\ell$-compact representation for all $i\in\i{0}{n}$ and one can deduce $\End(E_{i+1})$ from $\End(E_i)$ in polynomial time in $\log(p)$ for all $i\in\i{0}{n-1}$. Hence, one can recover $\End(E_n)$ from $\End(E_0)$ in polynomial time in $\log(p)$.
\end{proposition}

\begin{proof}
Let $i\in\i{0}{n}$ and let $\alpha_1,\cdots,\alpha_4$, $\beta_1^{(i)},\cdots,\beta_4^{(i)}$ be respectively a concise and useful $\Z$-basis of $\End(E_0)$ and a $\Z$-basis of $\End(E_i)$. Without loss of generality, we can assume that $\alpha_1=[1]_{E_0}$ and $\beta_1^{(i)}=[1]_{E_i}$. Let $\phi_i:=\varphi_{i-1}\circ\cdots\circ\varphi_0$. Then, by lemma \ref{lemma 3}, $\Z+\varphi\End(E_0)\widehat{\varphi}$ has index $\ell^{3i}$ in $\End(E_i)$ so that:
\[\beta_r^{(i)}=\frac{1}{\ell^{3i}}\sum_{s=1}^4 c_{r,s}\circ \phi_i\circ \alpha_s\widehat{\phi_i}\]
with $c_{r,1},\cdots,c_{r,4}\in\Z$ for all $r\in\i{1}{4}$.  Assuming, the $c_{r,s}$ have polynomial size in $\log(p)$, we get a compact representation of $\End(E_i)$. Indeed,  $(\beta_1^{(i)},\cdots,\beta_4^{(i)})$ is clearly concise.  

We prove the $\ell$-usefulness of this basis. Let $P\in E(k)$ with $[k:\F_p]$ polynomial in $\log(p)$ and order prime to $\ell$.  To evaluate $\beta_r^{(i)}(P)$, we first evaluate $[\ell^{3i}]\beta_r^{(i)}(P)=\sum_{s=1}^4 c_{r,s}\circ \phi_i\circ \alpha_s\widehat{\phi_i}(P)$.  First, since $\varphi_j$ has degree $\ell$ for all $j\in\i{0}{i-1}$, the $\varphi_j$ and $\widehat{\varphi_j}$ can be evaluated with $O(\ell)$ operations over $k$ (using V\'{e}lu's formulas \cite{Velu} for instance), so it can be performed in polynomial time in $\log(p)$.  Using efficient scalar multiplication techniques like double and add,  sliding windows, $w$-NAF or Yao's method, the scalar multiplication by the $c_{r,s}$ can be performed in time $O(\log(|c_{r,s}|)$, which is polynomial in $\log(p)$. $(\alpha_1,\cdots,\alpha_4)$ being useful, $[\ell^{3i}]\beta_r^{(i)}(P)$ can be evaluated in polynomial time in $\log(p)$. Knowing the order $m$ of $P$, we find an inverse $u$ of $\ell^{3i}$ modulo $m$ in time $O(\min(\log(m),\log(\ell^{3i})))$ using extended euclidean algorithm. But $\log(m)$ is polynomial in $\log(p)$ by Hasse-Weil's bound and $\log(\ell^{3i})=O(\log(p))$ since $p>|\Delta_K|\ell^{2n}$ by proposition \ref{proposition 9}, so we may find $u$ in polynomial time in $\log(p)$ and obtain $[u][\ell^{3i}]\beta_r^{(i)}(P)=\beta_r^{(i)}(P)$.  Hence the $\ell$-usefulness.

The fact that $c_{r,s}$ can be chosen in polynomial size in $\log(p)$ remains to be proved. It will follow naturally from the algorithm computing $\End(E_{i+1})$ from $\End(E_i)$. Let $\m{R}:=\End(E_{i+1})$ and $\m{R}':=\Z+\varphi_i\End(E_i)\widehat{\varphi_i}$.  Let $\gamma_r^{(i)}:=\varphi_i\circ\beta_r^{(i)}\circ\widehat{\varphi_i}$ for all $r\in\i{1}{4}$. Then, $(\gamma_1^{(i)},\cdots, \gamma_4^{(i)})$ is a $\Z$-basis of $\m{R}'$ and $[\m{R}:\m{R}']=\ell^3$ so if we fix a $\Z$-basis $(\beta_1^{(i+1)},\cdots, \beta_4^{(i+1)})$ of $\m{R}$, there is a matrix $M\in M_4(\Z)$ of determinant $\ell^3$ such that:
\[\,^t (\gamma_1^{(i)},\cdots, \gamma_4^{(i)})=M \,^t(\beta_1^{(i+1)},\cdots, \beta_4^{(i+1)})\]
Since $\gamma_1^{(i)}=1$ (by assumption, $\beta_1^{(i)}=1$) and we may assume without loss of generality, that $\beta_1^{(i+1)}=1$, the first row of $M$ is $(\begin{array}{cccc}
1 & 0 & 0 & 0
\end{array})$.  Since $\m{R}$ is determined by the basis $(\beta_1^{(i+1)},\cdots, \beta_4^{(i+1)})$ up to action by $GL_4(\Z)$, we can multiply $M$ on the right by any matrix of $GL_4(\Z)$. Hence, we can reduce $M$ to its Hermite normal form (HNF), so that $M$ is triangular inferior of the form:
\[M=\(\begin{array}{cccc}
1 & 0 & 0 & 0\\
0 & \ell^{n_1} & m_{2,3} & m_{2,4}\\
0 & 0 & \ell^{n_2} & m_{3,4} \\
0 & 0 & 0 & \ell^{n_3}
\end{array}\)\]
with $n_1,n_2,n_3\in\N$ such that $n_1+n_2+n_3=3$ and $m_{r,s}\in\i{0}{\ell^{n_r}-1}$ for all $r\in\{2,3\}$ and $s\geq r+1$. Hence, there are at most:
\[\sum_{n_1+n_2+n_3=3} \ell^{2n_1+n_2}\leq \binom{5}{2}\ell^{6}=10\ell^6\]
possible values for $M$, hence for $\langle\beta_1^{(i+1)},\cdots, \beta_4^{(i+1)}\rangle=\m{R}$. One can test each value by expressing $\beta_r^{(i+1)}\beta_s^{(i+1)}$ in the basis $(\beta_1^{(i+1)},\cdots, \beta_4^{(i+1)})$ for all $r,s\in\i{1}{4}$, in order to check if the coefficients are integer test if $\mbox{disc}(\m{R})=p^2$.  If yes, $\m{R}$ is a maximal order and one can test if $\m{R}=\End(E_{i+1})$ in polynomial time in $\log(p)$ by finding an elliptic curve $E/\F_{p^2}$ such that $\End(E)\simeq\m{R}$ using algorithm \ref{algorithm 1}, and checking if $j(E)=j(E_{i+1})$ or $j(E_{i+1})^p$, since $E_{i+1}$ is characterized by its endomorphism ring up to Galois action of the Frobenius by \cite[lemma 42.4.1]{Voight}. Note that this algorithm runs under the assumption that $(\beta_1^{(i+1)},\cdots, \beta_4^{(i+1)})$ is compact and $\ell$-useful. Expressing $M^{-1}$, we see immediately that $(\beta_1^{(i+1)},\cdots, \beta_4^{(i+1)})$ is compact and $\ell$-useful if $(\beta_1^{(i)},\cdots, \beta_4^{(i)})$ is, so we conclude by induction that it is the case if we initialize at $(\beta_1^{(0)},\cdots, \beta_4^{(0)})=(\alpha_1,\cdots,\alpha_4)$. Hence, we can compute $\End(E_{i+1})$ from $\End(E_i)$ in a bounded number of instances of a polynomial time algorithm in $\log(p)$. This completes the proof. 
\end{proof}

Now we explain how to solve the following problem, which will help us to test the different possible values for $E_{i+1}$.

\begin{problem}\label{problem 3}
Given $E_0$ and $\m{R}_0\subseteq B_{p,\infty}$ an $\ell$-compact representation of $\End(E_0)$ and a concise\footnote{Given by a $\Z$-basis with coefficients in polynomial size in $\log(p)$ in terms of $1, i, j, k$.} maximal order $\m{R}$, find $E/\F_{p^2}$ such that $\End(E)\simeq \m{R}$.
\end{problem}

We shall see that this problem can be solved in polynomial time in $\log(p)$ using the following algorithm. This algorithm is based on the Deuring correspondence between integral left $\m{R}_0$-ideals and isogenies with domain $E_0$ (see appendix \ref{paragraph 2}). 

\vspace{0.5cm}

\begin{algorithm}[H]\label{algorithm 1}
\SetAlgoLined
\KwData{$E_0$ an elliptic curve, $\m{R}_0$,  an $\ell$-compact representation of $\End(E_0)$ and $\m{R}$, a concise maximal order.}
\KwResult{$E/\F_{p^2}$ such that $\End(E)\simeq \m{R}$.}
Compute a connecting ideal $I$ between $\m{R}_0$ and $\m{R}$ (take $I:=\m{R}_0\m{R}$ and multiply it by an integer if necessary to ensure $I\subseteq \m{R}$)\;
Find an equivalent ideal $J\sim I$ of powersmooth norm using KLPT (see paragraph \ref{paragraph 3}, algorithm \ref{algorithm 2})\;
Compute the isogeny $\phi:E_0\longrightarrow E$ of kernel $E_0[J]$ using effective Deuring correspondence (see paragraph \ref{paragraph 4}, algorithm \ref{algorithm 4})\;
Return $E$\;
\caption{Algorithm to solve problem \ref{problem 3}.}
\end{algorithm}

\subsection{The KLPT algorithm}\label{paragraph 3}

We fix $\m{R}$ a concise maximal order and $I\subseteq \m{R}$ an integral and concise left $\m{R}$-ideal.  The KLPT algorithm due to Kohel, Lauter, Petit and Tignol \cite{KLPT} finds an equivalent integral ideal $J\sim I$ of powersmooth norm. The main idea of this algorithm lies in the following lemma:

\begin{lemma}\label{lemma 5}
Let  Then for all $\alpha\in I$, $J:=I\frac{\overline{\alpha}}{\mbox{nrd}(I)}$ is an integral left $\m{R}$-ideal equivalent to $I$ and $\mbox{nrd}(J)=\frac{\mbox{nrd}(\alpha)}{\mbox{nrd}(I)}$, $\mbox{nrd}$ being the reduced norm.
\end{lemma}

\begin{proof}
We have $\alpha\in I$ so $\overline{\alpha}\in \overline{I}$ and $I\overline{\alpha}\subseteq I\overline{I}$. But $I\overline{I}=\mbox{nrd}(I)\m{R}$ (by \cite[16.6.14]{Voight}), so that $J=I\frac{\overline{\alpha}}{\mbox{nrd}(I)}\subseteq \m{R}$ and $J$ is integral. 

Finally, by multiplicativity of the reduced norm \cite[lemma 16.3.7]{Voight}, we have:
\[\mbox{nrd}(J)=\mbox{nrd}(I)\mbox{nrd}\(\frac{\overline{\alpha}}{\mbox{nrd}(I)}\)=\mbox{nrd}(I)\frac{\mbox{nrd}(\alpha)}{\mbox{nrd}(I)^2}=\frac{\mbox{nrd}(\alpha)}{\mbox{nrd}(I)}\]
\end{proof}

Hence, by the preceding lemma, the goal of this algorithm is to find $\alpha\in I$ of norm $\mbox{nrd}(I)S$ where $S$ is a powersmooth integer.  The different steps of the algorithm are presented below (see algorithm \ref{algorithm 2}). For this algorithm to work, $\m{R}$ may not be any maximal order, but rather a \emph{special} order defined as follows:

\begin{definition}\label{definition 2}
We say that a maximal order $\m{R}\subseteq B_{p,\infty}$ is \emph{special} if $j\in \m{R}$ (with $j^2=-p$) and there exists a subring of rank $2$, $R\subset\m{R}$, such that $R^\bot\subseteq Rj$ for the scalar product given by:
\[(\alpha,\beta)\in B_{p,\infty}^2\longmapsto (\alpha|\beta):=\mbox{nrd}(\alpha+\beta)-\mbox{nrd}(\alpha)-\mbox{nrd}(\beta)=\mbox{Tr}(\alpha\overline{\beta})\]
\end{definition}

\begin{example}\label{example 3}
Recall the setting of example \ref{example 2}. When $p\equiv 3 \ [4]$ and $E_0: y^2=x^3+x$,  and the endomorphism ring is isomorphic to $\m{R}_0:= \langle 1,j, \frac{i+j}{2},\frac{1+k}{2}\rangle$ and we may take $R:=\Z[i]\subseteq\m{R}_0$.
\end{example}

\begin{remark}
In practice, it will be very useful to have $|\mbox{disc}(R)|$ sufficiently small, i.e.  polynomial in $\log(p)$.  For any $p$, we can always find an order $\m{R}$ with $|\mbox{disc}(R)|=O(\log(p)^2)$, and even $\mbox{disc}(R)=-4$ (as in example \ref{example 3}) and $\mbox{disc}(R)=-8$ when $p\not\equiv 1 \ [8]$ (see \cite[section 2.3]{KLPT}). We will always assume that $|\mbox{disc}(R)|=O(\log(p)^2)$ in the following.
\end{remark}

As previously announced, the following algorithm works under the hypothesis that $\m{R}$ is special but the general case can be treated using a connecting ideal to a special order and two instances of this algorithm (by \cite[theorem 9]{KLPT}).

\vspace{0.5cm}

\begin{algorithm}[H]\label{algorithm 2}
\SetAlgoLined
\KwData{A special order $\m{R}$ and an integral left $\m{R}$-ideal $I\subseteq\m{R}$.}
\KwResult{An equivalent integral ideal $J\sim I$ of powersmooth norm.}
\textbf{Step a:} Find $\delta\in I$ of norm $N\mbox{nrd}(I)$ where $N$ is a prime number $\neq p$ and compute $I':=I\overline{\delta}/\mbox{nrd}(I)$\;
\textbf{Step b:} Find $\alpha\in I'$ such that $I'=\m{R}N+\m{R}\alpha$\;
\textbf{Step c:} Find $\beta_1\in \m{R}$ of norm $NS_1$, with $S_1$ powersmooth\;
\textbf{Step d:} Find $\beta_2\in jR$ such that $\alpha\equiv\beta_1\beta_2 \ \mbox{mod} \ \m{R}N$\;
\textbf{Step e:} Find $\beta'_2\in \m{R}$ with powersmooth norm $S_2$ and $\lambda\in(\Z/N\Z)^*$ such that $\beta'_2\equiv \lambda\beta_2 \ \mbox{mod} \ \m{R}N$\;
\textbf{Step f:} Set $\beta:=\beta_1\beta'_2$ and return $J:=I'\overline{\beta}/N$\;

\caption{The KLPT algorithm}
\end{algorithm}

\subsubsection{Step a}

$\mathbb{H}:=B_{p,\infty}\otimes_{\Q}\R\simeq\R^4$ is a normed vector space for the norm associated to the scalar product of definition \ref{definition 2}, given by $\|\alpha\|^2:=2\mbox{nrd}(\alpha)$ for all $\alpha\in \mathbb{H}$. As a lattice, $I$ admits a Minkowski reduced $\Z$-basis, defined as follows:

\begin{definition}
Let $\Lambda\subseteq \R^d$ be a lattice. of rank $r$.A \emph{Minkowski reduced basis} of $\Lambda$ is a $\Z$-basis $(b_1,\cdots, b_r)$ of $\Lambda$ such that for all $i\in\i{1}{r}$, $b_i$ is the shortest vector (for the euclidean norm) such that $(b_1,\cdots, b_i)$ can be completed into a $\Z$-basis of $\Lambda$.
\end{definition}

\cite{Helfrich} provides an algorithm finding a Minkowski reduced basis $(b_1,\cdots,b_r)$ of $\Lambda$ given a basis $(e_1,\cdots,e_r)$ of $\Lambda$ when $\Lambda\subseteq \Z^d$ (we can always reduce to this case by multiplying all vectors by the lcm of their denominators). If $B:=\max_{1\leq i\leq r}\|b_i\|$, then the algorithm performs in time $O\(\(\frac{5}{4}\)^{4r^3}d\log(B)\)$ and returns an output $(b_1,\cdots,b_r)$ with integer components of size $O(r^4(r\log(r)+\log(B)))$. In the case of $I$ ($d=r=4$), since it is given by a $\Z$-basis expressed in terms of $1,i,j,k$ with a basis of size polynomial in $\log(p)$, this algorithm will perform in polynomial time in $\log(p)$ and returns an output of polynomial size in $\log(p)$.

Now, given a Minkowski reduced basis $(\alpha_1, \cdots, \alpha_4)$ of $I$, we look for $\delta:=\sum_{i=1}^4 a_i\alpha_i$ with integers $a_i\in\i{-m}{m}$ for $m\in\N^*$ well chosen.  Let $q_I:=\mbox{nrd}/\mbox{nrd}(I)$. We argue that $q_I(\delta)=O(m^2\sqrt{p})$ heuristically, and $q_I(\alpha)=O(m^2p^2)$ in the worst case.  Indeed, by \cite[Teil I.  § 7]{VDW}
%\footnote{If you want to understand anything of this article and you are not a German speaker, you can either spend a while on Google Translate... or learn God Damn German!}
the norms of the $\alpha_i$ are the successive minimas of the lattice:
\[\forall 1\leq i\leq 4, \quad \|\alpha_i\|=\lambda_i(I):=\min\{\|v_i\|\mid v_1, \cdots, v_i\in I \emph{ linearly independent } \|v_1\|\leq\cdots\leq\|v_i\|\}\]
By Minkowski's second theorem, it follows that:
\[\frac{2}{3}\frac{\mbox{Covol}(I)}{\mbox{Vol}(\B_4)}\leq \prod_{i=1}^4\|\alpha_i\|\leq 16\frac{\mbox{Covol}(I)}{\mbox{Vol}(\B_4)}\]
where $\B_4$ is the unit ball, so that $\mbox{Vol}(\B_4)=\frac{\pi^2}{2}$ and:
\[\mbox{Covol}(I)=[\mO:I]\sqrt{\mbox{disc}(\m{R})}=\mbox{nrd}(I)^2p\]
so that:
\[\frac{p^2}{9\pi^4}\leq \prod_{i=1}^4q_I(\alpha_i)\leq \frac{64p^2}{\pi^4}\]
Hence comes the heuristics $q_I(\alpha_i)=O(\sqrt{p})$, which is experimentally verified in \cite{KLPT}. Hence the heuristics $q_I(\delta)=O(m^2q_I(\alpha_4))=O(m^2\sqrt{p})$ and the output ideal $I':=I\overline{\delta}/\mbox{nrd}(I)$ has norm $N:=q_I(\delta)=O(m^2\sqrt{p})$ .


We heuristically assume that the distribution of the random variable $q_I(\delta)$ given by sampling integers $a_1,\cdots,a_4\in\i{-m}{m}$ is statistically indistinguishable from the uniform distribution on the interval $\i{q_I(\alpha_1)}{m^2 q_I(\alpha_4)}$, so for $m$ large enough, e.g. $m=\lceil \log(p)\rceil$, this interval contains prime numbers. Due to the distribution of prime numbers in $\Z$, $q_I(\delta)$ reaches a prime number after $O(\log(m^2 q_I(\alpha_4)))=O(\log(p))$ operations. 

\subsubsection{Step b}

Since $N=\mbox{nrd}(I')=\gcd\{\mbox{nrd}(\alpha)|\alpha\in I'\}$, there exists $\alpha\in I'$ such that $N^2\nmid\mbox{nrd}(\alpha)$. Finding such an $\alpha\in I'$ is sufficient. Indeed, in that case, $\alpha\not\in \m{R}N$ since $\mbox{nrd}(\m{R}N)=N^2$, so that $\m{R}N\subsetneq \m{R}N+\m{R}\alpha\subseteq I'$. It follows that $[I':\m{R}N+\m{R}\alpha]|[I':\m{R}N]$ and $[I':\m{R}N+\m{R}\alpha]<[I':\m{R}N]$ but $[I':\m{R}N]=\mbox{nrd}(\m{R}N)^2/\mbox{nrd}(I')^2=N^2$ so $[I':\m{R}N+\m{R}\alpha]\in \{1,N\}$. Since $[I':\m{R}N+\m{R}\alpha]$ is a square, we must have $[I':\m{R}N+\m{R}\alpha]=1$ i.e. $I'=\m{R}N+\m{R}\alpha$.

Finding a suitable element $\alpha$ can be done in $O(1)$ sampling operations on a basis of $I'$ with small coefficients (e.g., in $O(\log(p))$).  Indeed, by similar combinatoric arguments we gave above, we get that every $\alpha\in I'$ such that $N^2|\mbox{nrd}(\alpha)$ are in $\m{R}N$, but $[I':\m{R}N]=N^2$ so the probability that $N^2|\mbox{nrd}(\alpha)$ is negligible.

\subsubsection{Step c}

We fix $S_1$ a powersmooth number (actually,  other conditions could be required) and look for $\beta_1\in\m{R}$ of norm $NS_1$. We restrict to $\beta_1\in R+jR$ to use the fact that $R^\bot=jR$.  Indeed, writing $R=\Z[\omega]$ for a given generator $\omega\in R$, and writing $\beta_1=x_1+\omega y_1+j(x_2+\omega y_2)$ with $x_1, y_1, x_2, y_2\in\Z$, we get that:
\[\mbox{nrd}(\beta_1)=f(x_1,y_1)+pf(x_2,y_2)\]
where $f$ is the quadratic form $f(x,y):=x^2-t xy+s$ with $t:=\mbox{Tr}(\omega)$ and $s=\mbox{nrd}(\omega)$, of discriminant $\Delta:=t^2-4s=\mbox{disc}(R)$.  By choice of $\omega$, we can always assume that $t=-1$ when $\Delta\equiv 1 \ [4]$ and $t=0$ when $\Delta\equiv 0 \ [4]$, so that $f$ is the principal form.  

Let $M:=NS_1$. Solving the equation $\mbox{nrd}(\beta_1)=M$ will be done in two steps: first finding $x_2,y_2\in\Z$ such that $f(x_1,y_1)=M-pf(x_2,y_2)$ has a solution, and second solve the equation in $x_1,y_1\in\Z$.  The first condition to find a solution is $pf(x_2,y_2)<M$. Let $\Phi$ be an increasing function such that $|\Delta|<\Phi(M)<\frac{M}{p}$. To make sure this condition holds, we take $S_1$ big enough $S_1=\Omega(\sqrt{p})$, so that $M=\Omega(p)$, and $\Phi(x)=\log(x)^e$, where $e\in\N$ is such that $|\Delta|=o(\log(p)^e)$.  We restrict the sampling of $x_2, y_2$ to the interval $\i{-\lfloor\sqrt{\Phi(M)/|\Delta|}\rfloor+1}{\lfloor\sqrt{\Phi(M)/|\Delta|}\rfloor-1}$, so that:
\[f(x_2,y_2)=\(x_2-\frac{t}{2}y_2\)^2+\frac{|\Delta|}{4}y_2^2<\Phi(M)\(\frac{1}{|\Delta|}\(1-\frac{t}{2}\)^2+\frac{1}{4}\)\leq \Phi(M)\]
since $t\in\{-1,0\}$ and $|\Delta|\geq 3$, and finally $pf(x_2,y_2)<p\Phi(M)<M$. 

To find a solution $(x_1,y_1)$ to the equation :
\[f(x_1,y_1)=M-pf(x_2,y_2)\quad (\star)\]
(and check whether there exists one or not), we use an algorithm introduced in \cite[§ 46, pp. 73-75]{Dickson} based on Gauss reduction of integer quadratic forms (see algorithm \ref{algorithm 3} in appendix \ref{paragraph 5}), which is polynomial in $\log(p)$ with the chosen input values. Let $u:=M-pf(x_2,y_2)$. Then $(\star)$ admits a solution if and only if $\Delta$ is a square mod $4u$ and the form $g_u(x,y):=ux^2+vxy+wy^2$ is equivalent to $f$ (where $v\in\i{0}{2u}$ is a square root of $\Delta$ mod $4u$ and $v^2-4uw=\Delta$).  Since $\Delta\equiv 0, 1 \ [4]$,  the condition $\Delta$ is a square mod $4u$ is equivalent to $\Delta$ is a square mod $u$. In order to be able to find a square root $v$ of $\Delta$ by Tonelli-Shanks algorithm \cite[algorithm 1.5.1]{Cohen1}, we require $u$ to be prime. By Dirichlet's arithmetic progression theorem, the density of primes congruent to $M$ mod $p$ is $\frac{1}{p-1}$, which is very close to the density of integers congruent to $M$ mod $p$ (which is $\frac{1}{p}$). Hence, we can heuristically assume that the probability to find $u\in [M-p\Phi(M),M]$ prime is approximately $1/\log(M)$ when we sample  $x_2,y_2$. Assuming the distribution of the class $[g_u]$ among the classes of forms of discriminant $\Delta$ is uniform when sampling $x_2,y_2$, we expect to find a solution after $h(\Delta)\log(M)$ tests, so in a polynomial time in $\log(p)$ since $\Delta$ is polynomial in $\log(p)$ and solving $(\star)$ can be done in polynomial time in $\log(p)$. 

\subsubsection{Step d}

We look for $\beta_2\in jR$ such that $\alpha\equiv\beta_1\beta_2 \ \mbox{mod} \ \m{R}N$, or equivalently, we look for an equivalence class $[\beta_2]\in jR/\m{R}N$ such that $I'/\m{R}N=(\m{R}/\m{R}N)[\beta_1][\beta_2]$.  We have a group action of $(R/NR)^\times$ on the proper non-zero left-ideals of $\m{R}/N\m{R}$ by multiplication on the right. Hence, restricting our search to invertible elements, in order to find $[\beta_2]\in [j](R/NR)^\times $, $I'/N\m{R}$ needs to be in the orbit of $(\m{R}/N\m{R})[\beta_1][j]$.

\begin{lemma}\label{lemma 4}
\begin{itemize}
\item[(i)] $\m{R}/N\m{R}\simeq (R+jR)/N(R+jR) \simeq M_2(\Z/N\Z)$.
\item[(ii)] The proper non-zero left-ideals of $M_2(\Z/N\Z)$ are all principal and generated by a matrix of the form:
\[M_{a,b}:=\(\begin{array}{cc}
a  & b\\ 0 & 0
\end{array}\)\]
with $(a,b)\in(\Z/N\Z)^2\setminus\{0\}$.  

Moreover, for $(a,b),(a',b')\in(\Z/N\Z)^2\setminus\{0\}$, the matrices $M_{a,b}$ and $M_{a',b'}$ generate the same ideal if and only if the equality of classes $(a:b)=(a':b')$ holds in $\P^1(\Z/N\Z)$ ($\exists \lambda\in(\Z/N\Z)^*, \ (a,b)=\lambda\cdot(a',b')$). Hence, there are $N+1$ proper non-zero left-ideals in $M_2(\Z/N\Z)$.

\item[(iii)] There exists an orbit of at least $N-2$ elements under the action of $(R/NR)^\times$ on proper left-ideals of $\m{R}/N\m{R}$.
\end{itemize}
\end{lemma}

\begin{proof}
\textbf{(i)} We have $B_{p,\infty}\otimes\Q_N\simeq M_2(\Q_N)$ since $N$ does not ramify in $B_{p,\infty}$.  Hence, the inclusion $\m{R}\subseteq B_{p,\infty}$ induces an injection $\m{R}\hookrightarrow M_2(\Z_N)$. Taking the quotient modulo $N$, we get an injection $\m{R}/N\m{R}\hookrightarrow M_2(\Z/N\Z)$. But $|\m{R}/N\m{R}|=N^4=|M_2(\Z/N\Z)|$ so $\m{R}/N\m{R}\simeq M_2(\Z/N\Z)$.

A similar reasoning ensures that $(R+jR)/N(R+jR) \simeq M_2(\Z/N\Z)$ as well.

\textbf{(ii)} Let $I$ be a proper non-zero left-deal of $M_2(\Z/N\Z)$. Then $I$ contains a non-zero element $M$. $M$ has rank $1$, otherwise it would be invertible and we would have $I=M_2(\Z/N\Z)$, contradicting the properness of $I$. Since $I$ is a left-ideal, we can change $M$ by left operations. Hence, swapping rows if necessary so that the first is non-zero and eliminating the second, we get $M$ of the desired form $M=M_{a,b}$ for $(a,b)\in(\Z/N\Z)^2\setminus\{0\}$.

If $M'\in I$ is another non-zero matrix of $I$, we get that $M'=PM_{a',b'}$ for $(a',b')\in(\Z/N\Z)^2\setminus\{0\}$ and $P\in GL_2(\Z/N\Z)$. If $(a',b')$ and $(a,b)$ where linearly independent, swapping the rows $M_{a',b'}=P^{-1}M'\in I$ and adding $M_{a,b}$, we get that:
\[\(\begin{array}{cc}
a& b\\
a'& b'
\end{array}\)\in I\cap GL_2(\Z/N\Z)\]
contradicting the properness of $I$. Hence  $M'=PM_{a',b'}=\lambda PM_{a,b}$ where $\lambda\in(\Z/N\Z)^*$ is such that $(a',b')=\lambda\cdot(a,b)$, so $I$ is principal and generated by $M_{a,b}$. We also have obtained that every matrix $M_{a',b'}$ generating $I$ verifies $(a:b)=(a':b')$, completing the proof of point (ii).

\textbf{(iii)} $N$ does not ramify in $R$ since $N\nmid |\mbox{disc}(R)|$. Indeed, $|\mbox{disc}(R)|$ is polynomial in $\log(p)$ while $N=\Omega(\sqrt{p})$, according to the heuristics of step c. Hence $(R/NR)\simeq\F_{N^2}$ if $N$ is inert in $R$ and $(R/NR)\simeq(\Z/N\Z)^2$ if $N$ splits in $R$. It follows that $|(R/NR)^\times|\geq (N-1)^2$, so that all elements of $(R/NR)^\times$ are not in $(\Z/N\Z)^*$. 

Let $[\mu]\in (R/NR)^\times\setminus(\Z/N\Z)^*$.  Using the isomorphism $\m{R}/N\m{R}\simeq M_2(\Z/N\Z)$, we identify $[\mu]$ with a matrix:
\[\(\begin{array}{cc}
a & b\\
c & d
\end{array}\)\in GL_2(\Z/N\Z)\]
Let $[\lambda]\in\m{R}/N\m{R}$ corresponding to the matrix $M_{1,0}$. Then, $[\lambda]([\mu]+\nu)$ corresponds to $M_{a+\nu,b}$ for all $\nu\in\Z/N\Z$ but $[\mu]+\nu\in (R/NR)^\times$ if and only if $[\mu]+\nu$ is invertible i.e. $\nu$ is not a root of the characteristic polynomial of $[\mu]$. So $\nu$ can take at least $N-2$ values.Since $\nu\in \Z/N\Z\longmapsto (a+\nu:b)\in\P^1(\Z/N\Z)$ is injective, it follows that the orbit of $[\lambda]$ has at least $N-2$ elements.
\end{proof}

By lemma \ref{lemma 4}, $(\m{R}/N\m{R})[\beta_1][j]$ and $I'/N\m{R}$ will be in the same orbit with probability $\geq \frac{N-2}{N+1}$, which is overwhelming so the equation $\alpha\equiv\beta_1\beta_2 \ \mbox{mod} \ \m{R}N$ will almost always admit a solution $\beta_2\in jR$. If it is not the case, we can always repeat steps b and c. The equation can be solved in polynomial time in $\log(p)$, simply using linear algebra in a $\Z$-basis of $\m{R}$.

\subsubsection{Step e}

We are looking for $\lambda\in\i{0}{N-1}$ and $\gamma\in\m{R}$ such that $\beta'_2:=\lambda\beta_2+N\gamma$ has powersmooth norm $S_2$.  We restrict to $\gamma\in R+jR$. Let us write $\beta_2:=j(C+D\omega)$ and $\gamma:=a+b\omega+j(c+d\omega)$ with $C, D, a,b,c,d\in\Z$. We want to solve the equation:
\[S_2=\mbox{nrd}(\beta'_2)=N^2f(a,b)+pf(\lambda C+Nc,\lambda D+Nd)\quad (\star)\]
where $\lambda,a,b,c,d\in\Z$ are unknown, where $f(x,y):=x^2-txy+sy^2$ with $t:=\mbox{Tr}(\omega)$ and $s:=\mbox{nrd}(\omega)$. 

First, we reduce this equation modulo $N$: $\lambda^2 p f(C,D)\equiv S_2 \ [N]$. This equation has a solution if and only if $p f(C,D) S_2$ is a square modulo $N$, so we may chose $S_2$ to ensure it and find $\lambda\not\equiv 0 \ [N]$ in time $O(\log^4(N))=O(\log^4(p))$ by Tonelli-Shanks algorithm \cite[algorithm 1.5.1]{Cohen1}.  

Now reducing $(\star)$ mod $N^2$ and factoring by $N$, we get:
\[\lambda(2C-tD)c+\lambda(2sD-tC)d\equiv \frac{S_2-\lambda^2 p f(C,D)}{N} \ [N]\quad (\star\star)\]
We have $\lambda\not\equiv 0 \ [N]$, and $(2C-tD)(2sD-tC)\not\equiv 0 \ [N]$ with overwhelming probability (and if it is the case, we can always repeat steps c and d until this condition is satisfied). As a consequence, the equation above has $N$ solutions modulo $N$ and we can determine all of them in time $O(\log^2(N))=O(\log^2(p))$ using extended Euclid algorithm.  We pick one of them at random satisfying:
\[|\lambda C+Nc|\leq N^2 \qquad \mbox{and} \qquad |\lambda D+Nd|\leq N^2\]
so that:
\[f(\lambda C+Nc,\lambda D+Nd)\leq N^2\(\(1-\frac{t}{2}\)^2+\frac{|\Delta|}{4}\)\leq N^2\frac{9+|\Delta|}{4}\leq |\Delta|N^2\]
to make sure $S_2-pf(\lambda C+Nc,\lambda D+Nd)>0$, we may have chosen $S_2>p|\Delta|N^2$ from the beginning. We repeat the sampling of $c,d$ among the solutions of $(\star\star)$ until $(S_2-pf(\lambda C+Nc,\lambda D+Nd))/N^2$ is a prime. Assuming the distribution of the random values we get is fairly uniform, we find a prime in approximately $\log(p|\Delta|N^2)$ sampling operations. We then solve:
\[f(a,b):=\frac{S_2-pf(\lambda C+Nc,\lambda D+Nd)}{N^2}\]
using algorithm \ref{algorithm 3}. If this equation has no solution, we repeat the sampling again. On the hole, we need $h(\Delta)\log(p|\Delta|N^2)=\tilde{O}(\log(p))$ test to find a solution. Hence, step e is polynomial in $\log(p)$.

\subsubsection{Step f}

Let $\beta:=\beta_1\beta'_2$. Then, $\beta\equiv \lambda\beta_1\beta_2 \ \mbox{mod} \ \m{R}N\equiv \lambda\alpha \ \mbox{mod}\ \m{R}N$. Since $\m{R}N\subseteq I'$, it follows that $\beta\in I'$. Hence $J:=I'\overline{\beta}/N$ is an integral left-ideal of norm $\mbox{nrd}(J)=\mbox{nrd}(\beta)/N=S_1S_2$ by lemma \ref{lemma 5}, which is powersmooth. 

\subsection{Effective Deuring correspondence}\label{paragraph 4}

Given an elliptic curve $E_0$ of known endomorphism ring $\m{R}_0$ admitting an $\ell$-compact representation and a left ideal $I\subseteq \m{R}_0$ of powersmooth norm prime to $\ell$, we want to compute the isogeny $\phi_I : E_0\longrightarrow E$ of kernel $E_0[I]$ defined by Deuring correspondence (see appendix \ref{paragraph 5}). The algorithm we present here is due to \cite{Galbraith2016}. The authors chose to present it in the case of example \ref{example 3} ($p\equiv 3 \ [4]$, $E_0:y^2=x^3+x$ and $\m{R}_0=\left \langle 1, j,\frac{i+j}{2},\frac{1+k}{2}\right\rangle$). Our presentation is simply a generalization.

We write $I:=\langle\alpha_1,\alpha_2,\alpha_3,\alpha_4\rangle$ where the $\alpha_i$ are $\ell$-useful and concise, i.e. written in an $\ell$-useful and concise $\Z$-basis of $\m{R}_0$ (as defined in paragraph \ref{paragraph 6}) with coefficients of polynomial size in $\log(p)$.  In particular, the $\alpha_i$ can be evaluated in polynomial time in $\log(p)$ at any point of $E_0$ of order prime to $\ell$ defined over a field extension of $\F_p$ of polynomial degree in $\log(p)$.  

Let us write $\mbox{nrd}(I):=\prod_{i=1}^r \ell_i^{e_i}$, with $\ell_1, \cdots,\ell_r$ prime numbers $\neq \ell, p$ and $e_1,\cdots, e_r\in\N^*$. We assume that the $\ell_i^{e_i}$ are all bounded by an integer $B\in\N^*$.  Since $|\ker(\phi_I)|=\deg(\phi_I)=\mbox{nrd}(I)$ is exponentially large in $\log(p)$, one cannot describe $\phi_I$ via its kernel or formulas. The algorithm represents $\phi_I$ as a chain of isogenies $\phi_i : E_{i-1}\longrightarrow E_{i}$ for $i\in\i{1}{r}$ such that $\deg(\phi_i)=\ell_i^{e_i}$ for all $i\in\i{1}{r}$ and $E_r=E$. 

Factoring $I$ by integers if necessary, we may assume that $E[I]$ is cyclic. Then, for all $i\in\i{1}{r}$, there exists $R_i\in E_0[\ell_i^{e_i}]$ of order $\ell_i^{e_i}$ such that $\alpha_k(R_i)=0$ for all $k\in\i{1}{4}$. Then $\sum_{i=1}^rR_i$ is of $E_0$ order $\prod_{i=1}^r \ell_i^{e_i}=\mbox{nrd}(I)$ and in $E_0[I]$ so it generates $E_0[I]$. We may then define the $\phi_i$ as follows: $\phi_0:=[1]_{E_0}$ and for all $i\in\i{1}{r}$, $\ker(\phi_i)=\langle\phi_{i-1}\circ\cdots\circ\phi_0(R_i)\rangle$. (using V\'{e}lu's formulas \cite{Velu}). Indeed,  by induction, for $i\in\i{1}{r}$, $\phi_{i-1}\circ\cdots\circ\phi_1(R_i)$ has order $\ell_i^{e_i}$ since $\phi_{i-1}\circ\cdots\circ\phi_0$ has degree $\prod_{j=1}^{i-1}\ell_j^{e_j}$, which is prime to $\ell_i^{e_i}$ so $\phi_i$ has degree $\ell_i^{e_i}$. Moreover, $\ker(\phi_r\circ\cdots\circ\phi_0)\supseteq \langle\sum_{i=1}^rR_i\rangle$ and we have an equality by a degree argument so that $\phi_I=\phi_r\circ\cdots\circ\phi_0$.

Hence, the following algorithm:

\vspace{0.5cm}

\begin{algorithm}[H]\label{algorithm 4}
\SetAlgoLined
\KwData{$E_0$ an elliptic curve, $\m{R}_0$,  an $\ell$-compact representation of $\End(E_0)$ and $I\subseteq \m{R}_0$ a left-ideal of powersmooth norm $\mbox{nrd}(I)=\prod_{i=1}^r \ell_i^{e_i}$ prime to $\ell$ and $p$, with a concise $\Z$-basis $(\alpha_1,\cdots,\alpha_4)$.}
\KwResult{The isogeny associated to $I$: $\phi_I: E_0\longrightarrow E$, expressed as a product $\phi_I=\phi_r\circ\cdots\circ\phi_1$, with $\deg(\phi_i)=\ell_i^{e_i}$ for all $i\in\i{1}{r}$.}
$\phi_0:=[1]_{E_0}$\;
\For{$i=1$ \KwTo $r$}{
Find $(P_i,Q_i)$, a $\Z/\ell_i^{e_i}\Z$-basis of $E_0[\ell_i^{e_i}]$ using algorithm \ref{algorithm 5}\;
Find $a,b\in(\Z/\ell_i^{e_i}\Z)$ such that $R_i:=aP_i+bQ_i$ has order $\ell^i$ and $\alpha_k(R_i)=0$ for $k\in\i{1}{4}$. This can be done by finding the discrete logarithm of $(\alpha_k(Q_i))_{1\leq k\leq 4}$ in the group $E_0^4$ with basis $(\alpha_k(P_i))_{1\leq k\leq 4}$ (in this case $b=1$), and if it fails,  finding the discrete logarithm of $(\alpha_k(P_i))_{1\leq k\leq 4}$ with basis $(\alpha_k(Q_i))_{1\leq k\leq 4}$ (in this case $a=1$)\;
Compute $S_i:=\phi_{i-1}\circ\cdots\circ\phi_0(R_i)$\;
Compute the isogeny $\phi_i: E_{i-1}\longrightarrow E_i$ with kernel $\langle S_i\rangle$ by V\'{e}lu's formulas\;
}
Return $\phi_1, \cdots, \phi_r$\;
\caption{Effective Deuring correspondence}
\end{algorithm}

\vspace{0.5cm}

\begin{algorithm}[H]\label{algorithm 5}
\SetAlgoLined
\KwData{$E_0/\F_{p^2}$ an elliptic curve and $N$ a (relatively small) integer prime to $p$.}
\KwResult{A $\Z/N\Z$-basis $(P,Q)$ of $E_0[N]$.}
Find a root $x\in\overline{\F_p}$ of the $N$-th division polynomial $\Psi_N^2(X)$\;
Find $y\in\overline{\F_p}$ such that $(x,y)\in E_0$ and set $P:=(x,y)$\;
Compute $\mbox{order}(P)$\;
\While{$\mbox{order}(P)\neq N$}{
Find a \textbf{new} root $x\in\overline{\F_p}$ of $\Psi_N^2(X)$\;
Find $y\in\overline{\F_p}$ such that $(x,y)\in E_0$ and set $P:=(x,y)$\;
Compute $\mbox{order}(P)$\;
}
Find a \textbf{new} root $x'\in\overline{\F_p}$ of $\Psi_N^2(X)$\;
Find $y'\in\overline{\F_p}$ such that $(x',y')\in E_0$ and set $Q:=(x',y')$\;
Compute $\mbox{order}(e_N(P,Q))$\;
\While{$\mbox{order}(e_N(P,Q))\neq N$}{
Find a \textbf{new} root $x'\in\overline{\F_p}$ of $\Psi_N^2(X)$\;
Find $y'\in\overline{\F_p}$ such that $(x',y')\in E_0$ and set $Q:=(x',y')$\;
Compute $\mbox{order}(e_N(P,Q))$\;
}
Return $(P,Q)$\;
\caption{Computing the basis of a torsion subgroup}
\end{algorithm}

\subsection{Step 2: find a connecting ideal between $\End(E_n)$ and $\End(F_n)$}

Knowing $\ell$-concise representations $\m{R}$ and $\m{R}'$ (as maximal order of $B_{p,\infty}$) of $\End(E_n)$ and $\End(F_n)$ respectively, we obtain an $\ell$-concise representation of their product $I:=\m{R}\m{R}'$ which is a connecting left-$\m{R}$-ideal.  We compute a $\Z$-basis of $I$ in polynomial time in $\log(p)$ by Gauss reduction. To make $I$ integral, we may multiply this basis by an integer of size $O(\log(p))$, so that the basis remains $\ell$-concise.

\subsection{Step 3: find an equivalent ideal $J$ to $I$ that is generated by a prime ideal $\mf{N}$ of $\mO_n$}

As in step a of KLPT (algorithm \ref{algorithm 2}), we can find $\delta\in I$ of norm $N\mbox{nrd}(I)$ with $N\neq p$ prime and $N=O(\sqrt{p}\log^2(p))$ (in general), in time $O(\log(p))$. By lemma \ref{lemma 5}, $J:=I\overline{\delta}/\mbox{nrd}(I)\sim I$ is integral and $\mbox{nrd}(J)=N$.

We now prove that $J$ is generated by a prime ideal of $\mO_n$ lying above $N$. We may assume that $\m{R}\simeq\End(E_n)$ is special as defined in \ref{definition 2} with $R=\mO_n$. Indeed,  we usually take for $E_0$ the elliptic curve of equation $y^2=x^3+x$ with $p\equiv 3 \ [4]$, $K=\Q(i)$ with $i^2=-1$ and $\mO_K=\Z[i]\subseteq \End(E_0)\simeq \langle 1,j, \frac{i+j}{2},\frac{1+k}{2}\rangle$ (see example \ref{example 3}). Since $\mO_K\subseteq (j\mO_K)^\bot$, $\End(E_0)$ is special for $R=\mO_K$. The inclusion $\Z+\ell^n\End(E_0)\hookrightarrow \End(E_n)\simeq \m{R}$ ensures that $\m{R}$ is special with $R=\Z+\ell^n\mO_K=\mO_n$.

Let $\m{S}$ be the suborder $\mO_n\oplus j\mO_n$ in $\m{R}$. Then, $J\cap\m{S}=J\cap\mO_n\oplus(J\cap j\mO_n)$ is a left $\m{S}$-ideal and we have a natural injective ring homomorphism $\m{S}/J\cap\m{S}\hookrightarrow \m{R}/J$. It follows that $[\m{S}:J\cap\m{S}]|[\m{R}:J]=N^2$. Besides, by orthogonality of $\mO_n$ and $j\mO_n$, we have a group homomorphism: 
\[\m{S}/J\cap\m{S}\simeq \mO_n/J\cap\mO_n\times j\mO_n/J\cap j\mO_n\]
so that $[\m{S}:J\cap\m{S}]=[\mO_n:J\cap\mO_n][j\mO_n:J\cap j\mO_n]$. We obviously have, $[\mO_n:J\cap\mO_n]>1$, otherwise, $1\in J$ so $J=\m{R}$ and $\mbox{nrd}(J)=1\neq N$, so $[\mO_n:J\cap\mO_n]=N$ or $N^2$. In the latter case, $[j\mO_n:J\cap j\mO_n]=1$ so $j\in J$. But $\mbox{nrd}(j)=p$ and $N\nmid p$. Contradiction.  So $[\mO_n:J\cap\mO_n]=N$ and $J\cap\mO_n$ is a prime ideal of norm $N$ in $\mO_n$.

Hence, according to the following lemma, we can find an element $\alpha\in J\cap \mO_n$ such that $\gcd(\mbox{nrd}(\alpha),N^2)=N$ in polynomial time in $\log(p)$.  It follows that $J=\m{R}N+\m{R}\alpha=\m{R}\cdot J\cap\mO_n$ as in step b of KLPT (algorithm~\ref{algorithm 2}).

\begin{lemma}
Let $\mf{N}$ be an ideal of $\mO_n$ of prime norm $N$. Then, there exists $\alpha\in \mf{N}$ such that $\gcd(N(\alpha),N^2)=N$ and $\mf{N}=\langle N,\alpha\rangle$. One can find $\alpha$ in time $O(\log^4(N))$.
\end{lemma}

\begin{proof}
Let $\theta\in K$ be a generator of $\mO_K$, $t:=\mbox{Tr}(\theta)$ and $s:=N(\theta)$. Since $\mf{N}$ has norm $N$, $N$ is not inert in $K$ so there is a root $\lambda\in\Z$ of the reduction modulo $N$ of the minimal polynomial of $\theta$: $\Pi_\theta:=X^2-tX+s$ such that $\mf{N}=\langle N,\ell^n(\theta-\lambda)\rangle$, so we may set $\alpha:=\ell^n(\theta-\lambda)$. Then, we have:
\[N(\alpha)=\ell^{2n}(\lambda^2-t\lambda+s)=\ell^{2n}\Pi_\theta(\lambda)\equiv 0 \ [N]\]
Since $\ell\nmid N$, if $N(\alpha)\equiv 0 \ [N^2]$, then $\Pi_\theta(\lambda)\equiv 0 \ [N^2]$ and:
\[N(\alpha+N)=\ell^{2n}((\lambda+N)^2-t(\lambda+N)+s)=\ell^{2n}(\Pi_\theta(\lambda)+N\Pi'_\theta(\lambda)+N^2)\equiv \ell^{2n}N\Pi'_\theta(\lambda) \ [N^2]\]
but $\Pi'_\theta(\lambda)\neq 0 \ [N]$, since $N$ does not divide $\Delta_K$ (recall that $N=\Omega(\sqrt{p})$ is big and that $\Delta_K$ is small). Hence, $\gcd(N(\alpha+N),N^2)=N$.  

To find $\alpha$, the dominant operation is finding the roots of $\Pi_\theta$ modulo $N$.  This can be done with Tonelli-Shanks \cite[algorithm 1.5.1]{Cohen1} algorithm, computing a square root of $\Delta_K$, in time $O(\log^4(N))$.
\end{proof}

\subsection{Step 4: find an ideal of powersmooth norm equivalent to $\mf{N}$}

\subsubsection{A first subexponential attack based on elements with powersmooth norms}

We are looking for an ideal $\mf{a}$ of $\mO_n$, equivalent to $\mf{N}$, expressed as a product of small prime ideals of small prime norms with small exponents, ideally, as a product of the $\mf{q}_j$.  The naive method, is to solve an extended discrete logarithm problem (see definition \ref{definition 3}) in $\mbox{Cl}(\mO_n)$ in the basis $(\mf{q}_1, \cdots, \mf{q}_t)$, namely to find $e_1, \cdots, e_t\in\Z$ such that:
\[\prod_{j=1}^t[\mf{q}_j]^{e_j}=[\mf{N}]\]
Unfortunately, the best known algorithm to solve this problem is Teske's algorithm \cite{Teske} (presented in appendix \ref{paragraph 10}, proposition \ref{proposition 8}), running in time $O\(n\lceil \sqrt{\ell}\rceil^t\)$, which is exponential in $t$.

There exists a subexponential alternative to this method. Not that lemma \ref{lemma 5} still holds for ideal in quadrqtic imaginary orders. Namely, if $\beta\in\mf{N}$, then $\mf{a}:=\mf{N}\overline{\beta}/N$ is an ideal of $\mO_n$ of norm $N(\beta)/N$. Hence, it suffices to find $\beta\in \mf{N}$ such that $N(\beta)/N$ is powersmooth. Reusing the notations of step 3, we write $\mf{N}=N\Z+\alpha\Z$, where $\alpha\in\mf{N}$ is known. Let $q_{\mf{N}}$ be the form associated to $\mf{N}$, given by $q_{\mf{N}}(x,y):=N(Nx+\alpha y)/N$ for all $x, y\in\Z$. Writing $\beta:=Nx+\alpha y$, we get $q_{\mf{N}}(x,y)=N(\beta)/N$ so we look for a powersmooth integer reprsented by $q_{\mf{N}}$.

$q_{\mf{N}}$ has disciminant $\Delta_n:=\mbox{disc}(\mO_n)=\ell^{2n}\Delta_K$, and we have for all $(x,y)\in\Z$:
\[q_{\mf{N}}(x,y)=N\(\(x+\frac{\mbox{Tr}(\alpha)}{2N}y\)^2+\frac{|\Delta_n|}{4N^2}y^2\)\geq \frac{|\Delta_n|}{4N}y^2\]
Since $|\Delta_n|=\Omega(\ell^{2n})=\Omega(p)$ and $N=\tilde{O}(\sqrt{p})$ in general, we have $q_{\mf{N}}(x,y)=\tilde{\Omega}(\sqrt{p})$ whenever $y\neq 0$ (which is always the case when $q_{\mf{N}}(x,y)$ is powersmooth, because otherwise, it would be divisible by $N$).  If $x,y\in\i{-m}{m}$, we also have $q_{\mf{N}}(x,y)=O(m^2\sqrt{p})$.  In the following we shall assume that $m=O(p^{\frac{1}{4}})$.

We heuristically assume that $q_{\mf{N}}(x,y)$ is close to the uniform in $\i{A}{B}$ (with $A=O(\sqrt{p})$ and $B=O(m^2\sqrt{p})=O(p)$) when $(x,y)$ is uniform in $\i{-m}{m}^2$. Hence, given an integer $C\in\N^*$ to be chosen,  we estimate the number $\psi_*(A,B,C)$ of $C$-powersmooth integers\footnote{Integers whose prime power divisors are $\leq C$.} in the interval $\i{A}{B}$.  Since no asymptotic estimate of $\psi_*(A,B,C)$ is known today,  we assume that $C$ is sufficiently large so that $\psi_*(A,B,C)$ is close to $\psi(A,B,C)$, the number of $C$-smooth\footnote{Integers whose prime divisors are $\leq C$.} integers in the interval $\i{A}{B}$.  We have:
\[\psi(A,B,C)=\psi(B,C)-\psi(A,C)\quad (1)\]
with $\psi(a,b):=\psi(1,a,b)$ for all $a, b\in\N^*$. By \cite[theorem 1]{Hildebrand}, we have:
\[\psi(a,b)=a\rho\(\frac{\log(a)}{\log(b)}\)\(1+O\(\frac{\log(\log(a)/\log(b)+1)}{\log(b)}\)\)\quad (2)\]
under the conditions $b>\exp\((\log\log(a))^{\frac{5}{3}+\varepsilon}\)$, with $\varepsilon>0$ and $\rho$ the Dickman function, given by:
\[\forall u\in [0,1], \quad \rho(u):=1 \qquad \mbox{and}\qquad \forall u\in]1,+\infty], \quad -u\rho'(u)=\rho(u-1)\]
By \cite[§ 3.9]{Granville}, we have:
\[\rho(u)=\exp(-u\log(u)+o(u)) \quad \mbox{as } u\longrightarrow +\infty\quad (3)\] 
For $\theta\in ]0,1[$,  we set: 
\[C:=\exp\(\log(B)^{1-\theta}\log\log(B)\)=\exp\(O\(\log(p)^{1-\theta}\log\log(p)\)\)\]
so that the conditions for $(2)$ to hold are met, and we get the density of $C$-smooth numbers, by combining $(1)$, $(2)$ and $(3)$:
\[\frac{\psi(A,B,C)}{B-A}=\exp(-O(\log(p)^\theta))\]
Hence, we get the following result: 

\begin{lemma}
Let $C:=\exp\(O\(\log(p)^{1-\theta}\log\log(p)\)\)$. Then, one can find an ideal $\mf{a}$ equivalent to $\mf{N}$ of $C$-powersmooth norm $S=O(p)$ prime to $\ell$ in subexponential time $\exp(O(\log(p)^\theta))$. 
\end{lemma}

Then, we can factor $\mf{a}$ into prime ideals: 
\[\mf{a}=\prod_{i=1}^s \mf{l}_i^{e_i}\]
using algorithm \ref{algorithm 6} and then apply the techniques of paragraph \ref{paragraph 1} to compute the action the $\mf{l}_i$ (hence the action of $\mf{a}$) on any descending $\ell$-isogeny chain of length $n$ (in order to recover the shared secret). The dominant step in algorithm ??? (in terms of complexity) is the factorization of $S:=\mbox{nrd}(\mf{a})$,  using the general number field Seive (see \cite[§ 10.5]{Cohen1}) whose complexity is:
\[\exp\(O\(\log(S)^{\frac{1}{3}}\log\log(S)^{\frac{2}{3}}\)\)=\exp\(O\(\log(p)^{\frac{1}{3}}\log\log(p)^{\frac{2}{3}}\)\)\]
by \cite{MicrosoftGNFS}. All the other steps are polynomial in $\log(p)$.  

Without loss of generality, we can assume that all the $\mf{l}_i$ are not principal (since principal ideals act as endomorphisms). Hence, for all $i\in\i{1}{s}$,  $\mf{l}_i$ has prime norm $\ell_i\neq\ell, p$ (since $S\wedge \ell=1$). To compute the action of $\mf{l}_i$ on any descending $\ell$-isogeny chain of length $n$, one has to compute the modular polynomials $\Phi_{\ell_i}$ modulo $p$.  This can be done in time $O(\ell_i^{4+o(1)}\log(p)^{2+o(1)}+\log^4(p)\log\log(p))$ under the Generalized Riemann Hypothesis (GRH), with an algorithm due to Charles and Lauter \cite{LauterModPol}. Since $\ell_i\leq C$, this algorithm runs in time $\exp\(O\(\log(p)^{1-\theta}\log\log(p)\)\)$. Then, the computation of the $\ell_i$-ladder obtained by action of $\mf{l}_i$ can be performed with $O(n(\ell_i^2+\log^4(p)))$ operations over $\F_p$. Since $\ell_i\leq C$, and $n=O(\log(p))$, it follows that the action of $\mf{l}_i$ can be computed in time $\exp\(O\(\log(p)^{1-\theta}\log\log(p)\)\)$. Since the number of factors of $\mf{a}$ (with multiplicity) is $O(\log(S))=O(\log(p))$, computing the action of $\mf{a}$ on the chain can still be done in time $\exp\(O\(\log(p)^{1-\theta}\log\log(p)\)\)$.

\begin{theorem}
Let $C:=\exp\(O\(\log(p)^{1-\theta}\log\log(p)\)\)$. On a classical computer, one can recover an ideal $\mf{a}\subseteq mO_n$ of $C$-smooth norm $N(\mf{a})=O(p)$ such that $(F_i)_{0\leq i\leq n}=\mf{a}\cdot (E_i)_{0\leq i\leq n}$ in time:
\[\exp\(O\(\log(p)^{\frac{1}{3}}\log\log(p)^{\frac{2}{3}}\)\)+\exp\(O\(\log(p)^{\theta}\)\)\]
and compute the action of this ideal on any chain in time $\exp\(O\(\log(p)^{1-\theta}\log\log(p)\)\)$, where the $O$ constants in the time complexity, depend on $\theta$.
\end{theorem}

\subsubsection{An optimised subexponential attack based on CVP}\label{paragraph 11}

By corollary \ref{corollary 2},  assuming that the $[\mf{q}_j]$ generate $\mbox{Cl}(\mO_n)$, one can find a basis $\m{B}$ of $\mbox{Cl}(\mO_n)$ with $r\leq 4$ elements (by theorem \ref{theorem 8}) in time $O(n^3t^2)$ (where the constant depends on $\ell$ and $r$ only).  Then, one can use algorithm \ref{algorithm 9} to find the discrete logarithm of $[\mf{N}]$ in $\m{B}$ in time $O(n^2)$ (by proposition \ref{proposition 12}).  Knowing the expression of the elements of $\m{B}$ in terms of the $[\mf{q}_j]$, one can the find $e_1, \cdots, e_t\in\Z$ such that:
\[[\mf{N}]=\prod_{j=1}^t[\mf{q}_j]^{e_j}\]
However, the exponents $e_1, \cdots, e_{t}$ have order of magnitude $h(\mO_n)\approx\ell^n$ a priori,  making the action of $[\mf{N}]$ impossible to compute in practice. 

We want to make the $e_1, \cdots, e_t$ as short as possible, which can be done by computing the closest vector $c$ to $e$ in the lattice:
\[L':=\left\{(e_1,\cdots,e_{t})\in\Z^{t} \middle| \  \prod_{j=1}^t[\mf{q}_j]^{e_j}=[1]\right\}\]
In practice, an approximation of this closest vector is sufficient, because the search for such a vector may be very costly. In practice, there is a tradeoff between the norm of the vector $e':=e-c$ and the the cost of this approximation. Computing the action of $[\mf{N}]=\prod_{j=1}^t[\mf{q}_j]^{e'_j}$ has time complexity:
\[\theta\(n\sum_{j=1}P(q_j,n)|e'_j|\)\]
where $P$ is a polynomial. Since:
\[\|e'\|_2\leq \sum_{j=1}P(q_j,n)|e'_j|\leq \|e'\|_2\sqrt{\sum_{j=1}^tP(q_j,n)^2}\]
the temporal complexity of the action of $[\mf{N}]$ is $\|e'\|_2$, up to a polynomial factor in $n$, $t$ and the $q_j$. Hence, we can optimize $e'$ in $\ell_2$ norm. There is a trade-off between the tightness of our approximation of CVP to optimize the performance of  the action of $[\mf{N}]$ and the time complexity of finding a close vector.

\begin{theorem}\cite[theorem 3.3]{Espitau2020}\label{theorem 7}
Let $\Lambda\subseteq\Z^d$ be a lattice of rank $d$, $B:=(b_1,\cdots, b_d)$,  a basis of $\Lambda$, a target $x\in\R^d$ and $k\in\N^*$ such that $d>2k$. Under some heuristic assumptions, there exists an algorithm finding $c\in\Lambda$ such that:
\[\|x-c\|_2=O\(GH(k)^{\frac{d}{2k}}\mbox{Covol}(\Lambda)^{\frac{1}{d}}\)\]
where $GH$ is the Gaussian heuristic function given by:
\[GH(k):=\frac{\Gamma\(\frac{k}{2}+1\)^{\frac{1}{k}}}{\sqrt{\pi}}\]
This algorithm runs in time:
\[(T_{CVP}(k)+T_{SVP}(k))P\(k,d,\log\|x\|_2,\log\max_{1\leq i\leq d}\|b_i\|_2\)\]
where $T_{CVP}(k)$ and $T_{SVP}(k)$ are the time complexities of oracles  for CVP and SVP in dimension $k$ for the norm $\ell_2$ respectively and $P$ is a polynomial.
\end{theorem}

The best known algorithm for CVP (with preprocessing) is due to \cite{Ducas2020} and runs in time $T_{CVP}(k)=2^{c_1 k+o(k)}$ with $c_1\approx 0.264$. The best known algorithm for SVP is due to \cite{Ducas2016} and runs in time $T_{SVP}(k)=\(\frac{3}{2}\)^{k/2+o(k)}=2^{c_2 k+o(k)}$ with $c_2\approx 0.292$.

\begin{corollary}\label{corollary 1}
Applying the algorithm of theorem \ref{theorem 7}, one can recover an ideal $\mf{a}\subseteq mO_n$ which is a product of the $\mf{q}_j$ with small exponents such that $(F_i)_{0\leq i\leq n}=\mf{a}\cdot (E_i)_{0\leq i\leq n}$ in time: 
\[2^{c_2k+o(k)}P(k,n,t,\max_{1\leq j\leq t}q_j)\]
where $P$ is a polynomial.  One can compute the action of $[\mf{a}]$ on any chain in time: 
\[GH(k)^{\frac{t}{2k}}\ell^{\frac{n}{t}}Q(n,t,\max_{1\leq j\leq t}q_j)\] 
here $Q$ is a polynomial.
\end{corollary} 

\begin{proof}
The corollary is a restatement of what has been said before. We simply apply the algorithm of theorem \ref{theorem 7} to $\Lambda=L'$ and get the desired complexity, since $\mbox{Covol}(L')=|G|$, where $G$ is the subgroup generated by the $[\mf{q}_j]$.  Indeed, we have an exact sequence:
\[\{0\}\longrightarrow L'\hookrightarrow \Z^t\overset{\varphi}{\longrightarrow} G\longrightarrow\{0\}\]
where $ L'\hookrightarrow \Z^t$ is the natural inclusion and $\varphi : (e_1,\cdots,e_t)\in\Z^t\longmapsto \prod_{j=1}^t[\mf{q}_j]^{e_j}\in G$. It follows that:
\[\mbox{Covol}(L')=|\Z^t/L'|=|G|\]
but $|G||h(\mO_n)$ by Lagrange's theorem so $\mbox{Covol}(L')\leq h(\mO_n)$.
\end{proof}

This attack is still subexponential, but much more damaging to the cryptosystem. To ensure a security level of $\lambda=128$ bits, we need $t\geq 16064$, which is utterly unrealistic.

\section{A second attack using the class group action only}

We recall here the problem we have to solve: given a chain $(E_i,\iota_i)_{0\leq i\leq n}$ and a chain $(F_i,\iota'_i)_{0\leq i\leq n}=\mf{a}\cdot(E_i,\iota_i)_{0\leq i\leq n}$ with a secret ideal class $[\mf{a}]\in\mbox{Cl}(\mO_n)$, we want to recover $[\mf{a}]$. We have seen that this could be done by recovering the structure of the endomorphism rings $\mbox{End}(E_i)$ and $\mbox{End}(F_i)$. However, this might not be necessary and we present here a simpler approach to this problem. 

For $i\in\i{0}{n-1}$, suppose that we know an ideal of $\mf{a}_i=\prod_{j=1}^t \mf{q}_j^{e_{i, j}}$ of $\mO_K$, such that: 
\[\mf{a}_i\cdot(E_k, \iota_k)_{0\leq k\leq i}=(F_k,\iota'_k)_{0\leq k\leq i}\]
Then $[\mf{a}\cap \mO_i]=[\mf{a}_i\cap\mO_i]$ in $\mbox{Cl}(\mO_i)$ and $\mf{a}_i\cap \mO_i$ is determined up to multiplication by principal ideals of $\mO_i$, so that $\mf{a}_i$ is determined up to multiplication by elements of $\mO_i$.  We look for an ideal $\mf{a}_{i+1}=\prod_{j=1}^t \mf{q}_j^{e_{i+1, j}}$ of $\mO_K$ such that:
\[\mf{a}_{i+1}\cdot(E_k, \iota_k)_{0\leq k\leq i+1}=(F_k,\iota'_k)_{0\leq k\leq i+1}\]
Then, $[\mf{a}_{i+1}\cap\mO_{i}]=[\mf{a}\cap \mO_{i}]=[\mf{a}_i\cap\mO_{i}]$ in $\mbox{Cl}(\mO_{i})$ i.e. $\mf{a}_{i+1}\cap\mO_i\equiv \mf{a}_i\cap\mO_i \ \mbox{mod} \ P(\mO_i)$. Hence, to determine $\mf{a}_{i+1}$, one only has to determine an ideal $\mf{b}=\prod_{j=1}^t\mf{q}_j^{d_j}$ such that $\mf{b}\cap\mO_i$ is principal and: 
\[[\mf{a}_i\cdot \mf{b}\cap\mO_{i+1}]\cdot E_{i+1}=F_{i+1} \quad (\star)\]
Then,  we can set $\mf{a}_{i+1}:=\mf{a}_i\cdot \mf{b}$, so that $e_{i+1,j}:=e_{i,j}+d_j$ for all $j\in\i{1}{t}$.  Actually, $\mf{a}_{i+1}\cap\mO_{i+1}$ is determined modulo a principal ideal of $\mO_{i+1}$ and $\mf{b}\cap\mO_{i+1}$ as well. As a consequence,  $[\mf{b}\cap\mO_{i+1}]$ is in the kernel of the surjective group homomorphism:
\[[\mf{c}]\in\mbox{Cl}(\mO_{i+1})\relbar\joinrel\twoheadrightarrow [\mf{c}\mO_i]\in\mbox{Cl}(\mO_{i})\]
whose cardinality is $\ell$ for $i\geq 1$ and $\frac{1}{[\mO_K^\times:\mO_1^\times]}\(\ell-\(\frac{\Delta_K}{\ell}\)\)$ for $i=0$, so we only have to test a limited number of values for $\mf{b}$ until $(\star)$ is satisfied.

However, we have to make sure that all the values of $\mf{b}$ to be tested can be easily expressed in terms of the $\mf{q}_j$ and that the exponents $e_{i+1,j}$ of $\mf{a}_i\cdot \mf{b}$ are short enough to make the computation of $[\mf{a}_i\cdot \mf{b}\cap\mO_{i+1}]\cdot E_{i+1}$ practical.  

\subsubsection{Expressing $\ker(\mbox{Cl}(\mO_{i+1})\relbar\joinrel\twoheadrightarrow\mbox{Cl}(\mO_{i}))$ in terms of the $\mfq_j$}

In order to do that, we need to understand the structure of the ideal class groups. Actually, the structure of these groups is very simple.

\begin{lemma}
One of the following results hold:

\begin{description}
\item[(i)] For all $n\geq 1$, $\mbox{Cl}(\mO_n)$ is cyclic.
\item[(ii)] For all $n\geq 2$, $\mbox{Cl}(\mO_n)\simeq (\Z/\ell\Z)\times(\Z/h_{n-1}\Z)$ with:
\[h_{n-1}:=|\mbox{Cl}(\mO_{n-1})|=\frac{\ell^{n-2}}{[\mO_K^\times:\mO_1^\times]}\(\ell-\(\frac{\Delta_K}{\ell}\)\)\]
where $\Delta_K:=\mbox{disc}(K)$.
\end{description}
The last case only happens when $\ell=2$ or when $\ell\geq 3$ ramifies in $K$ (this condition is necessary but not sufficient). 
\end{lemma} 

\begin{proof}
See appendix \ref{appendix 1}.
\end{proof}

We describe how to proceed when $\mbox{Cl}(\mO_n)$ is cyclic (case $(i)$). If we assume that the $\mf{q}_j$ generate $\mbox{Cl}(\mO_n)$, we can compute an $\mO_K$-ideal $\mf{g}$ such that $[\mf{g}\cap\mO_n]$ generates $\mbox{Cl}(\mO_n)$, as one of the $\mf{q}_j$ or a as product of some $\mf{q}_j$. By the surjection $\mbox{Cl}(\mO_{i+1})\relbar\joinrel\twoheadrightarrow\mbox{Cl}(\mO_i)$, we get that $[\mf{g}\cap\mO_i]$ generates $\mbox{Cl}(\mO_i)$ for all $i\in\i{0}{n-1}$ and that:
\[\ker(\mbox{Cl}(\mO_{i+1})\relbar\joinrel\twoheadrightarrow\mbox{Cl}(\mO_{i}))=\langle [\mf{g}\cap\mO_{i+1}]^{h_i}\rangle\]
with $h_i:=|\mbox{Cl}(\mO_i)|$. 

Now, if $\mbox{Cl}(\mO_n)\simeq(\Z/\ell\Z)\times(\Z/h_{n-1}\Z)$ (case $(ii)$).  In that case, as previously, we obtain easily an ideal $\mf{g}$ expressed as one of the $\mf{q}_j$ or as a product of some $\mf{q}_j$ such that $[\mf{g}\cap\mO_n]$ has order $h_{n-1}$. We also obtain that $[\mf{g}\cap\mO_i]$ has order $h_{i-1}$ for all $i\in\i{2}{n}$ (for instance by lemma \ref{lemma 18}.(iv)).  As previously, it follows that:
\[\ker(\mbox{Cl}(\mO_{i+1})\relbar\joinrel\twoheadrightarrow\mbox{Cl}(\mO_{i}))=\langle [\mf{g}\cap\mO_{i+1}]^{h_{i-1}}\rangle\]
for all $i\in\i{2}{n-1}$. For $i=0,1$, the kernel can be very easily computed because the class groups are small. 

Either way, we can easily express every ideal $\mf{b}$ such that $\mf{b}\cap\mO_{i+1}$ lies in the above kernel in terms of the $\mf{q}_j$.

\subsubsection{Reducing the exponents of $\mf{a}_i\cdot \mf{b}$}

Once $\mf{b}$ is expressed in terms of the $\mf{q}_j$, i.e. when the $d_j$ are known, we still have to make sure that the exponents $e_{i+1,j}=e_{i,j}+d_j$ of $\mf{a}_i\cdot \mf{b}$ are small.  Actually, $e_{i+1}:=(e_{i+1,j})_{1\leq j\leq t}$ is determined up to trnaslation by an element of the lattice:
\[L_{i+1}:=\left\{(e_1,\cdots,e_{t})\in\Z^{t} \middle| \  \prod_{j=1}^t[\mf{q}_j]^{e_j}=[1] \quad \mbox{in} \ \mbox{Cl}(\mO_{i+1}) \right\}\]
Using algorithm \ref{algorithm 11},  one can find a basis of $L_{i+1}$ in time $O(t^3+t(i+1)^2)$. Using Babai's nearest plane algorithm, one can find $f\in L_{i+1}$ relatively close to $e_{i+1}$ in time $O(t^6)$. Then, we can compute the action of $[\mf{b}\cdot\mf{a}_i]=\prod_{j=1}^t[\mf{q}_j]^{e'_{i+1,j}}$ with $e'_{i+1}:=e_{i+1}-f$.  

\begin{theorem}
One can recover the secret ideal class $\mf{a}$ in time:
\[O\(n^3t^2+n^4+t^6+n\ell T_{CL}\)\]
where $T_{CL}$ is the time complexity of the computation of the class group action on a given elliptic curve by the method of paragraph \ref{paragraph 1} when exponents are outputted by Babai's nearest plane algorithm and where the $O$ constant depends only on $\ell$ and the rank $r\leq 4$ of $\mbox{Cl}(\mO_n)$.
\end{theorem}

\section{The OSIDH protocol}\label{paragraph 8}

The OSIDH is basically the Diffie-Hellmann key exchange presented in the preceding paragraph. However,  the parties do not exchange the chains $(E_{A,i},\iota_{A,i})$ and $(E_{B,i},\iota_{B,i})$ (which makes them vulnerable to an attack) while still giving enough data to recover $(E_{AB,i},\iota_{AB,i})$.  

Alice still computes $(E_{A,i},\iota_{A,i}):=\mf{a}\cdot (E_i,\iota_i)$ but only transmits the end of the chain $E_{A,n}$, which is the most interesting part (since $\mbox{Cl}(\mO_n)$ is the biggest class group).  Bob wants to compute $E_{AB,n}=\mf{b}\cap\mO_n\cdot E_{A,n}$ but without any further information, he cannot do this computation. Indeed, he needs at least to know the $\mO_n$-orientation of $E_{A,n}$ to determine the class group action (computing the kernels and using V\'{e}lu's formulas) and this information is contained in the whole isogeny chain $(E_{A,i},\iota_{A,i})$ (since $\iota_{A,n}$ could be obtained with the knowledge $\iota_{A,0}$ and the $\ell$-isogenies $E_{A,i}\longrightarrow E_{A,i+1}$ for all $i\in\i{0}{n-1}$). Otherwise, to compute $\mfq_j^{(n)}\cdot E_{A,n}=E_{A,n}/E_{A,n}[\mfq_j^{(n)}]$, for instance, Bob does not know how to chose between the $q+1$ possible values of $E_{A,n}[\mfq_j^{(n)}]$.  Actually, the action of powers of $\mfq_j^{(n)}$ and $\overline{\mfq}_j^{(n)}$ on $E_{A,n}$ for all $j\in\i{1}{t}$ is enough to determine $E_{AB,n}$.

We assumed that $\mf{a}$ and $\mf{b}$ are powersmooth. Then, we may choose a bound $r\in\N^*$ for the absolute values of the exponents $e_1,\cdots,e_t, f_1,\cdots,f_t\in\Z$ such that:
\[\mf{a}=\prod_{j=1}^t \mf{q}_j^{e_j} \qquad \mbox{and} \qquad \mf{b}=\prod_{j=1}^t \mf{q}_j^{f_j}\]
Note that we allow negative exponents as we identify $\mf{q}_j^{-k}$ with $\overline{\mf{q}}_j^{k}$ for all $k\in\N^*$ and $j\in\i{1}{t}$.  In the OSIDH protocol, Alice computes for all $j\in\i{1}{t}$ the chains $\mfq_j^k\cdot (E_{A,i},\iota_{A,i})$ and transmits to Bob the ending element $E_{A,n,j}^{(k)}:=(\mfq_j^{(n)})^k\cdot E_{A,n}$ for all $k\in\i{-r}{r}$, forming the $q_j$-isogeny chain:
\[E_{A,n,j}^{(-r)}\longrightarrow \cdots \longrightarrow E_{A,n}\longrightarrow \cdots\longrightarrow E_{A,n,j}^{(r)}\]
With this data, Bob can construct :
\[E_{A,n,\leq j}^{(k_1,\cdots,k_j)}:=\prod_{m=1}^j (\mfq_m^{(n)})^{k_m}\cdot E_{A,n}\] 
for all $j\in\i{1}{t}$ and $k_1,\cdots,k_j\in\i{-r}{r}$, which leads to $E_{A,n,\leq n}^{(f_1,\cdots,f_n)}=E_{AB,n}$. Let us explain the process for the computation of $E_{A,n,\leq 2}^{(f_1,1)}$ (assuming $e_1\geq 0$).  Bob knows the chain:
\[E_{A,n}=E_{A,n,1}^{(0)}\longrightarrow \cdots \longrightarrow E_{A,n,1}^{(f_1)}\]
and $E_{A,n,2}^{(1)}$, which enables him to construct the chain:
\[\xymatrix{
E_{A,n,2}^{(1)}  \ar[r] & E_{A,n,\leq 2}^{(1,1)} \ar[r] & \cdots \ar[r] & E_{A,n,\leq 2}^{(f_1-1,1)} \ar[r] & E_{A,n,\leq 2}^{(f_1,1)}\\
E_{A,n} \ar[u]^{q_2} \ar[r]^{q_1} & E_{A,n,1}^{(1)} \ar[u] \ar[r] & \cdots \ar[r] & E_{A,n,1}^{(f_1-1)}\ar[u] \ar[r] & E_{A,n,1}^{(f_1)}\ar[u]
}\]
using $q_1$ and $q_2$ modular equations only as in paragraph \ref{paragraph 1}.This can be done without ambiguity (there is always a unique solution to the system of modular equations) by the same arguments we used in proposition \ref{proposition 9}. Indeed, we know that $E_{A,n,2}^{(1)}=\mfq_2^{(n)}\cdot E_{A,n}$, $(\mfq_2^{(n)})^2$ is not principal in $\mO_n$ and the map $\mbox{SS}_{\mO_n}(p)\cap\im(\rho)\longrightarrow\mbox{SS}(p)$ is injective by theorem \ref{theorem 4}. Going further, Bob obtains $E_{A,n,\leq 2}^{(f_1,2)}$ from $E_{A,n,2}^{(2)}$ and the chain:
\[E_{A,n,2}^{(1)}\longrightarrow \cdots \longrightarrow  E_{A,n,\leq 2}^{(f_1,1)}\]
and repeats the process until reaching $E_{A,n,\leq 2}^{(f_1,f_2)}$ (if $f_2\geq 0$). To sum up the method, we compute the following diagram starting from the bottom:
\[\xymatrix{
E_{A,n,2}^{(f_2)}  \ar[r] & E_{A,n,\leq 2}^{(1,f_2)} \ar[r] & \cdots \ar[r] & E_{A,n,\leq 2}^{(f_1-1,f_2)} \ar[r] & E_{A,n,\leq 2}^{(f_1,f_2)}\\
E_{A,n,2}^{(f_2-1)} \ar[u] \ar[r] & E_{A,n,\leq 2}^{(1,f_2-1)}\ar[u] \ar[r] & \cdots \ar[r] & E_{A,n,\leq 2}^{(f_1-1,f_2-1)} \ar[u] \ar[r] & E_{A,n,\leq 2}^{(f_1,f_2-1)}\ar[u]\\
\vdots \ar[u] & \vdots \ar[u] & \ddots & \vdots \ar[u] & \vdots \ar[u]\\
E_{A,n,2}^{(1)}  \ar[u] \ar[r] & E_{A,n,\leq 2}^{(1,1)} \ar[u]\ar[r] & \cdots \ar[r] & E_{A,n,\leq 2}^{(f_1-1,1)} \ar[u]\ar[r] & E_{A,n,\leq 2}^{(f_1,1)} \ar[u] \\
E_{A,n} \ar[u]^{q_2} \ar[r]^{q_1} & E_{A,n,1}^{(1)} \ar[u] \ar[r] & \cdots \ar[r] & E_{A,n,1}^{(f_1-1)}\ar[u] \ar[r] & E_{A,n,1}^{(f_1)}\ar[u]
}\]
For negative exponents, the method is the same but starts from $E_{A,n,1}^{(-1)}$, $E_{A,n,1}^{(-2)}$...  

Starting from the chain:
\[\xymatrix{
E_{A,n,2}^{(f_2)}  \ar[r] & E_{A,n,\leq 2}^{(1,f_2)} \ar[r] & \cdots \ar[r] & E_{A,n,\leq 2}^{(f_1-1,f_2)} \ar[r] & E_{A,n,\leq 2}^{(f_1,f_2)}}\]
at the bottom, and the chain:
\[\xymatrix{
E_{A,n}=E_{A,n,3}^{(0)}  \ar[r] & E_{A,n,3}^{(1)} \ar[r] & \cdots \ar[r] & E_{A,n,3}^{(f_3-1)} \ar[r] & E_{A,n,3}^{(f_3)}}\]
on the left, Bob obtains $E_{A,n,\leq 3}^{(f_1,f_2,f_3)}$. Applying this process successively,  Bob finally obtains the secret $E_{A,n,\leq n}^{(f_1,\cdots,f_n)}=E_{AB,n}$.  Of course, Alice performs the symmetric process with the data sent by Bob.

%\pseudocode{
%\textbf{Alice} \<  \< \textbf{Bob} \\[][\hline ] \text{Choose random integers } (e_1,\cdots, e_t)\in\i{-r}{r}^t \<  \< \\
 %\text{Compute } (E_{A,i},\iota_{A,i}):=\prod_{j=1}^t \mf{q}_j^{e_j}\cdot (E_i,\iota_i) \<  \< \\
  %\text{Compute for all } j\in\i{1}{t} \text{ the chain} \<  \< \\
 %E_{A,n,j}^{(-r)}\longrightarrow \cdots \longrightarrow E_{A,n}\longrightarrow \cdots\longrightarrow E_{A,n,j}^{(r)} \< \sendmessagerightx{5}{E_{A,n,j}^{(-r)}\longrightarrow \cdots\longrightarrow E_{A,n,j}^{(r)} \ (j\in\i{1}{t}) }  \<\\
 %\<  \< \text{Choose random integers } (f_1,\cdots, f_t)\in\i{-r}{r}^t \\
 %\<  \< \text{Compute } (E_{B,i},\iota_{B,i}):=\prod_{j=1}^t \mf{q}_j^{f_j}\cdot (E_i,\iota_i)  \\
 %\<  \< \text{Compute for all } j\in\i{1}{t} \text{ the chain}  \\
%\< \< E_{B,n,j}^{(-r)}\longrightarrow \cdots \longrightarrow E_{B,n}\longrightarrow \cdots\longrightarrow E_{B,n,j}^{(r)} \\
 %\sendmessageleftx{5}{E_{B,n,j}^{(-r)}\longrightarrow \cdots\longrightarrow E_{B,n,j}^{(r)} \ (j\in\i{1}{t}) } \<\< \\
%\text{Computes } E_{B,n,\leq n}^{(e_1,\cdots,e_n)}=E_{AB,n} \text{ as above} \< \< \text{Computes } E_{A,n,\leq n}^{(f_1,\cdots,f_n)}=E_{AB,n} \text{ as above}
%}

\section{Security of OSIDH}

\subsection{Onuki's attack}

As we saw in paragraph \ref{paragraph 7}, the knowledge of the chains $(E_i,\iota_i)_{0\leq i\leq n}$ and $(E_{A,i},\iota_{A,i})_{0\leq i\leq n}=\mf{a}\cdot (E_i,\iota_i)_{0\leq i\leq n}$, gives away enough information to the attacker to recover the secret ideal class $[\mf{a}]\in\mbox{Cl}(\mO_n)$ in polynomial time on a quantum computer, and in subexponential time on a classical computer.  We present an attack due to Onuki \cite[§ 6.3]{Onuki} recovering the chain of $\ell$-isogenies $(\varphi_i : E_i\longrightarrow E_{i+1})_{0\leq i\leq n-1}$  given $E_0$ and $E_n$ together with the chains:
\[\mf{q}_j^{-r}\cdot E_n\longrightarrow \cdots \longrightarrow E_n\longrightarrow \cdots\longrightarrow \mf{q}_j^{r}\cdot E_n\]
for all $j\in\i{1}{n}$. There is a variant of this attack based on the shortest vector problem (SVP) in a lattice of dimension $t$ (see paragraph \ref{paragraph 9}).

Assume that the attacker knows an endomorphism $\iota_n(\beta)$ for a known value $\beta\in\mO_n\setminus \mO_{n+1}$ that we write $\beta:=a+b\ell^n\theta$, where $\theta$ is a generator of $\mO_K$ and $a,b\in\Z$, with $b\wedge \ell=1$. Since $\iota_n(a)=[a]$ is easy to compute, we can assume that $a=0$ i.e. that $\beta=b\ell^n\theta$. We assume that $\iota_n(\beta)$ can be efficiently evaluated on $\ell$-torsion points. Then the attacker can compute the subgroup $G:=\ker(\iota_n(\beta))\cap  E_n[\ell]$ in polynomial time in $\log(p)$. 

\begin{lemma}
$G=\ker(\widehat{\varphi}_{n-1})$.
\end{lemma}

\begin{proof}
We have:
\[\iota_n(\beta)=\iota_n(b\ell^n\theta)=[\ell]\iota_n(b\ell^{n-1}\theta)=\varphi_{n-1}\iota_{n-1}(b\ell^{n-1}\theta)\widehat{\varphi}_{n-1}\]
and $b\ell^{n-1}\theta\in\mO_{n-1}$, so that $\iota_{n-1}(b\ell^{n-1}\theta)\in\End(E_{n-1})$, and consequently, $\ker(\widehat{\varphi}_{n-1})\subseteq\ker(\iota_n(\beta))$. Since $\deg(\varphi_{n-1})=\ell$, we have also $\ker(\widehat{\varphi}_{n-1})\subseteq E_{n}[\ell]$ so that $\ker(\widehat{\varphi}_{n-1})\subseteq G$.  So $G$ is either cyclic of order $\ell$ and equal to $\ker(\widehat{\varphi}_{n-1})$ or of order $\ell^2$ and equal to the entire $\ell$-torsion subgroup $E_n[\ell]$. If the latter holds, $\iota_n(\beta)$ factors through $[\ell]$ by \cite[corollary III.4.11]{Silverman1} and $\beta/\ell=b\ell^{n-1}\theta\in\mO_n$, so $\ell|b$. Contradiction. Hence, $G=\ker(\widehat{\varphi}_{n-1})$.
\end{proof}

Hence, we can compute $\widehat{\varphi}_{n-1}$ using V\'{e}lu's formulas in $O(\ell)$ operations over the field of definition of $E_n[\ell]$. With this information, we can recover $\varphi_{n-1}$ easily, by evaluating $\widehat{\varphi}_{n-1}$ on $E_{n-1}[\ell]$, since $\ker(\varphi_{n-1})=\widehat{\varphi}_{n-1}(E_{n-1}[\ell])$, and using V\'{e}lu's formulas again.

We conclude that the attacker can compute the chain of isogenies $(\varphi_i : E_i\longrightarrow E_{i+1})_{0\leq i\leq n-1}$, if at each index $i\in\i{1}{n}$,  if they have access to an oracle providing $\iota_i(\beta_i)$ for $\beta_i\in\mO_i\setminus\mO_{i+1}$, when $E_{i}$ is given. Now, we present such an oracle (for $E_n$), due to Onuki. An alternate oracle relying on SVP will be presented in paragraph \ref{paragraph 9}.

First, we look for $\beta\in\mO_n\setminus\mO_{n+1}$ such that $\beta\mO_n=\mf{a}\cdot \mf{b}$, with a big factor $\mf{a}:=\prod_{j=1}^t\mf{q}_j^{e_j}$, with $e_1, \cdots, e_t\in\i{-r}{r}$ and $\mf{b}\subseteq\mO_n$, any ideal. In practice, we test different values of $\beta:=a+b\theta$ with $a$ is sampled uniformly in $\i{-m}{m}$ and $b$ is sampled uniformly in $\i{-m}{m}\setminus\ell\Z$, for $m$ big enough. We stop when $N(\beta)$ has a big enough divisor $Q:=\prod_{j=1}^t q_j^{e_j}$ with $e_1, \cdots, e_t\in\i{-r}{r}$, let's say $Q\geq x$, where the threshold $x$ is to be chosen. Then, we compute the ideal $\mf{a}$ using algorithm \ref{algorithm 7} to compute the valuations of the $\mf{q}_j$.  

With the knowledge of the chain: 
\[E_{n,j}^{(-r)}:=[\mf{q}_j^{-r}]\cdot E_n\longrightarrow \cdots \longrightarrow E_{n}\longrightarrow \cdots\longrightarrow E_{n,j}^{(r)}:=[\mf{q}_j^{-r}]\cdot E_n\]
for all $j\in\i{1}{r}$, using the techniques of paragraph \ref{paragraph 8}, it is easy to compute the isogeny $\varphi_{\mf{a}}:E_n\longrightarrow [\mf{a}]\cdot E_n$ of kernel $E_n[\mf{a}]$. 

It remains to compute the isogeny $\varphi_{\mf{b}}:[\mf{a}]\cdot E_n\longrightarrow [\mf{a}\cdot\mf{b}]\cdot E_n=E_n$ of kernel $[\mf{a}]\cdot E_n[\mf{b}]$.  We know that $\deg(\varphi_{\mf{b}})=N(\mf{b})=N(\beta)/N(\mf{a})$, so we can compute $\deg(\varphi_{\mf{b}})$ and factor it into primes:
\[\deg(\varphi_{\mf{b}})=\prod_{k=1}^s\ell_k^{f_k}\]
with $\ell_1,\cdots, \ell_s$ distinct prime numbers and $f_1,\cdots, f_s\in\N^*$ using general number field Seive in subexponential time:
\[\exp\(O\(\log(N(\mf{b}))^{\frac{1}{3}}\log\log(N(\mf{b}))^{\frac{2}{3}}\)\)\] 
and use a meet-in-the-middle technique to recover $\varphi_{\mf{b}}$ as follows. We divide our search in two approximately equal parts, by exhaustive search among isogenies $\phi_1 : [\mf{a}]\cdot E_n\longrightarrow E$ of degree $\deg(\phi_1)=\prod_{k=1}^s\ell_k^{g_k}$ and and $\phi_2 : E_n\longrightarrow E'$ of degree $\deg(\phi_2)=\prod_{k=1}^s\ell_k^{h_k}$, where the exponents are chosen, so that $h_k+g_k=f_k$ for all $k\in\i{1}{s}$ and $\deg(\phi_1)\simeq\deg(\phi_2)\simeq\sqrt{\deg(\varphi_{\mf{b}})}$. We stop our exhaustive search when we find a collision $E=E'$ and return $\varphi_{\mf{b}}=\widehat{\phi}_2\circ\phi_1$. $\phi_1$ (respectively $\phi_2$) is represented as chains of $g_k$ (respectively $g_k$) $\ell_k$-isogenies for $k\in\i{1}{s}$. Hence, there are $\prod_{k=1}^s(\ell_k+1)^{g_k}$ (respectively $\prod_{k=1}^s(\ell_k+1)^{h_k}$) possible isogenies (counting the number of possible kernels of each isogeny of the chain). Hence, the exhaustive search has complexity:
\[\Omega\(\prod_{k=1}^s(\ell_k+1)^{g_k}+\prod_{k=1}^s(\ell_k+1)^{h_k}\)=\Omega(\sqrt{\deg(\varphi_{\mf{b}})})=\Omega\(\sqrt{\frac{N(\beta)}{\prod_{j=1}^t q_j^{e_j}}}\)\]

\begin{lemma}
We make the heuristic assumption that $N(\beta)$ has the same arithmetic properties as a uniform variable in $\i{N_{min}}{N_{max}}$ when $\beta:=a+b\theta$ with $(a,b)$ sampled uniformly in $\i{-m}{m}\times\i{-m}{m}\setminus\ell\Z$. Then, the average time complexity of Onuki's attack \cite[§ 6.3]{Onuki} is:
\[C(x)\geq \frac{x}{2(r+1)^t}+\frac{\kappa N_{min}^{\frac{3}{2}}}{x^{\frac{3}{2}}(r+1)^t}\]
where $\kappa:=\frac{1}{4\sqrt{q_1}}\(1-\frac{1}{q_1}\)$ and $x$ is the threshold for the value of the norm of the ideal $\mf{a}=\prod_{j=1}^t\mf{q}_j^{e_j}$ dividing $\beta$. The optimal value for the threshold is $x_m:=(3\kappa)^{\frac{2}{5}}N_{min}^{\frac{3}{5}}(r+1)^{-\frac{2t}{5}}$ and the optimal average time complexity is: 
\[C(x_m)=\Omega\(\frac{N_{min}^{\frac{3}{5}}}{(r+1)^{\frac{2t}{5}}}\)\]
\end{lemma}

\begin{proof}
Under the heuristic assumptions we made, we can assume that $N:=N(\beta)$ is a uniform random variable in the range $\i{N_{min}}{N_{max}}$.  We define the random variable:
\[Q:=Q(N)=\prod_{j=1}^t q_j^{\min(r,v_{q_j}(N))}\]
The cost of the exhaustive search for a suitable $\beta$ is then:
\[C_1(x)=\frac{1}{\P(Q(N)\geq x)}=\frac{N_{max}-N_{min}}{|S(x)|}\]
with:
\begin{align*}S(x)&:=\left\{y\in\i{N_{min}}{N_{max}}\middle | \ \prod_{j=1}^t q_j^{\min(r,v_{q_j}(y))}\geq x\right\}\\
&=\bigcup_{\substack{(e_1, \cdots, e_t)\in\i{0}{r}^t\\x\leq \prod_{j=1}^t q_j^{e_j}\leq N_{max}}}\left\{k\prod_{j=1}^t q_j^{e_j}\middle | \ k\in\i{\left\lceil\frac{N_{min}}{\prod_{j=1}^t q_j^{e_j}}\right\rceil}{\left\lfloor\frac{N_{max}}{\prod_{j=1}^t q_j^{e_j}}\right\rfloor}\right\}
\end{align*}
so that:
\begin{align*}
|S(x)|&\leq \sum_{\substack{(e_1, \cdots, e_t)\in\i{0}{r}^t\\x\leq \prod_{j=1}^t q_j^{e_j}\leq N_{max}}}\(\left\lfloor\frac{N_{max}}{\prod_{j=1}^t q_j^{e_j}}\right\rfloor-\left\lceil\frac{N_{min}}{\prod_{j=1}^t q_j^{e_j}}\right\rceil\)\\
&\leq \sum_{\substack{(e_1, \cdots, e_t)\in\i{0}{r}^t\\x\leq \prod_{j=1}^t q_j^{e_j}\leq N_{max}}}\(\frac{N_{max}-N_{min}}{\prod_{j=1}^t q_j^{e_j}}+1\)\\
&\leq\(\frac{N_{max}-N_{min}}{x}+1\)|\{(e_1, \cdots, e_t)\in\i{0}{r}^t\mid x\leq \prod_{j=1}^t q_j^{e_j}\leq N_{max}\}|\\
&\leq\(\frac{N_{max}-N_{min}}{x}+1\)(r+1)^t\leq 2(N_{max}-N_{min})\frac{(r+1)^t}{x} \quad (1)
\end{align*}
under the fairly reasonable assumption that $x\leq N_{max}-N_{min}$ (this is plausible since $x\leq N_{max}$ and $N_{max}\simeq m^2 N_{min}$ with $m\gg 1$). It follows that the search for $\beta$ costs:
\[C_1(x)\geq  \frac{x}{2(r+1)^t}\quad (2)\]

The average cost of the meet-in-the-middle procedure to find the isogeny associated to $\mf{b}$ is:
\[C_2(x)\geq \E\left[\sqrt{\frac{N}{Q(N)}}\mid Q(N)\geq x\right]\geq \sqrt{A}\P(N\geq A Q(N)|Q(N)\geq x)\]
where we used Markov's inequality with $A>0$ to be chosen. Hence:
\[C_2(x)\geq  \sqrt{A}\frac{\P(\{N\geq A Q(N)\}\cap\{Q(N)\geq x\})}{\P(Q(N)\geq x)}=\frac{\sqrt{A}|T(A)|}{|S(x)|} \quad (3)\]
with:
\[T(A):=\left\{k\prod_{j=1}^tq_j^{e_j}\middle| \ N_{max}\geq\prod_{j=1}^tq_j^{e_j}\geq x \quad \mbox{and} \quad k\in\i{\max\(\lceil A\rceil,\left\lceil\frac{N_{min}}{\prod_{j=1}^t q_j^{e_j}}\right\rceil\)}{\left\lfloor\frac{N_{max}}{\prod_{j=1}^t q_j^{e_j}}\right\rfloor}\right\}\]
We take $A:=N_{max}/(q_1 x)$, so that for all $e_1, \cdots,e_t\in\i{0}{r}$ such that $N_{max}\geq \prod_{j=1}^tq_j^{e_j}\geq x$, we have:
\[\frac{N_{min}}{\prod_{j=1}^tq_j^{e_j}}\leq \frac{N_{min}}{x}<\frac{N_{max}}{q_tx}=A\]
since $N_{max}/N_{min}\simeq m^2\gg q_t$. Without loss of generality, we can assume that $x$ is a product of the $q_j$. Hence:
\[|T(A)|\geq\left\lfloor\frac{N_{max}}{x}\right\rfloor-\left\lceil\frac{N_{max}}{q_1x}\right\rceil\geq \frac{N_{max}}{x}-\frac{N_{max}}{q_1x}-1\geq\frac{N_{max}}{2x}\(1-\frac{1}{q_1}\)\]
under the fair assumption that $x\leq \frac{N_{max}}{2}\(1-\frac{1}{q_1}\)$. This inequality combined with $(1)$ and $(3)$ leads to:
\[C_2(x)\geq \frac{(N_{max})^{\frac{3}{2}}}{4\sqrt{q_1 x}(r+1)^t(N_{max}-N_{min})}\(1-\frac{1}{q_1}\)\]
But we know that $x\leq N_{max}-N_{min}$. It follows that:
\[C_2(x)\geq  \frac{(N_{min}+x)^{\frac{3}{2}}}{4\sqrt{q_1}(r+1)^tx^{\frac{3}{2}}}\(1-\frac{1}{q_1}\)\geq \frac{N_{min}^{\frac{3}{2}}}{4\sqrt{q_1}(r+1)^tx^{\frac{3}{2}}}\(1-\frac{1}{q_1}\)\quad (4)\]
Combining $(2)$ and $(4)$, we find that Onuki's attack has average complexity:
\[C(x)\geq C_1(x)+C_2(x)\geq  \frac{x}{2(r+1)^t}+\frac{\kappa N_{min}^{\frac{3}{2}}}{x^{\frac{3}{2}}(r+1)^t}\]
with $\kappa:=\frac{1}{4\sqrt{q_1}}\(1-\frac{1}{q_1}\)$. The optimal value for $x$ is obtained by differenciating of the function defined over $\R_+^*$:  $x\longmapsto \frac{x}{2(r+1)^t}+\frac{\kappa N_{min}^{\frac{3}{2}}}{x^{\frac{3}{2}}(r+1)^t}$.
\end{proof}

Since, we have $N_{min}=\Omega(\ell^{2n})$, to ensure a level of security of $\lambda$ bits, one has to choose the parameters so that:
\[\frac{\ell^{\frac{6n}{5}}}{(r+1)^{\frac{2t}{5}}}\geq 2^\lambda\]
i.e.:
\[n\geq \frac{5\log(2)}{6\log(\ell)}\lambda+\frac{t}{3}\log(r+1)\]

\begin{example}
For $\lambda=128$ bits, $\ell=2$, $r=3$ and $t=207$ (see how this parameter has been chosen in paragraph \ref{paragraph 9}), we get $n\geq 269$. This is much less than the first estimate of Onuki (see \cite[§ 6.3]{Onuki}) for similar parameters ($n=1428$).
\end{example}

\subsection{An attack based on SVP}\label{paragraph 9}

This is a variant of Onuki's attack : given $E_0$ and $E_n$ and the horizontal chains:
\[\mf{q}_j^{-r}\cdot E_n\longrightarrow \cdots \longrightarrow E_n\longrightarrow \cdots\longrightarrow \mf{q}_j^{r}\cdot E_n \quad (j\in\i{1}{t})\]
we recover the whole chain $(E_i,\iota_i)_{0\leq i\leq n}$ with an oracle returning an endomorphism $\iota_i(\beta_i)$ with $\beta_i\in\mO_i\setminus\mO_{i+1}$ when given $E_i$ for $i\in\i{1}{n}$. However, the oracle is different here.  Instead of searching for $\beta\in\mO_n\setminus\mO_{n+1}$ (for $i=n$) with smoothness conditions on its norm coupled with a meet-in-the-middle attack, we directly look for $\beta\in\mO_n\setminus\mO_{n+1}$ as a product of the $\mf{q}_j$ with exponents in $\i{-2r}{2r}$ by solving the equation:
\[\prod_{j=1}^t[\mf{q}_j]^{e_j}=[1]\]
in $\mbox{Cl}(\mO_n)$, with $e_1,\cdots, e_t\in\i{-2r}{2r}$ non-trivial.  Then, we write $e_j:=e'_j+e''_j$ with $e'_j,e''_j\in\i{-r}{r}$ for all $j\in\i{1}{t}$ and compute the isogenies:
\[\varphi : E_n \longrightarrow \prod_{j=1}^t[\mf{q}_j]^{e'_j}\cdot E_n \qquad \mbox{and} \qquad \psi : E_n  \longrightarrow  \prod_{j=1}^t[\mf{q}_j]^{-e''_j}\cdot E_n=\prod_{j=1}^t[\mf{q}_j]^{e'_j}\cdot E_n\]
and finally compute $\iota_n(\beta)=\hat{\psi}\circ\varphi$ with with $\beta\mO_K= \prod_{j=1}^t\mf{q}_j^{e_j}$.

As we saw in paragraph \ref{paragraph 11}, we can find a basis set of the lattice:
\[L:=\left\{(e_1,\cdots,e_t)\in\Z^t\middle| \  \prod_{j=1}^t[\mf{q}_j]^{e_j}=[1]\right\}\]
in polynomial time in $n$ and $t$.  Our problem reduces to finding a short vector in $L$ for the norm $\ell_\infty$, hoping that this vector has norm $\leq 2r$ to make sure that we can compute $\iota_n(\beta)$ by the meet-in-the-middle argument presented above.  Hence,  an estimation of the infinity norm of the shortest vector in $L$ is necessary.

\subsubsection{Estimating the first minimum of $L$ for the norm $\ell_\infty$}

We want to estimate, at least statistically the first minimum of $L$ for the norm $\ell_\infty$, depending on the parameters:
\[\lambda_1^{(\infty)}(L):=\min_{v\in L\setminus\{0\}}\|v\|_\infty\]
We provide a first estimate here:

\begin{lemma}
We have $\lambda_1^{(\infty)}(L)\leq h(\mO_n)^{\frac{1}{t}}$.
\end{lemma}

\begin{proof}
As in corollary \ref{corollary 1}, we get that $\mbox{Covol}(L)\leq h(\mO_n)$.

The conclusion follows from the classical result $\lambda_1^{(\infty)}(L)\leq \mbox{Covol}(L)^{\frac{1}{t}}$, which is a corollary of Minkowski's convex body theorem \cite[theorem V.3]{Lang_ANT}. We recall its proof here. We consider the ball for $\ell_\infty$ norm:
\[B_\infty(0,r):=\{v\in\R^t\mid \|v\|_\infty\leq r\}\]
where $r:=\mbox{Covol}(L)^{\frac{1}{t}}$, whose volume is $2^t\mbox{Covol}(L)$ and which is centrally-symmetric. Then, by Minkowski's convex body theorem, we have a non-zero lattice point in $B_\infty(0,r)$, so that $\lambda_1^{(\infty)}(L)\leq r=\mbox{Covol}(L)^{\frac{1}{t}}$. This completes the proof.
\end{proof}

\begin{remark}
Since $h(\mO_n)=\frac{\ell^{n-1}}{[\mO_K^\times:\mO_n^\times]}\(\ell-\(\frac{\Delta_K}{\ell}\)\)\simeq\ell^n$ by \cite[theorem 7.24]{Cox}, we conclude that $\lambda_1^{(\infty)}(L)=O(\ell^{\frac{n}{t}})$. Hence, we have to make sure that $2r<\ell^{\frac{n}{t}}$ to have a chance that $2r<\lambda_1^{(\infty)}(L)$.  Of course, $n$ has to be sufficiently larger than $t$ to make this inequality possible.

However, we do not know how thight the estimate $\lambda_1^{(\infty)}(L)\leq h(\mO_n)^{\frac{1}{t}}$ is, and therefore if the choice of parameters $2r<O(\ell^{\frac{n}{t}})$ is sufficient. Assuming that the $[\mf{q}_j]$ generate $\mbox{Cl}(\mO_n)$, we have $\mbox{Covol}(L)=h(\mO_n)^{\frac{1}{t}}$, and $\mbox{Covol}(L)$ is close to this bound if the $[\mf{q}_j]$ generate a big enough subgroup. Heuristically, it makes sense to assume that $\lambda_1^{(\infty)}(L)$ is relatively close to $\mbox{Covol}(L)^{\frac{1}{t}}$ in general, namely that $\lambda_1^{(\infty)}(L)=\theta(\mbox{Covol}(L)^{\frac{1}{t}})$, as the following asymptotical result indicates. 
\end{remark}

Let $N, n\in\N^*$ and $\m{I}_{N,n}$ be the set of full-rank sublattices of $\Z^n$ of rank $N$.

\begin{lemma}
\begin{description}
\item[(i)] $\m{I}_{N,n}$ is finite.
\item[(ii)] Let $\Lambda$ be a random value following the uniform distribution on $\m{I}_{N,n}$. Then, for all $\varepsilon>0$, there exists $n_0, N_0\in\N^*$ such that for all $n\geq n_0$ and $N\geq N_0$:
\[\P\left[\left|\lambda_1^{(\infty)}(\Lambda)-\frac{N^{\frac{1}{n}}}{2}\right|\leq \frac{\log\log(n)}{n}\frac{N^{\frac{1}{n}}}{2}\right]\geq 1-\varepsilon\]
\end{description}
\end{lemma}

\begin{proof}
\textbf{(i)} Since a lattice of $\m{I}_{N,n}$ is determined by an integral basis of determinant $\pm N$, up to multiplication on the right by a matrix of $SL_n(\Z)$, we get that $\m{I}_{N,n}$ is in bijection with the quotient of:
\[S_N:=\{M\in M_n(\Z)\mid \det(M)=\pm N\}\]
by the group action of $SL_n(\Z)$ by multiplication on the right.  We prove that this quotient $S_N/SL_n(\Z)$ is finite. Taking the column echelon reduced matrix, we get that modulo $SL_n(\Z)$ every $M\in S_N$ is in the class of a HNF matrix:
\[\(\begin{array}{cccc}
d_1 & a_{1,2} & \cdots & a_{1,n}\\
0 & d_2 & \cdots & a_{2,n}\\
\vdots &  & \ddots & \vdots\\
0 & 0 & \cdots & d_n
\end{array}\)\]
with $d_1, \cdots, d_n\in\N^*$ such that $\prod_{i=1}^n d_i=N$ and $a_{i,i+1}, \cdots, a_{i,n}\in\i{0}{d_i-1}$ for all $i\in\i{1}{n}$.There are only finitely many such matrices. (i) follows.

\textbf{(ii)} This result has already been proved in \cite[theorem 11]{Aono} for the norm $\ell_2$. The reasoning would be exactly the same here. We only have to replace the function $h(n)=\frac{1}{\mbox{Vol}(B_2(0,1))^{\frac{1}{n}}}$ by the constant $\frac{1}{\mbox{Vol}(B_\infty(0,1))^{\frac{1}{n}}}=\frac{1}{2}$ in the inequality.
\end{proof}

\begin{remark}
Let $G$ be the subgroup of $\mbox{Cl}(\mO_n)$ generated by the $[\mf{q}_j]$. Assuming that $L$ behaves like a random lattice with uniform distribution in $\m{I}_{|G|,t}$, we get that:
\[\lambda_1^{(\infty)}(L)\leq \(1+\frac{\log\log(t)}{t}\)\frac{|G|^{\frac{1}{t}}}{2}\] 

To ensure that the key space is sufficiently large to cover a wide portion of $\mbox{Cl}(\mO_n)$, we require the surjectivity of the map:
\[f:(e_1,\cdots, e_t)\in\i{-r}{r}^t\longmapsto \prod_{j=1}^t[\mf{q}_j]^{e_j}\in G\]
It follows that $|G|\leq (2r+1)^t$, so that:
\[2r\geq |G|^{\frac{1}{t}}-1>\(1+\frac{\log\log(t)}{t}\)\frac{|G|^{\frac{1}{t}}}{2}\geq \lambda_1^{(\infty)}(L)\]
for $|G|$ big enough, so the SVP attack is possible.
\end{remark}

\begin{example}
For instance, with the parameters of \cite[p. 28]{OSIDH}: $\ell=2$, $r=5$, $t=74$ and $n=256$, assuming that $G=\mbox{Cl}(\mO_n)$, so that $|G|\approx\ell^n$, we get the upper bound for $\lambda_1^{(\infty)}(L)$ is:
\[\(1+\frac{\log\log(t)}{t}\)\frac{\ell^{\frac{n}{t}}}{2}\approx 5.61\]
so that $\lambda_1^{(\infty)}(L)\leq 5<2r=10$ and the attack is indeed possible.
\end{example}

The safest way to find a vector $e\in L$ such that $\|e\|_\infty\leq 2r$ is the SVP algorithm for infinity norm due to \cite{Aggarwal2018} whose space and time complexities are $2^{0.62t+o(t)}$ and $2^{0.415t+o(t)}$ respectively. However, this is not necessary in practice since usual reduction algorithms like BKZ provide vectors far shorter than their theoretical bounds.

\begin{example}
With the parameters of \cite[p. 28]{OSIDH}: $\ell=2$, $r=5$, $t=74$ and $n=256$ $K=\Q(i)$,  and $q_1,\cdots, q_t$ the $t$ smallest splitting primes in $\mO_K$ the relation lattice $L$ was computed in 2 h 31 using \verb?SageMath? \cite{sagemath}. The BKZ algorithm was applied to $L$ using the \verb?fpylll? library \cite{fpylll} with a block size $k=4$ to find a vector $e\in L$ of infinity norm $\|e\|_\infty=9<2r$ in less that 0.5 s.
\end{example}

\subsection{Hidden shift attack}

OSIDH is broken whenever the attacker is able to recover the secret ideal class $[\mf{a}]\in\mbox{Cl}(\mO_n)$, given the public chain $(E_i,\iota_i)_{0\leq i\leq n}$ and the public data of Alice, namely the $t$ horizontal chains:
\[[\mf{q}_j]^{-r}\cdot E_{A,n}\longrightarrow \cdots \longrightarrow E_{A,n} \longrightarrow \cdots \longrightarrow [\mf{q}_j]^{r}\cdot E_{A,n}\]
for all $j\in\i{1}{t}$ (with $(E_{i,A},\iota'_i)_{0\leq i\leq n}:=[\mf{a}]\cdot (E_i,\iota_i)_{0\leq i\leq n}$). We consider the functions:
\[f: [\mf{c}]\in\mbox{Cl}(\mO_n)\longmapsto [\mf{c}]\cdot E_n \qquad \mbox{and} \qquad g: [\mf{c}]\in\mbox{Cl}(\mO_n)\longmapsto [\mf{c}]\cdot E_{A,n}\]
We know that $f$ and $g$ are injective and that $g([\mf{c}])=f([\mf{a}][\mf{c}])$ for all $[\mf{c}]\in\mbox{Cl}(\mO_n)$. Hence, our attack reduces to the Hidden Shift Problem.

\begin{problem}[Hidden Shift Problem (HSP)]\label{problem 4}
Given $f,g: G\longrightarrow S$ two injective functions such that there exists $s\in G$ such that $g(x)=f(sx)$ for all $x\in G$, the problem is to determine $s$.
\end{problem}

\begin{theorem}[Kuperberg]
We keep the notations of problem \ref{problem 4}. Given an oracle computing $f$ and $g$, there exists a quantum algorithm finding $s$ with $2^{O(\sqrt{\log_2(|G|)})}$ qubits and quantum queries.
\end{theorem}

\begin{proof}
See appendix \ref{paragraph 14}.
\end{proof}

\begin{remark}
Actually, we know how to compute $f$ and $g$ on products on the prime ideals $[\mf{q}_j]$ but not on the whole group $\mbox{Cl}(\mO_n)$ a priori. This could be an obstacle to Kuberbergs algorithm because we need an oracle computing these functions for any group element. Assuming those ideal classes $[\mf{q}_j]$ generate $\mbox{Cl}(\mO_n)$, these oracles can be computed provided that we can easily express any ideal class $[\mf{c}]\in \mbox{Cl}(\mO_n)$ as a product of the $[\mf{q}_j]$: $[\mf{q}_j]=\prod_{j=1}^t[\mf{q}_j]^{e_j}$, with small exponents $e_j$, and the additional restriction $e_j\in\i{-r}{r}$ for all $j\in\i{1}{t}$ to compute $g$. This can be done relatively efficiently with a basis computation of $\mbox{Cl}(\mO_n)$ and Babai's algorithm in the relations lattice as explained earlier.  

However, the condition $|e_j|\leq r$ might be an issue if the parameters are chosen so that $(2r+1)^t\ll |\mbox{Cl}(\mO_n)|$. Hence, we can avoid both our lattice based classical attack and Kuperberg's attack with this chose of parameters.
\end{remark}

\chapter{Cryptographic constructions obtained with the OSIDH framework}

\section{Hash proof systems}

\subsection{Definition}

This notion was first introduced in \cite{Cramer_Shoup}. We use the notations of \cite{DeFeo1}.

\begin{definition}
A \emph{hash proof system} is a tuple $\Pi:=(\Lambda,\pi,\mbox{ProjEval},L,\Sigma,W,\m{K},\m{P},\Gamma)$, where, on the one hand $L,\Sigma,W,\m{K},\m{P}$ and $\Gamma$ are sets such that:
\begin{description}
\item[(i)] There exist efficient algorithms to sample elements from $\Sigma$ and $\m{K}$ with uniform distribution.
\item[(ii)] $L\subset \Sigma$ and $W$ is the space of witnesses to test membership in $L$.
\item[(iii)]  The uniform distributions on $L$ and $\Sigma$ are computationally indistinguishable (\emph{subset membership problem}).
\end{description}

On the other hand, $\Lambda,\pi$ and $\mbox{ProjEval}$ are efficiently computable functions:
\begin{description}
\item[(i)] The \emph{hash function} $\Lambda: \m{K}\times\Sigma\longrightarrow \Gamma$.
\item[(ii)] The \emph{projection} $\pi: \m{K}\longrightarrow \m{P}$.
\item[(iii)] The \emph{projective evaluation} $\mbox{ProjEval}: \m{P}\times L\longrightarrow \Gamma$.
\end{description}
such that, for any algorithm (possibly inefficient) $\omega : L\longrightarrow W$ associating a membership witness $w=\omega(\sigma)\in W$ to every element $\sigma\in L$ there we have a commutative diagram:
\[
\xymatrix{
\m{K}\times L  \ar[r]^{\Lambda} \ar[d]_{\pi\times\omega} & \Gamma\\
\m{P}\times W \ar[ru]_{\mbox{ProjEval}} &
}
\]

We additionally require $\Pi$ to be \emph{universal}, meaning that knowing $(\pi(k),\sigma)$ for $(k,\sigma)\in \m{K}\times \Sigma\setminus L$ provides no information on the value of $\Lambda(k,\sigma)$. Formally, for $\varepsilon>0$, we say that $\Pi$ is $\varepsilon$-universal if:
\[H_\infty(\Lambda(k,\sigma)|(\pi(k),\sigma))\geq\log(\varepsilon^{-1})\]
where $H_\infty(.|.)$ is the conditional min-entropy defined below.
\end{definition}

\begin{definition}
Let $X$ and $Y$ be discrete random variables taking values in $\m{X}$ and $\m{Y}$ respectively. Then, the conditional min-entropy of $X$, knowing $Y$ is the quantity:
\[H_\infty(X|Y)=-\log\max_{(x,y)\in\m{X}\times\m{Y}}\P(X=x|Y=y)\]
\end{definition}

\subsection{Cryptographic applications of hash proof systems}

\subsection{Hash proof system form weak-pseudorandom restricted effective group actions}

\begin{definition}\cite[definition 2]{DeFeo1}
An \emph{effective group action} is a triplet $(G,X,\cdot)$ where $G$ is a finite group, $X$ a finite set $\cdot : G\times X\longrightarrow X$ a transitive and faithful group action, such that:
\begin{description}
\item[(i)] There are efficient algorithms on $G$ to test membership, equality,  to sample elements (with uniform distribution), compute the product of two elements and the inverse of one element.
\item[(ii)] There is an efficient algorithm to test membership in $X$ and every element of $X$ admits a unique (bitstring) representation.
\item[(iii)] We know (the bitstring representation of) an element $x_0\in X$ called the \emph{origin}.
\item[(iv)] There exists an efficient algorithm computing $g\cdot x$ when $g\in G$ and $x\in X$ are given.
\end{description}
\end{definition}

In the context of OSIDH, we don't know how to efficiently compute the action of the whole group but only on a subset. The definition can be adapted to this case:

\begin{definition}\cite[definition 6]{DeFeo1}
A \emph{restricted effective group action} is a triplet $(G,X,\cdot,g)$ where $G$ is a finite group, $X$ a finite set $\cdot : G\times X\longrightarrow X$ a transitive and faithful group action, and $\m{G}:=\{g_1,\cdots, g_t\}$ a generating set of $G$ such that:
\begin{description}
\item[(i)] $t$ is polynomial in $\log(|G|)$.
\item[(ii)] There is an efficient algorithm to test membership in $X$ and every element of $X$ admits a unique (bitstring) representation.
\item[(iii)] We know (the bitstring representation of) an element $x_0\in X$ called the \emph{origin}.
\item[(iv)] There exist efficient algorithms computing $g_i\cdot x$ and $g_i^{-1}\cdot x$ when $i\in\i{1}{t}$ and $x\in X$ are given.
\end{description}
\end{definition}

\begin{remark}\label{remark 3}
We assume $G$ is abelian. Knowing the generating set $\m{G}=\{g_1,\cdots, g_t\}$ of $G$,  we can represent elements $g\in G$ as tuples of $\Z^t$ via the map:
\[\phi : e:=(e_1,\cdots, e_t)\in\Z^t\longmapsto g^e:=\prod_{i=1}^t g_i^{e_i}\in G\]
and compute the action of $g^e$ on $X$ when $e\in\Z^t$ has components of polynomial size. We can even sample on $G$ with distributions statistically closed to the uniform by sampling $e\in \Z^t$ with Gaussian distribution with standard deviation sufficiently greater than the smoothing parameter of the lattice $\ker(\phi)\subseteq \Z^t$ (see \cite[sections 3 and 4]{MaccianoRegev}). 
\end{remark}

\begin{definition}
A group action $(G,X,\cdot)$ is said \emph{weak-pseudorandom} if given a randomly chosen secret $g\in G$, one cannot distinguish between the distribution of $(x,g\cdot x)$ and $(x, y)$, where $x$ and $y$ are chosen uniformly in $X$.
\end{definition}

Let $(G,X,\cdot)$ be an abelian weak-pseudorandom  (restricted) effective group action. We can construct a hash proof system with it as follows: we fix $x_0, x_1\in X$ with $x_1=s\cdot x_0$ with $s\in G$ secret. Let: 
\[\Sigma:=\{(g_0\cdot x_0,g_1\cdot x_1)\mid g_0, g_1\in G\}\quad \mbox{and} \quad L:=\{(g\cdot x_0,g\cdot x_1)\mid g\in G\}\]
$W:=G$, $\m{K}:=G\times\{0,1\}$ and $\m{P}=\Gamma:=X$.  We define the hash function $\Lambda : (G\times\{0,1\})\times\Sigma\longrightarrow X$ as follows:
\[\forall (h, b)\in G\times\{0,1\}, (y_0,y_1)\in \Sigma, \quad \Lambda((h,b),(y_0,y_1)):=h\cdot y_b\]
and set:
\[\forall (h, b)\in G\times\{0,1\}, \quad \pi(h,b):=h\cdot x_b\]
\[\forall (x,g)\in X\times G, \quad \mbox{ProjEval}(x,g):=g\cdot x\]
\[\forall g\in G, \quad \omega((g\cdot x_0,g\cdot x_1)):=g\]
so that $\Lambda=\mbox{ProjEval}\circ(\pi\times \omega)$ on $\m{K}\times L$.

\begin{theorem}\cite[theorem 1]{DeFeo1}\label{theorem 5}
The system $\Pi:=(\Lambda,\pi,\mbox{ProjEval},L,\Sigma,G,G\times\{0,1\},X,X)$ defined above is a $2^{-1}$-universal hash proof system.
\end{theorem}

\begin{proof}
Under the hypothesis we made, the non-trivial points to prove are subset membership problem and universality.  

Since the group action of $G$ on $X$ is transitive and faithful, sampling an element $(y_0,y_1)\in L$ with uniform distribution is equivalent to sampling $g\in G$ with uniform distribution and returning $(g\cdot x_0, g\cdot x_1)$. Writing $y_0:=g\cdot x_0$, we get that $g\cdot x_1=g\cdot s\cdot x_0=s\cdot g\cdot x_0=s\cdot y_0$ because $G$ is abelian. Since $y_0$ is uniform, $(g\cdot x_0, g\cdot x_1)=(y_0,s\cdot y_0)$ is indistinguishable from $(y_0,y_1)$ sampled with uniform distribution from $X^2$. by weak-pseudorandomness. But $X^2=\Sigma$ by transitivity of the group action. Hence, the uniform distributions on $L$ and $\Sigma$ are undistinguishable.

Let $(h,b)\in G\times\{0,1\}$ be a key (secret and sampled with uniform distribution) and $(y_0,y_1)=(g_0\cdot x_0, g_1\cdot x_1)\in \Sigma\setminus L$ be sampled with uniform distribution. Let us assume that an attacker with unbounded capabilities knows $(y_0,y_1)$ and $\pi(h,b)=h\cdot x_b$ and wants to recover $\Lambda((h,b),(y_0,y_1))=h\cdot y_b$. Since $\pi(h,b)=h\cdot x_b=hs^{2b-1}\cdot x_{1-b}$, the knowledge of $(y_0,y_1)$ and $\pi(h,b)$ enables the unbounded attacker to infer that $\Lambda((h,b),(y_0,y_1))=h\cdot y_b=hg_b\cdot x_b$ or:
\[\Lambda((h,b),(y_0,y_1))=hs^{2b-1}\cdot y_{1-b}=hs^{2b-1}g_{1-b}\cdot x_{1-b}=hs^{2b-1}g_{1-b}s^{1-2b}\cdot x_b=hg_{1-b}\cdot x_b\neq hg_b\cdot x_b\]
Hence, the attacker has a probability $\frac{1}{2}$ to guess the right value. It follows that:
\[H_\infty(\Lambda((h,b),(y_0,y_1))|(\pi(h,b),(y_0,y_1)))=-\log\(\frac{1}{2}\)\]
so that $\Pi$ is $2^{-1}$-universal.
\end{proof}

Using the OSIDH framework, we can take $G:=\mbox{Cl}(\mO_n)$ (or the subgroup generated by the ideals $\mf{q}_1, \cdots, \mf{q}_t$) and $X:=\rho(\mbox{Ell}(\mO_n))$. To simplify the computation of the group action using the techniques of paragraph \ref{paragraph 1}, we could represent elements of $X$ as descending $\ell$-isogeny chains $(E_i)_{0\leq i\leq n}$. However, in that case, weak-pseudorandomness would not hold because of the attacks of paragraph \ref{paragraph 7}.  Indeed, let us fix two descending $\ell$-isogeny chains $(E_{0,i})_{0\leq i\leq n}$ and $(E_{1,i})_{0\leq i\leq n}:=\mf{s}\cdot (E_{0,i})_{0\leq i\leq n}$, where $\mf{s}$ is a secret randomly chosen ideal of $\mO_n$. Then, sampling $[\mf{a}],[\mf{b}]\in\mbox{Cl}(\mO_n)$ uniformly (using Gaussian distributions as explained in remark \ref{remark 3} if necessary) we can distinguish the distribution of pairs $([\mf{a}]\cdot(E_{0,i}),[\mf{a}]\cdot(E_{1,i}))$ and $([\mf{a}]\cdot(E_{0,i}),[\mf{b}]\cdot(E_{1,i}))$ by recovering $[\mf{a}]$ and $[\mf{b}]$. 

To correct this, we use the same technique introduced in paragraph \ref{paragraph 8}. Given an descending $\ell$-isogeny chain $(E_i)_{0\leq i\leq n}$, we give away $E_n\in\rho(\mbox{Ell}(\mO_n))$ together with the additional data:
\[E_{n,j}^{(-r)}:=(\mf{q}_j^{(n)})^{-r}\cdot E_n\longrightarrow \cdots \longrightarrow E_{n}\longrightarrow \cdots\longrightarrow E_{n,j}^{(r)}:=(\mf{q}_j^{(n)})^{r}\cdot E_n\]
for all $j\in\i{1}{t}$. Under assumption ???, weak-pseudorandomness still holds but the subset membership problem remains vulnerable to a subexponential attack (see paragraph ???). In the following, we construct a hash proof system with enhanced subset membership security combining Supersingular Isogeny Diffie Hellman (SIDH) due to \cite{DeFeoSIDH} and OSIDH.

\subsection{An original hash proof system combining SIDH with OSIDH}

Attempts have been made to construct a hash proof system using SIDH only which has stronger security than OSIDH. If the subset membership problem is indeed stronger, these constructions fail to ensure universality, which is a direct consequence of the transitivity and faithfulness of the class group action in the OSIDH framework.  Actually, combining the strengths of both frameworks proves to be fruitful.  The main idea of the hash proof system we propose here is to make the projection $\pi$ act horizontally by ideal class group action (OSIDH component) and make $\mbox{ProjEval}$ act vertically as quotient by cyclic kernels (SIDH component).   

Let $K$ be a quadratic imaginary number field such that $\mbox{Cl}(\mO_K)$ is trivial.  Let $r\neq \ell$ be a small prime inert in $K$ (i.e. such that $\(\frac{\Delta_K}{r}\)=-1$). Let $\ell$ be a small prime and $\mO_i:=\Z+\ell^i\mO_K$ and $\mO_{i,j}:=\Z+\ell^ir^j\mO_K$ for all $i, j\in\N$. We chose $p$ of the form $p:=f r^e\pm 1$ with $e\in\N^*$ big enough (to ensure SIDH security) and $f$ big enough to construct descending $\ell$-ladders and $r$-ladders efficiently with the techniques of paragraph \ref{paragraph 1}. Actually:
\[p>\max_{1\leq j\leq t}(q_j)\ell^{2n}r^{2e}|\Delta_K|\qquad (\mbox{see lemma \ref{lemma 6}})\]
We also impose that $p$ does not split in $K$ (see proposition \ref{proposition 2}). 

\begin{lemma}\label{lemma 7}
Let $E/\F_{p^2}$ such that $|E(\F_{p^2})|=(f r^e)^2$. Then:
\begin{description}
\item[(i)] $E(\F_{p^2})=E[fr^e]$. In particular, $E[r^e]\subseteq E(\F_{p^2})$.
\item[(ii)] Assume that $E\in\rho(\mbox{Ell}(\mO_n))$ and let $P\in E[r^e]$ be of order $r^e$. Then $E/\langle P\rangle\in \rho(\mbox{Ell}(\mO_{n,e}))$ (we recall that $\mO_{n,e}=\Z+r^e\mO_n=\Z+\ell^n r^e\mO_K$).
\end{description}
\end{lemma}

\begin{proof}
\textbf{(i)} Since $|E(\F_{p^2})|=(f r^e)^2=(p\mp 1)^2$, the trace of the $p^2$-th Frobenius $\pi_2$ is $\mp 2p$, so we have $\pi_2^2\pm [2p]\pi_2+[p^2]=0$ i.e. $(\pi_2\pm[p])^2=0$ i.e. $\pi=\mp[p]$. 

Let $P\in E[fr^e]$. Then for all $Q\in E[fr^e]$, we have:
\[e_{fr^e}(\pi_2(P),Q)=e_{fr^e}(\mp[p]P,Q)= e_{fr^e}(P,Q)^{\mp p}=e_{fr^e}(P,Q)^{\mp fr^e+1}=e_{fr^e}(P,Q)\]
so that $e_{fr^e}(\pi_2(P)-P,Q)=1$. It follows that $\pi_2(P)=P$ i.e. $P\in E(\F_{p^2})$. Hence $E[fr^e]\subseteq E(\F_{p^2})$ and we have an equality since both sets have cardinality $(fr^e)^2$.

\textbf{(ii)} Let $\phi : E\longrightarrow E/\langle P\rangle$ the isogeny of kernel $\langle P\rangle$. Then, we have $\phi=\phi_e\circ\cdots\circ\phi_0$ with $\phi_0=[1]_E$ and for all $i\in\i{1}{e}$, $\phi_i :E_{i-1}\longrightarrow E_i$ ($E_0:=E$, $E_e:=E/\langle P\rangle$) has kernel generated by $\phi_{i-1}\circ\cdots\circ\phi_0(r^{e-i}P)$. For all $i\in\i{1}{r}$, $\phi_i$ has degree $r$, so it suffices to prove that $\phi_i$ is descending.  Since $r$ is inert in $K$, by proposition \ref{proposition 5}.(i), $\phi_1$ is descending. Let $i\in\i{2}{e}$. Assume that $\phi_1, \cdots, \phi_{i-1}$ are descending. By proposition \ref{proposition 5}.(ii), $\phi_i$ is either descending or ascending. If it was ascending, since there is only one ascending isogeny, from $E_{i-1}$, we would have $\phi_i=\widehat{\phi_{i-1}}$ so that $\phi$ factors through $[r]$ and $E[r]\subseteq \ker(\phi)$. But $\ker(\phi)$ is cyclic and $E[r]$ is not. Contradiction. Hence, $\phi_i$ is descending. This completes the proof.
\end{proof}

Let $q$ be a prime $\neq r,\ell, p$ splitting in $K$ and $\mf{q}$ a prime ideal of $\mO_K$ lying above $q$. Let $\mf{q}^{(i,j)}:=\mf{q}\cap\mO_{i,j}$ for all $i, j\in\N$. To lighten the notations, the exponent $(i,j)$ will often be omitted. Let $E\in\rho(\mbox{Ell}(\mO_n))$, such that $|E(\F_{p^2})|=(f r^e)^2$ and let $P\in E[r^e]$ of order $r^e$. For our construction, we need to compute the action of $\mf{q}^{(n,e)}$ on $E/\langle P\rangle$ (with its induced $\mO_{n,e}$-orientation).  This computation uses descending $r$-ladders and the ideas of paragraph \ref{paragraph 1}.

\begin{lemma}\label{lemma 8}
There is a descending $r$-ladder of length $n$ and degree $q$:
\[\xymatrix{
E_0 \ar[d]^{\psi_0} \ar[r]^{\phi_1} & E_1\ar[d]^{\psi_1} \ar[r]^{\phi_{2}}& \cdots \ar[r]^{\phi_{e-1}} & E_{e-1} \ar[d]^{\psi_{e-1}} \ar[r]^{\phi_{e}} & E_e \ar[d]^{\psi_e}\\
F_0:=\mf{q}\cdot E_0 \ar[r]^-{\phi'_1} & F_1:=\mf{q}\cdot E_1 \ar[r]^-{\phi'_{2}}& \cdots \ar[r]^-{\phi'_{e-1}} & F_{e-1}:=\mf{q}\cdot E_{e-1} \ar[r]^-{\phi'_{e}} & F_e:=\mf{q}\cdot E_e
}\]
such that: 
\begin{description}
\item[(i)] $E_0=E$ and $E_e=E/\langle P\rangle$.
\item[(ii)] $\phi:=\phi_e\circ\cdots\circ\phi_1$ has kernel $\langle P\rangle$.
\item[(iii)] $\ker(\psi_i)=E_i[\mf{q}]$ for all $i\in\i{0}{e}$.
\item[(iv)] $\phi':=\phi'_e\circ\cdots\circ\phi'_1$ has kernel $\langle \psi_0(P)\rangle$ or equivalently, $\mf{q}\cdot(E/\langle P\rangle)=(\mf{q}\cdot E)/\langle \psi_0(P)\rangle$.
\end{description}
\end{lemma}

\begin{proof}
As in the proof of lemma \ref{lemma 7}, point (ii), we define $\phi_0=[1]_E$ and for all $i\in\i{1}{e}$, $\phi_i :E_{i-1}\longrightarrow E_i$ as the $r$-isogeny of kernel generated by $Q_i:=\phi_{i-1}\circ\cdots\circ\phi_0(r^{e-i}P)$, so that points (i) and (ii) are satisfied. For all $i\in\i{0}{e}$, $\psi_i:E_i\longrightarrow \mf{q}\cdot E_i$ is the isogeny associated to $\mf{q}$ ($\ker(\psi_i)=E_i[\mf{q}]$), so that point (iii) is satisfied. 

To prove the existence of the $r$-ladder satisfying point (iv), we simply prove that for all $i\in\i{1}{e}$, $\psi_i\circ\phi_i$ factors through $\psi_{i-1}$ by an isogeny $\phi'_i$ of kernel $\langle \psi_{i-1}(Q_i)\rangle$.  By \cite[corollary III.4.11]{Silverman1}, it suffices to prove that $\ker(\psi_{i-1})\subseteq \ker(\psi_i\circ\phi_i)$. The equality $\ker(\phi'_i)=\langle \psi_{i-1}(Q_i)\rangle$ will then follow from $\psi_i\circ\phi_i=\phi'_i\circ\psi_{i-1}$. 

Let $\iota_{i-1}$ be the primitive $\mO_{n,i-1}$-orientation defined on $E_{i-1}$. Then, $\iota_i:={\phi_{i}}_{*}(\iota_{i-1})$ is a primitive $\mO_{n,i}$-orientation because $\phi_{i}$ is vertical, as we saw when we proved lemma \ref{lemma 7}, point (ii). Let $P\in\ker(\psi_{i-1})=E_{i-1}[\mf{q}^{(n,i-1)}]$. Then, we have $\iota_{i-1}(\alpha)(P)=0$ for all $\alpha\in\mf{q}^{(n,i-1)}$, so that:
\[\iota_{i}(\alpha)(\phi_i(P))=\frac{1}{r}\phi_i\iota_{i-1}(\alpha)\widehat{\phi_i}\phi_i(P)=\frac{1}{r}\phi_i\iota_{i-1}(\alpha)[r](P)=\phi_i\iota_{i-1}(\alpha)(P)=0\]
for all $\alpha\in \mf{q}^{(n,i)}\subseteq \mf{q}^{(n,i-1)}$. Hence $\phi_i(P)\in E_i[ \mf{q}^{(n,i)}]$ i.e. $\psi_i\circ\phi_i(P)=0$. This completes the proof.
\end{proof}

We can construct the $r$-ladder of lemma \ref{lemma 7} with the techniques of paragraph \ref{paragraph 1}. For all $i\in\i{1}{e}$, $j(F_i)$ is solution of:
\[\left\{\begin{array}{c}
\Phi_q(j(E_i),x)=0\\
\Phi_r(j(F_{i-1}),x)=0
\end{array}\right. \Longleftrightarrow \quad \gcd(\Phi_q(j(E_i),x),\Phi_r(j(F_{i-1}),x))=0\quad (E_i)\]

\begin{lemma}\label{lemma 6}
Conversely, consider a descending $r$-ladder of length $e$ and degree $q$:
\[\xymatrix{
E_0 \ar[d]^{\psi_0} \ar[r]^{\phi_1} & E_1\ar[d]^{\psi_1} \ar[r]^{\phi_{2}}& \cdots \ar[r]^{\phi_{e-1}} & E_{e-1} \ar[d]^{\psi_{e-1}} \ar[r]^{\phi_{e}} & E_e \ar[d]^{\psi_e}\\
F_0 \ar[r]^-{\phi'_1} & F_1 \ar[r]^-{\phi'_{2}}& \cdots \ar[r]^-{\phi'_{e-1}} & F_{e-1} \ar[r]^-{\phi'_{e}} & F_e
}\]
and assume that:
\begin{description}
\item[(i)] $E_0=E$ and $\ker(\phi_i)=\langle\phi_{i-1}\circ \cdots\circ\phi_0(r^{e-i}P)\rangle$ for all $i\in\i{1}{e}$ (with $\phi_0=[1]_{E_0}$).
\item[(ii)] $p>q\ell^{2n}r^{2e}|\Delta_K|$.
\item[(iii)] $F_0=\mf{q}\cdot E_0$
\item[(iv)] $j(F_i)$ is solution of $(E_i)$ for all $i\in\i{1}{e}$.
\item[(v)] $\mf{q}^2$ is not principal in $\mO_n$. 
\end{description}
Then $\ker(\psi_i)=E_i[\mf{q}]$ and $F_i=\mf{q}\cdot E_i$ for all $i\in\i{1}{e}$.
\end{lemma}

\begin{proof}
See proposition \ref{proposition 9}. The same ideas stand.
\end{proof}

In the following, we shall work under the hypothesis of lemma \ref{lemma 6}.

\subsubsection{Settings and public data}

\textbf{1. Two supersingular elliptic curves $E_0$ and $E_1$.}
We fix $E_0\in\rho(\mbox{Ell}(\mO_n))$ and $E_1:=[\mf{s}]\cdot E_0$ for a secret ideal class $[\mf{s}]\in\mbox{Cl}(\mO_n)$ such that $|E_0(\F_{p^2})|=|E_1(\F_{p^2})|=(f r^e)^2=(p\mp 1)^2$ (to ensure that $E_b[r^e]\subseteq E_b(\F_{p^2})$ for $b\in\{0,1\}$, by lemma \ref{lemma 7}.(i)). $E_0$ can be constructed as the ending curve of a descending $\ell$-isogeny chain $(E_{0,i})_{0\leq i\leq n}$ obtained by random descent of the $\ell$-isogeny graph from a known curve $E_{0,0}\in\rho(\mbox{Ell}(\mO_K))$.  Unfortunately, this process does not guarantee the cardinality of $E_0(\F_{p^2})$, which can be in a limited set of values $\{(p-1)^2,p^2-p+1,p^2+1,p^2+p+1,(p+1)^2\}$. Since $|E(\F_{p^2})|$ is roughly uniform when $E/\F_{p^2}$ is sampled uniformly among elliptic curves defined over $\F_{p^2}$ as \cite[theorem 1.1]{Howe} seems to indicate, there is heuristically a probability of success close to $\frac{1}{5}$. By repeating the descent of the $\ell$-isogeny graph we may then reach the desired cardinality.  For, $E_1$ we take the ending curve of $(E_{1,i})_{0\leq i\leq n}:=\mf{s}\cdot (E_{0,i})_{0\leq i\leq n}$ where $\mf{s}$ is uniformly sampled among the $\mO_n$-ideals of norm prime to $r$ and $\ell$, until $|E_1(\F_{p^2})|=(f r^e)^2$. 

\textbf{2. Basis of the $r^e$ torsion of $E_0$ and $E_1$.}
We fix $(P_0, Q_0)$, a basis of $E_0[r^e]$. To do that, we execute a slightly modified version of algorithm \ref{algorithm 5}, using the fact that $E_0[r^e]\subseteq E_0(\F_{p^2})$. First, we sample $P\in E_0(\F_{p^2})$ with uniform distribution and compute $fP$. Then $fP\in E_0[r^e]$ since $E_0(\F_{p^2})=E_0[fr^e]$ by lemma \ref{lemma 7}.(i) and $fP$ has order $r^e$ with probability $1-\frac{1}{r}$ (it can be checked by multiplying $fP$ by $r$ successively). If it is the case, we set $P_0:=fP$. Otherwise, we repeat this step. Then, we sample $Q\in E_0(\F_{p^2})$ in a similar way and compute $fQ$, until $e_{r^e}(P_0,fQ)$ has order $r^e$ and set $Q_0:=fQ$ when this condition is met.  

Then, we know that every point $R\in E_0[r^e]$ of order $r^e$ is of the form $R=\lambda P_0+\mu Q_0$ with $\lambda,\mu\in\Z/r^e\Z$ such that $\lambda$ or $\mu$ is invertible modulo $r^e$.  If $R':=\lambda'P_0+\mu'Q_0$ is another point of order $r^e$, then $\langle R\rangle=\langle R'\rangle$ if and only if there exists $\nu\in(\Z/r^e\Z)^\times$ such that $R'=\nu R$ i.e.  $\lambda'=\nu\lambda$ and $\mu'=\nu\mu$. Hence, the cyclic subgroups of order $r^e$ of $E_0$ are in bijection with $\P^1(\Z/r^e\Z)$ via the map:
\[(\lambda:\mu)\in\P^1(\Z/r^e\Z)\longmapsto \langle \lambda P_0+\mu Q_0\rangle\]
For all $\alpha:=(\lambda:\mu)\in\P^1(\Z/r^e\Z)$, we shall denote by $\langle\alpha\rangle$ the image subgroup $\langle \lambda P_0+\mu Q_0\rangle$. Given an ideal $\mf{a}\subseteq \mO_n$, of norm prime to $r$ and $\ell$, and $\varphi_{\mf{a}}: E_0\longrightarrow \mf{a}\cdot E_0$, the isogeny of kernel $E_0[\mf{a}]$, $B_{\mf{a}}:=(\varphi_{\mf{a}}(P_0), \varphi_{\mf{a}}(Q_0))$ is a basis of $\mf{a}\cdot E_0[r^e]$, since:
\[e_{r^e}(B_{\mf{a}})=e_{r^e}(\varphi_{\mf{a}}(P_0), \varphi_{\mf{a}}(Q_0))=e_{r^e}(P_0,Q_0)^{\deg(\varphi_{\mf{a}})}=e_{r^e}(P_0,Q_0)^{N(\mf{a})}\]
with $N(\mf{a})\wedge r=1$, so that $e_{r^e}(B_{\mf{a}})$ is still a primitive $r^e$-th root of unity.  For all $\alpha:=(\lambda:\mu)\in\P^1(\Z/r^e\Z)$, we shall also denote by $\langle \alpha\rangle_{B_{\mf{a}}}$ or simply $\langle \alpha\rangle$ the subgroup of $\mf{a}\cdot E_b$ generated by $\lambda\varphi_{\mf{a}}(P_0)+\mu\varphi_{\mf{a}}(Q_0)$. By lemma \ref{lemma 8}, we know that $\mf{a}\cdot E_0/\langle\alpha\rangle=(\mf{a}\cap\mO_{n,e})\cdot(E_0/\langle\alpha\rangle)$. 

In particular, we can consider $E_1/\langle\alpha\rangle=\mf{s}\cdot E_0/\langle\alpha\rangle=(\mf{s}\cap\mO_{n,e})\cdot(E_0/\langle\alpha\rangle)$ and the basis $(P_1,Q_1):=(\varphi_{\mf{s}}(P_0), \varphi_{\mf{s}}(Q_0))$ of $E_1[r^e]$. We assume that this basis is public along with $(P_0,Q_0)$. 

\textbf{3. Public chains to compute the action of $\mbox{Cl}(\mO_n)$ horizontally and the action of $\P^1(\Z/r^e\Z)$ vertically on $E_0$ and $E_1$.}
To have a restricted effective group action, we assume that $\mbox{Cl}(\mO_{n,e})$ is generated by $\mf{q}_1^{(n,e)}, \cdots, \mf{q}_t^{(n,e)}$, where $\mf{q}_1, \cdots, \mf{q}_t$ are prime ideals of $\mO_K$ lying above small splitting primes $q_1, \cdots, q_t$ distinct from $r,\ell,p$. We even assume that every ideal of $\mbox{Cl}(\mO_{n,e})$ can be written as a product of these primes with exponents in $\i{-s}{s}$, $s\in\N^*$ being relatively small (negative exponents meaning exponentiation of the conjugate ideal). We assume that the chains $(E_{b,i})_{0\leq i\leq n}$ associated to $E_b=E_{b,n}$ for $b\in\{0,1\}$ remain secret but that the chains:
\[E_{b,j}^{(-s)}:=(\mf{q}_j^{(n)})^{-s}\cdot E_b\longrightarrow \cdots \longrightarrow E_{b}\longrightarrow \cdots\longrightarrow E_{b,j}^{(s)}:=(\mf{q}_j^{(n)})^{s}\cdot E_b\]
are public for all $j\in\i{1}{t}$. Note that these chains can efficiently be computed with the techniques of paragraph \ref{paragraph 1}.  For all $\mO_n$-ideal $\mf{a}$, we denote by $\varphi_{b,\mf{a}}:E_b\longrightarrow \mf{a}\cdot E_b$, the isogeny of kernel $E_b[\mf{a}]$. We assume that the basis $(P_{b,j}^{(k)},Q_{b,j}^{(k)}):=(\varphi_{b,\mf{q}_j^{k}}(P_b),\varphi_{b,\mf{q}_j^{k}}(Q_b))$ of $E_{b,j}^{(k)}[r^e]$ is known for all $k\in\i{-s}{s}$ and $j\in\i{1}{t}$. It can be computed by expressing every isogeny of the chain above by exhaustive search among the $q_j+1$ possible $q_j$-isogenies to match the $j$-invariant of the codomain.

\subsubsection{The Hash Proof System HashOSIDH}

Now, we construct the following hash proof system, that we will call HashOSIDH. Let:
\[\Sigma:=\left\{\(((E_{0,j}^{(k)}/\langle\alpha\rangle)_{\substack{1\leq j\leq t\\ -s\leq k\leq s}}, (E_{1,j}^{(k)}/\langle\beta \rangle)_{\substack{1\leq j\leq t\\ -s\leq k\leq s}}\)\mid \alpha,\beta\in\P^1(\Z/r^e\Z)\right\}\]
and:
\[L:=\left\{\(((E_{0,j}^{(k)}/\langle\alpha\rangle)_{\substack{1\leq j\leq t\\ -s\leq k\leq s}}, (E_{1,j}^{(k)}/\langle\alpha \rangle)_{\substack{1\leq j\leq t\\ -s\leq k\leq s}}\)\mid \alpha\in\P^1(\Z/r^e\Z)\right\}\]
To lighten the notations, the elements of $\Sigma$ will be denoted $(E_0/\langle\alpha\rangle, E_1/\langle\beta\rangle)$ (and similarly for the elements of $L$), omitting the chains which are implicitly known. 

The definition of the projection space $\m{P}$ is more subtle and will become natural later (see the definition of $\pi$ and lemma \ref{lemma 9}). We consider the set $\m{S}$ of tuples $(E,\iota,P,Q)$ where $(E,\iota)$ is a primitively $\mO_n$-oriented elliptic curve whose $K$-equivalence class is in $\rho(\mbox{Ell}(\mO_n))$ and $(P,Q)$ is a basis of $E[r^e]$. We consider the equivalence relation $\sim$ over $\m{S}$ defined as follows: $(E,\iota,P,Q)\sim (E',\iota',P',Q')$ if and only if there exists an isomorphism $\lambda : E\overset{\sim}{\longrightarrow} E'$ such that $\lambda_*(\iota)=\iota'$ and $x, y\in\mO_{n,e}$ of norm prime to $p r\ell$ such that $\lambda\circ\iota(x)(P)=\iota'(y)(P')$ and $\lambda\circ\iota(x)(Q)=\iota'(y)(Q')$; and set $\m{P}:=\m{S}/\sim$. The elements of $\m{P}$ will be denoted by $[E,P,Q]$, omitting the $\mO_n$-orientation, which is unique on $E$ under hypothesis (ii) of lemma \ref{lemma 6}, by theorem \ref{theorem 4}. 

We also set $\m{K}:=\mbox{Cl}(\mO_{n,e})\times\{0,1\}$, $W:=\P^1(\Z/r^e\Z)$ and $\Gamma:=\rho(\mbox{Ell}(\mO_{n,e}))$. We define the functions:
\[\begin{array}{rcl}
\Lambda : \mbox{Cl}(\mO_{n,e})\times\{0,1\}\times \Sigma & \longrightarrow & \rho(\mbox{Ell}(\mO_{n,e}))\\
(([\mf{a}], b),(F_0,F_1)) & \longmapsto & [\mf{a}]\cdot F_b
\end{array}\]
\[\begin{array}{rcl}
\pi : \mbox{Cl}(\mO_{n,e})\times\{0,1\} & \longrightarrow & \m{P}\\
([\mf{a}], b) & \longmapsto & [[\mf{a}\mO_n]\cdot E_b,\varphi_{b,\mf{a}}(P_b),\varphi_{b,\mf{a}}(Q_b)]
\end{array}\]
where $\varphi_{b,\mf{a}}: E_b\longrightarrow (\mf{a}\mO_n)\cdot E_b$ is the isogeny of kernel $E_b[\mf{a}\mO_n]$, for all ideal $\mf{a}\subseteq\mO_{n,e}$ of norm prime to $r$ and $\ell$ and $b\in\{0,1\}$. Note that, by the definition of $\m{P}$, $\pi$ is well defined, meaning that the class $\pi([\mf{a}],b)$ does not depend on the representative $\mf{a}$ chosen in the class $[\mf{a}]$.  In practice, the computed value of $\pi([\mf{a}],b)$ is the value of a representative. Finally, we define:
\[\begin{array}{rcl}
\mbox{ProjEval} :\m{P}\times \P^1(\Z/r^e\Z) & \longrightarrow & \rho(\mbox{Ell}(\mO_{n,e}))\\
([E,P,Q],\alpha:=(a:b)) & \longmapsto & E/\langle\alpha\rangle_{(P,Q)}:=E/\langle aP+bQ\rangle
\end{array}\]
and:
\[\begin{array}{rcl}
\omega : L & \longrightarrow & \P^1(\Z/r^e\Z)\\
(E_0/\langle\alpha\rangle,E_1/\langle\alpha\rangle) & \longmapsto & \alpha
\end{array}\]
The well definition of $\mbox{ProjEval}$ is a consequence of the following lemma:

\begin{lemma}\label{lemma 9}
Let $(E,P,Q), (E',P',Q')\in \m{S}$ such that $(E,P,Q)\sim (E',P',Q')$ and $\alpha\in\P^1(\Z/r^e\Z)$.  Then $E/\langle\alpha\rangle_{(P,Q)}\simeq E'/\langle\alpha\rangle_{(P',Q')}$.
\end{lemma}

\begin{proof}
Since $(E,P,Q)\sim (E',P',Q')$, there exists an isomorphism $\lambda:E\overset{\sim}{\longrightarrow} E'$ and $x, y\in\mO_{n,e}$ of norm prime to $pr\ell$ such that $\lambda\circ\iota(x)(P)=\iota'(y)(P')$ and $\lambda\circ\iota(x)(Q)=\iota'(y)(Q')$, where $\iota$ and $\iota'$ are the primitive $\mO_n$-orientations of $E$ and $E'$ respectively.  We set $\alpha:=(a:b)$. Then, we have:
\begin{align*}
E'/\langle\alpha\rangle_{(P,Q)}&\simeq [y\mO_{n,e}]\cdot(E'/\langle\alpha\rangle_{(P',Q')}) \quad (\mbox{since } y\in\mO_{n,e})\\
&=[y\mO_{n,e}]\cdot(E'/\langle aP'+bQ' \rangle)\simeq [y\mO_n]\cdot E'/\langle \iota'(y)(aP'+bQ')\rangle \quad (\mbox{by lemma \ref{lemma 8}.(iv)})\\
&= E'/\langle \iota'(y)(aP'+bQ')\rangle=E'/\langle \lambda(a\iota(x)(P)+b\iota(x)(Q))\rangle \\
&\simeq E/\langle \iota(x)(aP+bQ)\rangle\quad (\mbox{since } \lambda \mbox{ is an isomorphism})\\
&=[x\mO_n]\cdot E/\langle \iota(x)(aP+bQ)\rangle\simeq [x\mO_{n,e}]\cdot (E/\langle aP+bQ \rangle) \quad (\mbox{by lemma \ref{lemma 8}.(iv)})\\
&=E/\langle aP+bQ \rangle=E/\langle\alpha\rangle_{(P,Q)} \quad (\mbox{since } x\in\mO_{n,e})
\end{align*}
\end{proof}

We now justify that $\Pi:=(\Lambda,\pi,\mbox{ProjEval},L,\Sigma,W,\m{K},\m{P},\Gamma)$ is indeed a hash proof system.

\begin{lemma}
The following diagram is commutative:
\[\xymatrix{
(\mbox{Cl}(\mO_{n,e})\times\{0,1\})\times L  \ar[r]^-{\Lambda} \ar[d]_{\pi\times\omega} & \rho(\mbox{Ell}(\mO_{n,e}))\\
\m{P}\times \P^1(\Z/r^e\Z) \ar[ru]_{\mbox{ProjEval}} &
}\]
\end{lemma}

\begin{proof}
This is a direct consequence of lemma \ref{lemma 8}.
\end{proof}

\begin{lemma}
$\Lambda$, $\pi$ and $\mbox{ProjEval}$ are efficiently computable (i.e. computable in polynomial time in the parameters $n, e,\ell, r, q_1, \cdots, q_t,s$).
\end{lemma}

\begin{proof}
$\mbox{ProjEval}((E,P,Q),\alpha)$ is efficiently computable by computing the chain of $r$-isogenies whose product is the isogoneny of kernel $\langle\alpha\rangle_{(P,Q)}$ for all $[E,P,Q]\in \m{P}$ and $\alpha\in\P^1(\Z/r^e\Z)$. This computation can be optimized with computation trees, as in \cite[section 4.2.2]{DeFeoSIDH}.

Let $b\in\{0,1\}$. The chain:
\[(E_{b,j}^{(-s)},P_{b,j}^{(-s)},Q_{b,j}^{(-s)})\longrightarrow \cdots \longrightarrow (E_{b},P_b,Q_b)\longrightarrow \cdots\longrightarrow (E_{b,j}^{(-s)},P_{b,j}^{(s)},Q_{b,j}^{(s)})\]
is public for all $j\in\i{1}{t}$. Hence, under the hypothesis of lemma \ref{lemma 6}, we can compute efficiently the chain:
\[E_{b,j}^{(-s)}/\langle\alpha\rangle:=(\mf{q}_j^{(n)})^{-s}\cdot (E_b/\langle\alpha\rangle)\longrightarrow \cdots \longrightarrow E_b/\langle\alpha\rangle\longrightarrow \cdots\longrightarrow E_{b,j}^{(s)}/\langle\alpha\rangle:=(\mf{q}_j^{(n)})^{s}\cdot(E_b/\langle\alpha\rangle)\]
for all $j\in\i{1}{t}$ and $\alpha\in\P^1(\Z/r^e\Z)$, by computing the chain of $r$-isogenies whose product is the isogoneny of kernel $\langle\alpha\rangle_{(P_b,Q_b)}$ and using the techniques of paragraph \ref{paragraph 1} to construct ladders on the right and on the left of this chain, whose last elements correspond to the chain above. Hence, given $\mf{a}\subseteq\mO_{n,e}$ expressed as a product of the $\mf{q}_j$: $\mf{a}=\prod_{j=1}^t\mf{q}_j^{e_j}$, with $e_1, \cdots, e_t\in\i{-s}{s}$, and $\alpha_0,\alpha_1\in\P^1(\Z/r^e\Z)$:
\[\Lambda(([\mf{a}],b),(E_0/\langle\alpha_0\rangle,E_1/\langle\alpha_1\rangle))=[\mf{a}]\cdot (E_b/\langle\alpha_b\rangle)\] 
is efficiently computable with the method of paragraph \ref{paragraph 8}, using the chains computed above. 

Knowing the chain:
\[E_{b,j}^{(-s)}\longrightarrow \cdots \longrightarrow E_{b}\longrightarrow \cdots\longrightarrow E_{b,j}^{(-s)}\]
is public for all $j\in\i{1}{t}$, we can easily compute $[\mf{a}\mO_n]\cdot E_b$ using the methods of paragraph \ref{paragraph 8}.  To compute $\pi([\mf{a}],b)$, we still have to compute the image of the basis $(P_b,Q_b)$ by $\varphi_{b,\mf{a}}$, the isogeny associated to $\mf{a}$.  $\varphi_{b,\mf{a}}$ is obtained by composition of $e_j$ $q_j$-isogenies for $j\in\i{1}{t}$.  Each $q_j$-isogeny can be computed using V\'{e}lu's formulas by an exhaustive search among the $q_j+1$ possible isogenies in order to map the $j$-invariant of the domain to the $j$-invariant of the codomain. The complexity of this exhaustive search is $O(s(q_j+1))$ uses of V\'{e}lu's formulas for all $j\in\i{1}{t}$, which is costly but still polynomial.
\end{proof}

\begin{lemma}
HashOSIDH is $2^{-1}$-universal.
\end{lemma}

\begin{proof}
Let $([\mf{a}],b)\in \mbox{Cl}(\mO_{n,e})\times\{0,1\}$ be a key (secret and sampled with uniform distribution). Let $(F_0,F_1)=(E_0/\langle\alpha_0\rangle, E_1/\langle\alpha_1\rangle)\in \Sigma\setminus L$ be sampled with uniform distribution.  Since $(F_0,F_1)\not\in L$, we have $\alpha_0\neq\alpha_1$. Let us assume that an attacker with unbounded capabilities knows $(F_0,F_1)$ and $\pi([\mf{a}],b)=[[\mf{a}\mO_n]\cdot E_b, \varphi_{b,\mf{a}}(P_b),\varphi_{b,\mf{a}}(Q_b)]$ and wants to recover $\Lambda(([\mf{a}],b),(F_0,F_1))=\mf{a}\cdot F_b$.  

We assume that $b=0$. Let $\mf{b}:=\mf{a}\cdot (\overline{\mf{s}}\cap\mO_{n,e})$. We prove that $\pi([\mf{a}],0)=\pi([\mf{b}],1)$. Let $(E,\iota, P,Q)$ and $(E',\iota',P',Q')$ be representatives of $\pi([\mf{a}],0)$ and $\pi([\mf{b}],1)$ respectively. It suffices to prove that $(E,\iota, P,Q)\sim(E',\iota',P',Q')$.  We know that there exists two isomorphisms $\lambda : E\overset{\sim}{\longrightarrow} [\mf{a}\mO_n]\cdot E_0$ and $\lambda' : E'\overset{\sim}{\longrightarrow} [\mf{b}\mO_n]\cdot E_1$ and $x, y, x',y'\in\mO_{n,e}$ of norm prime to $pr\ell$ such that:
\[\left\{\begin{array}{c}
\lambda\circ\iota(x)(P)=\iota_{0,\mf{a}}(y)\circ\varphi_{0,\mf{a}}(P_0)\\
\lambda\circ\iota(x)(Q)=\iota_{0,\mf{a}}(y)\circ\varphi_{0,\mf{a}}(Q_0)
\end{array}\right.\qquad \mbox{and}\qquad \left\{\begin{array}{c}
\lambda'\circ\iota'(x')(P')=\iota_{1,\mf{b}}(y')\circ\varphi_{1,\mf{b}}(P_1)\\
\lambda'\circ\iota'(x')(Q')=\iota_{1,\mf{b}}(y')\circ\varphi_{1,\mf{b}}(Q_1)
\end{array}\right.\quad (\star)\]
where $\iota_{0,\mf{a}}$ and $\iota_{1,\mf{b}}$ are the $\mO_n$-orientations of $[\mf{a}\mO_n]\cdot E_0$ and $[\mf{b}\mO_n]\cdot E_1$ respectively. Since $E_1=[\mf{s}]\cdot E_0$, we have $E_0=[\overline{\mf{s}}]\cdot E_1$, so that $[\mf{a}\mO_n]\cdot E_0=[\mf{b}\mO_n]\cdot E_1$ and $\varphi_{1,\mf{b}}=\varphi_{0,\mf{a}}\circ\varphi_{1,\overline{\mf{s}}}$.  Under hypothesis (ii) of lemma \ref{lemma 6}, we then have $\iota_{0,\mf{a}}=\iota_{1,\mf{b}}$ by theorem \ref{theorem 4}.  Furthermore, $P_1=\varphi_{0,\mf{s}}(P_0)$, so that:
\[\varphi_{1,\mf{b}}(P_1)=\varphi_{0,\mf{a}}\circ\varphi_{1,\overline{\mf{s}}}\circ\varphi_{0,\mf{s}}(P_0)=N(\mf{s})\varphi_{0,\mf{a}}(P_0)\]
and by the same argument $\varphi_{1,\mf{b}}(Q_1)=N(\mf{s})\varphi_{0,\mf{a}}(Q_0)$.  Combining that with $(\star)$, we get:
\[\left\{\begin{array}{c}
\lambda^{-1}\circ\lambda\circ\iota(x'y)(P')=\iota(N(\mf{s})xy')(P)\\
\lambda^{-1}\circ\lambda\circ\iota(x'y)(Q')=\iota(N(\mf{s})xy')(Q)
\end{array}\right.\]
so that $(E',\iota',P',Q')\sim (E,\iota, P,Q)$.

By similar arguments, we get that $\pi([\mf{a}],b)=\pi([\mf{b}],0)$, with $\mf{b}:=\mf{a}\cdot(\overline{\mf{s}}\cap\mO_{n,e})$, when $b=1$. Hence, the attacker can guess $([\mf{a}],b)$ or $([\mf{b}],1-b)$.

With its unbounded capabilities, the attacker can also guess $\alpha_0$ and $\alpha_1$ from $(F_0,F_1)=(E_0/\langle\alpha_0\rangle, E_1/\langle\alpha_1\rangle)$.  We also have:
\begin{align*}\Lambda(([\mf{a}],b),(F_0,F_1))&=[\mf{a}]\cdot F_b=[\mf{a}\mO_n]\cdot E_b/\langle\alpha_b\rangle=[\mf{b}\mO_n]\cdot E_{1-b}/\langle\alpha_b\rangle\\
&\neq [\mf{b}\mO_n]\cdot E_{1-b}/\langle\alpha_{1-b}\rangle=\Lambda(([\mf{b}],1-b),(F_0,F_1))
\end{align*}
since $\alpha_b\neq\alpha_{1-b}$, the inequality is a consequence of the following lemma. Hence, the attacker finds the value of the hash function with $1$ bit of indetermination, so that:
\[H_\infty(\Lambda(([\mf{a}],b),(F_0,F_1))|(\pi([\mf{a}],b),(F_0,F_1)))=-\log\(\frac{1}{2}\)\]
\end{proof}

\begin{lemma}
Let $E\in \rho(\mbox{Ell}(\mO_n))$. Then, the map:
\[\begin{array}{rcl}
\{\mbox{cyclic subbroups of order } r^e \mbox{ in } E[r^e]\}& \longrightarrow & \rho(\mbox{Ell}(\mO_{n,e}))\\
H & \longmapsto & E/H 
\end{array}\]
\end{lemma}

\begin{remark}
Note that under hypothesis (ii) of lemma \ref{lemma 6},  we can omit the $\mO_{n,e}$-orientation when considering elements of $\rho(\mbox{Ell}(\mO_{n,e}))$, and see these elements as elliptic curves up to isomorphism, or equivalently, as $j$-invariants.  Hence, we even have an injective map when considering $j$-invariants.
\end{remark}

\begin{proof}
Let $H, H'$ be two cyclic subgroups of order $r^e$ in $E$ such that $E/H=E/H'$. Then, as in the proof of lemma \ref{lemma 7}.(ii), we have descending $r$-isogeny chains $(E_i)_{0\leq i\leq e}$ and $(E'_i)_{0\leq i\leq e}$ whose composition are the isogenies $E\longrightarrow E/H$ and $E\longrightarrow E/H'$ respectively. We assume that these chains are distinct. Then, there exists $i\in\i{1}{e}$ such that $E_i=E'_i$ and $E_{i-1}\neq E'_{i-1}$. Hence, $E_i$ has two $r$-ascending isogenies, which contradicts proposition \ref{proposition 5}. Then, the two chains are the same and we have $H=H'$.
\end{proof}

Due to the strength of the SIDH framework, we can assume that the subset membership problem for HashOSIDH is hard (i.e. has exponential complexity).

\begin{theorem}
Assuming that uniform distributions on $\Sigma$ and $L$ are computationally indistinguishable (subset membership problem), HashOSIDH is a hash proof system.
\end{theorem}

\bibliography{bib_report_OSIDH}
\bibliographystyle{unsrt}

\appendix

\chapter{Mathematical prerequisites and complements}

\section{Reduction}

Let $R$ be a discrete valuation ring with unique prime ideal $\mf{m}$,  a uniformizer $\pi$ and valuation $v$.  Let $L$ be its field of fractions and $k:=R/\mfm$ be the residue field and $p:=\mbox{char}(k)$.  In practice,  $L$ will be a number field, $R$ will be the localization of $\mO_L$ at a place $\mfp$ lying above $p$ so that $\mfm:=\mfp\mO_{L,\mfp}$ and $\pi$ will be any element of $\mfm\setminus\mfm^2$.  In this case, we will talk by abuse, of reduction modulo $\mfp$ instead of reduction modulo $\mfm$. 

Let $E$ be an elliptic curve defined over $L$.  We assume that $p\geq 5$ so that $E$ admits a simplified Weierstrass equation $y^2=x^3+ax+b$ with $a,b\in L$.  For all $u\in L^*$,  we can substitute $x':=u^2 x$ and $y':=u^3 y$ so that are changed into: $a':=u^4a$ and  $b':=u^6b$.  With these substitutions,  we can always assume that $a, b\in R$.  We can even find a Weierstrass equation with $a, b\in R$ so that $v(\Delta(E))$ is minimal \cite[proposition VII.1.3.(a)]{Silverman1}.  

Then we can reduce a minimal Weierstrass equation modulo $\mfm=\pi R$ to obtain a curve $\overline{E}$ over $k$.  If $\overline{E}$ is singular we say that $E$ has \emph{bad reduction} modulo $\mfm$.  Otherwise,  $\overline{E}$ is an elliptic curve and we say that $E$ has \emph{good reduction} modulo $\mfm$.  It is clear that $E$ has good reduction if and only if $v(\Delta(E))=0$ ($\Delta(E)$ being the minimal discriminant).  If $L$ is a number field,  this case is not very frequent because $\mO_L$ is a Dedekind domain so $\Delta(E)$ is the product of finitely many prime ideals so there are finitely many places with bad reduction.

However,  we would like to avoid bad reduction in all cases.  It would be possible if we had more freedom in the choice of $u$ in the substitutions to get the minimal Weierstrass equation of $E$.  This may be done if we take a finite field extension $L'/L$.  In this case, we say that $E$ has \emph{potential good reduction}.

\begin{proposition}\label{proposition 1}
$E$ has potential good reduction if and only if $j(E)\in R$. 
\end{proposition}

\begin{proof}
See \cite[proposition VII.5.5]{Silverman1}.
\end{proof}

One we have reduced an elliptic curve $E$ to a nonsigular one $\overline{E}$ modulo $\mfm$,  we can reduce points working in projective coordinates and using scalars to make sure the coordinates are in integral (see \cite[VII.2 and VII.3]{Silverman1} for details).  The point reduction is a group homomorphism $E(\overline{L})\longrightarrow E(\overline{k})$.  If $n$ is prime to $p=\mbox{char}(k)$,  it induces an isomorphism $E[n]\longrightarrow \overline{E}[n]$.  

We can also reduce morphisms but the mathematical foundations of this reduction is far beyond the scope of this report and uses N\'{e}ron models (see \cite[chapter IV]{Silverman2} for a presentation of N\'{e}ron models and the forum \href{https://math.stackexchange.com/questions/2352060/definition-of-the-natural-reduction-map-tilde-phi-for-phie-1-to-e-2-an}{\protect\Verb+stackexchange.com+} for the definition of morphism reduction).  However,  the properties of the reduction of morphisms can be stated simply.  Let $E$ and $F$ be ellpitic curve over $L$ with good reduction modulo $\mfm$.  Then there is a group homomorphism :
\[\mbox{Hom}(E,F)\longrightarrow\mbox{Hom}(\overline{E},\overline{F})\]
This map is in fact injective.  But it is not always surjective : for instance,  when $E=F$ are defined over a number field and $\overline{E}=\overline{F}$ is supersingular.  See the results of Deuring (\cite[chapter 13]{Lang_EF}) for more about this topic.   

This definition is functorial,  meaning that the reduction of the composite of two isogenies is the composite of the reductions of these isogenies.  

\section{Rational endomorphisms}

Let $E$ be an elliptic curve defined over a field $k$.  We denote by $\End(E)$ the full endomorphism ring of $E$ (over $\overline{k}$) and $\End_k(E)$ the ring of endomorphisms defined \emph{over $k$}.  In general,  $\End_k(E)\neq\End(E)$ except when $k$ is algebraically closed.  However,  in cryptography,  $k$ is a finite field so we would like to have the equality $\End_k(E)=\End(E)$ for a finite extension $k/\F_p$.

If $E$ is supersingular,  we already know by \cite[theorem V.3.1]{Silverman1} that $E$ can be defined on $\F_{p^2}$ (up to $\overline{\F_p}$-isomorphism).  The following results provide finite extensions $k/\F_{p^2}$ such that $\End_k(E)=\End(E)$.

\begin{lemma}
Let $E/\F_{p^2}$ be a supersingular elliptic curve.  Then there exists a finite extension $k/\F_{p^2}$ such that $\End(E)=\End_k(E)$.  The minimal possible values of $k$ depend on the trace of the Frobenius $t:=|E(\F_{p^2})|-p^2-1$ over $F_{p^2}$ as follows:
\[[k:\F_{p^2}]=\left\{
\begin{array}{cl}
2 & \mbox{if } t=0\\
3 & \mbox{if } t=\pm p\\
1 & \mbox{if } t=\pm 2p 
\end{array}
\right.\]
\end{lemma}

\begin{proof}
Since $E$ is supersingular,  $p|t$ by \cite[theorem V.4.1.a]{Silverman1} so $p\in\{0,\pm p, \pm 2p\}$ by Hasse-Weil's bound \cite[theorem V.1.1]{Silverman1}.  Let $n:=[k:\F_{p^2}]$, $q:=|k|=p^{2n}$ and $t_n:=|E(\F_{q})|-q-1$ the trace of the Frobenius over $\F_q$.  By \cite[theorem 4.1]{Waterhouse1969},  to ensure that $\End(E)=\End_k(E)$,  it is necessary and sufficient that $t_n^2-4q=0$. 

According to \cite[theorem V.2.3.1.a]{Silverman1},  we have $t_n=\alpha^n+\beta^n$ where $\alpha$ and $\beta$ are roots of the $\F_{p^2}$-Frobenius characteristic polynomial $X^2-tX+p^2$.  Then,  it follows that:
\[t_n=\(\frac{-t-\sqrt{t^2-4p^2}}{2}\)^n+\(\frac{-t+\sqrt{t^2-4p^2}}{2}\)^n=\left\{
\begin{array}{cl}
i^np^n(1+(-1)^n) & \mbox{if } t=0\\
2(\pm 1)^n\cos\(\frac{n\pi}{3}\)& \mbox{if } t=\pm p\\
2(\pm 1)^n & \mbox{if } t=\pm 2p 
\end{array}
\right.\]
Hence $t_n^2-4q=0$ if and only if $n\equiv 0 \ [2]$ in the first case,  $n\equiv 0 \ [3]$ in the second case and without condition in the third case.  The result follows immediately.
\end{proof}

\section{The Deuring correspondence}\label{paragraph 2}

Let $E/\F_{p^2}$ be a supersingular elliptic curve and $\m{R}=\End(E)$.  By \cite[theorem 42.1.9]{Voight}, $\m{R}$ is a maximal order in the quaternion algebra $B_{p,\infty}\simeq\End^0(E)$ ramifying at $p$ and $\infty$. Any left integral $\m{R}$-ideal $I\subseteq \m{R}$ of norm prime to $p$ defines a separable isogeny $\phi_I : E\longrightarrow E_I$ whose kernel is:
\[E[I]=\bigcap_{\alpha\in I}\ker(\alpha)\]
This definition can be generalized to ideals $I$ of norm divisible by $p$ by factoring them as follows $I=P^r I'$ where $P$ is the only two sided $\m{R}$-ideal of norm $p$ and $I'$ is an integral left $\m{R}$-ideal of norm prime to $p$.  One pre-compose the isogeny associated to $I'$ by the the $r$-th Frobenius map (see \cite[42.2.4]{Voight}).  The isogeny $\phi_I$ associated to $I$ has degree $n(I)$, the reduced norm of $I$ (by \cite[proposition 42.2.16.(a)]{Voight}).

If $I$ is an integral $\m{R}$-ideal, then the left-order of $I$ is: 
\[O_L(I):=\{\alpha\in B_{p,\infty}\mid \alpha\cdot I \subseteq I\}=\m{R}\]
and by \cite[lemma 42.2.9]{Voight}:
\[O_R(I)=\{\alpha\in B_{p,\infty}\mid I\cdot\alpha \subseteq I\}\simeq \End(E_I)\]
Let $I, J$ be two integral left $\m{R}$-ideals. We say they are \emph{right equivalent} and denote $I\sim J$ if there exists $\beta\in B_{p,\infty}$ such that $J=I\beta$. If $I\sim J$, then $E_I\simeq E_J$ (by \cite[lemma 42.2.13]{Voight}).

Conversely, one can associate an integral left $\m{R}$-ideal to any finite subgroup $H\subseteq E(\overline{\F_p})$:
\[I(H)=\{\alpha\in\m{R}\mid\forall P\in H, \quad \alpha(P)=0\}\]
and in particular, one can define the \emph{kernel ideal} of an isogeny $\phi : E\longrightarrow F$ as $I(\ker(\phi))$, which is isomorphic to $\mbox{Hom}(F,E)$ as a left $\m{R}$-module via:
\[\psi\in\mbox{Hom}(F,E) \longmapsto \psi\circ\phi\in I(\ker(\phi)) \]
by \cite[lemma 42.2.7]{Voight}. Unsurprisingly, we always have $I(E[I])=I$ (by \cite[proposition 42.2.16.(b)]{Voight}) and every isogeny $\phi :E\longrightarrow F$ is determined by its kernel ideal $I:=I(\ker(\phi))$ as follows: there exists an isomorphism $\lambda : E_I\overset{\sim}{\longrightarrow} F$ such that $\phi=\lambda\circ\phi_I$ (by \cite[corollary 42.2.21]{Voight}).

If $\m{R}'$ is a maximal order of $B_{p,\infty}$, then there exists a connecting integral ideal between $\m{R}$ and $\m{R}'$, that is to say a lattice $I\subseteq \m{R}\cap\m{R}'$ such that $O_L(I)=\m{R}$ and $O_R(I)=\m{R}'$. This ideal can easily be constructed by taking $I=\m{R}\m{R}'$ and multiplying it by a certain integer to eliminate cumbersome denominators (see \cite[lemma 17.4.7]{Voight}). We then have $\End(E_I)\simeq\m{R}'$, so we just proved that any maximal order is the endomorphism ring of a supersingular elliptic curve. For a given maximal order $\m{R}$, there are only two elliptic curves at most with $\m{R}$ as endomorphism ring up to isomorphism and one is the image of the other by the $p$-th power Frobenius (see \cite[lemma 42.4.1]{Voight}).   

\section{$\mf{p}$-adic integers}

Let $K$ be a number field and $\mf{p}$ be a prime ideal of $\mO_K$ lying above a prime number $p$. We define the \emph{$\mf{p}$-adic valuation} on $\mO_K$ as follows:
\[\forall x\in\mO_K, \quad v_{\mf{p}}(x):=\sup\{k\in\N\mid x\in\mf{p}^k\}\in\N\cup\{+\infty\}\]
This valuation can be easily extended to $K$ by the formula $v_{\mf{p}}(x/y):=v_{\mf{p}}(x)-v_{\mf{p}}(y)$ for all $x,y\in\mO_K$ with $y\neq 0$.  $v_{\mf{p}}$ is indeed a valuation, meaning that for all $x,y\in K$:
\begin{description}
\item[(i)] $v_{\mf{p}}(x)=+\infty\Longleftrightarrow x=0$.
\item[(ii)] $v_{\mf{p}}(xy)=v_{\mf{p}}(x)+v_{\mf{p}}(y)$.
\item[(iii)] $v_{\mf{p}}(x+y)\geq\min(v_{\mf{p}}(x),v_{\mf{p}}(y))$.
\end{description}
This valuation extends the $p$-adic valuation on $\Q$ in the sense that $v_{\mf{p}}=\frac{1}{e}v_p$ on $\Q$, where $e$ is the ramification index of $\mf{p}$ above $p$. Moreover, it can be proved that all elements of $\mO_K$ have nonnegative $\mf{p}$-adic valuations.  

We can associate a norm to $v_{\mf{p}}$ by setting $|x|_{\mf{p}}:=p^{-v_{\mf{p}}(x)}$ for all $x\in K$. Unlike the complex module, this norm is non-archimedean (because of property (iii)). One can define the $\mf{p}$-adic completion $K_{\mf{p}}$ of $K$ for this norm $|.|_{\mf{p}}$, so that all Cauchy sequences converge.  Formally, the completion is defined as the quotient of the ring of Cauchy sequences by the maximal ideal of sequences converging to zero. We can extend the valuation to $K_{\mf{p}}$ by setting for all $x\in K_{\mf{p}}$, $v_{\mf{p}}(x):=\lim v_{\mf{p}}(x_n)$, where $(x_n)_{n\in\N}$ is a Cauchy sequence representing $x$.  It can be proved that $K_{\mf{p}}$ is complete for the extended valuation (or equivalently, the extended norm) \cite[theorem II.2.1]{Janusz}. Of course, we also have an injection $K\hookrightarrow K_{\mf{p}}$ and $K_{\mf{p}}$ is unique for these properties. 

Let:
\[\mO_{K,\mf{p}}:=\{x\in K_{\mf{p}}\mid v_{\mf{p}}(x)\geq 0\}\]
the ring of \emph{integers} of $K_{\mf{p}}$. It can be proved that $\mO_{K,\mf{p}}$ is integrally closed and has a unique maximal ideal:
\[\mf{m}_{\mf{p}}:=\{x\in K_{\mf{p}}\mid v_{\mf{p}}(x)\geq 1\}\]
This ideal is principal and a generator $\pi\in\mf{m}_{\mf{p}}$ is called a \emph{uniformizer}. Every element $x\in K_{\mf{p}}$ can be uniquely written as $x=\pi^{v_{\mf{p}}(x)}u$ with $u\in \mO_{K,\mf{p}}^\times$ (i.e. such that $v_{\mf{p}}(u)=0$) and admits a unique series development:
\[x=\pi^{v_{\mf{p}}(x)}\sum_{n=0}^{+\infty} a_n\pi^n\]
where the $a_n$ lye in a subset of $\mO_K$ in bijection with $\mO_K/\mf{p}$ via the reduction modulo $\mf{p}$ (see \cite[proposition II.2.8]{Janusz}). As a consequence, we obtain a natural ring isomorphism:
\[\mO_{K,\mf{p}}/\pi^n\mO_{K,\mf{p}}\overset{\sim}{\longrightarrow}\mO_K/\mf{p}^n\]
for all $n\in\N^*$. In particular, the \emph{residue field} $\mO_{K,\mf{p}}/\pi\mO_{K,\mf{p}}$ is isomorphic to $\mO_K/\mf{p}$.

\begin{theorem}[Hensel's lemma]\label{theorem 9}
Let $F\in \mO_{K,\mf{p}}[X]$ and $\overline{F}\in\mO_K/\mf{p}[X]$ its reduction modulo $\mf{m}_{\mf{p}}$. Let $g,h\in \mO_K/\mf{p}[X]$ be two coprime polynomials such that $\overline{F}=g\cdot h$. Then, there exist $G,H\in \mO_{K,\mf{p}}[X]$ such that $F=G\cdot H$ and $G\equiv g \ \mbox{mod} \ \mf{m}_{\mf{p}}$ and $G\equiv g \ \mbox{mod} \ \mf{m}_{\mf{p}}$.
\end{theorem}

\begin{proof}
See \cite[lemma II.3.5]{Janusz}.
\end{proof}

\begin{corollary}\label{corollary 3}
Let $f\in \mO_K/\mf{p}[X]$ admitting a simple root $\alpha\in \mO_K/\mf{p}[X]$ and $F\in \mO_{K,\mf{p}}[X]$ such that $F\equiv f \  \mbox{mod} \ \mf{m}_{\mf{p}}$. Then, there exists $\tilde{\alpha}\in \mO_{K,\mf{p}}$ such that $F(\tilde{\alpha})=0$ and $\tilde{\alpha}\equiv \alpha \ \mbox{mod} \ \mf{m}_{\mf{p}}$. 

In particular, if $f$ factors completely in $\mO_K/\mf{p}[X]$ with simple roots, then so does $F$ in $\mO_{K,\mf{p}}[X]$ and the roots of $F$ reduce to the roots of $f$ modulo $\mf{m}_{\mf{p}}$.
\end{corollary}

\section{The structure of the ideal class group $\mbox{Cl}(\mO_n)$}\label{appendix 1}

Let $K$ be a quadratic imaginary field such that $h(\mO_K)=1$, $\ell$ a small prime, $n\in\N^*$ a big integer and $\mO_n=\Z+\ell^n\mO_K$ the order of conductor $\ell^n$.  In this paragraph, we determine the structure of $\mbox{Cl}(\mO_n)$ and show that this group is either cyclic or quasi-cyclic. Most results of this paragraph are due to \cite[chapter 7]{Cox} and \cite[chapter 4]{Cohen2}.

\begin{lemma}
Let $K$ be a quadratic imaginary field such that $\mbox{Cl}(\mO_K)$ is trivial, $f\in\N\setminus\{0,1\}$ and $\mO:=\Z+f\mO_K$ be the order of $K$ of conductor $f$. Then, we have an exact sequence:
\[\{1\}\longrightarrow\{\pm 1\}\overset{\phi_1}{\longrightarrow} (\Z/f\Z)^\times\times \mO_K^\times\overset{\phi_2}{\longrightarrow} (\mO_K/f\mO_K)^\times\overset{\phi_3}{\longrightarrow} \mbox{Cl}(\mO)\longrightarrow\{1\}\]
Where the group homomorphisms are given by:
\[\phi_1:x\in\{\pm 1\}\longmapsto (x,x)\in (\Z/f\Z)^\times\times \mO_K^\times\]
\[\phi_2:(\overline{x},\omega)\in (\Z/f\Z)^\times\times \mO_K^\times\longmapsto [x\cdot \omega]\in(\mO_K/f\mO_K)^\times\]
\[\phi_3:[\alpha]\in(\mO_K/f\mO_K)^\times\longmapsto [\alpha\mO_K\cap\mO]\in \mbox{Cl}(\mO)\]
\end{lemma}

\begin{proof}
We have to prove that $\phi_1$ is injective (which is trivial), $\ker(\phi_2)=\im(\phi_1)$, $\ker(\phi_3)=\im(\phi_2)$ and that $\phi_3$ is surjective. The surjectivity of $\phi_3$ comes from the fact that every ideal of $\mO$ is given by the intersection of an ideal of $\mO_K$ with $\mO$ by \cite[proposition 7.20]{Cox} and that every ideal of $\mO_K$ is principal.

We trivially have $\ker(\phi_2)\supseteq \im(\phi_1)$. Conversely, let $(\overline{x},\omega)\in (\Z/f\Z)^\times\times \mO_K^\times$ such that $x\cdot \omega\equiv 1 \ \mbox{mod} \ f\mO_K$ so there exists $a, b\in\Z$ such that:
\[x\cdot\omega=1+fa+fb\theta\]
where $\theta$ is a generator of $\mO_K$. If $K\neq\Q(i),\Q(\sqrt{-3})$ then $\mO_K^\times=\{\pm 1\}$ so $b=0$ and $(\overline{x},\omega)\in\{\pm(1,1)\}=\im(\phi_1)$. If $K=\Q(i)$, we may take $\theta:=i$ and we have $\mO_K^\times=\{\pm 1, \pm i\}$. The case $\omega=\pm i$ is impossible, otherwise $f$ would divide $1$, so we must have $\omega=\pm 1$ and we conclude as previously. If $K=\Q(\sqrt{-3})$, then we may assume that $\theta:=(-1+i\sqrt{3})/2$ and we have $\mO_K^\times=\{\pm 1, \pm \theta,\pm\theta^2\}$. As previously, the case $\omega=\pm \theta$ is impossible. If $\omega=\pm\theta^2=\mp(\theta+1)$, then we must have $fb=\mp x$ so $f|x$ and $\overline{x}=0\not\in(\Z/f\Z)^\times$. Hence, $\omega=\pm 1$ and we conclude as previously. Hence, $\ker(\phi_2)=\im(\phi_1)$.

Now, we prove that $\ker(\phi_3)\supseteq \im(\phi_2)$. Let $(\overline{x},\omega)\in (\Z/f\Z)^\times\times \mO_K^\times$. Then:
\[(x\cdot\omega\mO_K)\cap\mO=(x\mO_K)\cap\mO=x\mO\]
since $x\in\mO$, so $\phi_2(\overline{x},\omega)\in \ker(\phi_3)$. Conversely, let $[\alpha]\in(\mO_K/f\mO_K)^\times$ such that $[\alpha\mO_K\cap\mO]=[1]$. Then, there exists $\beta\in\mO$ such that $\alpha\mO_K\cap\mO=\beta\mO$. Hence:
\[\alpha\mO_K=(\alpha\mO_K\cap\mO)\cdot\mO_K=\beta\mO_K\]
so that $\alpha=\beta u$ and $\beta=\alpha v$ with $u, v\in\mO_K$, so that $\beta=\beta uv$, $uv=1$ and $u\in\mO_K^\times$. Let us write $\beta:=a+bf\theta$ with $a, b\in\Z$. Since $[\alpha]\in(\mO_K/f\mO_K)^\times$, there exists $\gamma\in\mO_K$ such that $\alpha\gamma\equiv 1 \ \mbox{mod} \ f\mO_K$ and we get that $N(\alpha)N(\gamma)\equiv 1 \ [f]$, so that $f$ and $N(\alpha)$ are coprime.  Since $N(\beta)=N(\alpha)$, it follows that $a$ is prime to $f$.Hence $\overline{a}\in(\Z/f\Z)^\times$ and:
\[[\alpha]=[au]=\phi_2(\overline{a},u)\]
This completes the proof.
\end{proof}

By the exact sequence of the lemma, we have:
\[\mbox{Cl}(\mO_n)\simeq (\mO_K/\ell^n\mO_K)^\times/((\Z/\ell^n\Z)^\times\times \mO_K^\times/\{\pm(1,1)\})\]
Besides, we have an injective group homomorphism:
\[x\in(\Z/\ell^n\Z)^\times\longmapsto (x,1)\in (\Z/\ell^n\Z)^\times\times \mO_K^\times/\{\pm(1,1)\} \]
inducing a surjection:
\[(\mO_K/\ell^n\mO_K)^\times/(\Z/\ell^n\Z)^\times\relbar\joinrel\twoheadrightarrow \mbox{Cl}(\mO_n) \quad (\star\star)\]
Hence, we shall deduce the structure of $\mbox{Cl}(\mO_n)$ from the structure of $(\mO_K/\ell^n\mO_K)^\times/(\Z/\ell^n\Z)^\times$.

The structure of $(\Z/\ell^n\Z)^\times$ is well known (it is either cyclic or quasi cyclic for $\ell=2$). Now, we determine the structure of $(\mO_K/\ell^n\mO_K)^\times$. By the following lemma, this problem reduces to determining $(\mO_K/\mf{l}^n)^times$ where $\mf{l}$ is a prime ideal of $\mO_K$ lying above $\ell$.

\begin{lemma}\label{lemma 14}
Let $K$ be a number field and $\mf{a}, \mf{b}\subseteq \mO_K$ two coprime integral ideals ($\mf{a}+\mf{b}=\mO_K$). Then, we have:
\[(\mO_K/\mf{a}\mf{b})^\times\simeq(\mO_K/\mf{a})^\times\times(\mO_K/\mf{b})^\times\] 
\end{lemma}

\begin{proof}
We construct a split exact sequence:
\[\{1\}\longrightarrow(\mO_K/\mf{a})^\times\overset{\phi}{\longrightarrow}(\mO_K/\mf{a}\mf{b})^\times \stackrel[\psi]{\sigma}{\leftrightarrows}(\mO_K/\mf{b})^\times\longrightarrow\{1\}\]
Let $a\in\mf{a}$ and $b\in\mf{b}$ such that $a+b=1$. Then, we set, for all $x,y,z\in\mO_K$:
\[\phi(\overline{x})=\overline{bx+a}, \quad \psi(\overline{y})=\overline{y} \quad \mbox{and} \quad \sigma(\overline{z})=\overline{az+b}\]
where the overline denotes the residue class modulo $\mf{a}, \mf{b}$ or $\mf{a}\mf{b}$, depending on the context. 

$\psi$ is trivially a well-defined and surjective group homomorphism since $\mf{a}\mf{b}\subseteq\mf{b}$. 

Similarly, if $x,x'\in\mO_K$ satisfy $x-x'\in\mf{a}$ then $bx+a-(bx'+a)=b(x-x')\in\mf{a}\mf{b}$ so $\phi$ is well-defined as a map $\mO_K/\mf{a}\longrightarrow\mO_K/\mf{a}\mf{b}$. Besides, if $xx'\equiv 1 \ \mbox{mod} \ \mf{a}$ then:
\[(bx+a)(bx'+a)=b^2xx'+ab(x+x')+a^2\equiv a^2+b^2 \ \mbox{mod} \ \mf{a}\mf{b}\]
but $a^2=a(1-b)\equiv a \ \mbox{mod} \ \mf{a}\mf{b}$ and $b^2=b(1-a)\equiv b \ \mbox{mod} \ \mf{a}\mf{b}$ so that: 
\[(bx+a)(bx'+a)\equiv a+b\equiv 1 \ \mbox{mod} \ \mf{a}\mf{b}\]
so $\phi$ maps invertibles to invertibles and is well defined. By the same arguments (exchanging the roles of $\mf{a}$ and $\mf{b}$), we get that $\sigma$ is well defined.

If $x,x'\in\mO_K$ are invertible modulo $\mf{a}$, we also have:
\[\phi(\overline{x})\phi(\overline{x'})=\overline{(bx+a)}\overline{(bx'+a)}=\overline{b^2xx'+ab(x+x')+a^2}=\overline{b^2xx'+a^2}=\overline{bxx'+a}=\phi(\overline{xx'})\]
since $a^2\equiv a \ \mbox{mod} \ \mf{a}\mf{b}$ and $b^2\equiv b \ \mbox{mod} \ \mf{a}\mf{b}$. Hence, $\phi$ is a group homomorphism and by symmetry, $\sigma$ as well.

If $\phi(\overline{x})=1$, then $bx+a\equiv 1 \ \mbox{mod} \ \mf{a}\mf{b}$ so $bx\equiv 1 \ \mbox{mod} \ \mf{a}$ so $x\equiv 1 \ \mbox{mod} \ \mf{a}$ i.e. $\overline{x}=\overline{1}$, since $b=1-a\equiv 1 \ \mbox{mod} \ \mf{a}$. Hence, $\phi$ is injective.

Finally, we have $\psi\circ\sigma=\id$, since $a\equiv 1 \ \mbox{mod} \ \mf{b}$ so we have indeed a split exact sequence. It follows that:
\[\Phi : (\overline{x},\overline{y})\in(\mO_K/\mf{a})^\times\times (\mO_K/\mf{b})^\times\longmapsto \phi(\overline{x})\sigma(\overline{y})\in(\mO_K/\mf{a}\mf{b})^\times\]
is a group isomorphism.
\end{proof}

\subsection{Determining the structure of $(\mO_K/\mf{l}^n)^\times$}

\begin{proposition}\label{proposition 13}
Let $f$ be the inertia index of $\mf{l}$ and $q:=\ell^f$. $G:=(\mO_K/\mf{l}^n)^\times$,
\[W:=\{x\in G\mid x^{q-1}=1\}\]
and $G_{\mf{l}}:=(1+\mf{l})/(1+\mf{l}^n)$ (seen as a subgroup of $G$). Then:

\begin{description}
\item[(i)] $W\simeq(\mO_K/\mf{l})^\times$, so $W$ is cyclic of order $q-1$.

\item[(ii)] $G_{\mf{l}}$ is a $\ell$-group of order $q^{n-1}$.

\item[(iii)] $G\simeq W\times G_{\mf{l}}$.
\end{description}
\end{proposition}

\begin{proof}
\textbf{(i)} $\mO_K/\mf{l}$ is a finite field with $q$ elements so the invertible elements form a cyclic group of order $q-1$ and all of them are roots of $X^{q-1}-1$, so $X^{q-1}-1$ is completely factored in $\mO_K/\mf{l}[X]$ with simple roots:
\[X^{q-1}-1\equiv \prod_{x\in(\mO_K/\mf{l})^\times}(X-x) \ \mbox{mod} \ \mf{l}\]
By Hensel's lemma (see corollary \ref{corollary 3}), this factorization can be lifted in $\mO_{K,\mf{p}}[X]$. By reducing it modulo $\mf{l}^n$, we obtain a factorization mod $\mf{l}^n$:
\[X^{q-1}-1\equiv \prod_{y\in E}(X-y) \ \mbox{mod} \ \mf{l}^n\] 
Where $E\subseteq \mO_K/\mf{l}^n$ is set of $q-1$ elements reducing to $(\mO_K/\mf{l})^\times$ modulo $\mf{l}$. Actually, $E\subseteq (\mO_K/\mf{l}^n)^\times$ because $x\in E$ implies that $x$ is invertible with inverse $x^{q-2}$ and we even have $E\subseteq W$. Let us consider the group homomorphism:
\[\varphi: x\in W\longmapsto (x \ \mbox{mod} \ \mf{l})\in(\mO_K/\mf{l})^\times\]
Since $\varphi(E)=W$, $\varphi$ is surjective.  Now, if $x\in W$, then:
\[0=x^{q-1}-1\equiv \prod_{y\in E}(x-y) \ \mbox{mod} \ \mf{l}^n\]
But $x$ modulo $\mf{l}$, is only congruent to one element of $(\mO_K/\mf{l})^\times$, so there exists $y\in E$ such that $x\equiv y \ \mbox{mod} \ \mf{l}$ and for all $y'\in E\setminus\{y\}$,  $x\not\equiv y \ \mbox{mod} \ \mf{l}$. As a consequence, we must have $x=y$ so $y\in E$.As a consequence, $\varphi$ is injective.

\textbf{(ii)} We have a bijection $G_{\mf{l}}=(1+\mf{l})/(1+\mf{l}^n)\longmapsto \mf{l}/\mf{l}^n$ mapping $1+x$ to $x$. We also have a natural exact sequence:
\[\{1\}\longrightarrow \mf{l}/\mf{l}^n\longrightarrow \mO_K/\mf{l}^n\longrightarrow\mO_K/\mf{l}\longrightarrow\{1\}\]
so that:
\[N(\mf{l}^n)=N(\mf{l})|\mf{l}/\mf{l}^n| \quad \mbox{i.e.} \quad |\mf{l}/\mf{l}^n|=N(\ell)^{n-1}=\ell^{f(n-1)}=q^{n-1}\]
so that $G_{\mf{l}}$ is indeed an $\ell$-group of cardinality $q^{n-1}$.

\textbf{(iii)} Let us consider the group homomorphism:
\[\psi: (x,y)\in W\times G_{\mf{l}}\longmapsto x\cdot y\in G\]
Let $(x,y)\in W\times G_{\mf{l}}$ such that $\psi(x,y)=xy=1$. Since $y\equiv 1 \mbox{mod} \ \mf{l}$, we have $x\equiv 1 \mbox{mod} \ \mf{l}$, so that $x=1$, by injectivity of the morphism $\varphi$ of point $(i)$, and $y=1$. So $\psi$ is injective. 

If $z\in G$, then we consider a lift $x\in W$ of $z \mbox{mod} \ \mf{l}$ (by surjectivity of the map $\varphi$ of point $(i)$) and we set $y:=x^{-1}z$. Then, $y\equiv 1 \ \mbox{mod} \ \mf{l}$ so $y\in G_{\mf{l}}$ and $\psi(x,y)=z$. Hence, $\psi$ is an isomorphism.
 
\end{proof}

It remains to determine the structure of $G_{\mf{l}}:=(1+\mf{l})/(1+\mf{l}^n)$. The main idea here is to prove that the multiplicative group $G_{\mf{l}}$ is isomorphic to the additive group $\mO_K/\mf{l}^{n-1}$ under some conditions.  Fortunately, the group structure of $\mO_K/\mf{l}^{n-1}$ will be easy to determine. 

To linearise the multiplicative structure, we shall use the $\mf{l}$-adic logarithm.

\begin{definition}
Let $K_{\mf{l}}$ be the $\mf{l}$-adic completion of $K$. For all $x\in K_{\mf{l}}$ such that $v_{\mf{l}}(x)\geq 1$, we define the \emph{$\mf{l}$-adic logarithm} of $1+x$ by:
\[\log_{\mf{l}}(1+x):=\sum_{i=1}^{+\infty} \frac{(-1)^{i-1}}{i}x^i\]
Let $e$ be the ramification index of $\mf{l}$ above $\ell$. Then, for all $x\in K_{\mf{l}}$ such that $v_{\mf{l}}(x)>e/(\ell-1)$, we define the \emph{$\mf{l}$-adic exponential} of $x$ by:
\[\exp_{\mf{l}}(x):=\sum_{i=0}^{+\infty}\frac{x^i}{i!}\]
\end{definition}

\begin{proposition}
Let $x, y\in K_{\mf{l}}$ and $e$ be the ramification index of $\mf{l}$ above $\ell$. Then:

\begin{description}
\item[(i)] $\log_{\mf{l}}(1+x)$ is well defined if $v_{\mf{l}}(x)\geq 1$ and $\exp_{\mf{l}}(x)$ is well defined if $v_{\mf{l}}(x)>e/(\ell-1)$.
\item[(ii)] If $v_{\mf{l}}(x)\geq 1$ and $v_{\mf{l}}(y)\geq 1$, we have:
\[\log_{\mf{l}}((1+x)(1+y))=\log_{\mf{l}}(1+x)+\log_{\mf{l}}(1+y)\]
If $v_{\mf{l}}(x)> e/(\ell-1)$ and $v_{\mf{l}}(y)>e/(\ell-1)$,we have:
\[\exp_{\mf{l}}(x+y)=\exp_{\mf{l}}(x)\exp_{\mf{l}}(y)\]
\item[(iii)] If $v_{\mf{l}}(x)>e/(\ell-1)$, then $v_{\mf{l}}(\log_{\mf{l}}(1+x))=v_{\mf{l}}(x)$ and $v_{\mf{l}}(\exp_{\mf{l}}(x)-1)=v_{\mf{l}}(x)$.
\item[(iv)] If $v_{\mf{l}}(x)> e/(\ell-1)$, then we have:
\[\exp_{\mf{l}}(\log_{\mf{l}}(1+x))=1+x \qquad \mbox{and} \qquad \log_{\mf{l}}(\exp_{\mf{l}}(x))=x\]
\end{description}
\end{proposition}

\begin{proof}
\textbf{(i)} In the $\mf{l}$-adic topology, a series converge if and only if its terms converge towards zero. If $v_{\mf{l}}(x)\geq 1$, the we have for all $i\in\N^*$:
\[v_{\mf{l}}\(\frac{(-1)^{i-1}}{i}x^i\)=iv_{\mf{l}}(x)-v_{\mf{l}}(i)=iv_{\mf{l}}(x)-ev_{\ell}(i)\geq i-e\frac{\log(i)}{\log(\ell)}\]
Hence, $v_{\mf{l}}\(\frac{(-1)^{i-1}}{i}x^i\)\xrightarrow[i\rightarrow +\infty]{} +\infty$ and the series $\log_{\mf{l}}(1+x)$ converge.

For all $i\in\N$, we have:
\[v_{\mf{l}}\(\frac{x^i}{i!}\)=iv_{\mf{l}}(x)-v_{\mf{l}}(i!)=iv_{\mf{l}}(x)-ev_{\ell}(i!)\]
with:
\[v_{\ell}(i!)=\sum_{k=1}^{+\infty}\left\lfloor\frac{i}{\ell^k}\right\rfloor=\sum_{k=1}^{\lfloor \log_{\ell}(i)\rfloor}\frac{i}{\ell^k}=\frac{i}{\ell}\frac{1-\frac{1}{\ell^{\lfloor \log_{\ell}(i)\rfloor}}}{1-\frac{1}{\ell}}=\frac{i-\frac{i}{\ell^{\lfloor \log_{\ell}(i)\rfloor}}}{\ell-1}\leq\frac{i-1}{\ell-1}<\frac{i}{\ell-1}\]
so that, if $v_{\mf{l}}(x)>e/(\ell-1)$:
\[v_{\mf{l}}\(\frac{x^i}{i!}\)=i\(v_{\mf{l}}(x)-\frac{ev_{\ell}(i!)}{i}\)> i\(v_{\ell}(x)-\frac{e}{\ell-1}\)\geq i\]
and $v_{\mf{l}}\(\frac{x^i}{i!}\)\xrightarrow[i\rightarrow +\infty]{} +\infty$. Hence, $\exp_{\mf{\ell}}(x)$ converges.

\textbf{(ii)} The equalities hold in the ring of formal series (and can be proved over the complex numbers) so they hold as long as the series involved converge, which is true by $(i)$ for the values of $v_{\mf{l}}(x)$ and $v_{\mf{l}}(x)$ that we assumed.

\textbf{(iii)} We assume that $v_{\mf{l}}(x)> e/(\ell-1)$. To prove that $v_{\mf{l}}(\log_{\mf{l}}(1+x))=v_{\mf{l}}(x)$, it suffices to prove that $v_{\mf{l}}(x^i/i)>v_{\mf{l}}(x)$ for all $i\geq 2$. Let $i\geq 2$. Then:
\[v_{\mf{l}}\(\frac{x^i}{i}\)-v_{\mf{l}}(x)=(i-1)v_{\mf{l}}(x)-ev_{\ell}(i)>e\(\frac{i-1}{\ell-1}-v_{\ell}(i)\)\geq e(v_{\ell}(i!)-v_{\ell}(i))=ev_{\ell}((i-1)!)\geq 0\]
since we have seen that $v_{\ell}(i!)\leq (i-1)/(\ell-1)$. Hence, $v_{\mf{l}}(\log_{\mf{l}}(1+x))=v_{\mf{l}}(x)$.

Now, if $i\geq 2$, we have:
\[v_{\mf{l}}\(\frac{x^i}{i!}\)-v_{\mf{l}}(x)=(i-1)v_{\mf{l}}(x)-ev_{\ell}(i!)>(i-1)\frac{e}{\ell-1}-e\frac{i-1}{\ell-1}=0\]
So we conclude that $v_{\mf{l}}(\exp_{\mf{l}}(x)-1)=v_{\mf{l}}(x)$, as previously.

\textbf{(iv)} $(iii)$ ensures that the series involved in the equalities to be proved converge. Since those equalities hold in the ring of formal series, we conclude as in $(ii)$.
\end{proof}

\begin{corollary}
Suppose that $\ell\geq e+2$. Then $\log_{\mf{l}}$ and $\exp_{\mf{l}}$ induce reciprocal group isomorphisms between $G_{\mf{l}}=(1+\mf{l})/(1+\mf{l}^n)$ and $\mf{l}/\mf{l}^n$ (for $n\in\N^*$).
\end{corollary}

\begin{proof}
Since $\ell\geq e+2$, we have $e/(\ell-1)<1$ so $\exp_{\mf{l}}$ is well defined on $\mf{l}$ by proposition \ref{proposition 13}.(i). Point (iii) of this proposition ensures that $G_{\mf{l}}$ maps to $\mf{l}/\mf{l}^n$ via $\log_{\mf{l}}$ and that $\mf{l}/\mf{l}^n$ maps to $G_{\mf{l}}$ via $\exp_{\mf{l}}$. By point (ii), those are group homomorphisms and by point (iv), those homomorphisms are reciprocal isomorphisms.
\end{proof}

\begin{lemma}\label{lemma 17}
For $n\in\N^*$, we have an isomorphism of additive groups $\mO_K/\mf{l}^{n-1}\simeq \mf{l}/\mf{l}^{n}$.
\end{lemma}

\begin{proof}
We have $\mf{l}^2\subsetneq \mf{l}$ (otherwise, these ideals would have the same norm), so there exists $\alpha\in\mf{l}\setminus\mf{l}^2$. We consider the additive homomorphism $x\in\mO_K\longmapsto \alpha x\in\mf{l}$. Since this homomorphism maps $\mf{l}^{n-1}$ to $\mf{l}^n$, it induces a homomorphism $\phi:\mO_K/\mf{l}^{n-1}\longrightarrow \mf{l}/\mf{l}^{n}$. If $x\in\mO_K$ satisfies $\alpha x\in\mf{l}^n$, then:
\[v_{\mf{l}}(x)=v_{\mf{l}}(\alpha x)-v_{\mf{l}}(\alpha)\geq n-1\]
so that $x\in \mf{l}^{n-1}$. Hence, $\phi$ is injective, and this is an isomorphism because:
\[|\mf{l}/\mf{l}^n|=\frac{N(\mf{l})^n}{N(\mf{l})}=N(\mf{l})^{n-1}=|\mO_K/\mf{l}^{n-1}|\]
since we have the exact sequence:
\[\{1\}\longrightarrow \mf{l}/\mf{l}^n\longrightarrow \mO_K/\mf{l}^n\longrightarrow\mO_K/\mf{l}\longrightarrow\{1\}\]
\end{proof}

\begin{proposition}\label{proposition 14}
Let  $K$ be a number field and $\mf{l}$, a prime ideal of $\mO_K$ lying over a prime number $\ell$. Let $k\in\N^*$, $e$ and $f$ respectively the ramification and inertia index of $\mf{l}$ above $\ell$, $q$ and $r$ be the quotient and remainder in the euclidean division of $k+e-1$ by $e$: $k+e-1=eq+r$ ($r\in\i{0}{e-1}$). Then, we have the following additive group isomorphism:
\[(\mO_K/\mf{l}^k)\simeq (\Z/\ell^q\Z)^{(r+1)f}\times(\Z/\ell^{q-1}\Z)^{(e-r-1)f}\]
\end{proposition}

\begin{proof}
We have $|\mO_K/\mf{l}^k|=N(\mf{l}^k)=\ell^{kf}$ so $\mO_K/\mf{l}^k$ is a $\ell$-group and the structure theorem of finite abelian group ensures that:
\[\mO_K/\mf{l}^k=\prod_{i\geq 1}(\Z/\ell^i\Z)^{a_i}\]
where $(a_i)_{i\geq 1}$ is an almost zero sequence of integers such that:
\[\sum_{i=1}^{+\infty} ia_i=kf\quad (1)\]

We shall now obtain more relations as above to compute all the $a_i$. Let $j\in\N^*$. Then:
\[\ell^j(\mO_K/\mf{l}^k)=\prod_{i\geq j+1}(\Z/\ell^{i-j}\Z)^{a_i}\]
so that:
\[\log_{\ell}(|\ell^j(\mO_K/\mf{l}^k)|)=\sum_{i=j+1}^{+\infty} (i-j)a_i\quad (2)\]
But $\ell^j(\mO_K/\mf{l}^k)=\mf{b}/\mf{l}^k$ with $\mf{b}=\ell^j\mO_K+\mf{l}^k$. Since $\mf{b}$ is an integral ideal of $\mO_K$, which is Dedekind by \cite[corollary 5.6]{Cox}, $\mf{b}$ can be written as a product of prime ideals:
\[\mf{b}=\prod_{i=1}^r\mf{l}_i^{e_i}\]
where $\mf{l}_i$ are distinct primes and the $e_i$ are positive integers. This decomposition is unique.Since $\mf{l}^k\subseteq \mf{b}$, we have $\mf{l}^k\subseteq\mf{l}_i$ for all $i\in\i{1}{r}$, so  $\mf{l}\subseteq\mf{l}_i$ since $\mf{l}$ is prime, so $r=1$ and $\mf{l}_1=\mf{l}$ i.e. $\mf{b}$ is a power of $\mf{l}$ and:
\[v_{\mf{l}}(\mf{b})=\min(v_{\mf{l}}(p^j\mO_K),v_{\mf{l}}(\mf{l}^k))=\min(ej,k)\]
so that $\mf{b}=\mf{ell}^{\min(ej,k)}$. Furthermore, since $\mf{l}^k\subseteq \mf{b}$, we have a natural exact sequence:
\[\{0\}\longrightarrow(\mf{b}/\mf{l}^k)\longrightarrow (\mO_K/\mf{l}^k)\longrightarrow (\mO_K/\mf{b}) \longrightarrow \{0\}\]
so that:
\[|\mf{b}/\mf{l}^k|=\frac{|\mO_K/\mf{l}^k|}{|\mO_K/\mf{b}|}=\frac{N(\mf{l}^k)}{N(\mf{b})}=\ell^{f(k-\min(ej,k))}=\ell^{f(k-\min(ej,k))}=\ell^{f\max(k-ej,0)}\]
By $(2)$, it follows that:
\[f\max(k-ej,0)=\sum_{i=j+1}^{+\infty} (i-j)a_i \quad (3)\]

It follows that $a_i=0$ for all $i>\lceil k/e\rceil$. Let $q$ and $r$ be the quotient and remainder in the euclidean division of $k+e-1$ by $e$: $k+e-1=eq+r$ ($r\in\i{0}{e-1}$). Then $q=k/e+(k+e-1)/e\in[k/e,k/e+1[$, so that $q=\lceil k/e\rceil$.  By $(3)$ applied at $j=q-1$, we get that:
\[a_q=f(k-e(q-1))=f(r+1)\]
Applying $(3)$ again at $j=q-2$, we get:
\[a_{q-1}=f(k-e(q-2))-2a_q=f(r+1+e)-2f(r+1)=f(e-r-1)\]
Since:
\[qa_q+(q-1)a_{q-1}=qf(r+1)+(q-1)f(e-r-1)=qfe-f(e-r-1)=f(qe+r+1-e)=kf\]
we have $a_i=0$ for all $i\in\i{1}{q-2}$ by $(1)$. The result follows.
\end{proof}

\begin{corollary}
Let $n\geq 2$, $e$ and $f$ be respectively the ramification and inertia index of $\mf{l}$ above $\ell$ and $q$ and $r$ the quotient and remainder in the euclidean division of $n+e-2$ by $e$: $n+e-2=eq+r$ with $r\in\i{0}{e-1}$. We assume that $\ell\geq e+2$. Then, we have:
\[(\mO_K/\mf{l}^n)^\times\simeq (\Z/(\ell^f-1)\Z)\times (\Z/\ell^q\Z)^{(r+1)f}\times(\Z/\ell^{q-1}\Z)^{(e-r-1)f}\]
\end{corollary}

\begin{proof}
This result follows directly from proposition \ref{proposition 13}, lemma \ref{lemma 17} and proposition \ref{proposition 14}.
\end{proof}

\subsection{Case $\ell\geq e+2$}

Hence, we assume that $\ell\geq e+2$. Then, by the preceding corollary, we have:
\[(\mO_K/\ell^n\mO_K)^\times\simeq \left\{ \begin{array}{ll} 
(\Z/(\ell-1)\Z)^2\times(\Z/\ell^{n-1}\Z)^2 & \mbox{ if $\ell$ splits in $K$}\\
(\Z/(\ell-1)\Z)\times(\Z/\ell^{n-1}\Z)\times(\Z/\ell^{n}\Z)  & \mbox{ if $\ell$ ramifies in $K$}\\ 
(\Z/(\ell^2-1)\Z)\times(\Z/\ell^{n-1}\Z)^2  & \mbox{ if $\ell$ is inert in $K$}
\end{array}\right.\]
Since $\ell\geq e+2\geq 3$, by \cite[theorem IV.2]{Ireland1982}, $(\Z/\ell^n\Z)^\times$ is cyclic, so that:
\[(\Z/\ell^n\Z)^\times\simeq \Z/\varphi(\ell^n)\Z=\Z/(\ell-1)\ell^{n-1}\Z\simeq (\Z/(\ell-1)\Z)\times(\Z/\ell^{n-1}\Z)\]
To compute the quotient, $(\mO_K/\ell^n\mO_K)^\times/(\Z/\ell^n\Z)^\times$, we need the following result.

\begin{lemma}

\begin{description}

\item[(i)] Let $\Phi: G_1\times G_2\longmapsto H_1\times H_2$ be an injective group homomorphism between finite groups. Suppose that $|H_1|$ and $|H_2|$ are coprime and that $|G_i|||H_i|$ for $i\in\{1,2\}$. Then there exists injective group homomorphisms $\varphi_i: G_i\longrightarrow H_i$ for $i\in\{1,2\}$ such that:
\[\forall (g_1, g_2)\in G_1\times G_2, \quad \Phi(g_1,g_2)=(\varphi_1(g_1),\varphi(g_2))\]

\item[(ii)] Let $d\in\N^*$ and:
\[\varphi: \Z/d\Z\longmapsto (\Z/d\Z)^2\]
be an injective group homomorphism. Then:
\[(\Z/d\Z)^2/\im(\varphi)\simeq \Z/d\Z\]

\item[(iii)] Let $\varphi: \Z/\ell^{n-1}\Z\longrightarrow (\Z/\ell^{n-1}\Z)\times(\Z/\ell^{n}\Z)$ be an injective group homomorphism, then:
\[(\Z/\ell^{n-1}\Z)\times(\Z/\ell^{n}\Z)/\im(\varphi)\simeq \Z/\ell^{n}\Z \quad \mbox{or} \quad (\Z/\ell\Z)\times(\Z/\ell^{n-1}\Z)\]
\end{description}

\end{lemma}

\begin{proof}
\textbf{(i)} We may write $\Phi(g):=(\phi_1(g),\phi_2(g))$ for all $g\in G_1\times G_2$, where $\phi_i:G_1\times G_2\longrightarrow H_i$ are group homomorphisms.  Let $g_1\in G_1$. Then, $|\phi_2(g_1,1)|||g_1|$ ($|x|$ being the order of $x$) and by Lagrange's theorem $|\phi_2(g_1,1)|||H_2|$ and $|g_1|||G_1|||H_1|$. Since $|H_1|$ and $|H_2|$ are coprime, we have $|\phi_2(g_1,1)|=1$ so $\phi_2(g_1,1)=1$. By similar arguments, $\phi_1(1,g_2)=1$ for all $g_2\in G_2$ and the result follows.

\textbf{(ii)} It suffices to prove that:
\[ (\Z/d\Z)^2=\im(\varphi)\oplus\{0\}\times\Z/d\Z\]

Let $\varphi(1):=(\overline{a},\overline{b})$, with $a,b\in\i{0}{d-1}$. Then,  $\varphi(1)$ has order $d$ because $\varphi$ is injective so either $\overline{a}$ or $\overline{b}$ have order $d$ so we either have $\gcd(a,d)=1$ or $\gcd(b,d)=1$. Without loss of generality, we can assume that $\gcd(a,d)=1$.  It follows that for all $k,l\in\Z$, if $\varphi(\overline{k})+(0,\overline{l})=0$, then we have $k\overline{a}=0$ so $d|ka$ so $d|k$ and $\overline{k}=0$, so that $\overline{l}=0$. Besides, if $x,y\in\Z$, by B\'{e}zout's theorem, there exists $k\in\Z$ such that $k\overline{a}=\overline{x}$ and setting $l:=\overline{y}-k\overline{b}$, we get $\varphi(\overline{k})+(0,\overline{l})=(\overline{x},\overline{y})$. 

\textbf{(iii)} Let $a,b\in\Z$ such that $\varphi(1)=(\overline{a},\overline{b})$.  Since $\varphi$ is injective, $\varphi(1)$ has order $\ell^{n-1}$ so $\ell^{n-1}\overline{b}=0$ i.e. $\ell^n|\ell^{n-1}b$ i.e. $\ell|b$. So we may write $a:=\ell^e a'$ and $b:=\ell^f b'$ with $a'$ and $b'$ prime to $\ell$, $e\in\N$ and $f\in\N^*$.  It follows that:
\[\ell^{n-1}=|\varphi(1)|=\mbox{lcm}(|\overline{a}|,|\overline{b}|)=\mbox{lcm}(\ell^{n-1-e},\ell^{n-f})=\ell^{\max(n-1-e,n-f)}\]
so that $\max(n-1-e,n-f)=n-1$. If $e=0$, we obtain that:
\[(\Z/\ell^{n-1}\Z)\times(\Z/\ell^{n}\Z)/\im(\varphi)\simeq \Z/\ell^{n}\Z\]
by the arguments we used in (ii). 

Else, we have $f=1$. To conclude, it suffices to prove that the quotient has exponent $\ell^{n-1}$. Let $x,y\in\Z$. Then, $\ell^{n-1}(\overline{x},\overline{y})=(0,\overline{\ell^{n-1}y})=\varphi(\overline{\ell^{n-2}k})$ with $k\in\Z$ such that $kb'\equiv y \ [\ell]$ (such a $k$ exists because $b'$ and $\ell$ are coprime).  Hence, the exponent of the quotient divides $\ell^{n-1}$.  Furthermore, if $\ell^{n-2}(\overline{1},0)=\varphi(\overline{k})$ for some $k\in\Z$ then $\ell^n|k\ell b'$ so $\ell^{n-1}|k$ since $\gcd(\ell,b')=1$. Hence, $\overline{k}=0$ and $\ell^{n-2}(\overline{1},0)=0$. Contradiction. So $(\overline{1},0)$ has order $\ell^{n-1}$ in the quotient. This completes the proof.

\end{proof}

Applying the preceding lemma and the fact that a quotient of cyclic groups is cyclic, we conclude that:
\[(\mO_K/\ell^n\mO_K)^\times/(\Z/\ell^n\Z)^\times \simeq \left\{ \begin{array}{l} 
(\Z/(\ell-1)\Z)\times(\Z/\ell^{n-1}\Z) \mbox{ if $\ell$ splits}\\
\Z/\ell^{n}\Z \quad \mbox{or} \quad (\Z/\ell\Z)\times(\Z/\ell^{n-1}\Z) \mbox{ if $\ell$ ramifies}\\ 
(\Z/(\ell+1)\Z)\times(\Z/\ell^{n-1}\Z)  \mbox{ if $\ell$ is inert}
\end{array}\right.\]
By the surjection $(\star\star)$, we conclude that $\mbox{Cl}(\mO_n)$ is either cyclic or has rank $2$ with a tiny cyclic factor of order $\ell$, the last case happening only when $\ell$ ramifies in $K$.

\subsection{Case $\ell< e+2$}

Now, we assume that $\ell< e+2$. Hence, $\ell=2$ or $\ell=3$ and $\ell$ ramifies in $K$.  We shall conclude with the following lemma:

\begin{lemma}\label{lemma 18}

\begin{description}
\item[(i)] Let $\mf{a}$ be an $\mO_K$-ideal prime to $\ell$ that we may write $\mf{a}=\alpha\mO_K$ with $\alpha\in\mO_K$ ($\mbox{Cl}(\mO_K)$ being trivial). Let $i\in\N^*$. Then $\mf{a}\cap\mO_i$ is principal if and only if $\alpha\in\mO_K^\times\cdot \mO_i$.

\item[(ii)] Let $i\in\N^*$ and $\alpha\in\mO_i$. Then, $\alpha^\ell\in\mO_{i+1}$. Assume furthermore that $i\geq 2$, $\ell\nmid N(\alpha)$ and $\alpha\in\mO_i\setminus\mO_{i+1}$. Then, $\alpha\in\mO_{i+1}\setminus\mO_{i+2}$.

\item[(iii)] Let $i\in\N^*$ and $\alpha\in \mO_K^\times\cdot(\mO_i\setminus\mO_{i+1})$ such that $\ell\nmid N(\alpha)$. Then, $\alpha\in\mO_K^\times\cdot\mO_{i+1}$.

\item[(iv)] Let $i_0\geq 2$ such that $\mbox{Cl}(\mO_{i_0})$ has exponent $k$ and $\mbox{Cl}(\mO_{i_0+1})$ has exponent $k\ell$. Then, there exists an $\mO_K$-ideal $\mf{a}$ such that $\mf{a}\cap\mO_i$ has order $k\ell^{i-i_0}$ in $\mbox{Cl}(\mO_i)$ for all $i\geq i_0$ and $\mbox{Cl}(\mO_i)$ has exponent $k\ell^{i-i_0}$ for all $i\geq i_0$.
\end{description}
\end{lemma}

\begin{proof}

\textbf{(i)} Assume that $\mf{a}\cap\mO_i$ is principal. Then, there exists $\beta\in\mO_i$ such that $\mf{a}\cap\mO_i=\beta\mO_i$.  By \cite[proposition 7.20]{Cox}, it follows that $\alpha\mO_K=\mf{a}=(\mf{a}\cap\mO_i)\mO_K=\beta\mO_K$. Hence, $\alpha=\beta u$ and $\beta=\alpha v$ with $u, v\in\mO_K$, so that $\beta=\beta uv$, $uv=1$ and $u\in\mO_K^\times$, so that $\alpha\in\mO_K^\times\cdot \mO_i$. The converse is trivial.

\textbf{(ii)} Let $\theta$ be a generator of $\mO_K$. Let us write $\alpha=a+b\ell^i\theta$.  Then:
\[\alpha^\ell=a^\ell+\ell^{i+1}a^{\ell-1}b\theta+\sum_{k=2}^\ell\binom{\ell}{k}a^{\ell-k}\ell^{ik}b^k\theta^k\in \Z+\ell^{i+1}\mO_K=\mO_{i+1}\]
Now, assume that $i\geq 2$, $\ell\nmid N(\alpha)$ and $\alpha\not\in\mO_{i+1}$. Since $\ell|\binom{\ell}{k}$ for all $k\in\i{1}{\ell-1}$ and $i\geq 2$, we have:
\[\sum_{k=2}^\ell\binom{\ell}{k}a^{\ell-k}\ell^{ik}b^k\theta^k\in\ell^{i+2}\mO_K\]
Hence, to conclude that $\alpha^\ell\not\in\mO_{i+2}$, it suffices to prove that $\ell\nmid a^{\ell-1}b$. But $\ell\nmid a$ since $\ell\nmid N(\alpha)$ and $\ell\nmid b$ since $\alpha\not\in\mO_{i+1}$. The result follows.

\textbf{(iii)} For $K\neq \Q(\sqrt{-1}), \Q(\sqrt{-3})$, we have $\mO_K^\times=\{\pm 1\}$ so the result trivially holds.

Assume that $K:=\Q(\sqrt{-1})$. Let $\theta:=\sqrt{-1}$. Then, $\mO_K=\Z[\theta]$ and $\mO_K^\times=\{\pm 1,\pm\theta\}$.  Let $\alpha\in\mO_{i}$ that we may write $\alpha:=a+b\ell^{i}\theta$ with $a,b\in\Z$. Then:
\[\theta\alpha=-b\ell^{i}+a\theta\]
Since $\ell\nmid N(\alpha)$, $\ell\nmid a$ so $\theta\alpha\not\in\mO_{i+1}$.  The result follows in that case.

Assume that $K:=\Q(\sqrt{-3})$. Let $\theta:=(-1+\sqrt{-3})/2$. Then, $\mO_K=\Z[\theta]$ and $\mO_K^\times=\{\pm 1,\pm\theta,\pm\theta^2\}$.Let $\alpha\in\mO_{i}\setminus\mO_{i+1}$ that we may write $\alpha:=a+b\ell^{i}\theta$ with $a,b\in\Z$. Then:
\[\theta\alpha=a\theta+b\ell^i\theta^2=a\theta-b\ell^i(\theta+1)=-b\ell^i+(a-b\ell^i)\theta\]
\[\theta^2\alpha=-b\ell^i\theta+(a-b\ell^i)\theta^2=a\theta-(a-b\ell^i)(\theta+1)=b\ell^i-a+b\ell^i\theta\]
Since $\ell\nmid N(\alpha)$, $\ell\nmid a$ so $\theta\alpha\not\in\mO_{i+1}$.  Since $\alpha\not\in\mO_{i+1}$, $\ell\nmid b$ so that $\theta^2\alpha\not\in\mO_{i+1}$. The result follows.

\textbf{(iv)} Let $i\geq i_0$. Then, by \cite[proposition 7.20]{Cox} every invertible ideal of $\mO_i$ is of the form  $\mf{a}\cap\mO_i$ for a certain $\mO_K$-ideal $\mf{a}$ prime to $\ell$.  Let us write $\mf{a}:=\alpha\mO_K$ for $\alpha\in\mO_K$. Then, $\mf{a}^k\cap\mO_{i_0}$ is principal (since $\mbox{Cl}(\mO_{i_0})$ has exponent $k$) so $\alpha^{k}\in\mO_K^\times\cdot \mO_{i_0}$ by $(i)$ and by $(ii)$, $\alpha^{k\ell^{i-i_0}}\in\mO_K^\times\cdot\mO_i$, so that $\mf{a}^{k\ell^{i-i_0}}\cap\mO_i$ is principal. Hence, the exponent of $\mbox{Cl}(\mO_i)$ divides $k\ell^{i-i_0}$. 

Let $\mf{a}$ be an $\mO_K$-ideal prime to $\ell$ such that $\mf{a}\cap\mO_{i_0+1}$ has order $k\ell$ in $\mbox{Cl}(\mO_{i_0+1})$.  Let us write $\mf{a}:=\alpha\mO_K$ with $\alpha\in\mO_K$. Let $d$ be the order of $\mf{a}\cap\mO_{i_0}$ in $\mbox{Cl}(\mO_{i_0})$. Then, $\alpha^{d}\in\mO_K^\times\cdot\mO_{i_0}$ by $(i)$, so that $\alpha^{d\ell}\in\mO_K^\times\cdot\mO_{i_0+1}$ by $(ii)$, so that the order of $\mf{a}\cap\mO_{i_0+1}$ in $\mbox{Cl}(\mO_{i_0+1})$ divides $d\ell$., i.e. $k\ell|d\ell$ so $k|d$. But we also have $d|k$ because $\mbox{Cl}(\mO_{i_0})$ has exponent $k$, so $d=k$. 

We have $\alpha^k\in\mO_K^\times\cdot(\mO_{i_0}\setminus\mO_{i_0+1})$, otherwise, by $(i)$, $\mf{a}\cap\mO_{i_0+1}$ would have order $\leq k$. By $(ii)$, it follows that $\alpha^{k\ell^{i-i_0}}\in\mO_K^\times\cdot(\mO_{i}\setminus\mO_{i+1})$ for all $i\geq i_0$.

Now, we prove by induction on $i\geq i_0$ that $\mf{a}\cap\mO_i$ has order $k\ell^{i-i_0}$. As we already saw, the result holds for $i\in\{i_0,i_0+1\}$. Let $i\geq i_0+1$. Assume that $\mf{a}\cap\mO_i$ has order $k\ell^{i-i_0}$. It follows that for all $d\in\N^*$, $\alpha^d\in\mO_K^\times\cdot \mO_i$ if and only if $k\ell^{i-i_0}|d$.  As a consequence, $\alpha^{k\ell^{i+1-i_0}}\in\mO_K^\times\cdot \mO_{i+1}$ and if $d\in\N^*$ is such that $\alpha^{d}\in\mO_K^\times\cdot \mO_{i+1}\subseteq \mO_K^\times\cdot \mO_{i}$, then we must have $k\ell^{i-i_0}|d$ and $d|k\ell^{i+1-i_0}$ since the exponent of $\mbox{Cl}(\mO_{i+1})$ divides $k\ell^{i+1-i_0}$. But $\alpha^{k\ell^{i-i_0}}\not\in\mO_K\cdot\mO_{i+1}$ since $\alpha^{k\ell^{i-i_0}}\not\in\mO_K\cdot(\mO_i\setminus\mO_{i+1})$ and by $(iii)$. Hence, $\mf{a}\cap\mO_{i+1}$ has order $k\ell^{i+1-i_0}$. This completes the proof.

\end{proof}

By point $(iv)$ of the preceding lemma, we determine the structure of $\mbox{Cl}(\mO_n)$ by computing the exponent of $\mbox{Cl}(\mO_2)$ and $\mbox{Cl}(\mO_3)$. Since $\mbox{Cl}(\mO_K)$ is trivial, we have:
\[\mbox{disc}(K)\in\{-3,-4,-7,-8,-11,-19,-43,-67,-163\}\]
by \cite[theorem 7.30.(i)]{Cox}, so we have a limited number of computations to make. What happens is usually that either $\mbox{Cl}(\mO_{2})$ and $\mbox{Cl}(\mO_{3})$ are cyclic, in that case $\mbox{Cl}(\mO_n)$ is cyclic or $\mbox{Cl}(\mO_{i_0})\simeq(\Z/\ell\Z)\times(\Z/k\Z)$ and $\mbox{Cl}(\mO_{i_0+1})\simeq(\Z/\ell\Z)\times(\Z/k\ell\Z)$ for certain integers $i_0\geq 2$ and $k\geq 2$, in which case $\mbox{Cl}(\mO_n)\simeq(\Z/\ell\Z)\times(\Z/k\ell^{n-i_0}\Z)$.  We performed the computations with \verb?Magma? \cite{Magma} and obtained the following results:

\begin{center}
\begin{tabular}{|c|c|c|}
\hline
\diagbox{$\mbox{disc}(K)$}{$\ell$} & $2$ & $3$ \\ 
\hline
 $-3$ & $(\Z/2\Z)\times(\Z/2^{n-2}\Z)$ & $\Z/3^{n-1}\Z$ \\  
 \hline
$-4$ & $\Z/2^{n-1}\Z$ & \\  
\hline
$-7$ &  $(\Z/2\Z)\times(\Z/2^{n-2}\Z)$ & \\  
\hline
$-8$ &  $\Z/2^{n-1}\Z$ & \\  
\hline
$-11$ &  $(\Z/2\Z)\times(\Z/3\cdot 2^{n-2}\Z)$ & \\  
\hline
$-19$ &  $(\Z/2\Z)\times(\Z/3\cdot 2^{n-2}\Z)$ & \\
\hline  
$-43$ &  $(\Z/2\Z)\times(\Z/3\cdot 2^{n-2}\Z)$  & \\  
\hline
$-67$ &  $(\Z/2\Z)\times(\Z/3 \cdot 2^{n-2}\Z)$ & \\  
\hline
$-163$ &  $(\Z/2\Z)\times(\Z/3\cdot 2^{n-2}\Z)$ & \\
\hline
\end{tabular}
\end{center}

Finally, we have the concluding theorem:

\begin{theorem}\label{theorem 10}
One of the following results hold:

\begin{description}
\item[(i)] For all $n\geq 1$, $\mbox{Cl}(\mO_n)$ is cyclic.
\item[(ii)] For all $n\geq 2$, $\mbox{Cl}(\mO_n)\simeq (\Z/\ell\Z)\times(\Z/h_{n-1}\Z)$ with:
\[h_{n-1}:=|\mbox{Cl}(\mO_{n-1})|=\frac{\ell^{n-2}}{[\mO_K^\times:\mO_1^\times]}\(\ell-\(\frac{\Delta_K}{\ell}\)\)\]
where $\Delta_K:=\mbox{disc}(K)$.
\end{description}
The last case only happens when $\ell=2$ or when $\ell\geq 3$ ramifies in $K$ (this condition is necessary but not sufficient). 
\end{theorem} 

\chapter{Algorithms}

\section{Proper representation of an integer by a positive definite primitive quadratic form}\label{paragraph 5}

We follow the approach of \cite[§ 46, pp. 73-75]{Dickson}. We want to solve $f(x,y)=u$ for $x, y\in \Z$ with $\gcd(x,y)=1$, where $f:=[a,b,c]$ is a positive definite primitive quadratic form of discriminant $d<0$. The following algorithm determines if a solution exists and provides one.

\begin{algorithm}\label{algorithm 3}
\SetAlgoLined
\KwData{An integer $u\in\N$ and $[a,b,c]$, a positive definite primitive quadratic form of discriminant $d<0$.}
\KwResult{A solution $(x, y)$ of the equation $f(x,y)=u$ if there exists one, the boolean value False otherwise.}
Find a solution $v\in\i{0}{2u}$ to $v^2\equiv d \ [4u]$, e.g. using Tonelli-Shanks algorithm \cite[algorithm 1.5.1]{Cohen1} when $u$ is prime to find a square root mod $u$, and conclude by Chinese remainder theorem. If $d$ is not a square mod $4u$, return False\; 
Compute $w\in\Z$ such that $v^2-4uw=d$\;
Find the reduced form $[a',b',c']$ of $[a,b,c]$ and the associated unimodular transformation $x:=a_1x'+b_1y'$, $y:=c_1x+d_1y$ associated to it, using Gauss reduction algorithm described in \cite[theorem 2.8]{Cox}\;
Find the reduced form $[u',v',w']$ of $[u,v,w]$ and the associated unimodular transformation $x:=a_2x'+b_2y'$, $y:=c_2x+d_2y$ associated to it\;
\eIf{$[a',b',c']=[u',v',w']$}{
   $x:=a_2d_1-b_2c_1$, $y:=-a_2b_1+b_2a_1$\;
   Return $(x,y)$\;
   }{
   Return False\;
  }

\caption{Proper representation of an integer}
\end{algorithm}

It could be proved that this algorithm is correct and terminates in polynomial time in the size (number of bits) of $u,a,b,c$.

\section{Factorisation of an ideal into prime ideals in a quadratic number field}

\begin{algorithm}\label{algorithm 6}

\caption{Factorisation into prime ideals}
\end{algorithm}

\begin{algorithm}\label{algorithm 7}

\caption{Valuation of an ideal at a prime ideal}
\end{algorithm}

\section{Discrete logarithm and basis computation in finite abelian groups}

In this section, we present some algorithms due to Sutherland \cite{Sutherland2010} to compute discrete logarithms and basis of finite abelian groups, with the intent to apply them to $\mbox{Cl}(\mO_n)$.

The first three paragraphs are general and apply to any finite abelian group. However, the case of $\mbox{Cl}(\mO_n)$ is much simpler because this group is either cyclic of the product of $\Z/\ell\Z$ and a cyclic group.

\subsection{Discrete logarithm in a basis}

Throughout this paragraph, if $G$ is a finite group and $g\in G$, we shall denote by $|g|$ the order of $g$. If $\m{F}:=(g_1,\cdots, g_r)\in G^r$ and $x\in\Z^r$, we shall denote:
\[\m{F}^x:=\prod_{i=1}^r g_i^{x_i}\]

\begin{definition}
Let $G$ be a finite abelian group.  We say that the family $\m{F}:=(g_1,\cdots, g_r)\in G^r$ is \emph{free} if for all $x\in \Z^r$, $\prod_{i=1}^{r}g_i^{x_i}=1$ if and only if $|g_i||x_i$ for all $i\in\i{1}{r}$.


A \emph{basis} of $G$ is a free family $\m{B}:=(g_1,\cdots, g_r)\in G^r$ generating $G$. Equivalently, $\m{B}$ is a basis of $G$ if for every element $h\in G$ there exists a unique $x\in\prod_{i=1}^r\i{0}{|g_i|-1}$ such that $\m{B}^x=h$.

A basis is \emph{primitive} if it does not contain a trivial element: $g_i\neq 1$ for all $i\in\i{1}{r}$.
\end{definition}

\begin{definition}
Let $h\in G$ and $\m{B}:=(g_1,\cdots, g_r)\in G^r$ be a basis of $G$. The \emph{discrete logarithm of $h$ in the basis $\m{B}$}, denoted by $\mbox{DL}_{\m{B}}(h)$ is the unique tuple $x\in\prod_{i=1}^r\i{0}{|g_i|-1}$ (or equivalently, $x\in\prod_{i=1}^r\Z/|g_i|\Z$)  such that $\m{B}^x=h$. 
\end{definition}

\begin{definition}
A finite abelian group $G$ is \emph{effective} if: 
\begin{description}
\item[(i)] Given $a, b\in G$, we can compute $a\cdot b\in G$.
\item[(ii)] Given $a\in G$, we can compute $a^{-1}\in G$.
\item[(iii)] Given $a, b\in G$, we can test whether $a=b$.
\item[(iv)] $|G|$ and its decomposition into primes are known.
\end{description}
\end{definition}

In the following, we fix an effective finite abelian group $G$, a basis $\m{B}:=(g_1,\cdots, g_r)$ of $G$ and $h\in G$. We present an algorithm to compute $DL_{\m{B}}(h)$. Let $N:=|G|$ and its decomposition into primes:
\[N=\prod_{i=1}^s p_i^{\alpha_i}\]
For  all $i\in\i{1}{s}$, let $N_i:=\frac{N}{p_i^{\alpha_i}}$ and:
\[G_i:=\{g^{N_i}\mid g\in G\}\]

\begin{lemma}\label{lemma 11}
\begin{description}
\item[(i)] We have two group isomorphisms:
\[\begin{array}{rcl}
\phi : G&\overset{\sim}{\longrightarrow}&\prod_{i=1}^s G_i\\
g&\longmapsto & (g^{N_i})_{1\leq i\leq s}
\end{array} \quad \mbox{and} \quad \begin{array}{rcl}
\psi : \prod_{i=1}^s G_i &\overset{\sim}{\longrightarrow}& G\\
(g_i)_{1\leq i\leq s} &\longmapsto & \prod_{i=1}^s g_i
\end{array}\]
It follows that $G_i$ is the $p_i$-Sylow subgroup of $G$ for all $i\in\i{1}{s}$.

\item[(ii)] For $e\in\Z$, let $G^e:=\{g^e\mid g\in G\}$ and $\m{B}^{(e)}:=(g_1^e, \cdots, g_r^e)$. Then $\m{B}^{(e)}$ is a basis of $G^e$.  In particular, $\m{B}_i:=\m{B}^{(N_i)}=(g_1^{N_i},\cdots, g_r^{N_i})$ is a basis of $G_i$ for all $i\in\i{1}{s}$.

\item[(iii)] To compute $x:=DL_{\m{B}}(h)$, it suffices to compute $x_i:=DL_{\m{B}_i}(h^{N_i})$ for all $i\in\i{1}{s}$. We then recover each component $x_j$ of $x$ ($j\in\i{1}{r}$) by the Chinese remainder theorem:
\[x_j\equiv x_{i, j} \ [p_i^{\alpha_i}]\]
\end{description}
\end{lemma}

\begin{proof}
\textbf{(i)} Let $g\in G$ such that $g^{N_i}=1$ for all $i\in\i{1}{s}$. Then $|g||N_i$ for all $i\in\i{1}{s}$. But $\gcd(N_1,\cdots, N_s)=1$, so that $|g|=1$ and $g=1$. Hence $\phi$ is injective, so $\prod_{i=1}^s|G_i|\geq |G|$ .

If $(g_i)_{1\leq i\leq s} \in  \prod_{i=1}^s G_i$ is such that $\prod_{i=1}^s g_i=1$, then we get that $\prod_{j=1}^s g_j^{N_i}=g_i^{N_i}=1$ for all $i\in\i{1}{s}$,  since $|g_j||p_j^{\alpha_j}$ for all $j\in\i{1}{s}$.  Hence $|g_i||N_i$ and $|g_i||p_i^{\alpha_i}$ so $g_i=1$ because $N_i$ and $p_i^{\alpha_i}$ are coprime. Hence $\psi$ is injective. It follows that $\prod_{i=1}^s|G_i|=|G|$ so that $\phi$ and $\psi$ are isomorphisms.  

\textbf{(ii)} Trivially, $\m{B}^{(e)}$ generates $G^e$ and furthermore, if $x\in\Z^t$ is such that ${\m{B}^{(e)}}^x=1$ then $|g_j||e x_j$ for all $j\in\i{1}{r}$, since $\m{B}$ is a basis of $G$, so that $|g_j^{e}|=|g_j|/\gcd(e,|g_j|)|e/\gcd(e,|g_j|)x_j$. Since $|g_j|/\gcd(e,|g_j|)$ and $e/\gcd(e,|g_j|)$ are coprime, we get that $|g_j^{e}||x_j$, for all $j\in\i{1}{r}$. Whence~(ii).

\textbf{(iii)} For all $x\in\Z^r$, we have:
\[\m{B}^x=h\Longleftrightarrow \phi(\m{B}^xh^{-1})=1\Longleftrightarrow \forall i\in\i{1}{s}, \quad \m{B}^{N_i x}=\m{B}_i^x=h^{N_i}\]
By unicity of the discrete logarithm, it follows that for all $i\in\i{1}{s}$ and $j\in\i{1}{r}$, we have $x_j\equiv x_{i,j}\ [p_i^{\alpha_i}]$, where $x_i:=(x_{i,j})_{1\leq j\leq s}:=DL_{\m{B}_i}(h^{N_i})$. 
\end{proof}

With the preceding lemma, we reduce our computation to the computation of discrete logarithms in $p$-groups, so we can assume that $G$ is a $p$-group.  Let $e(G)$ be the exponent of $G$ and $\sigma=\sigma(G):=\log_p(e(G))$. We show how to reduce our computation of discrete logarithms in $G$ to the computation of $\sigma$ discrete logarithms in a $p$-subgroup of exponent $p$.  Indeed, if $x=(x_1,\cdots, x_r):=\mbox{DL}_{\m{B}}(h)$, we can write in basis~$p$:
\[\forall i\in\i{1}{r}, \quad x_i:=\sum_{k=0}^{\sigma_i-1}x_{i,\sigma_i-1-k} p^k=\sum_{k=0}^{\sigma_i-1}x_{i,k} p^{\sigma_i-1-k}\]
with $\sigma_i:=\log_p(|g_i|)\leq \sigma$ and $x_{i,k}\in\i{0}{p-1}$ for all $k\in\i{0}{\sigma_i-1}$.  It follows that for all $l\in\i{0}{\sigma-1}$:
\[h^{p^{l}}=\m{B}^{p^l x}=\prod_{i=1}^r g_i^{\sum_{k=0}^{\sigma_i-1}x_{i,\sigma_i-1-k} p^{k+l}}=\prod_{i=1}^r g_i^{\sum_{k=0}^{\sigma_i-1}x_{i,k} p^{\sigma_i-1-k+l}}=\prod_{i=1}^r g_i^{p^{\sigma_i-1}\sum_{k=0}^{\min(l,\sigma_i-1)}x_{i,k} p^{l-k}}\]
i.e.
\[\underbrace{h^{p^{l}}\prod_{\substack{1\leq i\leq r\\ l\leq \sigma_i-1}}^r g_i^{-p^l\sum_{k=0}^{l-1}x_{i,k}p^{\sigma_i-1-k}}}_{h_l}=\prod_{\substack{1\leq i\leq r\\ l\leq \sigma_i-1}}^r g_i^{p^{\sigma_i-1}x_{i,l}}\]
Hence, assuming that the $x_i$ are known for $l\geq \sigma_i$ and that the $x_{i,k}$ are known for $l\leq \sigma_i-1$ and $k\in\i{0}{l-1}$, we can compute the $x_{i,l}$ for $l\leq \sigma_i-1$ as:
\[(x_{i,l})_{ l\leq \sigma_i-1}:=\mbox{DL}_{\mC_l}(h_l)\]
with:
\[\mC_l:=(g_i^{p^{\sigma_i-1}})_{ l\leq \sigma_i-1}\] 

Hence, we reduced to the case where $G$ is a $p$-group of exponent $e(G)=p$. This can be done in time $O((\sqrt{p}+1)^r)$, for instance with Baby-step, Giant-step algorithm.

\begin{algorithm}\label{algorithm 8}
\SetAlgoLined
\KwData{$G$ an effective abelian $p$-group of exponent $p$, a basis $\m{B}:=(g_1,\cdots, g_r)$ of $G$ and $h\in G$.}
\KwResult{$\mbox{DL}_{\m{B}}(h)$.}
Set $m\leftarrow\lceil\sqrt{p}\rceil$\; 
Compute $\prod_{i=1}^r g_i^{j_i}$ for all $(j_1, \cdots, j_r)\in\i{0}{m-1}^r$ and store the result in a hash table\;
Compute $h\prod_{i=1}^r g_i^{mk_i}$ for $(k_1, \cdots, k_r)\in\i{0}{\left\lfloor\frac{p}{m}\right\rfloor}^r$ until we find a collision $h\prod_{i=1}^r g_i^{mk_i}=\prod_{i=1}^r g_i^{j_i}$ for $(j_1, \cdots, j_r)\in\i{0}{m-1}^r$\;
Return $(j_i-m k_i)_{1\leq i\leq r}$ modulo $p$\;

\caption{Multivariate Baby-step Giant-step in a $p$-group of exponent $p$}
\end{algorithm}

\begin{lemma}\label{lemma 10}
Algorithm \ref{algorithm 8} is correct. This algorithm performs at most:
\[m^r+2\(\left\lfloor\frac{p}{m}\right\rfloor+1\)^r-2r-3\]
multiplications and $\(\left\lfloor\frac{p}{m}\right\rfloor+1\)^r$ lookups in a hash table. Hence, assuming the table lookups and group operations have constant cost, the algorithm performs in $O((\sqrt{p}+1)^r)$.
\end{lemma}

\begin{proof}
To prove the corectness it suffices to prove that a collision is found on line 3, i.e. that the indices $j_i-m k_i$ cover $\Z/p\Z$.  Since they cover the interval $\i{-m\left\lfloor\frac{p}{m}\right\rfloor}{m-1}$ of cardinality:
\[m\left\lfloor\frac{p}{m}\right\rfloor+m\geq \(\frac{p}{m}-1\)m+m=p\]
they indeed cover $\Z/p\Z$ and the algorithm is correct.

On line 2, the algorithm computes:
\[S_r:=\{\prod_{i=1}^r g_i^{j_i}\mid (j_1, \cdots, j_r)\in\i{0}{m-1}^\}\]
Let $\mu(S_r)$ the number of multiplications necessary to compute $S_r$. Knowing $S_{r-1}$, one can compute $S_r$ by computing $1, g_r, g_r^2, \cdots, g_r^{m-1}$ ($m-2$ multiplications) and multiplying each element of $S_r\setminus\{1\}$ by these elements ($(m-1)(|S_{r-1}|-1)$ multiplications).  It follows that:
\[\mu(S_r)=(m-1)(|S_{r-1}|-1)+m-2+\mu(S_{r-1})=(m-1)(m^{r-1}-1)+m-2+\mu(S_{r-1})=(m-1)m^{r-1}-1+\mu(S_{r-1})\]
Since $\mu(S_1)=m-2$, it follows that:
\[\mu(S_r)=\sum_{k=1}^{r-1}((m-1)m^{k}-1)+m-2=m(m^{r-1}-1)-(r-1)+m-2=m^r-r-1\]

Similarly, computing $\prod_{i=1}^r g_i^{mk_i}$ for all $(k_1, \cdots, k_r)\in\i{0}{\left\lfloor\frac{p}{m}\right\rfloor}^r$ requires:
\[\(\left\lfloor\frac{p}{m}\right\rfloor+1\)^r-r-1\]
multiplications. Taking into account the multiplications by $h$, we get:
\[\(\left\lfloor\frac{p}{m}\right\rfloor+1\)^r-r-1+\(\left\lfloor\frac{p}{m}\right\rfloor+1\)^r-1=2\(\left\lfloor\frac{p}{m}\right\rfloor+1\)^r-r-2\]
multiplications in line 3. We also have as many table lookups as elements computed in line 3, hence $\(\left\lfloor\frac{p}{m}\right\rfloor+1\)^r$ table lookups. This completes the proof.
\end{proof}

Assuming again that $G$ is general (not a $p$ group), the following algorithm computes the discrete logarithm $\mbox{DL}_{\m{B}}(h)$ in $G$.

\begin{algorithm}[!h]\label{algorithm 9}
\SetAlgoLined
\KwData{$G$ an effective abelian group, $N:=|G|$ and its decomposition into primes $N:=\prod_{i=1}^s p_i^{\alpha_i}$, a basis $\m{B}:=(g_1,\cdots, g_r)$ of $G$ and $h\in G$.}
\KwResult{$\mbox{DL}_{\m{B}}(h)$.}
\For{$i=1$ \KwTo $s$}{
$N_i\leftarrow \frac{N}{p_i^{\alpha_i}}$\;
$\m{B}_i=(b_1,\cdots, b_r)\leftarrow (g_1^{N_i},\cdots, g_r^{N_i})$\;
$h_i\leftarrow h^{N_i}$\;
\For{$j=1$ \KwTo $r$}{
$\sigma_{i,j}\leftarrow \log_{p_i}|g_j^{N_i}|$\;
}
$\sigma_i\leftarrow \max_{1\leq i\leq r}\sigma_{i,j}$\;
$x_i\leftarrow (0)_{1\leq j\leq r}$\;
\For{$l=\sigma_i-1$ \KwTo $0$}{
$h_{i,l}\leftarrow h_i^{p^{l}}\prod_{\substack{1\leq j\leq r\\ l\leq \sigma_{i,j}-1}}^r b_j^{-p_i^lx_{i,j}}$\;
$\m{C}_{i,l}\leftarrow (b_j^{p_i^{\sigma_i-1}})_{\substack{1\leq j\leq r\\l\leq\sigma_{i,j}-1}}$\;
$y\leftarrow DL_{\m{C}_{i,l}}(h_{i,l})$ (using algorithm \ref{algorithm 8})\;
$(x_{i,j})_{\substack{1\leq j\leq r\\l\leq\sigma_{i,j}-1}}\leftarrow (x_{i,j}+p_i^{\sigma_{i,j}-1-l}y_j)_{\substack{1\leq j\leq r\\l\leq\sigma_{i,j}-1}}$ \;
}
}
Compute $x\in\prod_{j=1}^r\i{0}{|g_j|-1}$ such that $x_j\equiv x_{i, j} [p_i^{\alpha_i}]$ for all $i\in\i{1}{s}$ and $j\in\i{1}{r}$ using Chinese remainder theorem \cite[algorithm 1.3.12]{Cohen1}\;
Return $x$\;

\caption{Multivariate discrete logarithm in an effective finite abelian group}
\end{algorithm}

\begin{proposition}\label{proposition 12}
Algorithm \ref{algorithm 9} is correct and computes $DL_{\m{B}}(h)$ with:
\[O\(\sum_{i=1}^s\sigma_i((\sqrt{p_i}+1)^r+r\log(N))+rs\log^2(N)\)\]
elementary operations, where $N:=|G|=\prod_{i=1}^s p_i^{\alpha_i}$ and $\sigma_i$ is the logarithm in basis $p_i$ of the exponent of the $p_i$-Sylow of $G$ for all $i\in\i{1}{s}$.
\end{proposition}

\begin{proof}
The correctness follows directly from what we explained above. 

For the complexity, we count the operations line by line. Line 2 is negligible, lines 3 and 4 require $r+1$ exponentiations by $N_i$, that can be performed with $\log(N_i)$ multiplications for all $i\in\i{1}{s}$. Hence, line 3 and 4 cost:
\[O\((r+1)\sum_{i=1}^s \log(N_i)\)\] 
multiplications. Computing the exponents on line 6 requires at most $\sigma_i r$ exponentiations by $p_i$ for all $i\in\i{1}{s}$, for a total cost of:
\[O\(r\sum_{i=1}^s\sigma_i\log(p_i)\)\]
multiplications.  Line 11 requires at most $r$ exponentiations of order of magnitude $p_i^{\sigma_i}$, $r$ multiplications and an exponentiation by $p_i^{l}$ for all $i\in\i{1}{s}$ and $l\in\i{0}{\sigma_i-1}$, for a total cost of:
\[O\(\sum_{i=1}^s\sum_{l=0}^{\sigma_i-1}(r\sigma_i\log(p_i)+l\log(p_i)+r)\)=O\(rs\sum_{i=1}^s\sigma_i(1+\sigma_i\log(p_i))+\sum_{i=1}^s\frac{\sigma_i(\sigma_i-1)}{2}\log(p_i)\)\]
multiplications. The $\m{C}_{i,l}$ on line 12 can be computed outside of the loop on $l$ and inside the loop on $i$ for a total cost of:
\[O\(r\sum_{i=1}^s(\sigma_i-1)\log(p_i)\)\]
multiplications. Line 13 requires the computation of a discrete logarithm in $p_i$-group of exponent $p_i$, whose complexity is $O(\sqrt{p_i}+1)^r)$ (by lemma \ref{lemma 10}) for all $i\in\i{1}{s}$ and $j\in\i{0}{\sigma_i-1}$, for a total cost of:
\[O\(\sum_{i=1}^s\sigma_i(\sqrt{p_i}+1)^r\)\]
elementary operations. Line 14 is negligible. Finally, line 17 requires the computation of $r$ Chinese remainders with $s$ variable integers of order of magnitude $N$, using algorithm \cite[algorithm 1.3.12]{Cohen1}, hence applying $rs$ times extended Euclid's algorithm for a total cost of $O(rs\log^2(N))$. Taking the dominant terms into account only, we get the announced time complexity.
\end{proof}


\subsection{Basis computation from a generating set}

Let us recall the notations of the preceding paragraph: let $G$ be an effective finite abelian group, $N:=|G|$ and its decomposition into primes $N=\prod_{i=1}^s p_i^{\alpha_i}$. For  all $i\in\i{1}{s}$, let $N_i:=\frac{N}{p_i^{\alpha_i}}$ and $G_i:=\{g^{N_i}\mid g\in G\}$.

\begin{lemma}\label{lemma 12}
\begin{description}
\item[(i)] Let $S:=\{s_1,\cdots, s_t\}$ be a generating set of $G$.  Then, for all $i\in\i{1}{s}$, $S^{(N_i)}:=\{s_1^{N_i},\cdots, s_t^{N_i}\}$ generates $G_i$.

\item[(ii)] Let $\m{B}_i$ be a basis of $G_i$ for all $i\in\i{1}{s}$. Then, $\m{B}:=\bigvee_{i=1}^r\m{B}_i$, the concatenation of the $\m{B}_i$, is a basis of $G$.

\item[(iii)] If $G$ is a $p$-group $G$, then all of its basis have the same cardinality, which is called the \emph{rank} of $G$.
\end{description}
\end{lemma}

\begin{proof}
\textbf{(i)} Trivial.

\textbf{(ii)} It follows directly from the fact that:
\[\begin{array}{rcl}
\psi : \prod_{i=1}^s G_i &\overset{\sim}{\longrightarrow}& G\\
(g_i)_{1\leq i\leq s} &\longmapsto & \prod_{i=1}^s g_i
\end{array}\]
is an isomorphism, as proved in point (i) of lemma \ref{lemma 11}.

\textbf{(iii)} Let $\m{B}:=\{g_1,\cdots, g_r\}$ be a primitive basis of $G$. Then, all the orders $|g_i|$ are non-trivial powers of $p$.Without loss of generality, we can reorder the $g_i$, so that $|g_1||\cdots||g_r|$ and we trivially have:
\[G\simeq \prod_{i=1}^r (\Z/|g_i|\Z)\]
via the isomorphism $x\in\prod_{i=1}^r (\Z/|g_i|\Z)\longmapsto\m{B}^x\in G$.  Hence, $|g_1|,\cdots,|g_r|$ are the invariant factors of $G$ so there are unique and in particular, their number is fixed and depends only on $G$.
\end{proof}

The preceding lemma indicates that it suffices to find basis of the $p_i$-Sylow subgroups $G_i$ of $G$ to compute a basis of $G$. In the following, we assume that $G$ is a $p$-group.

\begin{definition}
Let $\m{B}:=(g_1,\cdots, g_r)$ be a free family of $G$ and $h\in G$. We denote by $\mbox{DL}_{\m{B}}^*(h)$ the tuple $(x,e)\in\Z^u\times\Z$ such that $e\in\N$ is the smallest integer such that $h^{p^e}\in\langle\m{B}^{(p^e)}\rangle=\langle g_1^{p^e},\cdots, g_r^{p^e}\rangle$ and $x:=\mbox{DL}_{\m{B}^{(p^e)}}(h^{p^e})$, so that $h^{p^e}=\m{B}^{p^e x}$. 
\end{definition}

\begin{lemma}
Let $\m{B}:=(g_1,\cdots, g_r)$ be a free family of $G$, $n_i:=\log_p(|g_i|)$ for all  $i\in\i{1}{r}$, $m_0:=\min_{1\leq i\leq r} n_i$, $m:=\max_{1\leq i\leq r} n_i$, $(x,e):=\mbox{DL}_{\m{B}}^*(h)$ and $h':=h\m{B}^{-x}$. Suppose that $|h|\leq p^m$. Then:

\begin{description}
\item[(i)] $|h'|=p^e$.
\item[(ii)] If furthermore $|h'|\leq p^{m_0}$, then $\m{B}':=\m{B}\vee (h')$ is a free family.
\end{description}
\end{lemma}

\begin{proof}
\textbf{(i)} By the definition of $\mbox{DL}_{\m{B}}^*(h)$, we have $h^{p^e}=\m{B}^{p^ex}$, so that ${h'}^{p^e}=(h\m{B}^{-x})^{p^e}=1$. If ${h'}^{p^{e'}}=1$ for $e'<e$, then we would have $h^{p^{e'}}=\m{B}^{p^{e'} x}$ and $e$ would not be minimal for this equality. Hence, $|h'|=p^e$.

\textbf{(ii)} We assume that $|h'|\leq p^{m_0}$ and that $\m{B}':=\m{B}\vee (h')$ is not free. Then, we have a non-trivial relation ${h'}^k=\m{B}^y$ for $k\in\Z\setminus\{0\}$ and $y\in\Z^r\setminus\{0\}$. Let us write $k:=k'p^f$ with $k\in\Z\setminus\{0\}$ and $f\in\i{0}{e-1}$ such that $\gcd(k',p)=1$. Let $l$ be an inverse of $k'$ modulo $p^{e-f}$. Then, we get $h'^{p^f}=\m{B}^{z}$ with $z:=ly$. 

$p^f\nmid z$. Indeed, otherwise, set $v:=x+z/p^f$. Then:
\[h^{p^f}=(h'\m{B}^x)^{p^f}=\m{B}^{z+p^fx}=\m{B}^{p^f v}\]
but $f<e$, so it contradicts the minimality of $e$.Hence, $p^f\nmid z$.

We also have $m_0\geq e>f$ since $|h'|\leq p^{m_0}$, so that: 
\[1={h'}^{p^{m_0}}=\m{B}^{p^{m_0-f}z}\]
and consequently, $p^{n_i}|p^{m_0-f}z_i$ so $p^{m_0}|p^{m_0-f}z_i$ and $p^f| z_i$ for all $i\in\i{1}{r}$. Contradiction. Hence, $\m{B}'$ is free.
\end{proof}

Our basis computation algorithm follows from the preceding lemma. Assume that we already have constructed the free family $\m{B}:=(g_1,\cdots, g_r)$ and that we have a generating set $S:=\{s_1,\cdots, s_t\}$ (that is not free in general) such that $\langle\m{B}\cup S\rangle=G$.  We assume that $|s_i|\leq p^{m_0}$ for all $i\in\i{1}{t}$. Let $(x_i,e_i):=\mbox{DL}_{\m{B}}^*(s_i)$ for all $i\in\i{1}{t}$. Then, $e_i\leq \log_p(|s_i|)\leq m_0$ and $s'_i:=s_i\m{B}^{-x_i}$ has order $e_i$ for all $i\in\i{1}{t}$. We select $i_0\in\i{1}{t}$ such that $e_{i_0}$ is maximal, set $g_{r+1}:=s'_{i_0}$, $\m{B}':=\m{B}\vee(g_{r+1})$ and $S':=\{s'_1,\cdots, s'_t\}\setminus\{s'_{i_0}\}$. Then, $\m{B}'$ is still free by point (ii) of the lemma, we still have $\langle\m{B}'\cup S'\rangle=G$ and $\log_p(|s'_i|)=e_i\leq\min(m_0,e_{i_0})$ so that our invariants from the beginning are still satisfied with $\m{B}'$ and $S'$. 

Applying these principles, we can compute a basis from a generating set using the following algorithm due to \cite{Sutherland2010}.

\begin{algorithm}[!h]\label{algorithm 10}
\SetAlgoLined
\KwData{$G$ an effective abelian $p$-group, a generating set of $G$, $S:=\{s_1,\cdots, s_t\}$.}
\KwResult{A primitive basis of $G$: $\m{B}:=(g_1,\cdots, g_r)$.}
$\m{B}\leftarrow \emptyset$\;
$e_i\leftarrow \log_p(|s_i|)$ for all $i\in\i{1}{t}$\;
\eIf{$\forall i\in\i{1}{t}, \ e_i=0$}{
Return $\m{B}$;
}{
$i_0\leftarrow\mbox{argmax}_{1\leq i\leq t} e_i$\;
$\m{B}\leftarrow \m{B}\vee(s_{i_0})$\;
$S\leftarrow S\setminus\{s_{i_0}\}$ and $t\leftarrow |S|$\;
}
\While{$t\neq 0$ and $\max_{1\leq i\leq t}e_i>0$}{
\For{$i:=1$ \KwTo $t$, $e_i>0$}{
$(x_i,e_i)\leftarrow \mbox{DL}_{\m{B}}^*(s_i)$ (try to compute $\mbox{DL}_{\m{B}^{(p^e)}}(h^{p^e})$ for $e:=0$ to $e_i$ using algorithm \ref{algorithm 9} until the computation succeeds)\;
$s_i\leftarrow s_i\m{B}^{-x_i}$\;
}
\eIf{$\forall i\in\i{1}{t}, \ e_i=0$}{
Return $\m{B}$;
}{
$i_0\leftarrow\mbox{argmax}_{1\leq i\leq t} e_i$\;
$\m{B}\leftarrow \m{B}\vee(s_{i_0})$\;
$S\leftarrow S\setminus\{s_{i_0}\}$ and $t\leftarrow |S|$\;
}
}
Return $\m{B}$\;

\caption{Basis computation in a $p$-group.}
\end{algorithm}

\begin{proposition}\label{proposition 11}
Algorithm \ref{algorithm 10} terminates and is correct. It performs:
\[O(t^2(\sigma^2(\sqrt{p}+1)^r+\sigma rn^2\log^2(p)))\]
elementary operations, where $t:=|S|$, $p^\sigma$ is the exponent of $G$, $|G|=p^n$ and $r$ is the rank of $G$.
\end{proposition}

\begin{proof}
The algorithm terminates because the number of elements in $S$ decreases at each iteration of the loop, unless all the $e_i$ are zero in which case the termination is immediate.  As explained above, the algorithm respects the following loop invariant: $\m{B}$ is a free family, $\langle\m{B}\cup S\rangle=G$ and the orders of the element of $S$ are smaller than all the orders of elements of $\m{B}$.  When the algorithm terminates, $S$ is either empty or equal to $\{1\}$, so $\m{B}$ generates $G$ and is a basis. Hence, the algorithm is correct.

Now, we compute the complexity. The order computation on line 2 requires at most $t\sigma$ exponentiations by $p$, each of them costing $O(\log(p))$ group multiplications, for a total cost of $O(t\sigma\log(p))$.Operations on lines 3 to 9 are negligible. The while loop is executed at most $t$ times ($t$ being the initial cardinality of $|S|$ here). At the $j$-th iterations of the while loop, we have $|S|\leq t-j$ so we execute lines 12 and 13 at most $t-j$ times. Everytime it is executed, line 12 requires at most $\sigma$ computations of the discrete logarithm in a $p$-group with a basis of $r$ elements so we have a complexity of:
\[O(\sigma^2((\sqrt{p}+1)^r+r\log(|G|))+\sigma r\log^2(|G|))=O(\sigma^2(\sqrt{p}+1)^r+\sigma rn^2\log^2(p))\]
using algorithm \ref{algorithm 9}.  Everytime line 13 is executed, $j$ exponentiations and $j$ multiplications are performed, for a cost of $O(j(\sigma\log(p)+1))$. Hence, the total cost of line 12 and 13 (counting the number of times they are executed) is:
\begin{align*}&O\((\sigma^2(\sqrt{p}+1)^r+\sigma rn^2\log^2(p))\sum_{j=1}^t(t-j)+(\sigma\log(p)+1)\sum_{j=1}^t j\)\\
&=O(t^2(\sigma^2(\sqrt{p}+1)^r+\sigma rn^2\log^2(p)))
\end{align*}
The time complexity of the algorithm follows.
\end{proof}

\subsection{Specialization to the case of the ideal class group $\mbox{Cl}(\mO_n)$}

By theorem \ref{theorem 10}, $\mbox{Cl}(\mO_n)$ is either cyclic or of the form $(\Z/\ell\Z)\times(\Z/h_{n-1}\Z)$ with $h_{n-1}:=|\mbox{Cl}(\mO_{n-1})|$. 

We want to find a basis of $\mbox{Cl}(\mO_n)$ given the generating set $S:=\{[\mf{q}_1], \cdots, [\mf{q}_t]\}$. In that case, we do not need to use Sutherland's algorithm (algorithm \ref{algorithm 10}). First, we compute all the orders of the $[\mf{q}_j]$. Then, we build $g_1\in \mbox{Cl}(\mO_n)$ whose order is $|g_1|=\mbox{lcm}_{1\leq j\leq t}|[\mf{q}_j]|$ (the exponent of $\mbox{Cl}(\mO_n)$). In general, one of the $[\mf{q}_j]$ will convene. Otherwise, we may take the product of all the $[\mf{q}_j]$. 

If $\mbox{Cl}(\mO_n)$ is cyclic, then $g_1$ is a generator and we are done. Otherwise, $|g_1|=h_{n-1}$ and to find a basis of $\mbox{Cl}(\mO_n)$, it suffices to find $g_2\not\in \langle g_1\rangle$ of order $\ell$. We simply try to compute the discrete logarithm of $[\mf{q}_j]$ with respect to $g_1$ with algorithm \ref{algorithm 9} (for $r=1$) and stops when it fails. If it fails for $j\in\i{1}{t}$, we must have $[\mf{q}_j]^\ell\in\langle g_1\rangle$ so we find the discrete logarithm $k:=DL_{g_1}([\mf{q}_j]^\ell)$. Since $\mbox{Cl}(\mO_n)$ has exponent $h_{n-1}$, we must have $g_1^{kh_{n-1}/\ell}=[\mf{q}_j]^{h_{n-1}}=[1]$, so that $h_{n-1}|kh_{n-1}/\ell$ i.e. $\ell|k$. Set $k':=k/\ell$ and $g_2:=[\mf{q}_j]g_1^{-k'}$. Then $g_2$ is convenient.

\begin{lemma}\label{lemma 19}
Assume that $h(\mO_K)=1$ and that $\ell$ is relatively small. Then, given a generating set of $\mbox{Cl}(\mO_n)$ with $t$ elements, one can compute a basis in time $O(tn^2)$ in the worst case. 
\end{lemma}

\begin{proof}
To compute the orders of the $[\mf{q}_j]$, one only has to compute their exponentiation by all the divisors of $h_n=|\mbox{Cl}(\mO_n)|$. Since $h_n=\frac{\ell^{n-1}}{[\mO_K^\times:\mO_1^\times]}\(\ell-\(\frac{\Delta_K}{\ell}\)\)$, there are $O(n)$ such divisors and each exponentiation takes $O(\log(h_n))=O(n)$ operations. Hence, the total cost of this step is $O(tn^2)$.

Computing $g_1$ costs $O(t)$ operation in the worst case (multiplying all the $[\mf{q}_j]$).

Computing a discrete logarithm by algorithm \ref{algorithm 9} costs $O(n^2)$ and there are $t+1$ such discrete logarithms to compute in the worst case. The total complexity follows.
\end{proof}

\section{Lattice of relations of a finite abelian group}

Given a finite abelian group $G$ and a generating set $S=\{s_1,\cdots, s_t\}$ of $G$, we want to compute a $\Z$-basis of the following lattice:
\[L=\left\{(e_1,\cdots,e_t)\in\Z^t \ \middle| \ \prod_{j=1}^t s_j^{e_j}=1\right\}\]
Using algorithm \ref{algorithm 10}, we can compute a basis $\m{B}:=(g_1,\cdots, g_r)$ of $G$ and then use algorithm \ref{algorithm 9} to compute the discrete logarithm $x_j:=\mbox{DL}_{\m{B}}(s_j)$ for all $j\in\i{1}{t}$. 

We then have for all $e\in\Z^t$:
\begin{align*} e\in L&\Longleftrightarrow \prod_{j=1}^t s_j^{e_j}=1\Longleftrightarrow \m{B}^{\sum_{j=1}^t e_jx_j}=1\Longleftrightarrow \forall k\in\i{1}{r},\quad \sum_{j=1}^t e_jx_{j,k}\equiv 0 \  [|g_k|]\\
&\Longleftrightarrow X_k\cdot e\equiv 0 \ [|g_k|]
\end{align*}
with $X_k:=(x_{j,k})_{1\leq j\leq t}$, seen as a line vector for all $k\in\i{1}{r}$ and $e$ seen as a column vector.Hence:
\[L=\bigcap_{k=1}^r L_k\]
with $L_k:=\{e\in\Z^t\mid X_k\cdot e\equiv 0 \ [|g_k|]\}$ for all $k\in\i{1}{r}$.  To compute $L$, it is useful to introduce dual lattices. 

\begin{definition}
Let $\Lambda\subset\R^d$ be a full-rank lattice. Then, the \emph{dual lattice} of $\Lambda$, denoted by $\Lambda^*$ is the lattice:
\[\Lambda^*:=\{x\in\R^d\mid \forall y\in\Lambda, \quad \langle x,y\rangle\in\Z\}\]
where $\langle.,.\rangle$ is the usual scalar product.
\end{definition}

\begin{lemma}\label{lemma 16}
Let $\Lambda, \Lambda_1, \cdots, \Lambda_r\subset\R^d$ be full-rank lattices.  Then:

\begin{description}
\item[(i)] If $B$ is a $\Z$-basis of $\Lambda$, then $(B^T)^{-1}$ is a $\Z$-basis of $\Lambda^*$.
\item[(ii)] $\Lambda^{**}=\Lambda$.
\item[(iii)] Suppose that $\bigcap_{k=1}^r\Lambda_k$ has full-rank. Then $ \(\bigcap_{k=1}^r\Lambda_k\)^*=\sum_{k=1}^r \Lambda_k^*$.
\end{description}
\end{lemma}

\begin{proof}
\textbf{(i)} Let us write $B=(b_1|\cdots|b_d)$ and  $(B^T)^{-1}=(b_1^*|\cdots|b_d^*)$ in columns.  Then, for all $i,j \in\i{1}{d}$, we have:
\[\langle b_i^*, b_j\rangle=b_i^T\cdot b_j=(B^{-1}\cdot B)_{i, j}=\delta_{i,j}\in\Z\]
It follows that $\Lambda^*$ contains $(B^T)^{-1}$. Conversely, let $x\in\Lambda^*$. Since $(B^T)^{-1}$ is invertible, the $b_i^*$ form a $\R$-basis of $\R^d$ so we can write $x=\sum_{i=1}^d x_i b_i^*$ with $x_1, \cdots, x_d\in\R$. Hence, for all $j\in\i{1}{d}$:
\[\langle x, b_j\rangle=\sum_{i=1}^d x_i\langle b_i^*,b_j\rangle=\sum_{i=1}^d x_i\delta_{i, j}=x_j\in\Z\]
so $x$ is an integer linear combination of the $b_i^*$ and $(B^T)^{-1}$ is indeed a basis of $\Lambda^*$.

\textbf{(ii)} It follows immediately from (i).

\textbf{(iii)} By (ii), it suffices to prove that $\bigcap_{k=1}^r\Lambda_k=\(\sum_{k=1}^r \Lambda_k^*\)^*$. Let $x\in\R^d$. Then, we have:
\[x\in \bigcap_{k=1}^r\Lambda_k \Longleftrightarrow \forall k\in\i{1}{r}, \forall y\in \Lambda_k^*,  \  \langle x,y\rangle\in \Z\Longleftrightarrow \forall y\in\sum_{k=1}^r\Lambda_k^*, \ \langle x, y\rangle\in\Z\Longleftrightarrow x\in \(\sum_{k=1}^r \Lambda_k^*\)^*\]
The result follows.
\end{proof}

$L$ has full rank since $G\simeq \Z^t/L$ is finite so we may apply point (iii) of the preceding lemma to get:
\[L^*=\sum_{k=1}^r L_k^*\]
Hence, it suffices to obtain generating families of the lattices $L_k^*$ to obtain a generating family of $L^*$. We then compute the HNF of the matrix of this generating family to obtain a basis $C$ of $L^*$. We the easily obtain a basis $B:=(C^T)^{-1}$ of $L$.

Actually, the following lemma ensures that $L_k^*=|g_k|^{-1}(\Z\cdot X_k^T+|g_k|\Z^t)$, so we can apply this method to determine $B$.

\begin{lemma}
Let $v\in\Z^d$, $q\in\N^*$,
\[\Lambda_q^\bot(v)=\{x\in\Z^d\mid \langle v, x\rangle\equiv 0 \ [q]\} \quad \mbox{and} \quad \Lambda_q(v)=\{y\in\Z^d\mid \exists \lambda\in\Z, \quad y\equiv \lambda\cdot v \ [q]\}\]
Then $\Lambda_q^\bot(v)^*=q^{-1}\Lambda_q(v)$.
\end{lemma}

\begin{proof}
By lemma \ref{lemma 16}, points (i) and (ii), it suffices to prove that $\Lambda_q(v)^*=q\Lambda_q^\bot(v)$. Let $x\in \Z^d$.Then:
\begin{align*}
x\in \Lambda_q(v)^* & \Longleftrightarrow x\in (\Z\cdot v+q\Z^d)^*\Longleftrightarrow \langle v,x\rangle\in\Z \quad \mbox{and} \quad \forall y\in\Z^d, \quad \langle qy, x\rangle\in\Z\\
&  \Longleftrightarrow  \exists x'\in\Z^d, \quad x=\frac{1}{q}x' \quad \mbox{and}\quad \langle v, x'\rangle\equiv 0 \ [q] \Longleftrightarrow x\in q^{-1} \Lambda_q^\bot(v)
\end{align*}
This completes the proof.
\end{proof}

\begin{algorithm}[!h]\label{algorithm 11}
\SetAlgoLined
\KwData{$G$ an effective abelian group, a generating set of $G$, $S:=\{s_1,\cdots, s_t\}$ and a basis of $G$, $\m{B}=(g_1, \cdots, g_r)$ (computed with algorithm \ref{algorithm 10} for instance).}
\KwResult{A basis of the relations lattice $L:=\{(e_1,\cdots,e_t)\in\Z^t \ \mid \ \prod_{j=1}^t s_j^{e_j}=1\}$.}

$x_j:=(x_{j,k})_{1\leq k\leq r}\leftarrow \mbox{DL}_{\m{B}}(s_j)$ for $j\in\i{1}{t}$\;
$X_k\leftarrow (x_{j,k})_{1\leq j\leq t}$ for all $k\in\i{1}{r}$\;
$m\leftarrow \mbox{lcm}(|g_j|)_{1\leq j\leq t}$\;
$M\leftarrow \(m/|g_1|X_1^T|\cdots|m/|g_r|X_r^T|mI_t\)\in M_{t, t+r}(\Z)$\;
$M'\leftarrow HNF(M)$ using \cite[algorithm 2.4.4]{Cohen1}\;
$C\leftarrow (M'_{i,j})_{\substack{1\leq i\leq t\\ r+1\leq j\leq r+t}}$\;
$B\leftarrow m(C^T)^{-1}$\;
Return $B$\;

\caption{Relation lattice basis computation.}
\end{algorithm}

\section{Kuperberg's algorithm}\label{paragraph 14}

The presentation of this section follows Kuperberg's foundational article \cite{Kuperberg}. Let us consider a finite abelian group $G$ with multiplicative law. We define the \emph{dehedral group} associated to $G$ as the semi-direct product:
\[D_G:=G\rtimes_\phi (\Z/2\Z)\]
with $\phi: \Z/2\Z\longrightarrow \mbox{Aut}(G)$ given by $\phi(1)(g):=g^{-1}$ for all $g\in G$, so that $D_G$ is the set $G\times(\Z/2\Z)$ with inner product given by:
\[\forall g,g'\in G, \epsilon,\epsilon'\in(\Z/2\Z), \quad (g,\epsilon)\cdot(g',\epsilon')=(g\phi(\epsilon)(g'),\epsilon+\epsilon')=(gg'^{-\epsilon},\epsilon+\epsilon')\]

When $G$ is cyclic of order $N$, $D_G$ is isomorphic to the \emph{dihedral group of order $N$} denoted by $D_N$ generated by a \emph{reflection} $y$ (of order $2$) and a \emph{rotation} $x$ (of order $N$) related by $yxyx=1$.  Elements of $\langle x\rangle$ are called rotations and the others are called reflections. Similarly, when $G$ is not cyclic, we can set $y:=(1,1)$ whose order is $2$ and embed $G$ in $D_G$, so that $D_G$ is generated by $y$ and $G$ and for all $g\in G$, $ygyg=1$. Elements of $G$ are called are called rotations and the others are called reflections.$y$ is called the \emph{standard reflection} but actually, any other reflection $y'$ generate $D_G$ together with $G$ and satisfies $y'gy'g=1$ for all $g\in G$. 

\begin{problem}[Hidden Shift Problem]
Let $G$ be a group. Given $f,g: G\longrightarrow S$ two injective functions such that there exists $s\in G$ such that $g(x)=f(sx)$ for all $x\in G$, the problem is to determine $s$.
\end{problem}

\begin{problem}[Hidden Subgroup Problem]
Let $G$ be a group. Given $f: G\longrightarrow S$ a function such that there exists an unknown subgroup $H\subseteq G$ satisfying:
\[\forall x,y\in G, \quad f(x)=f(y)\Longleftrightarrow y\in Hx\]
hence, inducing an injective map $G/H\longrightarrow S$, the problem is to determine $H$.
\end{problem}

\begin{problem}[Hidden Reflection Problem]
Hidden reflection problem is a particular case of the hidden subgroup problem when $G$ is dihedral and $H$ is generated by a reflection.
\end{problem}

\begin{lemma}
The hidden subgroup problem in a finite abelian group $G$ is equivalent to the hidden reflection problem in the dihedral group $D_G$.
\end{lemma}

\begin{proof}
Let $f,g: G\longrightarrow S$ two injective functions such that there exists $s\in G$ such that $g(x)=f(sx)$ for all $x\in G$.  Let $h: D_G\longrightarrow S$ defined as follows:
\[\forall x\in G, \quad h(x):=f(x) \quad \mbox{and} \quad h(yx):=g(x)\]
It follows that for all $u,v\in D_G$, $h(u)=h(v)\Longleftrightarrow v\in Hu$ with $H:=\langle ys^{-1}\rangle$.

Conversely, let $h: D_G\longrightarrow S$ inducing an injective map $D_G/H\longrightarrow S$ where $H$ is generated by a reflection $y'\in D_G$, that we may write $y':=ys^{-1}$ with $s\in G$. Then, let $f, g:G\longrightarrow S$ given by:
\[\forall x\in G, \quad f(x):=h(x) \quad \mbox{and} \quad g(x):=h(yx)\]
Then, $f$ and $g$ are injective and $g(x)=f(sx)$ for all $x\in G$.
\end{proof}

Hence, in the latter, we explain how to solve the hidden reflection problem.We start our explanation for $G$ cyclic: $G\simeq\Z/N\Z$. We shall then explain how the general case reduces to this case. 

\subsection{Hidden reflection problem in the cyclic case}

In the following, we fix $H:=\langle yx^s\rangle$ with $y$ the standard reflection, $x$ a generator of the rotation subgroup and $s\in\Z/N\Z$, the \emph{slope} of our hidden reflection.  We also fix $f:D_N\longrightarrow S$, a function such that for all $u, v\in D_N$, $f(u)=f(v)$ if and only if $v\in Hu$. Our goal is to find $s$ when $f$ is given.

We explain how operations are performed on a quantum computer using the formalism of \cite[chapter 8]{NielsanChaung} and the lecture notes of Dimitri Petritis modelling quantum states as density operators and quantum operations. We assume that $S:=\{0,1\}^e$ is a set of bits.We associate to $f$ a unitary operator $U_f$, defined on the Hilbert space $\C[D_N\times S]$ as:
\[\forall g\in D_N, s\in S, \quad U_f|g,s\rangle:=|g,s\oplus f(g)\rangle\]
where $\oplus$ is the bitwise addition (xor). Assuming there is a classical circuit to compute $f$, we can create a quantum circuit representing $U_f$. Hence, our classical oracle computing $f$ translates into a quantum oracle computing $U_f$. 

Let us denote for all finite sets $F\subseteq E$, $|F\rangle\in\C[E]$ the unitary vector:
\[|F\rangle:=\frac{1}{\sqrt{|F|}}\sum_{f\in F}|f\rangle\]
The first step of Kuperberg's algorithm is to prepare the system in the quantum pure state $\rho_0:=|\psi\rangle\langle\psi|$ where $|\psi\rangle:=|D_N\rangle|0^e\rangle\in\C[D_N\times S]$.  Then, we operate by $U_f$ and discard the output register $\C[S]$. After this operation, the system is in the mixed state:
\[\rho_1=\mbox{Tr}_{\C[S]}(U_f\cdot \rho_0\cdot U_f^{\dag})\]
defined on $\C[D_N]$.  

The second step is to operate by quantum Fourier transform $\m{F}_N$, defined on $\C[D_N]$ as follows:
\[\forall k\in\i{0}{N-1}, \epsilon\in\{0,1\}, \quad \m{F}_N|y^\epsilon x^k\rangle:=\frac{1}{\sqrt{N}}\sum_{j=0}^{N-1}\omega_N^{jk}|y^\epsilon x^j\rangle\]
with $\omega_N:=e^{\frac{2i\pi}{N}}$, leaving system be in the state:
\[\rho_2:=\m{F}_N\cdot \rho_1\cdot \m{F}_N^{\dag}\]
defined on $\C[D_N]$.

Since $D_N$ is in bijection (as a set) to the Cartesian product of $y$ with $\langle x\rangle$, we have $\C[D_N]\simeq\C[\Z/2\Z]\otimes\C[\Z/N\Z]$, and in this decomposition, every basis vector $|y^\epsilon x^k\rangle$ with $\epsilon\in\Z/2\Z$ and $k\in\Z/N\Z$ can be represented as $|\epsilon\rangle|k\rangle$. The third operation of Kuperberg's algorithm is to measure the last register $|k\rangle$ of the system $\rho_2$.

\begin{lemma}
We have:
\[\rho_1=\frac{1}{N}\sum_{g\in \langle x\rangle}|Hg\rangle\langle Hg|\]
\[\rho_2=\frac{1}{2N}\sum_{k=0}^{N-1}(|0k\rangle +\omega_N^{ks}|1k\rangle)(\langle 0k|+\omega_N^{-ks}\langle 1k|)\]
Hence, after the measurement step, the system is in the pure state:
\[|\psi_k\rangle:=\frac{1}{\sqrt{2}}(|0\rangle +\omega_N^{ks}|1\rangle)\]
\end{lemma}

\begin{proof}
We have:
\begin{align*}
\rho_1&=\mbox{Tr}_{\C[S]}(U_f\cdot \rho_0\cdot U_f^{\dag})=\mbox{Tr}_{\C[S]}(U_f|D_N0^e\rangle\langle D_N 0^e|U_f^{\dag})\\
&=\mbox{Tr}_{\C[S]}\(\frac{1}{2N}\sum_{g,g'\in D_N}U_f|g,0^e\rangle\langle g',0^e|U_f^{\dag}\)=\frac{1}{2N}\mbox{Tr}_{\C[S]}\(\sum_{g,g'\in D_N}|g,f(g)\rangle\langle g',f(g')|\)\\
&=\frac{1}{2N}\sum_{s\in S}\sum_{g,g'\in D_N}\langle s|f(g)\rangle \langle f(g')|s\rangle |g\rangle\langle g'|=\frac{1}{2N}\sum_{s\in f(D_N)}\sum_{\substack{g,g'\in D_N\\f(g)=f(g')=s}}|g\rangle\langle g'|\\
&=\frac{1}{2N}\sum_{g\in \langle x\rangle}\sum_{h,h'\in H}|h\rangle\langle h'|=\frac{1}{N}\sum_{g\in \langle x\rangle}|Hg\rangle\langle Hg|
\end{align*}
where we used the fact that every element of $D_N$ can be uniquely written as the product of an element of $H$ and an element of $\langle x\rangle$, so that $D_N/H\simeq \langle x\rangle$ and the fact that $f$ induces a injective map $D_N/H\simeq \langle x\rangle\longrightarrow S$.

For all $k\in\Z/N\Z$, we have:
\[\m{F}_N|Hx^k\rangle=\frac{1}{\sqrt{2}}\m{F}_N(|x^k\rangle+|yx^{k+s}\rangle)=\frac{1}{\sqrt{2N}}\sum_{j=0}^{N-1}(\omega_N^{jk}|x^j\rangle+\omega_N^{j(k+s)}|yx^j\rangle)\]
so that:
\begin{align*}
\m{F}_N|Hx^k\rangle\langle Hx^k|\m{F}_N^{\dag}&=\frac{1}{2N}\sum_{j=0}^{N-1}(\omega_N^{jk}|x^j\rangle+\omega_N^{j(k+s)}|yx^j\rangle)\sum_{l=0}^{N-1}(\omega_N^{-lk}\langle x^l|+\omega_N^{-l(k+s)}\langle yx^l|)\\
&=\frac{1}{2N}\sum_{0\leq j,l\leq N-1}(\omega_N^{(j-l)k}|x^j\rangle\langle x^l|+\omega_N^{j(k+s)-lk}|yx^j\rangle\langle x^l|+\omega_N^{jk-l(k+s)}|x^j\rangle\langle yx^l|\\
&+\omega_N^{(j-l)(k+s)}|yx^j\rangle\langle yx^l|)
\end{align*}
and finally:
\begin{align*}
\rho_2&=\m{F}_N\rho_1\m{F}_N^{\dag}=\frac{1}{N}\sum_{k=0}^{N-1}\m{F}_N|Hx^k\rangle\langle Hx^k|\m{F}_N^{\dag}\\
&=\frac{1}{2N^2}\sum_{0\leq j,l\leq N-1}\(\sum_{k=0}^{N-1}\omega_N^{(j-l)k}\)\(|x^j\rangle\langle x^l|+\omega_N^{js}|yx^j\rangle\langle x^l|+\omega_N^{-ls}|x^j\rangle\langle yx^l|+|yx^j\rangle\langle yx^l|\)\\
&=\frac{1}{2N^2}\sum_{0\leq j,l\leq N-1}N\delta_{j,l}\(|x^j\rangle\langle x^l|+\omega_N^{js}|yx^j\rangle\langle x^l|+\omega_N^{-ls}|x^j\rangle\langle yx^l|+|yx^j\rangle\langle yx^l|\)\\
&=\frac{1}{2N}\sum_{k=0}^{n-1}\(|x^k\rangle\langle x^k|+\omega_N^{ks}|yx^k\rangle\langle x^k|+\omega_N^{-ks}|x^j\rangle\langle yx^k|+|yx^k\rangle\langle yx^k|\)\\
&=\frac{1}{2N}\sum_{k=0}^{n-1}(|x^k\rangle +\omega_N^{ks}|yx^k\rangle)(\langle x^k|+\omega_N^{-ks}\langle yx^k|)=\frac{1}{2N}\sum_{k=0}^{N-1}(|0k\rangle +\omega_N^{ks}|1k\rangle)(\langle 0k|+\omega_N^{-ks}\langle 1k|)
\end{align*}

It is now clear that if we measure the last register $\C[\Z/N\Z]$ and find the value $k$, then the system is in the following state right after the measurement:
\[\frac{I\otimes |k\rangle\langle k|\cdot \rho_2\cdot I\otimes |k\rangle\langle k|}{\mbox{Tr}(I\otimes |k\rangle\langle k|\cdot \rho_2\cdot I\otimes |k\rangle\langle k|)}= \frac{1}{2}(|0k\rangle +\omega_N^{ks}|1k\rangle)(|0k\rangle +\omega_N^{-ks}|1k\rangle)\]
which is a the pure state associated to:
\[|\psi_k\rangle:=\frac{1}{\sqrt{2}}(|0\rangle +\omega_N^{ks}|1\rangle)\]
the last register $|k\rangle$ being omitted because it does not carry any information.
\end{proof}

We have just described a procedure to compute states $|\psi_k\rangle=\frac{1}{\sqrt{2}}(|0\rangle +\omega_N^{ks}|1\rangle)$ with uniformly random values of $k\in\Z/N\Z$ as follows:

\begin{algorithm}[!h]\label{algorithm 12}
\SetAlgoLined
\KwData{$f:D_N\longrightarrow S$ with a hidden reflection $yx^s$ and a quantum oracle to compute $U_f$.}
\KwResult{A state $|\psi_k\rangle$ together with $k$, for $k\in\Z/N\Z$ uniformly random.}

Prepare the system in the pure state $\rho_0:=|D_N\rangle |0^e\rangle\langle 0^e|\langle D_G|$ over the Hilbert space $\C[D_N\times S]$\;
Let $U_f$ act on $\rho_0$ and discard the output register to produce $\rho_1:=\mbox{Tr}_{\C[S]}(U_f\cdot \rho_0\cdot U_f^{\dag})$\;
Apply the quantum Fourier transform to obtain $\rho_2:=\m{F}_N\cdot \rho_1\cdot \m{F}_N^{\dag}$\;
Measure the register $\C[\Z/N\Z]$ of $\rho_2$ to obtain $k\in\Z/N\Z$ and $|\psi_k\rangle$\;
Return $k$ and $|\psi_k\rangle$\;

\caption{Procedure to produce the states $|\psi_k\rangle$ with $k\in\Z/N\Z$ uniformly random.}
\end{algorithm}

With this procedure, we can produce as many states $|\psi_k\rangle$ as we want and then apply a sieving procedure to all those states in order to determine $s$. The sieving relies on the ability to produce a new state when two states are given. 

\subsection{Basis of the Sieving: producing new states}\label{paragraph 12}

Let $|\psi_k\rangle$ and $|\psi_l\rangle$ be two sampled states. We consider the joint state:
\[|\psi_k\psi_l\rangle=\frac{1}{2}\(|00\rangle+\omega_N^{ks}|10\rangle+\omega_N^{ls}|01\rangle+\omega_N^{(k+l)s}|11\rangle\)\]
and we let the C-NOT gate $C^{\lnot}$ given by:
\[\forall a, b\in\{0,1\}, \quad C^{\lnot}|a,b\rangle=|a,a+b \ \mbox{mod} \ 2\rangle\]
operate on $|\psi_k\psi_l\rangle$. The system is now in the pure state:
\[C^{\lnot}|\psi_k\psi_l\rangle=\frac{1}{2}\(|00\rangle+\omega_N^{(k+l)s}|10\rangle+\omega_N^{ls}|01\rangle+\omega_N^{ks}|11\rangle\)\]
Then, we measure the second bit. If we measure the value $0$, then the state becomes:
\[\frac{1}{\sqrt{2}}\(|0\rangle +\omega_N^{(k+l)s}|1\rangle\)=|\psi_{k+l}\rangle\]
and if we measure the value $1$, then the state becomes:
\[\frac{1}{\sqrt{2}}\(\omega_N^{ls}|0\rangle +\omega_N^{ks}|1\rangle\)=\omega_N^{ls}|\psi_{k-l}\rangle\]
which can be assimilated to $|\psi_{k-l}\rangle$ because collinear unit states are equivalent. Hence, we either obtain $|\psi_{k+l}\rangle$ or $|\psi_{k-l}\rangle$ by the end of this procedure.  By measurement, we also know if we obtained $k+l$ or $k-l$.

\begin{algorithm}[!h]\label{algorithm 13}
\SetAlgoLined
\KwData{Two state $|\psi_k\rangle$ and $|\psi_l\rangle$.}
\KwResult{A state $|\psi_{k\pm l}\rangle$ together with the integer $k\pm l$, where the sign $\pm$ is an unbiased coin flip.}

Let the C-NOT gate operate on $|\psi_k\psi_l\rangle$ to obtain $|\Psi\rangle:=C^{\lnot}|\psi_k\psi_l\rangle$\;
Measure the second bit of $\Psi$\;
If the result of the measure is $\epsilon\in\{0,1\}$, we obtain $|\psi_{k+(-1)^\epsilon l}\rangle$\;
Output $|\psi_{k+(-1)^\epsilon l}\rangle$ and $k+(-1)^\epsilon l$\;

\caption{State creation.}
\end{algorithm}

\subsection{Sieving procedure in the case $N=r^n$}

In this paragraph, we describe how this sieving procedure works when $N$ is a prime power $N:=r^n$, with $r$ relatively small. However, this could be generalized to any value of $N$ (see \cite[algorithm 2]{Kuperberg} for details). Here, we will not deal with the general case because it is not necessary for our application to $G=\mbox{Cl}(\mO_n)$ whose $p$-groups have small values of $p$.

\subsubsection{Goal of the sieving: reduce the problem to $D_{N/r}$}\label{paragraph 13}

If $s\equiv a \ [r]$ for $a\in\i{0}{r-1}$ then our hidden reflection $yx^s$ is in the subgroup $G_a:=\langle yx^a,x^r\rangle$, which is isomorphic to $D_{N/r}$. Hence, we have reduced our problem to the hidden reflection in $D_{N/r}$, provided that we can find $s \ \mbox{mod} \ r$.

To find $s \ \mbox{mod} \ r$, we use states $|\psi_k\rangle$ with $k:=br^{n-1}$ and $b\in\i{1}{r-1}$. With sufficiently many copies of $|\psi_k\rangle$ (for the same $k$), we can recover $s \ \mbox{mod} \ r$ by \emph{state tomography}, as explained in \cite[§ 8.4.2, p.389]{NielsanChaung}. We consider the Pauli matrices:
\[\sigma_0:=I_2, \quad \sigma_1:=\(\begin{array}{cc}
0 & 1\\
1 & 0
\end{array}\), \quad \sigma_2:=\(\begin{array}{cc}
0 & -i\\
i & 0
\end{array}\) \quad \mbox{and} \quad \sigma_3:=\(\begin{array}{cc}
1 & 0\\
0 & -1
\end{array}\)\]
The system $(\sigma_j/\sqrt{2})_{0\leq j\leq 3}$ is a basis for the Hilbert-Schmidt scalar product:
\[(A,B)\in M_2(\C)\longmapsto (A|B):=\mbox{Tr}(A^{\dag}\cdot B)\]
Hence, our state $\rho:=|\psi_k\rangle\langle\psi_k|$ is fully determined by the equation: 
\[\rho=\frac{1}{2}\sum_{j=0}^3\mbox{Tr}(\sigma_j\cdot\rho)\sigma_j\]
Actually, the trace $\mbox{Tr}(\sigma_j\cdot\rho)$ is the expected value of the observable $\sigma_j$ when the system is in state $\rho$ so we may evaluate it by law of large numbers,  provided that we have enough copies of $\rho$ to test. By the central limit theorem, if we have $m$ observations $z_1, \cdots, z_m$, the statistical $\frac{1}{m}\sum_{l=1}^m z_l$ should approximate $\mbox{Tr}(\sigma_j\cdot\rho)$ with precision $1/\sqrt{m}$.  Actually, we have
\[\mbox{Tr}(\sigma_0\cdot\rho)=\frac{1}{2}, \quad \mbox{Tr}(\sigma_1\cdot\rho)=\cos\(\frac{2\pi bs}{r}\), \quad \mbox{Tr}(\sigma_2\cdot\rho)=\sin\(\frac{2\pi bs}{r}\) \quad \mbox{and} \quad \mbox{Tr}(\sigma_3\cdot\rho)=0\]
so we only have to measure $\mbox{Tr}(\sigma_1\cdot\rho)$ and $\mbox{Tr}(\sigma_2\cdot\rho)$, to determine $\rho$.

\subsubsection{The sieve}

For all $k\in\Z/N\Z$ (seen as an integer in $\i{0}{N-1}$), let $\alpha(k)$ be the number of trailing zeros in the decomposition of $k$ in basis $r$. We describe a sieving procedure maximizing the value of $\alpha$. We start with a list $L_0$ of sub-exponential size containing states $|\psi_k\rangle$ with $k\in\Z/N\Z$ uniformly random, provided by repeated quantum oracle queries following algorithm \ref{algorithm 12}.  

Let $k:=\lceil\log_2(r)\rceil$, $m:=\lceil \sqrt{(n-1)/k}\rceil$ and $m':=\lceil (n-1)/m\rceil$. For $j\in\i{0}{m'-1}$, we assume that we have a list $L_j$ of states $|\psi_k\rangle$ with $k$ having $mj$ trailing zeros ($\alpha(k)\geq mj$). We construct a list $L_{j+1}$ of states $|\psi_k\rangle$ such that $\alpha(k)\geq m(j+1)$ as follows: we divide $L_j$ into pairs of states $|\psi_k\rangle$ and $|\psi_l\rangle$ such that $k$ and $l$ share $m$ digits next to their trailing zeros (or $n-1-m(m'-1)$ digits if $j=m'-1$). Then, we apply algorithm \ref{algorithm 13} to produce a state $|\psi_{k\pm l}\rangle$. If the result is $k-l$, we add the new state $|\psi_{k-l}\rangle$ to $L_{j+1}$. Otherwise, we do nothing.  

Finally, the list $L_{m'}$ will contain \emph{final states} $|\psi_k\rangle$ such that $r^{n-1}|k$. Provided that $L_{m'}$ contains sufficiently many of these states, we can find $s \ \mbox{mod} \ r$ and reduce our problem to $D_{N/r}$.  To sum up, we obtain the following version of Kuperberg's algorithm in the case of a cyclic $r$-group. Note that this algorithm is recursive.

\begin{algorithm}\label{algorithm 14}
\SetAlgoLined
\KwData{$N:=r^n$ with $r$ prime, $f:D_N\longrightarrow S$ with a hidden reflection $yx^s$ and a quantum oracle to compute $U_f$.}
\KwResult{$s\in\Z/N\Z$.}

Use algorithm \ref{algorithm 12} repeatedly to produce a list $L_0$ of states $|\psi_k\rangle$ with $k\in\Z/N\Z$ uniformly random\;
$k\leftarrow \lceil\log_2(r)\rceil$, $m\leftarrow \lceil \sqrt{(n-1)/k}\rceil$, $m'\leftarrow\lceil (n-1)/m\rceil$\;
\For{$j:=0$ \KwTo $m'-1$}{
Initiate $L_{j+1}$ as the empty list\;
Divide $L_j$ into a maximal list $P_j$ of pairs $|\psi_k\rangle$ and $|\psi_l\rangle$ such that $k$ and $l$ share $\min(m,n-1-mj)$ $r$-digits next to their trailing zeros\;
For every pair $\{|\psi_k\rangle,|\psi_l\rangle\}\in P_j$, apply algorithm \ref{algorithm 13} to create a new state  $|\psi_{k\pm l}\rangle$ and add this state to $L_{j+1}$ if $\pm=+$\;
}
All sates of $L_{m'}$ are of the form $|\psi_{br^{n-1}}\rangle$ with $b\in\i{0}{r-1}$. Extract all the copies of $|\psi_{br^{n-1}}\rangle$ with a fixed value $b\neq 0$ chosen to maximize the number of these copies. \;
Apply state tomography (see paragraph \ref{paragraph 13}) to recover $a:=s \ \mbox{mod} \ r$ from the copies of $|\psi_{br^{n-1}}\rangle$\;
Compute recursively the slope $s'\in\Z/r^{n-1}\Z$ for the hidden reflection problem induced by $f$ in $G_a:=\langle yx^a,x^r\rangle$\;
Return $a+rs'$\;

\caption{Kuperberg's algorithm in a cyclic $r$-group.}
\end{algorithm}

The number of states in $L_0$ to make sure that $L_{m'}$ contains enough copies of the same non trivial state to perform state tomography.

\begin{lemma}\label{lemma 21}
Let $k:=\lceil\log_2(r)\rceil$, $m:=\lceil \sqrt{(n-1)/k}\rceil$ and $m':=\lceil (n-1)/m\rceil$. Suppose that $|L_0|\geq 4\cdot 2^{km+2m'}$. Then, $|L_{m'}|\geq 2^{km}$ with overwhelming probability: 
\[\P\(|L_{m'}|\geq 2^{km}\)\geq \(1-e^{-2^{\frac{m'}{3}-1}}\)^{m'}\]
\end{lemma}

Before proving the lemma, we prove the following classical inequality due to Chernoff:

\begin{lemma}
Let $X_1, \cdots, X_{M}$ be $M$ independent Bernoulli variables of parameter $\frac{1}{2}$ and $S_M:=\sum_{i=1}^M X_i$. Then, for all $b\in]0,1[$, we have:
\[\P\(S_M\leq\frac{N(1-b)}{2}\)\leq \cosh(b)^N e^{-Nb^2}\leq e^{-\frac{Nb^2}{2}}\]
\end{lemma}

\begin{proof}
We have by Markov's inequality:
\begin{align*}
\P\(S_M\leq\frac{N(1-b)}{2}\)&=\P\(M-S_M\geq\frac{N(1+b)}{2}\)=\P\(e^{2b(M-S_M)}\geq e^{Nb(1+b)}\)\\
&\leq \E\(e^{2b(M-S_M)}\)e^{-Nb(1+b)}= \E\(\prod_{i=1}^M e^{2b(1-X_i)}\)e^{-Nb(1+b)}\\
&=\E(e^{2b(1-X_1)})^Ne^{-Nb(1+b)} \quad (\mbox{the } X_i \mbox{ being i.i.d})\\
&=\(\frac{1+e^{2b}}{2}\)^Ne^{-Nb(1+b)}=\(\frac{e^b+e^{-b}}{2}\)^Ne^{-Nb^2}=\cosh(b)^Ne^{-Nb^2}
\end{align*}

To conclude, it suffices to prove that $\cosh(b)\leq e^{\frac{b^2}{2}}$. Actually, this equality holds for all $b\geq 0$. Let: 
\[g: t\in\R_+\longmapsto \ln(2)+\frac{t^2}{2}-t-\ln\(1+e^{-2t}\)\]
to prove the desired inequality,it is sufficient and necessary to prove that $g$ is non-negative on $\R_+$. $g$ is $\mC^2$ and:
\[\forall t\in\R_+, \quad g'(t)=t-1+\frac{2}{e^{2t}+1} \quad \mbox{and} \quad g''(t)=1-\frac{4e^{2t}}{(1+e^{2t})^2}=1-\frac{1}{\cosh(t)^2}\]
Since $\cosh\geq 1 $ on $\R_+$, it follows that $g''\geq 0$ on $\R_+$, so that $g'(t)\geq g'(0)=0$ for all $t\in\R_+$, so $g$ is increasing and $g(t)\geq g(0)=0$ for all $t\in\R_+$. This completes the proof.
\end{proof}

\begin{proof} (of lemma \ref{lemma 21})
We prove by induction that we have for all $j\in\i{0}{m'}$:
\[\P\(|L_j|\geq C_j 2^{km+2(m'-j)}\)\geq \(1-e^{-2^{\frac{m'}{3}-1}}\)^j\]
with $C_0:=4$ and for all $j\in\i{0}{m'-1}$, $C_{j+1}:=C_j(1-2^{j-\frac{4m'}{3}})(1-2^{2(j-m')})$. 

This is trivial for $j=0$. Let $j\in\i{0}{m'-1}$. We assume that the result holds at rank $j$. Let $P_j$ be a maximal list of pairs of states $|\psi_k\rangle$ and $|\psi_l\rangle$ of $L_j$ such that $k$ and $l$ share $\min(m,n-1-mj)$ digits (in basis $r$) next to their trailing zeros. Since at most $r^m$ elements of $L_j$ do not belong to one of these pairs and $r\leq 2^k$, we have:
\[|P_j|\geq \frac{|L_j|-r^m}{2}\geq \frac{|L_j|-2^{km}}{2}\]
Assuming that $|L_j|\geq C_j 2^{km+2(m'-j)}$ and that $C_j\geq 1$ (that we shall prove later), we get that:
\[|P_j|\geq \frac{C_j 2^{km+2(m'-j)} -2^{km}}{2}=2^{km+2(m'-j)-1}(C_j-2^{2(j-m')})\geq 2^{km+2(m'-j)-1}C_j(1-2^{2(j-m')}) \] 
When executing algorithm \ref{algorithm 13} for each pair $\{|\psi_k\rangle, |\psi_l\rangle\}\in P_j$, we have a probability of $\frac{1}{2}$ to obtain the state $|\psi_{k+l}\rangle$ that we can add to $L_{j+1}$. Hence, $|L_{j+1}|$ is the sum of $|P_j|$ independent Bernoulli variables so for $b\in]0,1[$ to be chosen, Chernoff's inequality ensures that:
\[\P\(|L_{j+1}|\leq \frac{|P_j|(1-b)}{2}\)\leq e^{-\frac{|P_j|b^2}{2}} \quad \mbox{i.e.} \quad \P\(|L_{j+1}|\geq \frac{|P_j|(1-b)}{2}\)\geq 1-e^{-\frac{|P_j|b^2}{2}}\]
We set $b:=2^{j-\frac{4m'}{3}}$. Then, conditionally to the event $|L_j|\geq C_j 2^{km+2(m'-j)}$, we get:
\[\frac{|P_j|(1-b)}{2}\geq 2^{km+2(m'-j-1)}C_j(1-2^{2(j-m')})(1-2^{j-\frac{4m'}{3}})= 2^{km+2(m'-j-1)}C_{j+1}\]
and:
\[\frac{|P_j|b^2}{2}\geq 2^{km+2(m'-j)-1}C_j(1-2^{2(j-m')})2^{2j-\frac{8m'}{3}}\geq 2^{km+\frac{m'}{3}-2}\geq 2^{\frac{m'}{3}-1}\]
since $C_j\geq 1$ and $km\geq 1$. It follows that:
\[\P\(|L_{j+1}|\geq 2^{km+2(m'-j-1)}C_{j+1}\middle| |L_j|\geq C_j 2^{km+2(m'-j)} \)\geq 1-e^{-2^{\frac{m'}{3}}}\]
The result follows immediately at rank $j+1$. 

It remains to prove that $C_j\geq 1$ for all $j\in\i{0}{m'}$. Since the $C_j$ are decreasing, we just have to prove that $C_{m'}\geq 1$. But we have:
\begin{align*}
C_{m'}&=C_0\prod_{j=0}^{m'-1}\(1-2^{j-\frac{4m'}{3}}\)\(1-2^{2(j-m')}\)=C_0\prod_{j=1}^{m'}\(1-2^{-j-\frac{m'}{3}}\)\(1-2^{-2j}\)\\
&=C_0\exp\(\sum_{j=1}^{m'}\(\ln\(1-2^{-j-\frac{m'}{3}}\)+\ln\(1-2^{-2j}\)\)\)\\
&\geq 4\exp\(-\sum_{j=1}^{m'}\(2^{-j-\frac{m'}{3}}+2^{-2j-\frac{4m'}{3}-1}+2^{-2j}+2^{-4j-1}\)\)\\
&\geq 4\exp\(-\frac{1}{2^{\frac{m'}{3}+1}\(1-\frac{1}{2}\)}-\frac{1}{2^{\frac{4m'}{3}+3}\(1-\frac{1}{2^2}\)}-\frac{1}{2^{2}\(1-\frac{1}{2^2}\)}-\frac{1}{2^{4}\(1-\frac{1}{2^4}\)}\)\\
&= 4\exp\(-\frac{1}{2^{\frac{m'}{3}}}-\frac{1}{3\cdot 2^{\frac{4m'}{3}+1}}-\frac{1}{3}-\frac{1}{15}\)\geq 1
\end{align*}
as soon as $m'\geq 1$, which is obviously the case.
\end{proof}

\begin{theorem}
In the cyclic case with $N=r^n$ for $r$ relatively small, Kuperberg's algorithm (algorithm~\ref{algorithm 14}) terminates and is correct with overwhelming probability, requires $2^{O(\sqrt{\log_2(N)})}$ queries to the oracle $U_f$, runs in time $2^{O(\sqrt{\log_2(N)})}$ and uses $2^{O(\sqrt{\log_2(N)})}$ qubits.
\end{theorem}

\begin{proof}
The termination and correctness follows from the explanations and results given above (lemma \ref{lemma 21} in particular).

We keep the notations of algorithm \ref{algorithm 14}. By lemma \ref{lemma  21}, the size of the list $L_0$ is $4\cdot 2^{km+2m'}$, where $k:=\lceil\log_2(r)\rceil$, $m:=\lceil \sqrt{(n-1)/k}\rceil$ and $m':=\lceil (n-1)/m\rceil$, so that, when $n\rightarrow+\infty$ and $r$ is constant, $m=\sqrt{n/k}+O(1)$ and $m'=\sqrt{kn}+O(1)$ and: 
\[km+2m'=3\sqrt{kn}+O(1)=3\sqrt{\log_2(r)\log_r(N)}+O(1)=3\sqrt{\log_2(N)}+O(1)\]
As a consequence, $2^{3\sqrt{\log_2(N)}+O(1)}$ quantum queries are necessary on line 1 of \ref{algorithm 14}. Taking into account the $n$ recursive calls we get that the number of quantum queries is:
\[\sum_{k=0}^{n-1}2^{3\sqrt{\log_2(N/r^k)}+O(1)}\leq n2^{3\sqrt{\log_2(N)}+O(1)}=2^{O(\sqrt{\log_2(N)})}\]

The operations performed on the lists $L_j$ for $j\in\i{0}{m'-1}$ are linear in the size of these lists which is bounded by $|L_0|$. As a consequence, the for loop in algorithm \ref{algorithm 14} has a time complexity $m'2^{3\sqrt{\log_2(N)}+O(1)}=2^{O(\sqrt{\log_2(N)})}$. Line 8 and 9 of the algorithm do not change the complexity. Taking into account the recursion, we get a time complexity of $n2^{O(\sqrt{\log_2(N)})}=2^{O(\sqrt{\log_2(N)})}$.

The space complexity in terms of qubits is bounded by $|L_0|=2^{O(\sqrt{\log_2(N)})}$.
\end{proof}

\begin{remark}
The complexities given here only hold only if $r$ is small and $n\rightarrow +\infty$. If $n=1$ and $N=r$ is prime, algorithm \ref{algorithm 14} is exponential in $\log_2(N)$.  Hopefully, Kuperberg's provided an algorithm working in this case.
\end{remark}

\subsubsection{General case ($G$ not cyclic)}

We briefly explain (without proof) how the cyclic case can be generalized to any finite abelian group $G$. By the structure theorem of finite abelian groups, there exists integers $N_1,\cdots,N_a\geq 2$ such that:
\[G\simeq\prod_{i=1}^a \Z/N_i\Z\]
We can even assume that the $N_i$ are prime powers by the Chinese remainder theorem. As in the cyclic case, every element $g\in D_G$ can be uniquely written as $g=y^\epsilon \prod_{i=1}^a x_i^{t_i}$, with $\epsilon\in\Z/2\Z$ and $t_i\in\Z/N_i\Z$ for all $i\in\i{1}{a}$, $y$ being the standard reflection and $x_i$ being generator of the factor $\Z/N_i\Z$ for $i\i{1}{a}$. The hidden reflection is then determined by an $a$-dimensional slope $s\in\prod_{i=1}^a \Z/N_i\Z$.

A slightly modified version of algorithm \ref{algorithm 12} (with a multidimensional quantum Fourier transform), when given the pure state $|D_G\rangle|0^e\rangle$, outputs a state:
\[|\psi_k\rangle:=|0\rangle +e^{\sum_{j=1}^a \frac{2ik_js_j\pi}{N_j}}|1\rangle\]
with a random uniform vector $k:=(k_1, \cdots, k_a)\in\prod_{i=1}^a \Z/N_i\Z$. The idea is to perform $2^{O(\log_2(|G|))}$ such quantum queries to obtain a list of such states $|\psi_k\rangle$ and then apply a sieving procedure to produce $2^{O(\log_2(N_i))}$ states $|\psi_k\rangle$ with $k$ almost zero except at index $i\in\i{1}{a}$, and then apply a new sieving in the group $\langle y, x_i\rangle\simeq D_{N_i}$ to recover $s_i$.  If $N_i$ is a prime power, algorithm \ref{algorithm 14} can be applied.

As previously, this sieving procedure to discard vector components except at index $i\in\i{1}{a}$ uses a variant of algorithm \ref{algorithm 13} to produce states $|\psi_{k\pm l}\rangle$ with pairs of states $|\psi_k\rangle$ and $|\psi_l\rangle$ and maximizes an objective function $\alpha_i$ defined over $\prod_{j=1}^a \Z/N_j\Z$. For $i=a$, this objective function was explicitely defined by Kuperberg \cite[proof of theorem 7.1]{Kuperberg}. For $k\in\prod_{j=1}^a \Z/N_j\Z$, let $b(k):=\min\{1\leq j\leq a| k_j\neq 0\}$ and if $b(k)<a$, set:
\[\alpha(k):=\sum_{j=1}^{b(k)}\lceil 1+\log_2(N_j+1)\rceil -\lceil\log_2(k_{b(k)}+1)\rceil\]
if $b(k)=a$, set:
\[\alpha(k):=\sum_{j=1}^{a}\lceil 1+\log_2(N_j+1)\rceil\]

\begin{theorem}
Hidden reflection problem in $D_G$ can be solved in time $2^{O(\log_2(|G|))}$ with $2^{O(\log_2(|G|))}$ quantum queries and $2^{O(\log_2(|G|))}$ qubits.
\end{theorem}

\begin{proof}
See \cite[theorem 7.1]{Kuperberg}.
\end{proof}

\end{document}
